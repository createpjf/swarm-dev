<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cleo Dashboard</title>
<style>
/* ══════════════════════════════════════════════════════════════════
   CLEO DASHBOARD — Liquid Glass Design System (Dark Mode)
   Inspired by Apple iOS 26 / macOS 26 Liquid Glass
   Translucent, luminous surfaces floating above deep space.
   ══════════════════════════════════════════════════════════════════ */

/* ── DejaVu Sans Mono Web Font ───────────────────────────────── */
@font-face{font-family:'DejaVu Sans Mono';src:url('https://cdn.jsdelivr.net/npm/dejavu-fonts-ttf@2.37/ttf/DejaVuSansMono.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap}
@font-face{font-family:'DejaVu Sans Mono';src:url('https://cdn.jsdelivr.net/npm/dejavu-fonts-ttf@2.37/ttf/DejaVuSansMono-Bold.ttf') format('truetype');font-weight:700;font-style:normal;font-display:swap}

/* ── Reset & Base ─────────────────────────────────────────────── */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  /* Apple System Colors — Light Mode (iOS 26 / macOS 26) */
  --bg:        #FFFFFF;
  --bg2:       rgba(0,0,0,0.03);
  --bg3:       rgba(0,0,0,0.06);
  --bg4:       rgba(0,0,0,0.10);
  --fg:        #1D1D1F;
  --fg2:       #6E6E73;
  --fg3:       #AEAEB2;
  --accent:    #007AFF;
  --accent2:   #0055D4;
  --green:     #34C759;
  --cyan:      #32ADE6;
  --red:       #FF3B30;
  --yellow:    #FFCC00;
  --magenta:   #AF52DE;
  --orange:    #FF9500;
  --radius:    14px;

  /* Glass shadows — light mode */
  --glass-shadow:       0 2px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
  --glass-shadow-lg:    0 8px 32px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
  --glass-shadow-inset: inset 0 1px 3px rgba(0,0,0,0.06);
  --glass-shadow-flat:  0 1px 2px rgba(0,0,0,0.04);
  --glass-shadow-subtle:0 1px 6px rgba(0,0,0,0.05);

  /* Border tokens — light mode */
  --glass-border:       1px solid rgba(0,0,0,0.08);
  --glass-border-light: 1px solid rgba(0,0,0,0.05);
  --glass-border-hover: 1px solid rgba(0,0,0,0.15);
  --glass-border-inset: 1px solid rgba(0,0,0,0.06);

  --font: -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",sans-serif;
  --mono: "SF Mono","Fira Code","JetBrains Mono","DejaVu Sans Mono",Menlo,monospace;
  --sidebar-w: 220px;
}

html,body{
  background:linear-gradient(160deg, #F5F5F7 0%, #EEF0F5 30%, #E8EBF2 55%, #F0F1F6 80%, #F5F5F7 100%);
  color:var(--fg);
  font:14px/1.6 var(--font);
  height:100%;
  overflow:hidden;
}
a{color:var(--accent);text-decoration:none}

/* ── App Layout: sidebar + content ────────────────────────────── */
.app{display:flex;height:100vh;position:relative}

/* Animated mesh / orb overlay */
.app::before{
  content:'';
  position:fixed;
  top:-50%;left:-50%;
  width:200%;height:200%;
  background:
    radial-gradient(ellipse at 25% 40%, rgba(0,122,255,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 75% 25%, rgba(175,82,222,0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 75%, rgba(52,199,89,0.03) 0%, transparent 50%);
  animation:meshDrift 20s ease-in-out infinite alternate;
  pointer-events:none;
  z-index:0;
}
@keyframes meshDrift{
  0%{transform:translate(0,0) rotate(0deg)}
  100%{transform:translate(2%,1%) rotate(1deg)}
}

/* ── Sidebar ──────────────────────────────────────────────────── */
.sidebar{
  width:var(--sidebar-w);
  min-width:var(--sidebar-w);
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(24px) saturate(180%);
  -webkit-backdrop-filter:blur(24px) saturate(180%);
  border-right:1px solid rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  z-index:2;
  position:relative;
}
.sidebar-logo{
  padding:16px 18px;
  font-size:16px;
  font-weight:700;
  letter-spacing:-.3px;
  border-bottom:1px solid rgba(0,0,0,0.06);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.sidebar-logo span{color:var(--accent)}
/* ── Session Sidebar ── */
.session-section{border-bottom:1px solid rgba(0,0,0,0.06);padding:4px 0 6px;max-height:260px;display:flex;flex-direction:column}
.session-header{display:flex;align-items:center;justify-content:space-between;padding:4px 14px 4px}
.session-header-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--fg3)}
.session-new-btn{background:none;border:1px solid rgba(0,0,0,0.1);border-radius:6px;padding:3px 6px;cursor:pointer;color:var(--fg2);display:flex;align-items:center;transition:all .15s}
.session-new-btn:hover{background:rgba(0,122,255,0.08);border-color:var(--accent);color:var(--accent)}
.session-list{overflow-y:auto;flex:1;padding:0 6px}
.session-item{padding:7px 10px;border-radius:8px;cursor:pointer;font-size:12px;color:var(--fg2);display:flex;align-items:center;gap:6px;transition:background .15s;position:relative}
.session-item:hover{background:rgba(0,0,0,0.04)}
.session-item.active{background:rgba(0,122,255,0.08);color:var(--accent);font-weight:600}
.session-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.session-time{font-size:10px;color:var(--fg3);flex-shrink:0}
.session-actions{display:none;gap:4px;flex-shrink:0}
.session-item:hover .session-actions{display:flex}
.session-item:hover .session-time{display:none}
.session-action-btn{background:none;border:none;cursor:pointer;padding:2px;font-size:11px;color:var(--fg3);border-radius:4px}
.session-action-btn:hover{background:rgba(0,0,0,0.08);color:var(--fg)}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--fg3);display:inline-block}
.status-dot.online{background:var(--green);box-shadow:0 0 8px var(--green),0 0 16px rgba(52,199,89,0.25)}
.status-dot.offline{background:var(--red);box-shadow:0 0 8px var(--red),0 0 16px rgba(255,59,48,0.20)}

/* ── Heartbeat Dot (on agent cards) ──────────────────────────── */
.hb-dot{width:9px;height:9px;border-radius:50%;display:inline-block;background:var(--fg3);transition:.3s}
.hb-dot.online{background:var(--green);box-shadow:0 0 8px var(--green),0 0 16px rgba(52,199,89,0.25);animation:hbPulse 2s infinite}
.hb-dot.offline{background:var(--fg3)}
@keyframes hbPulse{0%,100%{opacity:1}50%{opacity:.5}}

/* ── API Key Badge ───────────────────────────────────────────── */
.key-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-size:10px;padding:2px 7px;border-radius:10px;
  font-family:var(--mono);
  background:rgba(255,255,255,0.60);
  border:1px solid rgba(0,0,0,0.05);
}
.key-badge.set{background:rgba(48,209,88,.10);color:var(--green);border-color:rgba(48,209,88,0.15)}
.key-badge.unset{background:rgba(255,69,58,.08);color:var(--red);border-color:rgba(255,59,48,0.10)}
.key-badge.shared{background:rgba(10,132,255,.08);color:var(--accent2);border-color:rgba(0,122,255,0.12)}

/* ── Channel cards ── */
.ch-card{
  position:relative;
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:var(--radius);
  padding:16px 18px;
  transition:border-color .2s, box-shadow .2s;
  display:flex;flex-direction:column;gap:10px;
  box-shadow:0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.8);
}
.ch-card:hover{
  border-color:rgba(0,0,0,0.12);
  box-shadow:0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.8), 0 0 20px color-mix(in srgb,var(--ch-brand,var(--accent)) 12%,transparent);
}
.ch-status-dot{position:absolute;top:12px;right:14px;width:8px;height:8px;border-radius:50%}
.ch-status-dot.running{background:var(--green);box-shadow:0 0 8px rgba(48,209,88,.5)}
.ch-status-dot.enabled{background:var(--yellow);box-shadow:0 0 6px rgba(255,214,10,.3)}
.ch-status-dot.disabled{background:var(--fg3);opacity:.5}
.ch-header{display:flex;align-items:center;gap:10px}
.ch-logo{width:32px;height:32px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.ch-logo svg{width:20px;height:20px}
.ch-title{font-size:14px;font-weight:700;color:var(--fg)}
.ch-meta{display:flex;flex-wrap:wrap;align-items:center;gap:6px;font-size:11px;color:var(--fg3)}
.ch-meta code{font-size:10px;color:var(--fg2)}
.ch-actions{display:flex;gap:6px;padding-top:8px;border-top:1px solid rgba(0,0,0,0.05);margin-top:auto}
.ch-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}

.nav-section{padding:12px 0 4px}
.nav-section-title{padding:0 18px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--fg3)}
.nav-section-title.clickable:hover{color:var(--fg2)}
.nav-caret{font-size:8px;margin-left:4px;transition:transform .15s}
.nav-caret.open{transform:rotate(90deg)}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:7px 18px;cursor:pointer;
  color:var(--fg2);font-size:13px;font-weight:500;
  transition:all .12s;
  border-left:3px solid transparent;
  border-radius:0;
}
.nav-item .icon{display:flex;align-items:center;justify-content:center;width:20px;height:16px;flex-shrink:0}
.nav-item .icon svg{width:16px;height:16px}
.nav-item:hover{
  color:var(--fg);
  background:rgba(0,0,0,0.04);
}
.nav-item.active{
  color:var(--accent);
  background:rgba(0,122,255,0.08);
  border-left-color:var(--accent);
  box-shadow:none;
  border-radius:0 10px 10px 0;
}

.sidebar-footer{
  margin-top:auto;padding:12px 18px;
  border-top:1px solid rgba(0,0,0,0.06);
  font-size:11px;color:var(--fg3);line-height:1.8;
}
.sidebar-footer code{font-family:var(--mono);background:rgba(255,255,255,0.75);padding:1px 5px;border-radius:3px;font-size:10px}

/* ── Main Content ─────────────────────────────────────────────── */
.content{flex:1;overflow-y:auto;padding:20px 28px;min-width:0;min-height:0;position:relative;z-index:1}
.panel{display:none}
.panel.active{display:block}

.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;min-height:36px}
.page-title{font-size:18px;font-weight:700;line-height:1.4}
.page-actions{display:flex;gap:8px;align-items:center}

/* ── Cards ────────────────────────────────────────────────────── */
.card{
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:12px;
  box-shadow:0 1px 4px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
  transition:border-color .2s, box-shadow .2s;
}
.card:hover{
  border-color:rgba(255,255,255,0.18);
}
.card-title{font-size:13px;font-weight:600;color:var(--fg2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.card-row{display:flex;gap:12px;flex-wrap:wrap}
.card-row>.card{flex:1;min-width:200px}

/* ── Stats Row ────────────────────────────────────────────────── */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.stat{
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:var(--radius);
  padding:12px 14px;
  text-align:center;
  box-shadow:0 1px 4px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
}
.stat-value{font-size:24px;font-weight:700;color:var(--fg);font-family:var(--mono)}
.stat-label{font-size:11px;color:var(--fg2);margin-top:2px}
.stat-value.green{color:var(--green)}
.stat-value.red{color:var(--red)}
.stat-value.cyan{color:var(--cyan)}

/* ── Buttons ──────────────────────────────────────────────────── */
.btn{
  background:var(--accent);
  color:#fff;
  border:1px solid transparent;
  padding:6px 16px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:all .15s;
  font-family:var(--font);
  line-height:1.4;
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  box-shadow:0 1px 3px rgba(0,0,0,0.08);
  white-space:nowrap;
}
.btn:hover{
  background:var(--accent2);
  box-shadow:0 2px 8px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,122,255,0.1);
}
.btn:active{box-shadow:inset 0 1px 3px rgba(0,0,0,0.15);transform:scale(0.98)}
.btn:disabled{opacity:.4;cursor:not-allowed;box-shadow:none;transform:none}
.btn-sm{padding:4px 12px;font-size:12px;border-radius:7px}
.btn-danger{background:var(--red)}
.btn-danger:hover{background:#FF3B30;box-shadow:0 2px 8px rgba(0,0,0,0.12), 0 0 8px rgba(255,59,48,0.1)}
.btn-outline{
  background:rgba(255,255,255,0.80);
  color:var(--fg2);
  border:1px solid rgba(0,0,0,0.10);
  box-shadow:0 1px 3px rgba(0,0,0,0.06);
}
.btn-outline:hover{
  color:var(--fg);
  background:rgba(255,255,255,0.90);
  border-color:rgba(0,0,0,0.15);
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
.btn-green{background:var(--green)}
.btn-green:hover{background:#2DB84D;box-shadow:0 2px 8px rgba(0,0,0,0.12), 0 0 8px rgba(52,199,89,0.15)}

/* ── Inputs ───────────────────────────────────────────────────── */
.input{
  background:rgba(0,0,0,0.03);
  border:1px solid rgba(0,0,0,0.10);
  color:var(--fg);
  padding:6px 12px;
  border-radius:8px;
  font-size:13px;
  font-family:var(--font);
  line-height:1.4;
  outline:none;
  width:100%;
  box-shadow:inset 0 1px 2px rgba(0,0,0,0.04);
  transition:border-color .15s, box-shadow .15s;
}
.input:focus{
  border-color:rgba(0,122,255,0.5);
  box-shadow:0 0 0 3px rgba(0,122,255,0.12);
}
.input::placeholder{color:var(--fg3)}
select.input{cursor:pointer}
textarea.input{resize:vertical;min-height:80px;line-height:1.5}
textarea.mono{font-family:var(--mono);font-size:12px;line-height:1.6}

/* ── Task Table ───────────────────────────────────────────────── */
.task-table{width:100%;border-collapse:collapse}
.task-table th{text-align:left;font-size:11px;font-weight:600;color:var(--fg3);text-transform:uppercase;padding:6px 8px;border-bottom:1px solid rgba(0,0,0,0.06)}
.task-table td{padding:7px 8px;border-bottom:1px solid rgba(0,0,0,0.05);font-size:13px;vertical-align:middle}
.task-table tr:last-child td{border-bottom:none}
.task-table tbody tr{cursor:pointer;transition:.1s}
.task-table tbody tr:hover{background:rgba(255,255,255,0.60)}
.data-table{width:100%;border-collapse:collapse;table-layout:fixed}
.data-table th{text-align:left;font-size:11px;font-weight:600;color:var(--fg3);text-transform:uppercase;padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.06)}
.data-table td{padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.05);font-size:13px;vertical-align:middle}
.data-table tr:last-child td{border-bottom:none}
.data-table tbody tr:hover{background:rgba(255,255,255,0.60);transition:.1s}
.status-icon{font-size:14px;width:20px;display:inline-block;text-align:center}
.status-working{color:var(--cyan)}
.status-done{color:var(--green)}
.status-failed{color:var(--red)}
.status-pending{color:var(--fg3)}
.status-review{color:var(--magenta)}
.status-critique{color:var(--yellow)}
.task-desc{max-width:340px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.task-time{font-family:var(--mono);font-size:12px;color:var(--fg2)}
.task-agent{font-weight:500}
.task-error{color:var(--red);font-size:11px;opacity:.85}

/* ── Task Detail ──────────────────────────────────────────────── */
.task-detail{
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(0,0,0,0.05);
  padding:12px 14px;
  font-size:12px;
  border-radius:0 0 12px 12px;
  animation:slideDown .15s ease;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);
}
.task-detail pre{
  background:rgba(0,0,0,0.05);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(0,0,0,0.04);
  padding:8px 10px;
  border-radius:8px;
  font-family:var(--mono);
  font-size:11px;
  line-height:1.5;
  overflow-x:auto;
  white-space:pre-wrap;
  max-height:200px;
  overflow-y:auto;
  margin:6px 0;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);
}
.task-detail-row{display:flex;gap:8px;margin:4px 0;align-items:flex-start}
.task-detail-label{font-weight:600;min-width:90px;color:var(--fg2)}
.error-badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(255,69,58,.12);color:var(--red)}
.score-badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600}
@keyframes slideDown{from{opacity:0;max-height:0}to{opacity:1;max-height:500px}}

/* ── Submit Box ───────────────────────────────────────────────── */
.submit-box{display:flex;gap:8px;margin-top:12px}
.submit-box input{flex:1}
.submit-msg{font-size:12px;color:var(--fg2);margin-top:6px}

/* ── Summary Bar ──────────────────────────────────────────────── */
.summary-bar{font-size:12px;color:var(--fg2);padding:8px 0;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.summary-bar .dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:3px;vertical-align:middle}

/* ── Agent Cards ──────────────────────────────────────────────── */
.agent-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.agent-card{
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:var(--radius);
  padding:14px 16px;
  transition:border-color .2s, box-shadow .2s;
  cursor:pointer;
  display:flex;flex-direction:column;gap:6px;
  box-shadow:0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.7);
}
.agent-card:hover{
  border-color:rgba(0,0,0,0.12);
  box-shadow:0 8px 24px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.8), 0 0 24px rgba(0,122,255,0.06);
}
.agent-card.editing{
  border-color:rgba(10,132,255,0.25);
  box-shadow:0 8px 24px rgba(0,0,0,0.3), 0 0 24px rgba(0,122,255,0.10);
  border-bottom-left-radius:0;
  border-bottom-right-radius:0;
}
.agent-card-header{display:flex;align-items:center;gap:6px}
.agent-name{font-size:15px;font-weight:700}
.agent-working{font-size:10px;color:var(--cyan);font-weight:400;background:rgba(100,210,255,.1);padding:1px 6px;border-radius:4px}
.agent-card-model{font-family:var(--mono);font-size:12px;color:var(--accent2)}
.agent-provider{color:var(--fg3);font-size:11px}
.agent-card-skills{display:flex;flex-wrap:wrap;gap:4px}
.skill-tag{
  display:inline-block;
  background:rgba(255,255,255,0.60);
  border:1px solid rgba(0,0,0,0.05);
  color:var(--fg2);
  padding:2px 8px;
  border-radius:6px;
  font-size:11px;
}
.agent-card-chain{font-size:11px;color:var(--fg2);display:flex;flex-direction:column;gap:3px}
.agent-card-chain-row{display:flex;align-items:center;gap:6px}
.agent-card-chain a{font-family:var(--mono);color:var(--accent2);text-decoration:none;font-size:11px}
.sparkline-wrap{height:28px;width:100%;margin-top:2px}
.sparkline-wrap svg{width:100%;height:100%}
.key-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.key-dot.set{background:var(--green)}
.key-dot.unset{background:var(--red)}
.agent-score{display:flex;align-items:center;gap:8px;padding-top:6px;border-top:1px solid rgba(0,0,0,0.05)}
.score-bar{
  flex:1;height:6px;
  background:rgba(0,0,0,0.05);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:3px;
  overflow:hidden;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
}
.score-fill{height:100%;border-radius:3px;transition:width .5s}
.score-num{font-family:var(--mono);font-size:14px;font-weight:700;min-width:36px;text-align:right}

/* ── Agent Editor (popup modal) ───────────────────────────────── */
.agent-modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  z-index:1000;
  display:flex;align-items:center;justify-content:center;
  animation:fadeIn .18s ease;
}
.agent-modal{
  background:rgba(255,255,255,0.78);
  backdrop-filter:blur(40px) saturate(200%);
  -webkit-backdrop-filter:blur(40px) saturate(200%);
  border:1px solid rgba(0,0,0,0.10);
  border-radius:16px;
  padding:24px;
  width:min(600px,90vw);
  max-height:85vh;
  overflow-y:auto;
  animation:scaleIn .2s ease;
  box-shadow:0 8px 32px rgba(0,0,0,0.4), 0 24px 64px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.12);
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes scaleIn{from{transform:scale(.95) translateY(10px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.agent-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.agent-modal-title{font-size:16px;font-weight:700;color:var(--fg);display:flex;align-items:center;gap:6px}
.agent-modal-close{
  background:rgba(0,0,0,0.05);
  border:1px solid rgba(0,0,0,0.06);
  color:var(--fg3);
  font-size:16px;
  cursor:pointer;
  width:32px;height:32px;
  display:inline-flex;align-items:center;justify-content:center;
  border-radius:8px;
  transition:all .15s;
  padding:0;
  line-height:1;
}
.agent-modal-close:hover{background:rgba(0,0,0,0.08);color:var(--fg)}

/* ── Modal tabs ── */
.modal-tabs{
  display:flex;gap:0;margin-bottom:16px;
  border-bottom:1px solid rgba(0,0,0,0.06);
}
.modal-tab{
  padding:8px 16px;font-size:12px;font-weight:600;
  color:var(--fg3);background:none;border:none;cursor:pointer;
  border-bottom:2px solid transparent;
  transition:all .15s;
  line-height:1.4;
}
.modal-tab:hover{color:var(--fg2);background:rgba(0,0,0,0.03)}
.modal-tab.active{
  color:var(--accent);
  border-bottom-color:var(--accent);
  background:rgba(0,122,255,0.04);
}
.modal-tab-content{display:none}
.modal-tab-content.active{display:block}
.tab-badge{
  display:inline-block;font-size:10px;font-weight:600;
  background:var(--accent);color:#fff;border-radius:8px;
  padding:1px 6px;margin-left:4px;min-width:16px;text-align:center;
  font-family:var(--mono);vertical-align:middle;line-height:1.4;
}
.tab-badge-secondary{background:var(--bg4);color:var(--fg2)}

/* ── Overview tab ── */
.overview-section{margin-bottom:14px}
.overview-card{
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(16px) saturate(180%);
  -webkit-backdrop-filter:blur(16px) saturate(180%);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:12px;
  padding:12px 14px;
  margin-bottom:10px;
  transition:border-color .2s, box-shadow .2s;
  box-shadow:0 2px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.6);
}
.overview-card:hover{
  border-color:rgba(255,255,255,0.18);
  box-shadow:0 4px 16px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.7), 0 0 16px color-mix(in srgb,var(--accent,#38bdf8) 8%,transparent);
}
.overview-label{font-size:10px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.overview-card .overview-label{margin-bottom:8px}
.rep-big{
  font-size:28px;font-weight:800;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--accent,#38bdf8),var(--green));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  line-height:1;
}
.rep-sub{font-size:11px;color:var(--fg3);margin-top:2px}
.rep-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:10px}
.trend-chart{
  position:relative;height:100px;margin-top:8px;
  border-radius:10px;overflow:hidden;
  background:rgba(0,0,0,0.04);
  border:1px solid rgba(255,255,255,0.04);
}
.trend-chart svg{width:100%;height:100%}
.trend-chart .axis-label{font-size:9px;fill:var(--fg3);font-family:var(--mono)}
.trend-chart .grid-line{stroke:rgba(255,255,255,0.06);stroke-dasharray:3,3}
.trend-dot{r:3;fill:var(--accent,#38bdf8);stroke:var(--bg);stroke-width:1.5;cursor:pointer;transition:r .15s}
.trend-dot:hover{r:5}
.trend-tooltip{
  position:absolute;
  background:rgba(255,255,255,0.82);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border:1px solid rgba(0,0,0,0.08);
  color:var(--fg);font-size:10px;padding:4px 8px;
  border-radius:8px;pointer-events:none;white-space:nowrap;
  opacity:0;transition:opacity .15s;z-index:10;
  font-family:var(--mono);
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.config-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 14px;font-size:12px}
.config-grid .cfg-key{color:var(--fg3);font-size:10px;text-transform:uppercase;font-weight:600}
.config-grid .cfg-val{color:var(--fg);word-break:break-all}
.overview-value{font-size:13px;color:var(--fg);line-height:1.5}
.overview-role{font-size:12px;color:var(--fg2);line-height:1.6;white-space:pre-wrap;max-height:80px;overflow-y:auto}
.overview-task{
  background:rgba(255,255,255,0.75);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:8px;
  padding:8px 10px;
  font-size:12px;
  color:var(--fg);
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);
}
.overview-task-id{font-family:var(--mono);color:var(--accent);font-size:11px}
.overview-logs{list-style:none;padding:0;margin:0}
.overview-logs li{
  font-size:11px;color:var(--fg3);font-family:var(--mono);
  padding:2px 0;
  border-bottom:1px solid rgba(0,0,0,0.04);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.overview-score-row{display:flex;align-items:center;gap:6px;margin:3px 0;font-size:11px;color:var(--fg2)}
.overview-score-label{min-width:76px}
.overview-score-bar{
  flex:1;height:4px;
  background:rgba(0,0,0,0.05);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:2px;
  overflow:hidden;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
}
.overview-score-fill{height:100%;border-radius:2px;transition:width .3s}
.overview-score-num{min-width:28px;text-align:right;font-family:var(--mono)}
.rep-top{display:flex;align-items:center;justify-content:space-between;padding:0 10px}
.rep-left{flex:0 0 auto;display:flex;flex-direction:column;align-items:flex-start;gap:5px}
.radar-wrap{flex:0 0 auto;display:flex;justify-content:center;align-items:center;overflow:visible}
.radar-wrap svg{overflow:visible}
.dim-badges{display:flex;flex-direction:column;gap:2px;margin-top:4px}
.dim-badge{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:600}
.dim-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.agent-editor .field{margin-bottom:12px}
.agent-editor .field label{display:block;font-size:11px;font-weight:600;color:var(--fg2);text-transform:uppercase;margin-bottom:4px}
.agent-editor .field-row{display:flex;gap:12px}
.agent-editor .field-row>.field{flex:1}
.agent-editor .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid rgba(0,0,0,0.05)}
.skills-collapse{
  background:rgba(255,255,255,0.60);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:10px;
  overflow:hidden;
  transition:border-color .2s, box-shadow .2s;
}
.skills-collapse:hover{
  border-color:rgba(0,0,0,0.08);
  box-shadow:0 2px 12px rgba(0,0,0,0.15), 0 0 12px rgba(0,122,255,0.05);
}
.skills-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;cursor:pointer;user-select:none;
  background:rgba(255,255,255,0.60);
  transition:background .2s;
}
.skills-header:hover{background:rgba(255,255,255,0.75)}
.skills-header .skills-summary{font-size:12px;color:var(--fg2);display:flex;align-items:center;gap:6px}
.skills-header .skills-count{background:var(--accent,#38bdf8);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;min-width:20px;text-align:center}
.skills-header .skills-chevron{font-size:14px;color:var(--fg3);transition:transform .3s ease}
.skills-header.open .skills-chevron{transform:rotate(180deg)}
.skills-body{max-height:0;overflow:hidden;transition:max-height .35s cubic-bezier(.4,0,.2,1),opacity .25s ease;opacity:0;padding:0 12px}
.skills-body.open{opacity:1;padding:8px 12px}
.skills-search{
  width:100%;padding:5px 8px;font-size:12px;
  background:rgba(0,0,0,0.04);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:8px;
  color:var(--fg);
  margin-bottom:8px;
  outline:none;
  transition:border-color .2s, box-shadow .2s;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);
}
.skills-search:focus{
  border-color:rgba(10,132,255,0.4);
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 2px rgba(0,122,255,0.15);
}
.skills-grid{display:flex;flex-wrap:wrap;gap:5px}
.skills-grid label{font-size:11px;color:var(--fg2);display:flex;align-items:center;gap:3px;cursor:pointer;padding:2px 6px;border-radius:6px;transition:background .15s,opacity .2s}
.skills-grid label:hover{background:rgba(255,255,255,0.75)}
.skills-grid label.hidden{display:none}
.model-dropdown{
  position:absolute;top:100%;left:0;right:60px;
  background:rgba(255,255,255,0.78);
  backdrop-filter:blur(40px) saturate(200%);
  -webkit-backdrop-filter:blur(40px) saturate(200%);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:10px;
  z-index:100;
  max-height:200px;
  overflow-y:auto;
  margin-top:4px;
  box-shadow:0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.8);
}
.model-dropdown .model-option{
  padding:8px 12px;font-size:13px;color:var(--fg);cursor:pointer;
  border-bottom:1px solid rgba(0,0,0,0.05);
  transition:background .1s;
}
.model-dropdown .model-option:last-child{border-bottom:none}
.model-dropdown .model-option:hover{background:rgba(255,255,255,0.75)}
.model-dropdown .model-option.selected{background:rgba(10,132,255,.1);color:var(--accent)}
.btn-create-agent{
  background:var(--accent);color:#fff;border:1px solid transparent;border-radius:8px;
  padding:6px 16px;font-size:13px;font-weight:600;cursor:pointer;line-height:1.4;
  display:inline-flex;align-items:center;gap:4px;
  transition:all .15s;
  box-shadow:0 1px 3px rgba(0,0,0,0.08);
}
.btn-create-agent:hover{background:var(--accent2);box-shadow:0 2px 8px rgba(0,0,0,0.12)}
.btn-delete-agent{
  background:none;color:var(--red);border-radius:7px;
  padding:4px 12px;font-size:12px;cursor:pointer;line-height:1.4;
  transition:all .15s;
  border:1px solid rgba(255,59,48,0.20);
}
.btn-delete-agent:hover{background:var(--red);color:#fff;box-shadow:0 2px 8px rgba(255,59,48,0.15)}

/* ── Skills Layout ────────────────────────────────────────────── */
.skills-layout{display:flex;gap:16px;height:calc(100vh - 120px)}
.skills-list{
  width:260px;min-width:260px;
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:var(--radius);
  display:flex;flex-direction:column;overflow:hidden;
  box-shadow:0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.7);
}
.skills-list-header{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,0.06)}
.skills-list-body{overflow-y:auto;flex:1}
.skill-group-title{padding:8px 12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--fg3);letter-spacing:.5px}
.skill-item{
  padding:7px 12px;cursor:pointer;font-size:13px;color:var(--fg2);
  transition:.1s;border-left:3px solid transparent;
  display:flex;align-items:center;justify-content:space-between;
}
.skill-item:hover{background:rgba(255,255,255,0.72);color:var(--fg)}
.skill-item.active{background:rgba(10,132,255,.06);color:var(--accent2);border-left-color:var(--accent)}
.skill-item .skill-scope{font-size:10px;padding:1px 5px;border-radius:3px;background:rgba(255,255,255,0.82);color:var(--fg3)}

.skills-editor{flex:1;display:flex;flex-direction:column;min-width:0}
.skills-toolbar{display:flex;align-items:center;gap:8px;padding:10px 0;flex-wrap:wrap}
.skills-toolbar .skill-filename{font-family:var(--mono);font-size:13px;color:var(--fg2)}
.skills-editor textarea{
  flex:1;
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:var(--radius);
  color:var(--fg);
  font-family:var(--mono);font-size:12px;line-height:1.6;
  padding:14px;resize:none;outline:none;
  min-height:300px;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);
  transition:border-color .15s, box-shadow .15s;
}
.skills-editor textarea:focus{
  border-color:rgba(10,132,255,0.3);
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 2px rgba(0,122,255,0.12);
}
.skills-empty{display:flex;align-items:center;justify-content:center;flex:1;color:var(--fg3);font-size:14px}
.skill-assign-bar{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.05);flex-wrap:wrap}
.skill-assign-label{font-size:11px;font-weight:600;color:var(--fg2);text-transform:uppercase;flex-shrink:0}
.skill-assign-cb{display:flex;align-items:center;gap:3px;font-size:12px;color:var(--fg2);cursor:pointer}
.skill-assign-cb span{user-select:none}

/* ── Health Checks ────────────────────────────────────────────── */
.checks{list-style:none}
.checks li{padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.05);font-size:13px;display:flex;align-items:center;gap:8px}
.checks li:last-child{border-bottom:none}
.check-icon{font-size:14px;width:16px}
.check-label{font-weight:600;min-width:100px}
.check-detail{color:var(--fg2);font-size:12px}

/* ── Config View ──────────────────────────────────────────────── */
.config-pre{
  background:rgba(0,0,0,0.05);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:12px;
  padding:14px;
  font-family:var(--mono);font-size:12px;line-height:1.7;
  overflow-x:auto;color:var(--fg2);
  white-space:pre-wrap;
  max-height:400px;overflow-y:auto;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);
}

/* ── Gateway Panel ────────────────────────────────────────────── */
.token-display{display:flex;align-items:center;gap:8px;margin:8px 0}
.token-display code{
  flex:1;font-family:var(--mono);font-size:12px;
  background:rgba(0,0,0,0.04);
  border:1px solid rgba(0,0,0,0.05);
  padding:8px 12px;border-radius:8px;
  word-break:break-all;user-select:all;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2);
}
.info-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:12px}
.info-item{
  padding:10px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
}
.info-item .info-label{font-size:11px;color:var(--fg3);text-transform:uppercase;margin-bottom:2px}
.info-item .info-value{font-family:var(--mono);font-size:14px;font-weight:600}

/* ── Logs Panel ───────────────────────────────────────────────── */
.logs-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.logs-controls select{width:160px}
.logs-controls .input{height:auto}
.log-levels{display:flex;gap:2px;align-items:center}
.log-level-btn{
  padding:6px 12px;border-radius:7px;font-size:12px;font-weight:600;
  line-height:1.4;cursor:pointer;
  background:rgba(255,255,255,0.80);
  color:var(--fg2);
  border:1px solid rgba(0,0,0,0.08);
  transition:all .12s;
  display:inline-flex;align-items:center;
}
.log-level-btn:hover{
  background:rgba(255,255,255,0.90);
  border-color:rgba(0,0,0,0.12);
}
.log-level-btn.active{
  background:var(--accent);
  color:#fff;
  border-color:transparent;
  box-shadow:0 1px 4px rgba(0,122,255,0.15);
}
.log-content{
  background:rgba(0,0,0,0.04);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:var(--radius);
  padding:12px;
  font-family:var(--mono);font-size:11px;line-height:1.6;
  overflow:auto;
  max-height:calc(100vh - 220px);
  white-space:pre-wrap;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.2), 0 4px 16px rgba(0,0,0,0.15);
}
.log-line-error{color:var(--red)}
.log-line-warn{color:var(--yellow)}
.log-line-info{color:var(--fg2)}
.auto-refresh-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fg2);cursor:pointer}
.auto-refresh-toggle input{accent-color:var(--accent)}

/* ── Usage Table ──────────────────────────────────────────────── */
.usage-table{width:100%;border-collapse:collapse;font-size:13px}
.usage-table th{text-align:left;font-size:11px;font-weight:600;color:var(--fg3);text-transform:uppercase;padding:6px 10px;border-bottom:1px solid rgba(0,0,0,0.06)}
.usage-table td{padding:6px 10px;border-bottom:1px solid rgba(0,0,0,0.05)}
.usage-table td.mono{font-family:var(--mono)}
.usage-table tr:hover{background:rgba(255,255,255,0.60)}

/* ── Empty State ──────────────────────────────────────────────── */
.empty{text-align:center;color:var(--fg3);padding:30px 0;font-size:13px}

/* ── Knowledge Base Notes ─────────────────────────────────────── */
.kb-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.kb-note{
  background:rgba(255,255,255,0.55);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:14px;padding:16px 18px;
  transition:all .2s ease;position:relative;overflow:hidden;
}
.kb-note:hover{
  border-color:rgba(0,0,0,0.10);
  box-shadow:0 4px 16px rgba(0,0,0,0.06);
  transform:translateY(-1px);
}
.kb-note-head{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px}
.kb-note-icon{
  width:32px;height:32px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:15px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),#7c3aed);
  color:#fff;
}
.kb-note-title{font-size:14px;font-weight:600;color:var(--fg1);line-height:1.35;flex:1}
.kb-note-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
.kb-tag{
  padding:2px 8px;border-radius:6px;font-size:10px;font-weight:500;
  letter-spacing:.3px;
}
.kb-tag-blue{background:rgba(59,130,246,0.12);color:#3b82f6}
.kb-tag-purple{background:rgba(139,92,246,0.12);color:#8b5cf6}
.kb-tag-green{background:rgba(34,197,94,0.12);color:#16a34a}
.kb-tag-orange{background:rgba(249,115,22,0.12);color:#ea580c}
.kb-tag-pink{background:rgba(236,72,153,0.12);color:#db2777}
.kb-tag-cyan{background:rgba(6,182,212,0.12);color:#0891b2}
.kb-note-body{
  font-size:12.5px;line-height:1.65;color:var(--fg2);
  max-height:200px;overflow-y:auto;position:relative;
  scrollbar-width:thin;scrollbar-color:var(--bg4) transparent;
}
.kb-note-body::-webkit-scrollbar{width:5px}
.kb-note-body::-webkit-scrollbar-track{background:transparent}
.kb-note-body::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
.kb-note-body h3{font-size:13px;font-weight:600;color:var(--fg1);margin:10px 0 4px}
.kb-note-body h4{font-size:12px;font-weight:600;color:var(--fg2);margin:8px 0 3px}
.kb-note-body pre{
  background:var(--bg3);border-radius:8px;padding:10px 12px;
  font-size:11px;font-family:var(--mono);overflow-x:auto;
  margin:6px 0;line-height:1.5;
}
.kb-note-body code{
  background:var(--bg3);padding:1px 5px;border-radius:4px;
  font-size:11px;font-family:var(--mono);
}
.kb-note-body ul,.kb-note-body ol{margin:4px 0;padding-left:18px}
.kb-note-body li{margin:2px 0}
.kb-note-body p{margin:4px 0}
.kb-note-body strong{color:var(--fg1)}
.kb-note-body hr{border:none;border-top:1px solid var(--bg4);margin:10px 0}
.kb-note-footer{
  display:flex;justify-content:space-between;align-items:center;
  margin-top:10px;padding-top:8px;border-top:1px solid rgba(0,0,0,0.05);
  font-size:10px;color:var(--fg3);
}
.kb-note-footer .contributor{color:var(--accent);font-weight:500}
.kb-density{
  padding:1px 6px;border-radius:4px;font-size:9px;
  font-weight:600;letter-spacing:.3px;text-transform:uppercase;
}
.kb-density-high{background:rgba(239,68,68,0.10);color:#ef4444}
.kb-density-normal{background:rgba(59,130,246,0.10);color:#3b82f6}
.kb-density-low{background:rgba(34,197,94,0.10);color:#22c55e}

/* ── Daily Log Content ─────────────────────────────────────────── */
.daily-log-content{font-size:13px;line-height:1.7;color:var(--fg2);max-height:500px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--bg4) transparent}
.daily-log-content::-webkit-scrollbar{width:5px}
.daily-log-content::-webkit-scrollbar-track{background:transparent}
.daily-log-content::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
.daily-log-content h3{font-size:14px;font-weight:600;color:var(--fg1);margin:12px 0 4px}
.daily-log-content h4{font-size:12.5px;font-weight:600;color:var(--fg2);margin:8px 0 3px}
.daily-log-content p{margin:4px 0}
.daily-log-content strong{color:var(--fg1)}
.daily-log-content hr{border:none;border-top:1px solid var(--bg4);margin:10px 0}
.daily-log-content pre{background:var(--bg3);border-radius:8px;padding:10px 12px;font-size:11px;font-family:var(--mono);overflow-x:auto;margin:6px 0;line-height:1.5}
.daily-log-content code{background:var(--bg3);padding:1px 5px;border-radius:4px;font-size:11px;font-family:var(--mono)}
.daily-log-content ul,.daily-log-content ol{margin:4px 0;padding-left:18px}
.daily-log-content li{margin:2px 0}

/* Dark mode overrides */
[data-theme="dark"] .kb-note{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.06)}
[data-theme="dark"] .kb-note:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 4px 16px rgba(0,0,0,0.3)}
[data-theme="dark"] .kb-note-body pre{background:rgba(0,0,0,0.3)}
[data-theme="dark"] .kb-note-body code{background:rgba(0,0,0,0.25)}
[data-theme="dark"] .kb-note-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15)}
[data-theme="dark"] .daily-log-content pre{background:rgba(0,0,0,0.3)}
[data-theme="dark"] .daily-log-content code{background:rgba(0,0,0,0.25)}
[data-theme="dark"] .daily-log-content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15)}

/* ── Toast ────────────────────────────────────────────────────── */
.toast{
  position:fixed;bottom:24px;right:24px;
  padding:10px 18px;border-radius:12px;
  font-size:13px;font-weight:500;color:#fff;
  z-index:999;
  animation:toastIn .25s ease;
  pointer-events:none;
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.10);
  box-shadow:0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.12);
}
.toast.success{background:rgba(48,209,88,0.85);box-shadow:0 8px 32px rgba(0,0,0,0.3), 0 0 20px rgba(52,199,89,0.25), inset 0 1px 0 rgba(255,255,255,0.15)}
.toast.error{background:rgba(255,69,58,0.85);box-shadow:0 8px 32px rgba(0,0,0,0.3), 0 0 20px rgba(255,59,48,0.20), inset 0 1px 0 rgba(255,255,255,0.15)}
.toast.info{background:rgba(10,132,255,0.85);box-shadow:0 8px 32px rgba(0,0,0,0.3), 0 0 20px rgba(10,132,255,0.3), inset 0 1px 0 rgba(255,255,255,0.15)}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ── Dialog ───────────────────────────────────────────────────── */
.dialog-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  z-index:100;
  display:flex;align-items:center;justify-content:center;
}
.dialog{
  background:rgba(255,255,255,0.78);
  backdrop-filter:blur(40px) saturate(200%);
  -webkit-backdrop-filter:blur(40px) saturate(200%);
  border:1px solid rgba(0,0,0,0.10);
  border-radius:16px;
  padding:24px;
  min-width:360px;max-width:500px;
  box-shadow:0 8px 32px rgba(0,0,0,0.4), 0 24px 64px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.12);
}
.dialog-title{font-size:16px;font-weight:700;margin-bottom:14px}
.dialog .field{margin-bottom:12px}
.dialog .field label{display:block;font-size:11px;font-weight:600;color:var(--fg2);text-transform:uppercase;margin-bottom:4px}
.dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* ── Overview: Split Layout (top orchestration + bottom chat) ── */
#panel-overview.active{display:flex!important;flex-direction:column;height:calc(100vh - 44px);gap:0;position:relative}

/* ── Overview: Header Bar (statuses left, agents right) ────── */
.ov-header{
  display:flex;align-items:center;gap:8px;flex-shrink:0;
  padding:5px 8px;
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:var(--radius);
  margin-bottom:8px;
  min-height:36px;
  box-shadow:0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.7);
}
.ov-statuses{flex:1;display:flex;gap:4px;min-width:0;align-items:center;overflow:hidden}
.ov-status-item{
  display:flex;align-items:center;gap:5px;
  font-size:11px;color:var(--fg2);
  padding:4px 10px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:8px;
  overflow:hidden;max-width:260px;
  height:26px;box-sizing:border-box;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.15);
}
.ov-status-item .status-icon{font-size:11px;flex-shrink:0;width:14px;height:14px;display:flex;align-items:center;justify-content:center}
.ov-status-item .status-icon img{width:14px;height:14px;border-radius:50%;object-fit:cover}
.ov-status-item .status-agent{font-weight:600;flex-shrink:0;font-size:11px;text-transform:capitalize}
.ov-status-item .status-agent.leo-d{color:var(--accent)}
.ov-status-item .status-agent.jerry-d{color:var(--cyan)}
.ov-status-item .status-agent.alic-d{color:var(--magenta)}
.ov-status-item .status-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.ov-status-empty{font-size:11px;color:var(--fg3);padding:0 8px}
.ov-header-sep{width:1px;height:20px;background:rgba(255,255,255,0.82);flex-shrink:0}
.ov-agents{display:flex;gap:4px;flex-shrink:0;align-items:center}
.ov-agent-chip{
  display:flex;align-items:center;gap:5px;
  padding:3px 10px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:8px;height:26px;box-sizing:border-box;
  transition:.3s;
}
.ov-agent-chip.active{
  border-color:rgba(0,122,255,0.15);
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.15), 0 0 12px rgba(10,132,255,0.1);
  background:rgba(10,132,255,.06);
}
.ov-agent-chip.active.jerry{
  border-color:rgba(50,173,230,0.15);
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.15), 0 0 12px rgba(50,173,230,0.08);
  background:rgba(100,210,255,.06);
}
.ov-agent-chip.active.alic{
  border-color:rgba(175,82,222,0.15);
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.15), 0 0 12px rgba(175,82,222,0.08);
  background:rgba(191,90,242,.06);
}
.ov-agent-chip .chip-avatar{width:14px;height:14px;border-radius:50%;object-fit:cover;flex-shrink:0}
.ov-agent-chip .chip-name{font-size:11px;font-weight:600;color:var(--fg2);text-transform:capitalize}
.ov-agent-chip.active .chip-name{color:var(--fg)}
.ov-agent-chip .chip-dot{width:5px;height:5px;border-radius:50%;background:var(--fg3);flex-shrink:0}
.ov-agent-chip.active .chip-dot{background:var(--accent);animation:livePulse 1.2s infinite}
.ov-agent-chip.active.jerry .chip-dot{background:var(--cyan)}
.ov-agent-chip.active.alic .chip-dot{background:var(--magenta)}

/* ── Subtask Spec Cards ──────────────────────────────────── */
.subtask-card{
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:var(--radius);
  padding:10px 14px;
  margin:6px 0;
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
}
.subtask-header{display:flex;align-items:center;gap:8px}
.subtask-icon{font-size:14px;flex-shrink:0}
.subtask-objective{font-weight:600;flex:1;line-height:1.4}
.subtask-complexity{font-size:10px;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,0.75);color:var(--fg2);flex-shrink:0}
.subtask-meta{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.subtask-constraint,.subtask-tool{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.72);color:var(--fg2)}
.subtask-tool{color:var(--cyan)}
.subtask-output{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--accent);color:#0a0a1a}

/* ── Task Route Tree ──────────────────────────────────────── */
.subtask-tree{flex-shrink:0;padding:0;margin-bottom:8px;display:none}
.subtask-tree.has-tree{display:block}
/* Container block */
.tr-block{
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(16px) saturate(180%);
  -webkit-backdrop-filter:blur(16px) saturate(180%);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
}
/* Summary header */
.tr-summary{
  display:flex;align-items:center;gap:8px;
  padding:7px 12px;cursor:pointer;user-select:none;
  transition:background .15s;
  border-bottom:1px solid rgba(0,0,0,0.05);
}
.tr-summary:hover{background:rgba(255,255,255,0.72)}
.tr-chevron{font-size:10px;color:var(--fg3);transition:transform .2s;flex-shrink:0}
.tr-chevron.open{transform:rotate(90deg)}
.tr-summary-text{font-size:11px;font-weight:600;color:var(--fg2);flex:1;min-width:0}
.tr-stats{display:flex;gap:8px;flex-shrink:0;align-items:center}
.tr-stat{font-family:var(--mono);font-size:10px;display:flex;align-items:center;gap:3px}
.tr-stat .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.tr-stat .dot.done{background:var(--green)}
.tr-stat .dot.active{background:var(--cyan)}
.tr-stat .dot.wait{background:var(--fg3)}
/* Tree body -- CSS Grid for smooth collapse */
.tr-body{overflow:hidden;padding:4px 8px 6px;display:grid;grid-template-rows:1fr;opacity:1;transition:grid-template-rows .3s cubic-bezier(.4,0,.2,1),opacity .2s,padding .3s cubic-bezier(.4,0,.2,1)}
.tr-body>.tr-inner{overflow:hidden;min-height:0}
.tr-body.collapsed{grid-template-rows:0fr;opacity:0;padding-top:0;padding-bottom:0}
/* Single task row in tree */
.tr-row{display:flex;align-items:center;gap:5px;padding:3px 6px;font-size:10.5px;line-height:1.4;min-height:22px}
.tr-row:hover{background:rgba(255,255,255,0.60);border-radius:6px}
/* Connector lines */
.tr-connector{color:var(--fg4,var(--fg3));font-family:var(--mono);font-size:11px;flex-shrink:0;white-space:pre;opacity:.5;user-select:none}
/* Status dot */
.tr-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.tr-dot.pending{background:var(--fg3)}
.tr-dot.claimed{background:var(--yellow);animation:livePulse 1.2s infinite}
.tr-dot.review{background:var(--magenta)}
.tr-dot.completed{background:var(--green)}
.tr-dot.failed{background:var(--red)}
.tr-dot.critique{background:var(--yellow)}
/* Description */
.tr-desc{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--fg2);flex:1;min-width:0}
/* Agent badge */
.tr-agent{font-size:9px;font-weight:700;padding:1px 5px;border-radius:3px;flex-shrink:0;text-transform:capitalize;letter-spacing:.3px}
.tr-agent.leo{color:var(--accent);background:rgba(10,132,255,.1)}
.tr-agent.jerry{color:var(--cyan);background:rgba(100,210,255,.1)}
.tr-agent.alic{color:var(--magenta);background:rgba(191,90,242,.1)}
/* Source badge */
.tr-source{font-size:9px;color:var(--fg3);flex-shrink:0;font-family:var(--mono)}
/* Collapse toggle per-node */
.tr-toggle{cursor:pointer;font-size:9px;color:var(--fg3);user-select:none;flex-shrink:0;padding:0 2px}
.tr-toggle:hover{color:var(--fg)}

.ov-bottom{display:flex;flex-direction:column;flex:1;min-height:200px;overflow:hidden}

/* ── (Legacy ov-top/divider kept for non-overview panels) ──── */
.ov-top{display:none}
.ov-divider{display:none}
.workflow-viz{display:none}
.wf-pipeline{display:flex;align-items:center;justify-content:center;gap:0;padding:4px 0 10px}
.wf-node{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  min-width:90px;padding:10px 14px;border-radius:12px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.06);
  transition:.3s;
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
}
.wf-node.active{
  border-color:rgba(10,132,255,0.25);
  box-shadow:0 4px 16px rgba(0,0,0,0.2), 0 0 20px rgba(0,122,255,0.10), inset 0 1px 0 rgba(255,255,255,0.8);
}
.wf-node.active.jerry{
  border-color:rgba(100,210,255,0.25);
  box-shadow:0 4px 16px rgba(0,0,0,0.2), 0 0 20px rgba(50,173,230,0.10), inset 0 1px 0 rgba(255,255,255,0.8);
}
.wf-node.active.alic{
  border-color:rgba(191,90,242,0.25);
  box-shadow:0 4px 16px rgba(0,0,0,0.2), 0 0 20px rgba(175,82,222,0.10), inset 0 1px 0 rgba(255,255,255,0.8);
}
.wf-avatar{font-size:22px;line-height:1}
.wf-name{font-size:12px;font-weight:700;color:var(--fg)}
.wf-status{font-size:10px;color:var(--fg3);font-family:var(--mono);transition:.3s}
.wf-node.active .wf-status{color:var(--accent)}
.wf-node.active.jerry .wf-status{color:var(--cyan)}
.wf-node.active.alic .wf-status{color:var(--magenta)}
.wf-connector{display:flex;align-items:center;width:80px;height:2px;position:relative;margin:0 2px}
.wf-line{width:100%;height:2px;background:rgba(255,255,255,0.82);border-radius:1px;position:relative;overflow:visible}
.wf-connector.active .wf-line{background:linear-gradient(90deg,var(--accent),var(--cyan))}
.wf-arrow{position:absolute;right:-3px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--fg3)}
.wf-connector.active .wf-arrow{color:var(--accent)}
.wf-stats{text-align:center;font-size:11px;color:var(--fg2);font-family:var(--mono);padding-top:2px}

/* ── Dispatch Log (top panel, compact) ───────────────────────── */
.ov-dispatch{
  flex:1;overflow-y:auto;
  background:rgba(0,0,0,0.03);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(0,0,0,0.04);
  border-radius:0 0 var(--radius) var(--radius);
  padding:6px 10px;min-height:0;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.15);
}
.ov-dispatch::-webkit-scrollbar{width:4px}
.ov-dispatch::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.82);border-radius:2px}
.dispatch-entry{
  display:flex;align-items:center;gap:6px;
  padding:3px 0;font-size:11px;color:var(--fg2);
  border-bottom:1px solid rgba(0,0,0,0.04);
  animation:chatIn .15s ease;
}
.dispatch-entry:last-child{border-bottom:none}
.dispatch-icon{width:16px;text-align:center;font-size:12px;flex-shrink:0}
.dispatch-agent{font-weight:600;min-width:56px;flex-shrink:0}
.dispatch-agent.leo-d{color:var(--accent)}
.dispatch-agent.jerry-d{color:var(--cyan)}
.dispatch-agent.alic-d{color:var(--magenta)}
.dispatch-agent.user-d{color:var(--accent2)}
.dispatch-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dispatch-tokens{font-family:var(--mono);font-size:9px;color:var(--fg3);flex-shrink:0}
.dispatch-tokens .tok-in{color:var(--cyan)}
.dispatch-tokens .tok-out{color:var(--green)}
.dispatch-time{font-family:var(--mono);font-size:9px;color:var(--fg3);min-width:36px;text-align:right;flex-shrink:0}
.dispatch-live{display:inline-flex;align-items:center;gap:3px}
.dispatch-live-dot{width:5px;height:5px;border-radius:50%;animation:livePulse 1.2s infinite}
.dispatch-toggle{
  display:flex;align-items:center;justify-content:center;gap:4px;
  padding:4px 12px;cursor:pointer;font-size:11px;
  color:var(--fg3);
  background:rgba(255,255,255,0.70);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:0 0 8px 8px;
  margin:-1px auto 0;width:fit-content;
  transition:all .15s;
}
.dispatch-toggle:hover{color:var(--fg);background:rgba(255,255,255,0.85);border-color:rgba(0,0,0,0.08)}

/* ── Workflow: Data Packet Animation ─────────────────────────── */
.wf-packet{position:absolute;top:50%;transform:translate(-50%,-50%);width:10px;height:10px;border-radius:50%;opacity:0;pointer-events:none;filter:blur(0px);z-index:5}
.wf-packet.animating{animation:wfPacketMove 1s ease-in-out forwards}
.wf-packet.leo-packet{background:var(--accent);box-shadow:0 0 12px var(--accent),0 0 24px rgba(10,132,255,.3)}
.wf-packet.jerry-packet{background:var(--cyan);box-shadow:0 0 12px var(--cyan),0 0 24px rgba(100,210,255,.3)}
.wf-packet.alic-packet{background:var(--magenta);box-shadow:0 0 12px var(--magenta),0 0 24px rgba(191,90,242,.3)}
@keyframes wfPacketMove{0%{left:0;opacity:0;transform:translate(-50%,-50%) scale(.4)}10%{opacity:1;transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.2)}90%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{left:100%;opacity:0;transform:translate(-50%,-50%) scale(.4)}}

/* ── Workflow: Pulse ring on receiving node ───────────────────── */
.wf-node.receiving{animation:wfReceivePulse .6s ease}
@keyframes wfReceivePulse{0%{box-shadow:0 0 0 0 rgba(10,132,255,.4)}50%{box-shadow:0 0 0 14px rgba(10,132,255,0)}100%{box-shadow:none}}
.wf-node.receiving.jerry{animation-name:wfReceivePulseCyan}
@keyframes wfReceivePulseCyan{0%{box-shadow:0 0 0 0 rgba(100,210,255,.4)}50%{box-shadow:0 0 0 14px rgba(100,210,255,0)}100%{box-shadow:none}}
.wf-node.receiving.alic{animation-name:wfReceivePulsePurple}
@keyframes wfReceivePulsePurple{0%{box-shadow:0 0 0 0 rgba(191,90,242,.4)}50%{box-shadow:0 0 0 14px rgba(191,90,242,0)}100%{box-shadow:none}}

/* ── Overview: Chat Messages (bottom panel) ──────────────────── */
.chat-messages{
  flex:1;overflow-y:auto;
  padding:16px 12px;
  display:flex;flex-direction:column;gap:12px;
  min-height:0;
  background:rgba(245,245,247,0.3);
}
.chat-messages::-webkit-scrollbar{width:5px}
.chat-messages::-webkit-scrollbar-track{background:rgba(245,245,247,0.3)}
.chat-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.82);border-radius:3px}
.chat-welcome{
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  flex:1;gap:10px;
  color:var(--fg3);
  min-height:200px;
}
.chat-welcome-icon{font-size:42px;opacity:.4;filter:drop-shadow(0 0 12px rgba(0,122,255,0.12))}
.chat-welcome-text{font-size:20px;font-weight:700;color:var(--fg);text-shadow:0 0 24px rgba(10,132,255,0.1)}
.chat-welcome-sub{font-size:13px;max-width:320px;text-align:center;line-height:1.6}

.chat-msg{display:flex;gap:10px;max-width:88%;animation:chatIn .2s ease}
.chat-msg.user{align-self:flex-end;flex-direction:row-reverse;max-width:75%}
.chat-msg.system{align-self:center;max-width:90%}
.chat-msg.agent{align-self:flex-start}
.chat-msg.assistant{align-self:flex-start;max-width:100%}
@keyframes chatIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.chat-avatar{
  width:26px;height:26px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;flex-shrink:0;
  background:rgba(255,255,255,0.75);
  margin-top:2px;
}
.chat-avatar.leo{background:rgba(10,132,255,.10);box-shadow:0 0 10px rgba(10,132,255,.15)}
.chat-avatar.jerry{background:rgba(100,210,255,.10);box-shadow:0 0 10px rgba(100,210,255,.15)}
.chat-avatar.alic{background:rgba(191,90,242,.10);box-shadow:0 0 10px rgba(191,90,242,.15)}
.chat-avatar.user-av{background:rgba(10,132,255,.10);box-shadow:0 0 10px rgba(10,132,255,.15)}

.chat-bubble{
  padding:8px 12px;border-radius:12px;
  font-size:13px;line-height:1.55;word-break:break-word;
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(16px) saturate(180%);
  -webkit-backdrop-filter:blur(16px) saturate(180%);
  border:1px solid rgba(0,0,0,0.06);
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
}
.chat-bubble.user-bubble{
  background:rgba(255,255,255,0.82);
  border-color:rgba(0,0,0,0.08);
  color:var(--fg);
  border-bottom-right-radius:3px;
}
.chat-bubble.agent-bubble{
  background:rgba(255,255,255,0.72);
  border-color:rgba(0,0,0,0.06);
  border-bottom-left-radius:3px;
}
.chat-bubble.agent-bubble.leo-bubble{border-left:3px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6)}
.chat-bubble.agent-bubble.jerry-bubble{border-left:3px solid var(--cyan);box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6)}
.chat-bubble.agent-bubble.alic-bubble{border-left:3px solid var(--magenta);box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6)}
.chat-bubble.system-bubble{
  background:rgba(255,255,255,0.60);
  border-color:rgba(0,0,0,0.05);
  color:var(--fg2);font-size:12px;
  padding:5px 12px;border-radius:16px;
}
.chat-bubble.assistant-bubble{
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(20px) saturate(180%);
  -webkit-backdrop-filter:blur(20px) saturate(180%);
  border:1px solid rgba(0,0,0,0.08);
  border-radius:var(--radius);
  padding:14px 16px;font-size:14px;line-height:1.75;
  box-shadow:0 4px 16px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.7);
}
.chat-bubble.assistant-bubble .asst-header{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:12px;color:var(--fg3)}
.chat-bubble.assistant-bubble .asst-header .asst-label{font-weight:700;color:var(--fg);font-size:13px}
.asst-body-wrap{position:relative;overflow:hidden;transition:max-height .35s ease}
.asst-body-wrap.collapsed{max-height:260px}
.asst-body-wrap.collapsed::after{content:'';position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(transparent,rgba(255,255,255,0.06));pointer-events:none}
.msg-expand-btn{display:none;width:100%;padding:6px 0 2px;border:none;background:rgba(245,245,247,0.3);color:var(--accent);font-size:12px;font-weight:600;cursor:pointer;text-align:center;letter-spacing:.3px}
.msg-expand-btn:hover{text-decoration:underline}
.asst-body-wrap.collapsed+.msg-expand-btn,.asst-body-wrap.expandable+.msg-expand-btn{display:block}
.stream-body{max-width:100%;font-size:13px;color:var(--fg);line-height:1.7;word-break:break-word;overflow-y:auto;max-height:60vh;min-height:20px}
.stream-body p{margin:2px 0}
.stream-body h1,.stream-body h2,.stream-body h3{color:var(--fg);margin:10px 0 4px;font-size:14px;font-weight:700}
.stream-body h1{font-size:16px}
.stream-body ul,.stream-body ol{margin:4px 0 4px 20px;padding:0}
.stream-body ol.md-ol{list-style:none;margin-left:4px;padding-left:0}
.stream-body li{margin:2px 0;line-height:1.5}
.ol-num{color:var(--cyan);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-weight:600;margin-right:2px;min-width:1.4em;display:inline-block}
.stream-body strong{color:var(--fg);font-weight:700}
.stream-body code{
  background:rgba(0,0,0,0.05);
  border:1px solid rgba(0,0,0,0.04);
  padding:1px 5px;border-radius:4px;
  font-family:var(--mono);font-size:12px;
}
.stream-body pre{
  background:rgba(0,0,0,0.05);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(0,0,0,0.05);
  padding:10px 12px;border-radius:10px;
  font-family:var(--mono);font-size:11px;line-height:1.5;
  overflow-x:auto;white-space:pre-wrap;
  max-height:300px;overflow-y:auto;margin:8px 0;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);
}
.stream-body blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:6px 0;color:var(--fg2);background:rgba(10,132,255,.04);border-radius:0 6px 6px 0}
.stream-body table{width:100%;border-collapse:collapse;margin:8px 0;font-size:12px}
.stream-body th{background:rgba(255,255,255,0.72);color:var(--fg);font-weight:700;padding:6px 10px;border-bottom:1px solid rgba(0,0,0,0.06)}
.stream-body td{padding:5px 10px;border-bottom:1px solid rgba(0,0,0,0.05);color:var(--fg2)}
.stream-body a{color:var(--accent2)}
.stream-body hr{border:none;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.10),transparent);margin:8px 0}
.stream-cursor{display:inline-block;width:2px;height:14px;background:var(--accent);animation:cursorBlink 1s step-end infinite;vertical-align:text-bottom;margin-left:2px}
@keyframes cursorBlink{0%,100%{opacity:1}50%{opacity:0}}
.stream-steps{display:flex;flex-direction:column;gap:3px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.05)}
.stream-step{
  display:flex;align-items:center;gap:7px;font-size:12px;
  color:var(--fg2);padding:5px 10px;border-radius:10px;
  background:rgba(0,0,0,0.03);
  border:1px solid rgba(255,255,255,0.04);
  transition:all .25s ease;
  animation:stepSlideIn .3s ease both;
}
.stream-step.step-done{color:var(--fg3);opacity:.7}
.stream-step.step-done .step-icon{opacity:.5}
.stream-step.step-active{
  color:var(--fg);
  background:rgba(10,132,255,.06);
  border-color:rgba(0,122,255,0.10);
  box-shadow:0 0 12px rgba(0,122,255,0.06);
}
.step-icon{font-size:12px;flex-shrink:0;width:16px;text-align:center}
.step-label{font-weight:500;white-space:nowrap}
.step-preview{color:var(--fg3);font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:280px;margin-left:4px}
.step-spinner{width:10px;height:10px;border:1.5px solid rgba(255,255,255,0.10);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-left:auto;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes stepSlideIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.stream-meta{font-size:10px;color:var(--fg3);margin-top:6px;display:flex;align-items:center;gap:8px;padding-top:6px;border-top:1px solid rgba(0,0,0,0.05)}
.stream-meta .char-count{opacity:.6;font-family:var(--mono);font-size:9px}
.stream-meta .stream-agent-status{color:var(--cyan);font-weight:600;display:flex;align-items:center;gap:4px}
.stream-meta .stream-agent-status::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--cyan);animation:statusPulse 1.5s ease-in-out infinite}
@keyframes statusPulse{0%,100%{opacity:1}50%{opacity:.3}}
/* ── Artifacts sidebar ── */
.artifacts-sidebar{position:absolute;right:0;top:0;bottom:0;width:400px;max-width:50%;background:var(--bg);border-left:1px solid var(--border);display:flex;flex-direction:column;z-index:50;box-shadow:-4px 0 20px rgba(0,0,0,0.15)}
.artifacts-header{padding:12px 16px;font-size:14px;font-weight:700;color:var(--fg);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.artifacts-close{background:none;border:none;color:var(--fg3);cursor:pointer;font-size:20px;padding:0 4px;line-height:1}
.artifacts-close:hover{color:var(--fg)}
.artifacts-list{flex:1;overflow-y:auto;padding:12px}
.artifact-card{background:var(--bg1);border:1px solid var(--border);border-radius:10px;margin-bottom:12px;overflow:hidden}
.artifact-card-header{padding:10px 14px;font-size:12px;font-weight:600;color:var(--fg2);display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);cursor:pointer}
.artifact-card-header:hover{background:rgba(0,0,0,0.03)}
.artifact-card-body{padding:12px 14px;font-size:12px;line-height:1.6}
.artifact-card-body pre{margin:0;padding:10px;background:var(--bg2);border-radius:6px;overflow-x:auto;font-size:11px;line-height:1.5}
.artifact-card-body code{font-family:var(--mono)}
/* ── Think toggle ── */
.think-toggle{cursor:pointer;text-decoration:underline;text-decoration-style:dotted}
.think-toggle:hover{color:var(--accent)}
.chat-bubble.assistant-bubble .asst-body{word-break:break-word;color:var(--fg)}
.chat-bubble.assistant-bubble .asst-body p{margin:6px 0}
.chat-bubble.assistant-bubble .asst-body h1,.chat-bubble.assistant-bubble .asst-body h2,.chat-bubble.assistant-bubble .asst-body h3,.chat-bubble.assistant-bubble .asst-body h4,.chat-bubble.assistant-bubble .asst-body h5,.chat-bubble.assistant-bubble .asst-body h6{color:var(--fg);margin:16px 0 8px;font-weight:700}
.chat-bubble.assistant-bubble .asst-body h1{font-size:18px;letter-spacing:-.3px}
.chat-bubble.assistant-bubble .asst-body h2{font-size:16px}
.chat-bubble.assistant-bubble .asst-body h3{font-size:15px}
.chat-bubble.assistant-bubble .asst-body h4{font-size:14px;color:var(--fg2)}
.chat-bubble.assistant-bubble .asst-body h5,.chat-bubble.assistant-bubble .asst-body h6{font-size:12px;color:var(--fg2);text-transform:uppercase;letter-spacing:.3px}
.chat-bubble.assistant-bubble .asst-body ul,.chat-bubble.assistant-bubble .asst-body ol{margin:6px 0 6px 22px;padding:0}
.chat-bubble.assistant-bubble .asst-body ol.md-ol{list-style:none;margin-left:4px;padding-left:0}
.chat-bubble.assistant-bubble .asst-body li{margin:3px 0;line-height:1.65}
.chat-bubble.assistant-bubble .asst-body strong{color:var(--fg);font-weight:700}
.chat-bubble.assistant-bubble .asst-body em{color:var(--fg2);font-style:italic}
.chat-bubble.assistant-bubble .asst-body code{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.04);padding:2px 6px;border-radius:6px;font-family:var(--mono);font-size:12.5px;color:var(--cyan)}
.chat-bubble.assistant-bubble .asst-body hr{border:none;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.10),transparent);margin:12px 0}
.chat-bubble.assistant-bubble .asst-body del{color:var(--fg3);text-decoration:line-through}
.chat-bubble.assistant-bubble .asst-body blockquote{border-left:3px solid var(--accent);padding:6px 14px;margin:8px 0;color:var(--fg2);background:rgba(10,132,255,.04);border-radius:0 8px 8px 0}
.chat-bubble.assistant-bubble .asst-body table{width:100%;border-collapse:collapse;margin:10px 0;font-size:13px}
.chat-bubble.assistant-bubble .asst-body th{background:rgba(255,255,255,0.72);color:var(--fg);font-weight:700;padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.06);font-size:12px;text-transform:uppercase;letter-spacing:.3px}
.chat-bubble.assistant-bubble .asst-body td{padding:6px 12px;border-bottom:1px solid rgba(0,0,0,0.05);color:var(--fg2)}
.chat-bubble.assistant-bubble .asst-body tr:hover td{background:rgba(255,255,255,0.55)}
.chat-bubble.assistant-bubble .asst-body .md-img{max-width:100%;border-radius:10px;margin:8px 0;box-shadow:0 4px 16px rgba(0,0,0,0.3)}
.chat-bubble.assistant-bubble .asst-body a{color:var(--accent2);text-decoration:none;border-bottom:1px dotted rgba(125,211,252,.3)}
.chat-bubble.assistant-bubble .asst-body a:hover{border-bottom-color:var(--accent2)}
.chat-bubble.assistant-bubble pre,.stream-body pre{
  position:relative;
  background:rgba(0,0,0,0.05);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  border:1px solid rgba(0,0,0,0.05);
  padding:10px 12px;border-radius:10px;
  font-family:var(--mono);font-size:11.5px;line-height:1.6;
  overflow-x:auto;white-space:pre-wrap;
  max-height:400px;overflow-y:auto;margin:8px 0;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);
}
.code-block-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:6px 12px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.05);
  border-bottom:none;
  border-radius:10px 10px 0 0;
  margin:8px 0 0;
}
.code-block-header+pre{margin-top:0;border-radius:0 0 10px 10px;border-top:none}
.code-lang{font-family:var(--mono);font-size:10px;color:var(--fg3);text-transform:lowercase;letter-spacing:.3px}
.code-copy-btn{
  background:rgba(0,0,0,0.04);border:1px solid rgba(0,0,0,0.06);
  color:var(--fg3);font-size:11px;padding:4px 10px;
  border-radius:6px;cursor:pointer;font-family:var(--font);
  line-height:1.4;transition:all .15s;
}
.code-copy-btn:hover{background:rgba(0,0,0,0.06);color:var(--fg);border-color:rgba(0,0,0,0.10)}
.code-copy-btn.copied{color:var(--green);box-shadow:0 0 8px rgba(48,209,88,.2)}
.chat-bubble.assistant-bubble .asst-tokens{display:flex;gap:10px;margin-top:12px;padding-top:8px;border-top:1px solid rgba(0,0,0,0.05);font-family:var(--mono);font-size:10px;color:var(--fg3)}

.chat-bubble pre{
  background:rgba(0,0,0,0.05);
  border:1px solid rgba(0,0,0,0.04);
  padding:8px 10px;border-radius:8px;
  font-family:var(--mono);font-size:11px;line-height:1.5;
  overflow-x:auto;white-space:pre-wrap;
  max-height:200px;overflow-y:auto;margin:6px 0 2px;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.3);
}
.chat-bubble .chat-agent-name{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.chat-bubble .chat-agent-name.leo-name{color:var(--accent)}
.chat-bubble .chat-agent-name.jerry-name{color:var(--cyan)}
.chat-bubble .chat-agent-name.alic-name{color:var(--magenta)}
.chat-bubble .chat-score{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;margin-top:4px}
.chat-bubble .chat-task-id{font-family:var(--mono);font-size:10px;color:var(--fg3);margin-top:2px}
.chat-bubble .chat-tokens{
  display:inline-flex;align-items:center;gap:4px;
  font-family:var(--mono);font-size:9px;color:var(--fg3);
  margin-top:3px;padding:2px 6px;
  background:rgba(0,0,0,0.04);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:6px;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.2);
}
.chat-bubble .chat-tokens .tok-in{color:var(--cyan)}
.chat-bubble .chat-tokens .tok-out{color:var(--green)}
.chat-bubble .chat-tokens .tok-sep{color:var(--fg3);margin:0 1px}
.chat-result-toggle{font-size:11px;color:var(--accent2);cursor:pointer;margin-top:4px;user-select:none}
.chat-result-toggle:hover{text-decoration:underline}
.chat-result-content{display:none}
.chat-result-content.open{display:block}

.chat-typing{display:flex;gap:4px;padding:4px 12px;align-items:center}
.chat-typing-dot{width:5px;height:5px;border-radius:50%;background:var(--fg3);animation:typingBounce .8s infinite}
.chat-typing-dot:nth-child(2){animation-delay:.15s}
.chat-typing-dot:nth-child(3){animation-delay:.3s}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* ── Live agent status indicator ─────────────────────────────── */
.chat-live-status{display:flex;gap:8px;max-width:85%;animation:chatIn .2s ease;align-self:flex-start}
.chat-live-inner{
  display:flex;align-items:center;gap:8px;
  padding:6px 12px;
  background:rgba(255,255,255,0.72);
  backdrop-filter:blur(16px) saturate(180%);
  -webkit-backdrop-filter:blur(16px) saturate(180%);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:12px;border-bottom-left-radius:3px;
  font-size:12px;color:var(--fg2);
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
}
.chat-live-inner .live-dot{width:7px;height:7px;border-radius:50%;animation:livePulse 1.2s infinite}
.chat-live-inner.leo-live{border-left:3px solid var(--accent)}
.chat-live-inner.leo-live .live-dot{background:var(--accent)}
.chat-live-inner.jerry-live{border-left:3px solid var(--cyan)}
.chat-live-inner.jerry-live .live-dot{background:var(--cyan)}
.chat-live-inner.alic-live{border-left:3px solid var(--magenta)}
.chat-live-inner.alic-live .live-dot{background:var(--magenta)}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ── Overview: Chat Input (Claude Code style) ────────────────── */
.chat-input-area{padding:10px 0 4px;flex-shrink:0}
.chat-attachments{display:flex;gap:6px;flex-wrap:wrap;padding-bottom:6px}
.chat-attach-thumb{
  position:relative;width:56px;height:56px;
  border-radius:10px;overflow:hidden;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.05);
}
.chat-attach-thumb img{width:100%;height:100%;object-fit:cover}
.chat-attach-thumb .chat-attach-name{position:absolute;bottom:0;left:0;right:0;font-size:8px;background:rgba(0,0,0,.6);color:var(--fg);padding:1px 3px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
.chat-attach-remove{position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:var(--red);color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1.5px solid #fff;z-index:1}
.chat-input-box{
  display:grid;
  grid-template-columns:1fr auto;
  grid-template-rows:1fr auto;
  background:rgba(255,255,255,0.80);
  border:1px solid rgba(0,0,0,0.10);
  border-radius:16px;
  transition:border-color .15s, box-shadow .15s;
  overflow:hidden;
  box-shadow:0 1px 4px rgba(0,0,0,0.04);
}
.chat-input-box .chat-textarea{grid-column:1;grid-row:1}
.chat-input-box .chat-input-bottom{grid-column:1;grid-row:2}
.chat-input-box .chat-send{grid-column:2;grid-row:1/3;align-self:center;margin:0 8px}
.chat-input-box:focus-within{
  border-color:rgba(10,132,255,0.35);
  border-color:rgba(0,122,255,0.5);
  box-shadow:0 0 0 3px rgba(0,122,255,0.12);
}
.chat-textarea{flex:1;background:transparent;border:none;color:var(--fg);padding:12px 16px 4px;font-size:14px;font-family:var(--font);outline:none;resize:none;line-height:1.5;max-height:160px;overflow-y:auto;min-height:24px}
.chat-textarea::placeholder{color:var(--fg3)}
.chat-input-bottom{display:flex;align-items:center;justify-content:space-between;padding:4px 6px 6px}
.chat-input-actions{display:flex;gap:1px;flex-shrink:0}
.chat-action-btn{
  width:32px;height:32px;border-radius:8px;
  border:1px solid transparent;background:transparent;
  color:var(--fg3);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;transition:all .12s;flex-shrink:0;
}
.chat-action-btn:hover{
  color:var(--fg);
  background:rgba(0,0,0,0.04);
  border-color:rgba(0,0,0,0.06);
}
.chat-action-btn.active{
  color:var(--accent);
  background:rgba(0,122,255,0.08);
  border-color:rgba(0,122,255,0.15);
}
.chat-send{padding:6px 16px;border-radius:8px;height:32px;display:inline-flex;align-items:center;justify-content:center;gap:4px;font-size:13px;font-weight:600}
.chat-send:disabled{opacity:.2;cursor:not-allowed}

/* ── Chat: Search indicator ──────────────────────────────────── */
.chat-search-indicator{
  display:flex;align-items:center;gap:6px;
  padding:4px 10px;margin-bottom:4px;font-size:11px;
  color:var(--cyan);
  background:rgba(100,210,255,.06);
  border:1px solid rgba(50,173,230,0.10);
  border-radius:10px;
  box-shadow:0 0 12px rgba(50,173,230,0.05);
}
.chat-search-indicator .search-spinner{width:12px;height:12px;border:2px solid rgba(100,210,255,.2);border-top-color:var(--cyan);border-radius:50%;animation:spin .6s linear infinite}

/* ── Chat: Image in messages ─────────────────────────────────── */
.chat-bubble .chat-images{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.chat-bubble .chat-images img{max-width:200px;max-height:150px;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.chat-bubble .chat-images img:hover{box-shadow:0 4px 16px rgba(0,0,0,0.3), 0 0 12px rgba(10,132,255,0.1)}
.chat-bubble .chat-file-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 8px;border-radius:8px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.05);
  font-size:11px;color:var(--fg2);margin-top:4px;
}
.task-decomp{display:flex;flex-direction:column;gap:6px;margin:8px 0}
.task-decomp-item{
  display:flex;align-items:flex-start;gap:8px;
  padding:8px 12px;
  background:rgba(0,0,0,0.03);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:12px;
  font-size:13px;line-height:1.45;
  transition:border-color .15s, box-shadow .15s;
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.04);
}
.task-decomp-item:hover{
  border-color:rgba(0,0,0,0.08);
  box-shadow:0 4px 16px rgba(0,0,0,0.2), 0 0 10px rgba(0,122,255,0.05);
}
.task-decomp-num{flex-shrink:0;font-size:14px;margin-top:1px}
.task-decomp-text{flex:1;color:var(--fg)}
.task-role-badge{flex-shrink:0;font-size:10px;padding:2px 7px;border-radius:6px;background:rgba(10,132,255,.08);color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:.3px;margin-top:1px}
.chat-file-card{
  display:flex;align-items:center;gap:8px;
  padding:8px 12px;
  background:rgba(255,255,255,0.72);
  border:1px solid rgba(0,0,0,0.06);
  border-radius:10px;
  text-decoration:none;color:var(--fg);
  transition:.15s;
  min-width:180px;max-width:280px;
  box-shadow:0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.6);
}
.chat-file-card:hover{
  border-color:rgba(255,255,255,0.16);
  box-shadow:0 4px 16px rgba(0,0,0,0.2), 0 0 10px rgba(0,122,255,0.06);
}
.chat-file-card .file-icon{font-size:20px;flex-shrink:0}
.chat-file-card .file-info{display:flex;flex-direction:column;min-width:0}
.chat-file-card .file-name{font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.chat-file-card .file-path{font-size:9px;color:var(--fg3);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ── Chat: Search result cards ───────────────────────────────── */
.chat-search-results{margin-top:6px}
.chat-search-card{
  background:rgba(0,0,0,0.03);
  border:1px solid rgba(0,0,0,0.05);
  border-radius:8px;
  padding:8px 10px;
  margin:3px 0;
  font-size:12px;
}
.chat-search-card a{color:var(--accent2);font-weight:600;font-size:12px}
.chat-search-card .search-snippet{color:var(--fg2);font-size:11px;margin-top:2px;line-height:1.4}

/* ── Responsive ───────────────────────────────────────────────── */
@media(max-width:800px){
  .sidebar{width:56px;min-width:56px}
  .session-section{display:none}
  .nav-section-title,.nav-item span:not(.icon),.sidebar-footer,.sidebar-logo span,.sidebar-logo div:not(:first-child){display:none}
  .nav-item{justify-content:center;padding:10px 0}
  .nav-item .icon{margin:0}
  .content{padding:12px 14px}
  .skills-layout{flex-direction:column;height:auto}
  .skills-list{width:100%;min-width:0;max-height:200px}
  .agent-grid{grid-template-columns:1fr}
  .ov-header{flex-direction:column;gap:6px}
  .ov-header-sep{display:none}
  .ov-statuses{flex-wrap:wrap;justify-content:center}
  .ov-agents{justify-content:center}
  .chat-bubble.assistant-bubble .asst-body table{font-size:11px}
  .chat-bubble.assistant-bubble .asst-body th,.chat-bubble.assistant-bubble .asst-body td{padding:4px 6px}
  .chat-msg{max-width:92%}
  .kb-grid{grid-template-columns:1fr}
}

/* ── Responsive: MacBook 14" (~1440-1512px) ──────────────────── */
@media(max-width:1600px){
  :root{--sidebar-w:200px}
  .content{padding:16px 20px}
  .chat-bubble.assistant-bubble .asst-body{font-size:13.5px}
}

/* ── Responsive: MacBook 16" (~1680-1728px) ──────────────────── */
@media(min-width:1601px) and (max-width:1920px){
  .content{padding:20px 28px}
}

/* ── Responsive: 24" monitor (~1920-2560px) ──────────────────── */
@media(min-width:1921px){
  .content{padding:24px 48px}
  .chat-bubble.assistant-bubble .asst-body{font-size:14.5px;line-height:1.8}
}

/* ── Responsive: 27"+ monitor (2560px+, including 4K) ────────── */
@media(min-width:2561px){
  :root{--sidebar-w:260px}
  .content{padding:28px 64px}
  html,body{font-size:15px}
  .chat-textarea{font-size:15px}
  .chat-bubble{font-size:14px}
  .chat-bubble.assistant-bubble .asst-body{font-size:15px}
  .stat-value{font-size:28px}
  .agent-grid{grid-template-columns:repeat(auto-fill,minmax(320px,1fr))}
}
</style>
</head>
<body>
<div class="app">

<!-- ═══════════════ Sidebar ═══════════════ -->
<nav class="sidebar">
  <div class="sidebar-logo">
    ⬡ <span>Cleo</span>
    <span class="status-dot" id="statusDot"></span>
  </div>

  <!-- ═══ Session List ═══ -->
  <div class="session-section">
    <div class="session-header">
      <span class="session-header-title">Sessions</span>
      <button class="session-new-btn" onclick="createNewSession()" title="New Chat">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>
    </div>
    <div class="session-list" id="sessionList">
      <div style="padding:8px 10px;color:var(--fg3);font-size:11px">Loading…</div>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-item active" data-panel="overview" onclick="switchPanel('overview')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span><span>Overview</span>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Agents</div>
    <div class="nav-item" data-panel="agents" onclick="switchPanel('agents')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span><span>Agents</span>
    </div>
    <div class="nav-item" data-panel="skills" onclick="switchPanel('skills')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></span><span>Skills</span>
    </div>
    <div class="nav-item" data-panel="memory" onclick="switchPanel('memory')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></span><span>Memory</span>
    </div>
    <div class="nav-item" data-panel="tools" onclick="switchPanel('tools')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span><span>Tools</span>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Ops</div>
    <div class="nav-item" data-panel="usage" onclick="switchPanel('usage')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span><span>Usage</span>
    </div>
    <div class="nav-item" data-panel="logs" onclick="switchPanel('logs')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span><span>Logs</span>
    </div>
    <div class="nav-item" data-panel="runtime" onclick="switchPanel('runtime')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span><span>Runtime</span>
    </div>
    <div class="nav-item" data-panel="cron" onclick="switchPanel('cron')">
      <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span><span>Cron</span>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title clickable" onclick="toggleNavSection(this)" style="cursor:pointer;user-select:none">System <span class="nav-caret">▸</span></div>
    <div class="nav-collapsible" style="display:none">
      <div class="nav-item" data-panel="config" onclick="switchPanel('config')">
        <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span><span>Config</span>
      </div>
      <div class="nav-item" data-panel="gateway" onclick="switchPanel('gateway')">
        <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span><span>Gateway</span>
      </div>
      <div class="nav-item" data-panel="health" onclick="switchPanel('health')">
        <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></span><span>Health</span>
      </div>
      <div class="nav-item" data-panel="channels" onclick="switchPanel('channels')">
        <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><circle cx="12" cy="20" r="1"/></svg></span><span>Channels</span>
      </div>
      <div class="nav-item" data-panel="cleo-files" onclick="switchPanel('cleo-files')">
        <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span><span>Files</span>
      </div>
      <div class="nav-item" data-panel="chain" onclick="switchPanel('chain')">
        <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg></span><span>Chain</span>
      </div>
      <div class="nav-item" data-panel="a2a" onclick="switchPanel('a2a')">
        <span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg></span><span>A2A</span>
      </div>
    </div>
  </div>

  <div class="sidebar-footer">
    <div id="footerAgents">0/0 agents online</div>
    <div id="footerUptime">uptime —</div>
    <div><code id="footerPort">:19789</code></div>
  </div>
</nav>

<!-- ═══════════════ Main Content ═══════════════ -->
<main class="content">

<!-- ── Panel: Overview ── -->
<div class="panel active" id="panel-overview">
  <!-- ═══ HEADER BAR: Latest statuses (left) | Agent chips (right) ═══ -->
  <div class="ov-header">
    <div class="ov-statuses" id="ovStatuses">
      <span class="ov-status-empty">Ready — Submit a task to start</span>
    </div>
    <div class="ov-header-sep"></div>
    <div class="ov-agents" id="ovAgents">
      <div class="ov-agent-chip" id="chipPlanner"><img class="chip-avatar" src="/avatars/leo.png" alt="Leo"><span class="chip-name">Leo</span><span class="chip-dot"></span></div>
      <div class="ov-agent-chip" id="chipExecutor"><img class="chip-avatar" src="/avatars/jerry.png" alt="Jerry"><span class="chip-name">Jerry</span><span class="chip-dot"></span></div>
      <div class="ov-agent-chip" id="chipReviewer"><img class="chip-avatar" src="/avatars/alic.png" alt="Alic"><span class="chip-name">Alic</span><span class="chip-dot"></span></div>
    </div>
  </div>

  <!-- Hidden legacy elements for JS compatibility -->
  <div style="display:none">
    <div id="ovTop"></div><div id="ovDivider"></div><div id="dispatchLog"></div>
    <div id="wfPlanner"></div><div id="wfExecutor"></div><div id="wfReviewer"></div>
    <div id="wfPlannerStatus"></div><div id="wfExecutorStatus"></div><div id="wfReviewerStatus"></div>
    <div id="wfConn1"></div><div id="wfConn2"></div><div id="wfStats"></div>
    <div id="wfPacket1"></div><div id="wfPacket2"></div>
  </div>

  <!-- ═══ SUBTASK TREE (shows when leo decomposes a task) ═══ -->
  <div class="subtask-tree" id="subtaskTree"></div>

  <!-- ═══ CHATBOX (takes most of the space) ═══ -->
  <div class="ov-bottom">
    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome">
        <div class="chat-welcome-icon">⬡</div>
        <div class="chat-welcome-text">What can I help you with?</div>
        <div class="chat-welcome-sub">Your task will be planned, executed, and reviewed by the Cleo agent team</div>
      </div>
    </div>
    <div class="chat-input-area">
      <div class="chat-attachments" id="chatAttachments" style="display:none"></div>
      <div class="chat-input-box">
        <textarea class="chat-textarea" id="chatInput" rows="1"
                  placeholder="Message Cleo…"></textarea>
        <div class="chat-input-bottom">
          <div class="chat-input-actions">
            <button class="chat-action-btn" title="Attach file" onclick="document.getElementById('chatFileInput').click()">📎</button>
            <button class="chat-action-btn" id="searchToggle" title="Web search (Brave)" onclick="toggleSearchMode()">🔍</button>
            <input type="file" id="chatFileInput" multiple accept="image/*,.pdf,.txt,.md,.json,.csv,.py,.js,.ts" style="display:none" onchange="handleFileSelect(this)">
          </div>
        </div>
        <button class="btn chat-send" id="chatSend" onclick="chatSubmit()">Send ↑</button>
      </div>
    </div>
  </div>

  <!-- ═══ ARTIFACTS SIDEBAR ═══ -->
  <div id="artifactsSidebar" class="artifacts-sidebar" style="display:none">
    <div class="artifacts-header">
      <span>📎 Artifacts</span>
      <button onclick="toggleArtifacts()" class="artifacts-close" title="Close">&times;</button>
    </div>
    <div id="artifactsList" class="artifacts-list"></div>
  </div>
</div>

<!-- ── Panel: Agents ── -->
<div class="panel" id="panel-agents">
  <div class="page-header" style="display:flex;align-items:center;justify-content:space-between">
    <div>
      <div class="page-title">Agents</div>
      <div style="font-size:12px;color:var(--fg3)">Click an agent card to edit</div>
    </div>
    <button class="btn-create-agent" onclick="showCreateAgentModal()">+ Create Agent</button>
  </div>
  <div class="agent-grid" id="agentGrid">
    <div class="empty">Loading agents…</div>
  </div>
  <div id="agentModalContainer"></div>
</div>

<!-- ── Panel: Skills ── -->
<div class="panel" id="panel-skills">
  <div class="page-header">
    <div class="page-title">Skills</div>
    <div class="page-actions">
      <button class="btn btn-sm btn-outline" onclick="showCreateDialog()">+ New Skill</button>
      <label class="btn btn-sm btn-outline" style="cursor:pointer">
        ↑ Upload <input type="file" accept=".md" style="display:none" onchange="uploadSkill(this)">
      </label>
    </div>
  </div>
  <div class="skills-layout">
    <div class="skills-list">
      <div class="skills-list-header">
        <input class="input" type="text" placeholder="Search skills…" id="skillSearch" oninput="filterSkills()">
        <select class="input" id="skillAgentFilter" onchange="filterSkills()" style="margin-top:6px;font-size:11px">
          <option value="">All agents</option>
        </select>
      </div>
      <div class="skills-list-body" id="skillsListBody">
        <div class="empty">Loading…</div>
      </div>
    </div>
    <div class="skills-editor" id="skillsEditor">
      <div class="skills-empty">Select a skill from the list</div>
    </div>
  </div>
</div>

<!-- ── Panel: Cleo Files ── -->
<div class="panel" id="panel-cleo-files">
  <div class="page-header">
    <div class="page-title">Files</div>
    <div class="page-actions">
      <span style="font-size:12px;color:var(--fg3)">Agent config, memory, and identity files</span>
    </div>
  </div>
  <div class="skills-layout">
    <div class="skills-list">
      <div class="skills-list-header">
        <input class="input" type="text" placeholder="Search files…" id="cfSearch" oninput="filterCfFiles()">
      </div>
      <div class="skills-list-body" id="cfListBody">
        <div class="empty">Loading…</div>
      </div>
    </div>
    <div class="skills-editor" id="cfEditor">
      <div class="skills-empty">Select a file from the list to view or edit</div>
    </div>
  </div>
</div>

<!-- ── Panel: Tools ── -->
<div class="panel" id="panel-tools">
  <div class="page-header">
    <div class="page-title">Built-in Tools</div>
    <div style="font-size:12px;color:var(--fg3)">Agent tool registry — Web Search, Shell Exec, Cron, Media, Filesystem</div>
  </div>
  <div class="stats" id="toolsStats">
    <div class="stat"><div class="stat-value green" id="tAvail">0</div><div class="stat-label">Available</div></div>
    <div class="stat"><div class="stat-value" id="tTotal">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-value cyan" id="tGroups">0</div><div class="stat-label">Groups</div></div>
  </div>
  <div id="toolsContent" class="card-row" style="flex-direction:column;gap:12px"></div>
</div>

<!-- ── Panel: Usage ── -->
<div class="panel" id="panel-usage">
  <div class="page-header"><div class="page-title">Usage</div></div>
  <div class="stats" id="usageStats">
    <div class="stat"><div class="stat-value" id="uCalls">0</div><div class="stat-label">API Calls</div></div>
    <div class="stat"><div class="stat-value" id="uTokens">0</div><div class="stat-label">Tokens</div></div>
    <div class="stat"><div class="stat-value green" id="uCost">$0</div><div class="stat-label">Est. Cost</div></div>
    <div class="stat"><div class="stat-value cyan" id="uRetries">0</div><div class="stat-label">Retries</div></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">By Agent</div>
      <div id="usageByAgent"><div class="empty">No usage data</div></div>
    </div>
    <div class="card">
      <div class="card-title">By Model</div>
      <div id="usageByModel"><div class="empty">No usage data</div></div>
    </div>
  </div>
</div>

<!-- ── Panel: Channels ── -->
<div class="panel" id="panel-channels">
  <div class="page-header">
    <div class="page-title">Channels</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadChannels()">Refresh</button></div>
  </div>
  <div class="ch-grid" id="channelStats" style="margin-bottom:14px">
    <div class="stat"><div class="stat-value cyan" id="chTotal">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-value green" id="chRunning">0</div><div class="stat-label">Running</div></div>
    <div class="stat"><div class="stat-value" id="chEnabled">0</div><div class="stat-label">Enabled</div></div>
    <div class="stat"><div class="stat-value red" id="chDisabled">0</div><div class="stat-label">Disabled</div></div>
  </div>
  <div class="ch-grid" id="channelGrid"><div class="empty">Loading…</div></div>
</div>

<!-- ── Panel: Config ── -->
<div class="panel" id="panel-config">
  <div class="page-header"><div class="page-title">Configuration</div></div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Agent Configuration</div>
      <pre class="config-pre" id="configView">Loading…</pre>
    </div>
    <div class="card">
      <div class="card-title">Resilience</div>
      <pre class="config-pre" id="resilienceView">Loading…</pre>
    </div>
  </div>
</div>

<!-- ── Panel: Gateway ── -->
<div class="panel" id="panel-gateway">
  <div class="page-header"><div class="page-title">Gateway</div></div>
  <div class="card">
    <div class="card-title">API Token</div>
    <div class="token-display">
      <code id="gatewayToken">Loading…</code>
      <button class="btn btn-sm" onclick="copyToken()">Copy</button>
      <button class="btn btn-sm btn-danger" onclick="regenerateToken()">Regenerate</button>
    </div>
    <div style="font-size:11px;color:var(--fg3);margin-top:4px">Use this token in Authorization header: <code>Bearer &lt;token&gt;</code></div>
  </div>
  <div class="card">
    <div class="card-title">Server Info</div>
    <div class="info-grid" id="gatewayInfo">
      <div class="info-item"><div class="info-label">Port</div><div class="info-value" id="gwPort">—</div></div>
      <div class="info-item"><div class="info-label">Uptime</div><div class="info-value" id="gwUptime">—</div></div>
      <div class="info-item"><div class="info-label">Status</div><div class="info-value" id="gwStatus" style="color:var(--green)">—</div></div>
    </div>
  </div>
</div>

<!-- ── Panel: Health ── -->
<div class="panel" id="panel-health">
  <div class="page-header">
    <div class="page-title">System Health</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadDoctor()">Re-check</button></div>
  </div>
  <div class="stat-grid" id="healthStats" style="margin-bottom:16px">
    <div class="stat-card"><div class="stat-value" id="hGateway" style="color:var(--green)">—</div><div class="stat-label">Gateway</div></div>
    <div class="stat-card"><div class="stat-value" id="hUptime">—</div><div class="stat-label">Uptime</div></div>
    <div class="stat-card"><div class="stat-value" id="hPort">—</div><div class="stat-label">Port</div></div>
    <div class="stat-card"><div class="stat-value" id="hAgents">—</div><div class="stat-label">Agents</div></div>
  </div>
  <div class="card">
    <div class="card-title">Diagnostic Checks</div>
    <ul class="checks" id="healthChecks"><li class="empty">Running checks…</li></ul>
  </div>
</div>

<!-- ── Panel: Logs ── -->
<div class="panel" id="panel-logs">
  <div class="page-header"><div class="page-title">Logs</div></div>
  <div class="logs-controls">
    <select class="input" id="logAgentSelect" onchange="loadLogs()" style="width:160px">
      <option value="">Select agent…</option>
    </select>
    <input class="input" type="text" id="logSearch" placeholder="Search…" style="width:180px" oninput="loadLogs()">
    <div class="log-levels">
      <div class="log-level-btn active" data-level="" onclick="setLogLevel(this)">All</div>
      <div class="log-level-btn" data-level="INFO" onclick="setLogLevel(this)">Info</div>
      <div class="log-level-btn" data-level="WARNING" onclick="setLogLevel(this)">Warn</div>
      <div class="log-level-btn" data-level="ERROR" onclick="setLogLevel(this)">Error</div>
    </div>
    <label class="auto-refresh-toggle">
      <input type="checkbox" id="logAutoRefresh" onchange="toggleLogAutoRefresh()"> Auto-refresh
    </label>
  </div>
  <div class="log-content" id="logContent">Select an agent to view logs</div>
</div>

<!-- ── Panel: Chain ── -->
<div class="panel" id="panel-chain">
  <div class="page-header">
    <div class="page-title">On-Chain Identity</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadChain()">Refresh</button></div>
  </div>

  <div class="stats" id="chainStats" style="margin-bottom:18px">
    <div class="stat"><div class="stat-value cyan" id="chainNetwork">—</div><div class="stat-label">Network</div></div>
    <div class="stat"><div class="stat-value" id="chainLitNet">—</div><div class="stat-label">Lit Network</div></div>
    <div class="stat"><div class="stat-value green" id="chainAgents">—</div><div class="stat-label">Registered</div></div>
    <div class="stat"><div class="stat-value" id="chainX402">—</div><div class="stat-label">X402</div></div>
  </div>

  <div class="card">
    <div class="card-title">Agent Identities</div>
    <table class="data-table">
      <thead><tr>
        <th>Agent</th><th>Status</th><th>PKP Address</th><th>Chain ID</th><th>Balance</th><th></th>
      </tr></thead>
      <tbody id="chainAgentsBody"><tr><td colspan="6" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-title">Recent Transactions</div>
    <div id="chainTxList" style="font-size:12px;color:var(--fg2)">Loading…</div>
  </div>
</div>

<!-- ── Panel: Memory ── -->
<div class="panel" id="panel-memory">
  <div class="page-header" style="display:flex;align-items:center;justify-content:space-between">
    <div style="display:flex;align-items:center;gap:16px">
      <div class="page-title">Agent Memory</div>
      <select id="memAgentSelect" class="input" style="width:140px;padding:6px 10px" onchange="loadMemory()">
        <option value="all">All Agents</option>
        <option value="leo">Leo</option>
        <option value="jerry">Jerry</option>
        <option value="alic">Alic</option>
      </select>
    </div>
    <div class="page-actions" style="display:flex;gap:8px">
      <button class="btn btn-green" onclick="showMemoExportDialog()">🧠 Memo Export</button>
      <button class="btn btn-outline" onclick="exportMemory()">Export</button>
      <button class="btn" onclick="loadMemory()">Refresh</button>
    </div>
  </div>

  <!-- Sub-tabs with inline stat badges -->
  <div class="modal-tabs" id="memTabs" style="margin-bottom:16px">
    <button class="modal-tab active" data-memtab="episodes" onclick="switchMemoryTab('episodes')">Episodes <span class="tab-badge" id="memEpisodes">—</span></button>
    <button class="modal-tab" data-memtab="cases" onclick="switchMemoryTab('cases')">Cases <span class="tab-badge" id="memCases">—</span></button>
    <button class="modal-tab" data-memtab="daily" onclick="switchMemoryTab('daily')">Daily Log</button>
    <button class="modal-tab" data-memtab="kb" onclick="switchMemoryTab('kb')">KB <span class="tab-badge" id="memNotes">—</span> <span class="tab-badge tab-badge-secondary" id="memPatterns">—</span></button>
  </div>

  <!-- Data Area (content switches per tab) -->
  <div id="memDataArea">
    <div class="card"><div class="empty">Select an agent and tab to view memory data</div></div>
  </div>

  <!-- Edit Modal Container -->
  <div id="memEditModalContainer"></div>
</div>

<!-- ═══════════════ Cron Jobs Panel ═══════════════ -->
<div class="panel" id="panel-cron">
  <div class="page-header">
    <div class="page-title">Cron Jobs</div>
    <div class="page-actions"><button class="btn" onclick="showNewCronModal()">+ New Job</button> <button class="btn" onclick="loadCron()">Refresh</button></div>
  </div>

  <div class="stat-grid" id="cronStats" style="margin-bottom:18px">
    <div class="stat-card"><div class="stat-value" id="cronTotal">—</div><div class="stat-label">Total Jobs</div></div>
    <div class="stat-card"><div class="stat-value" id="cronActive">—</div><div class="stat-label">Active</div></div>
    <div class="stat-card"><div class="stat-value" id="cronRuns">—</div><div class="stat-label">Total Runs</div></div>
  </div>

  <div class="card">
    <div class="card-title">Scheduled Jobs</div>
    <table class="data-table">
      <thead><tr>
        <th>Name</th><th>Action</th><th>Schedule</th><th>Last Run</th><th>Runs</th><th>Enabled</th><th>Actions</th>
      </tr></thead>
      <tbody id="cronJobsBody"><tr><td colspan="7" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<!-- ═══════════════ Runtime Panel ═══════════════ -->
<div class="panel" id="panel-runtime">
  <div class="page-header">
    <div class="page-title">Agent Runtime</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadRuntime()">Refresh</button></div>
  </div>

  <div class="stats" style="margin-bottom:18px">
    <div class="stat"><div class="stat-value cyan" id="rtMode">—</div><div class="stat-label">Runtime Mode</div></div>
    <div class="stat"><div class="stat-value green" id="rtAlive">—</div><div class="stat-label">Agents Alive</div></div>
    <div class="stat"><div class="stat-value" id="rtAlwaysOn">—</div><div class="stat-label">Always-On</div></div>
    <div class="stat"><div class="stat-value" id="rtIdleShutdown">—</div><div class="stat-label">Idle Shutdown</div></div>
  </div>

  <div class="card" style="margin-bottom:16px">
    <div class="card-title">Runtime Mode Details</div>
    <div id="rtModeDesc" style="font-size:12px;color:var(--fg2);line-height:1.8;padding:8px 0">Loading…</div>
  </div>

  <div class="card">
    <div class="card-title">Agent Processes</div>
    <table class="data-table">
      <thead><tr>
        <th>Agent</th><th>Status</th><th>Model</th><th>Current Task</th><th>Always-On</th><th>Last Active</th>
      </tr></thead>
      <tbody id="rtAgentsBody"><tr><td colspan="6" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<!-- ═══════════════ A2A Panel ═══════════════ -->
<div class="panel" id="panel-a2a">
  <div class="page-header">
    <div class="page-title">A2A Protocol</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadA2A()">Refresh</button></div>
  </div>

  <div class="stats" style="margin-bottom:18px">
    <div class="stat"><div class="stat-value" id="a2aServerStatus">—</div><div class="stat-label">Server</div></div>
    <div class="stat"><div class="stat-value" id="a2aClientStatus">—</div><div class="stat-label">Client</div></div>
    <div class="stat"><div class="stat-value cyan" id="a2aRemotes">—</div><div class="stat-label">Remotes</div></div>
    <div class="stat"><div class="stat-value" id="a2aTaskMap">—</div><div class="stat-label">Task Map</div></div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
    <div class="card">
      <div class="card-title">A2A Server (Inbound)</div>
      <div id="a2aServerInfo" style="font-size:12px;color:var(--fg2);line-height:1.8">Loading…</div>
    </div>
    <div class="card">
      <div class="card-title">A2A Client (Outbound)</div>
      <div id="a2aClientInfo" style="font-size:12px;color:var(--fg2);line-height:1.8">Loading…</div>
    </div>
  </div>

  <div class="card" style="margin-bottom:16px">
    <div class="card-title">Registered Remote Agents</div>
    <table class="data-table">
      <thead><tr>
        <th>URL</th><th>Trust Level</th><th>Skills</th><th>Auth</th>
      </tr></thead>
      <tbody id="a2aRemotesBody"><tr><td colspan="4" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>

  <div class="card">
    <div class="card-title">Agent Registries</div>
    <table class="data-table">
      <thead><tr>
        <th>Registry URL</th><th>Trust Level</th><th>Refresh Interval</th>
      </tr></thead>
      <tbody id="a2aRegistriesBody"><tr><td colspan="3" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-title">Security Policy</div>
    <div id="a2aSecurityInfo" style="font-size:12px;color:var(--fg2);line-height:1.8">Loading…</div>
  </div>
</div>

</main>
</div><!-- .app -->

<!-- ═══════════════ Create Skill Dialog ═══════════════ -->
<div class="dialog-overlay" id="createDialog" style="display:none" onclick="if(event.target===this)closeCreateDialog()">
  <div class="dialog">
    <div class="dialog-title">Create New Skill</div>
    <div class="field">
      <label>Skill Name</label>
      <input class="input" id="newSkillName" placeholder="e.g. planning, code-review">
    </div>
    <div class="field">
      <label>Scope</label>
      <select class="input" id="newSkillScope">
        <option value="shared">Shared (all agents)</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn btn-outline" onclick="closeCreateDialog()">Cancel</button>
      <button class="btn" onclick="createSkill()">Create</button>
    </div>
  </div>
</div>

<!-- ═══════════════ Memo Export Dialog ═══════════════ -->
<div class="dialog-overlay" id="memoExportDialog" style="display:none" onclick="if(event.target===this)closeMemoExportDialog()">
  <div class="dialog" style="max-width:440px">
    <div class="dialog-title">🧠 Memo Protocol Export</div>
    <div class="field">
      <label>Agent <span style="color:var(--red)">*</span></label>
      <select class="input" id="memoExportAgent">
        <option value="">— Select Agent —</option>
        <option value="leo">Leo</option>
        <option value="jerry">Jerry</option>
        <option value="alic">Alic</option>
      </select>
    </div>
    <div class="field">
      <label>Export Name</label>
      <input class="input" id="memoExportName" type="text" placeholder="e.g. leo_memo_2024">
      <div style="font-size:11px;color:var(--text2);margin-top:2px">File name for the exported .json (auto-generated if empty)</div>
    </div>
    <div class="field">
      <label>Memory Type</label>
      <select class="input" id="memoExportType">
        <option value="">All Types</option>
        <option value="episodic">Episodic</option>
        <option value="semantic">Semantic</option>
        <option value="procedural">Procedural</option>
      </select>
    </div>
    <div class="field">
      <label>Min Quality Score</label>
      <input class="input" id="memoExportMinQuality" type="number" value="0.6" min="0" max="1" step="0.1">
    </div>
    <div class="field">
      <label>Min Episode Score</label>
      <input class="input" id="memoExportMinScore" type="number" value="7" min="0" max="10" step="1">
    </div>
    <div class="field" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="memoExportDryRun">
      <label for="memoExportDryRun" style="margin:0">Dry Run (preview only)</label>
    </div>
    <div class="field" style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" id="memoExportUpload">
      <label for="memoExportUpload" style="margin:0">Upload to Memo Platform</label>
    </div>
    <div id="memoExportResult" style="display:none;margin-top:12px;padding:12px;background:var(--bg2);border-radius:8px;font-size:13px;font-family:monospace"></div>
    <div class="actions">
      <button class="btn btn-outline" onclick="closeMemoExportDialog()">Cancel</button>
      <button class="btn btn-green" id="memoExportBtn" onclick="executeMemoExport()">Export</button>
    </div>
  </div>
</div>

<script>
/* ══════════════════════════════════════════════════════════════════
   Cleo Dashboard — Vanilla JS
   ══════════════════════════════════════════════════════════════════ */

const API = '';  // same origin

// Migrate legacy 'swarm_token' → 'cleo_token' (one-time, non-destructive)
if (!localStorage.getItem('cleo_token') && localStorage.getItem('swarm_token')) {
  localStorage.setItem('cleo_token', localStorage.getItem('swarm_token'));
}

// Auto-login: prefer server-injected token > URL param > localStorage
let TOKEN = (function() {
  // 1. Token injected by gateway into <head> — highest priority
  if (window.__CLEO_TOKEN__) {
    localStorage.setItem('cleo_token', window.__CLEO_TOKEN__);
    return window.__CLEO_TOKEN__;
  }
  // 2. URL param (?token=xxx)
  const p = new URLSearchParams(window.location.search);
  const t = p.get('token');
  if (t) {
    localStorage.setItem('cleo_token', t);
    history.replaceState(null, '', window.location.pathname);
    return t;
  }
  // 3. localStorage fallback
  return localStorage.getItem('cleo_token') || '';
})();

// ── State ───────────────────────────────────────────────────────
let currentPanel = 'overview';
let editingAgent = null;
let currentSkill = null;
let skillsDirty = false;
let skillsData = null;
let cfData = null;           // Cleo Files list cache
let currentCfFile = null;    // Currently editing: {scope, name, content}
let cfDirty = false;         // Unsaved changes flag
let logLevel = '';
let logAutoRefreshTimer = null;
let expandedTaskId = null;
let allTasks = {};
let heartbeatData = {};  // {agent_id: {online, status, task_id, ...}}

// ── Chat state (Overview panel) ──
let chatMsgs = [];              // {id, type:'user'|'agent'|'system', agent, text, ts, taskId}
let chatPrevSnapshot = {};      // previous polling snapshot for diff
let chatTaskMap = {};           // taskId → Set of generated message types (dedup)
let chatMsgCounter = 0;        // unique msg id counter
let dashboardUser = 'createpjf';  // default submitter name for dashboard tasks

// ── Session state ──
let currentSessionId = null;
let dashboardSessions = [];

// ══════════════════════════════════════════════════════════════════
//  AUTH & API HELPERS
// ══════════════════════════════════════════════════════════════════

function authHeaders() {
  const h = {'Content-Type':'application/json'};
  if (TOKEN) h['Authorization'] = 'Bearer ' + TOKEN;
  return h;
}

async function api(path) {
  try {
    const r = await fetch(API + path, {headers: authHeaders()});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return api(path); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

async function apiPost(path, body) {
  try {
    const r = await fetch(API + path, {method:'POST', headers: authHeaders(), body: JSON.stringify(body)});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return apiPost(path, body); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

async function apiPut(path, body) {
  try {
    const r = await fetch(API + path, {method:'PUT', headers: authHeaders(), body: JSON.stringify(body)});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return apiPut(path, body); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

async function apiDelete(path) {
  try {
    const r = await fetch(API + path, {method:'DELETE', headers: authHeaders()});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return apiDelete(path); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

// ══════════════════════════════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════════════════════════════

function fmtTime(s) {
  if (!s || s <= 0) return '—';
  if (s < 60) return s.toFixed(1) + 's';
  const m = Math.floor(s/60), sec = Math.floor(s%60);
  if (m < 60) return m + 'm' + String(sec).padStart(2,'0') + 's';
  const h = Math.floor(m/60), rm = m%60;
  return h + 'h' + String(rm).padStart(2,'0') + 'm';
}
function fmtNum(n) { return n != null ? n.toLocaleString() : '0'; }
function truncate(s, n) { return s && s.length > n ? s.slice(0,n-1)+'…' : (s||''); }
function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function titleCase(s) { return (s||'').replace(/\b\w/g, c => c.toUpperCase()); }
function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

function showToast(msg, type) {
  const el = document.createElement('div');
  const bg = type === 'error' ? 'var(--red)' : type === 'success' ? 'var(--green)' : 'var(--accent)';
  el.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:10px 18px;border-radius:8px;font-size:13px;color:#fff;z-index:10000;background:' + bg + ';box-shadow:0 4px 12px rgba(0,0,0,.3);transition:opacity .3s';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
}

function statusIcon(status) {
  switch(status) {
    case 'claimed': return '<span class="status-icon status-working">●</span>';
    case 'completed': return '<span class="status-icon status-done">✓</span>';
    case 'failed': return '<span class="status-icon status-failed">✗</span>';
    case 'review': return '<span class="status-icon status-review">◆</span>';
    case 'critique': return '<span class="status-icon status-critique">⚠</span>';
    default: return '<span class="status-icon status-pending">○</span>';
  }
}

function parseError(flags) {
  for (const f of (flags||[])) {
    if (!f.startsWith('failed:')) continue;
    const err = f.slice(7);
    if (err.includes('401')) return 'API Key Invalid (401)';
    if (err.includes('403')) return 'Permission Denied (403)';
    if (err.includes('429')) return 'Rate Limited (429)';
    if (/timeout|timed out/i.test(err)) return 'Request Timeout';
    if (/connect/i.test(err)) return 'Connection Failed';
    return truncate(err.split('\n')[0], 60);
  }
  return '';
}

function classifyError(err) {
  if (!err) return null;
  if (err.includes('401')) return {label:'API Key', color:'var(--red)'};
  if (err.includes('429')) return {label:'Rate Limit', color:'var(--orange)'};
  if (/timeout/i.test(err)) return {label:'Timeout', color:'var(--yellow)'};
  if (/connect/i.test(err)) return {label:'Connection', color:'var(--magenta)'};
  return {label:'Error', color:'var(--red)'};
}

function scoreColor(score) {
  if (score >= 80) return 'var(--green)';
  if (score >= 60) return 'var(--yellow)';
  if (score >= 40) return 'var(--orange)';
  return 'var(--red)';
}

function toast(msg, type='success') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
}

// ══════════════════════════════════════════════════════════════════
//  SIDEBAR NAVIGATION
// ══════════════════════════════════════════════════════════════════

function toggleNavSection(titleEl) {
  const caret = titleEl.querySelector('.nav-caret');
  const collapsible = titleEl.nextElementSibling;
  if (!collapsible) return;
  const isOpen = collapsible.style.display !== 'none';
  collapsible.style.display = isOpen ? 'none' : 'block';
  if (caret) caret.classList.toggle('open', !isOpen);
}

function switchPanel(name) {
  currentPanel = name;
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.panel === name);
    // Auto-expand collapsed section if active item is inside it
    if (n.dataset.panel === name) {
      const collapsible = n.closest('.nav-collapsible');
      if (collapsible && collapsible.style.display === 'none') {
        collapsible.style.display = 'block';
        const caret = collapsible.previousElementSibling?.querySelector('.nav-caret');
        if (caret) caret.classList.add('open');
      }
    }
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const p = document.getElementById('panel-' + name);
  if (p) p.classList.add('active');

  // Load data for panel
  if (name === 'agents') loadAgents();
  if (name === 'skills') loadSkills();
  if (name === 'cleo-files') loadCfFiles();
  if (name === 'tools') loadTools();
  if (name === 'usage') loadUsage();
  if (name === 'config') loadConfig();
  if (name === 'gateway') loadGatewayInfo();
  if (name === 'health') loadDoctor();
  if (name === 'logs') initLogs();
  if (name === 'chain') loadChain();
  if (name === 'memory') loadMemory();
  if (name === 'channels') loadChannels();
  if (name === 'cron') loadCron();
  if (name === 'runtime') loadRuntime();
  if (name === 'a2a') loadA2A();
}

// ══════════════════════════════════════════════════════════════════
//  HEALTH POLLING
// ══════════════════════════════════════════════════════════════════

async function pollHealth() {
  const [data, hbData] = await Promise.all([api('/health'), api('/v1/heartbeat')]);
  const dot = document.getElementById('statusDot');
  if (data && data.status === 'ok') {
    dot.className = 'status-dot online';
    const onlineCount = hbData?.online || 0;
    const totalCount = data.agents || 0;
    document.getElementById('footerAgents').textContent = onlineCount + '/' + totalCount + ' agents online';
    document.getElementById('footerUptime').textContent = 'uptime ' + fmtTime(data.uptime_seconds);
    document.getElementById('footerPort').textContent = ':' + (data.port || 19789);
  } else {
    dot.className = 'status-dot offline';
  }
  // Cache heartbeat data for agent cards
  if (hbData && hbData.agents) {
    heartbeatData = {};
    for (const hb of hbData.agents) {
      heartbeatData[hb.agent_id] = hb;
    }
    // Update agent card status dots if panel is visible
    updateAgentStatusDots();
  }
}

function updateAgentStatusDots() {
  document.querySelectorAll('.agent-card .hb-dot').forEach(dot => {
    const aid = dot.dataset.agentId;
    const hb = heartbeatData[aid];
    if (hb && hb.online) {
      dot.className = 'hb-dot online';
      dot.title = hb.status === 'working' ? 'Working on: ' + (hb.task_id||'') : 'Idle';
    } else {
      dot.className = 'hb-dot offline';
      dot.title = 'Offline';
    }
  });
}

// ══════════════════════════════════════════════════════════════════
//  OVERVIEW — Dual Panel (Orchestration + ChatBox)
// ══════════════════════════════════════════════════════════════════

const AGENT_META = {
  leo:      {emoji:'📋', color:'var(--accent)',  cls:'leo',    label:'Leo',   avatar:'/avatars/leo.png'},
  jerry:    {emoji:'⚙️', color:'var(--cyan)',    cls:'jerry',  label:'Jerry', avatar:'/avatars/jerry.png'},
  alic:     {emoji:'🧠', color:'var(--magenta)', cls:'alic',   label:'Alic',  avatar:'/avatars/alic.png'},
  search:   {emoji:'🌐', color:'var(--accent)',  cls:'leo',    label:'Search'},
};

// Dynamic color/emoji palette for new agents
const _AGENT_COLORS = ['var(--green)','var(--yellow)','var(--red)','var(--blue)','var(--cyan)','var(--magenta)'];
const _AGENT_EMOJIS = ['🤖','🔧','📊','🎯','💡','🔬','📝','🛠️'];

function agentMeta(agentId) {
  const id = (agentId||'').toLowerCase();
  const known = AGENT_META[id];
  if (known) return {...known, icon: known.emoji};
  // Dynamic meta for new agents
  const hash = [...id].reduce((h,c) => ((h << 5) - h + c.charCodeAt(0))|0, 0);
  const color = _AGENT_COLORS[Math.abs(hash) % _AGENT_COLORS.length];
  const emoji = _AGENT_EMOJIS[Math.abs(hash) % _AGENT_EMOJIS.length];
  // Non-agent names (users) get a user icon
  if (!id || id === 'user') return {emoji:'👤', color:'var(--accent2)', cls:'user', label: agentId, icon:'👤'};
  return {
    emoji, color, cls: 'dynamic',
    label: id.charAt(0).toUpperCase() + id.slice(1),
    avatar: '/avatars/' + id + '.png',
    icon: emoji
  };
}
function avatarHtml(meta, size) {
  size = size || 28;
  if (meta.avatar) return '<img src="'+meta.avatar+'" style="width:'+size+'px;height:'+size+'px;border-radius:50%;object-fit:cover;flex-shrink:0" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'inline\'">'
    + '<span style="font-size:'+(size*0.5)+'px;display:none">'+meta.emoji+'</span>';
  return '<span style="font-size:'+(size*0.5)+'px">'+meta.emoji+'</span>';
}

// ── State ──
let chatAttachments = [];
let searchMode = false;
let chatLastRenderedIdx = 0;
let recentUsageCalls = [];
let liveStatusAgents = {};
let dispatchEntries = [];   // top panel log entries
let dispatchLastIdx = 0;

// ══════════════════════════════════════════════════════════════════
//  DUAL PANEL — Top: Dispatch Log  |  Bottom: ChatBox
// ══════════════════════════════════════════════════════════════════
// Top panel (#dispatchLog):  all agent orchestration — scheduling,
//   claimed, working, intermediate I/O, review scores, tokens, live status
// Bottom panel (#chatMessages): user messages + final completed results
//   styled like ChatGPT / Claude — only the polished end product

// ── Add entry to TOP dispatch log ──
function addDispatch(icon, agentId, text, opts={}) {
  const meta = agentMeta(agentId);
  const knownAgents = new Set(['leo','jerry','alic','search','system','advisor']);
  const isUser = !knownAgents.has((agentId||'').toLowerCase());
  dispatchEntries.push({
    id: ++chatMsgCounter,
    icon: icon || '•',
    agent: agentId,
    agentCls: meta.cls,
    isUser,
    text,
    ts: Date.now(),
    taskId: opts.taskId || null,
    promptTokens: opts.promptTokens || null,
    completionTokens: opts.completionTokens || null,
    result: opts.result || null,
    score: opts.score || null,
    scoreComment: opts.scoreComment || null,
    critiqueSpec: opts.critiqueSpec || null,
  });
  // Accumulation limit — prevent unbounded memory growth
  while (dispatchEntries.length > 500) dispatchEntries.shift();
}

// ── Add message to BOTTOM chatbox (user msgs + final AI results) ──
function addChatMsg(type, text, opts={}) {
  const msg = {
    id: ++chatMsgCounter,
    type, // 'user' | 'assistant' | 'system'
    agent: opts.agent || null,
    text,
    ts: Date.now(),
    taskId: opts.taskId || null,
    result: opts.result || null,
    score: opts.score || null,
    scoreComment: opts.scoreComment || null,
    critique: opts.critique || null,
    critiqueSpec: opts.critiqueSpec || null,
    images: opts.images || null,
    files: opts.files || null,
    searchResults: opts.searchResults || null,
    promptTokens: opts.promptTokens || null,
    completionTokens: opts.completionTokens || null,
  };
  chatMsgs.push(msg);
  // Accumulation limit — prevent unbounded memory growth
  while (chatMsgs.length > 200) chatMsgs.shift();
  return msg;
}

// ── Render a single dispatch entry (compact one-line, top panel) ──
function renderDispatchHtml(d) {
  let tokHtml = '';
  if (d.promptTokens || d.completionTokens) {
    tokHtml = '<span class="dispatch-tokens"><span class="tok-in">↑' + fmtNum(d.promptTokens||0)
      + '</span>/<span class="tok-out">↓' + fmtNum(d.completionTokens||0) + '</span></span>';
  }
  let text = escHtml(truncate(d.text, 120));
  // Expandable result for agent output in dispatch
  if (d.result) {
    const rid = 'dRes' + d.id;
    const cleanedResult = stripLlmTags(d.result);
    text += ' <span class="chat-result-toggle" onclick="toggleChatResult(\'' + rid + '\',this)" style="font-size:10px">▸ detail</span>'
      + '<div class="chat-result-content" id="' + rid + '" style="margin-top:3px"><pre style="font-size:10px;max-height:160px;overflow-y:auto;margin:0;padding:4px 6px">' + escHtml(cleanedResult) + '</pre></div>';
  }
  if (d.critiqueSpec) {
    try {
      const cs = typeof d.critiqueSpec === 'string' ? JSON.parse(d.critiqueSpec) : d.critiqueSpec;
      const verdict = cs.verdict || '';
      const composite = cs.composite_score != null ? cs.composite_score : '';
      const c = verdict === 'LGTM' ? 'var(--green)' : 'var(--red)';
      text += ' <span style="font-size:10px;font-weight:700;color:' + c + '">' + escHtml(verdict) + ' ' + composite + '/10</span>';
    } catch(e) {}
  } else if (d.score != null) {
    const c = scoreColor(d.score);
    text += ' <span style="font-size:10px;font-weight:700;color:' + c + '">' + d.score + '/100</span>';
    if (d.scoreComment) text += ' <span style="font-size:10px;color:var(--fg3)">' + escHtml(truncate(d.scoreComment, 60)) + '</span>';
  }
  const elapsed = ((Date.now() - d.ts) / 1000)|0;
  const timeStr = elapsed < 5 ? 'now' : elapsed < 60 ? elapsed + 's' : Math.floor(elapsed/60) + 'm';
  const dMeta = agentMeta(d.agent || '');
  const dAvIcon = dMeta.avatar ? '<img src="'+dMeta.avatar+'" style="width:14px;height:14px;border-radius:50%;object-fit:cover;vertical-align:middle">' : d.icon;
  return '<div class="dispatch-entry" data-d-id="' + d.id + '">'
    + '<span class="dispatch-icon">' + dAvIcon + '</span>'
    + '<span class="dispatch-agent ' + d.agentCls + '-d">' + escHtml(capitalize(d.agent || 'system')) + '</span>'
    + '<span class="dispatch-text">' + text + '</span>'
    + tokHtml
    + '<span class="dispatch-time">' + timeStr + '</span>'
    + '</div>';
}

// ── Incremental render for dispatch log (top panel) ──
function renderDispatch() {
  const container = document.getElementById('dispatchLog');
  if (container) {
    const newEntries = dispatchEntries.slice(dispatchLastIdx);
    if (newEntries.length) {
      const frag = document.createDocumentFragment();
      for (const d of newEntries) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = renderDispatchHtml(d);
        while (wrapper.firstChild) frag.appendChild(wrapper.firstChild);
      }
      container.appendChild(frag);
      container.scrollTop = container.scrollHeight;
    }
  }
  dispatchLastIdx = dispatchEntries.length;
  // Update header bar with latest 3 statuses
  updateHeaderStatuses();
}

function updateHeaderStatuses() {
  const el = document.getElementById('ovStatuses');
  if (!el) return;
  const latest = dispatchEntries.slice(-3);
  if (!latest.length) {
    el.innerHTML = '<span class="ov-status-empty">Ready — Submit a task to start</span>';
    return;
  }
  // Sort: user-submitted entries always first
  const sorted = [...latest].reverse();
  const knownAgents = new Set(['leo','jerry','alic','search','system','advisor']);
  sorted.sort((a, b) => {
    const aIsUser = !knownAgents.has((a.agent||'').toLowerCase());
    const bIsUser = !knownAgents.has((b.agent||'').toLowerCase());
    return aIsUser === bIsUser ? 0 : aIsUser ? -1 : 1;
  });
  let html = '';
  for (const d of sorted) {
    const aid = (d.agent||'').toLowerCase();
    const isUser = !knownAgents.has(aid);
    const agentCls = aid.replace(/[^a-z]/g,'');
    const colorCls = agentCls.includes('leo') ? 'leo-d' : agentCls.includes('jerry') ? 'jerry-d' : agentCls.includes('alic') ? 'alic-d' : '';
    const sMeta = agentMeta(d.agent || '');
    const sIcon = sMeta.avatar ? '<img src="'+sMeta.avatar+'">' : (sMeta.emoji || '▸');
    // User entries: show name as-is (lowercase); agents: capitalize
    const agentName = isUser ? (d.agent || 'You') : capitalize(d.agent || 'system');
    const statusText = titleCase(truncate(cleanTaskDesc(d.text || ''), 30));
    html += '<div class="ov-status-item">'
      + '<span class="status-icon">' + sIcon + '</span>'
      + '<span class="status-agent ' + colorCls + '">' + escHtml(agentName) + '</span>'
      + '<span class="status-text">' + escHtml(statusText) + '</span>'
      + '</div>';
  }
  el.innerHTML = html;
}

// ── Render a single chat message (bottom panel, ChatGPT-style) ──
function renderChatMsgHtml(m) {
  if (m.type === 'user') {
    let content = escHtml(m.text);
    if (m.images && m.images.length) {
      content += '<div class="chat-images">';
      for (const img of m.images) content += '<img src="' + img.dataUrl + '" alt="' + escHtml(img.name) + '" onclick="window.open(this.src)">';
      content += '</div>';
    }
    if (m.files && m.files.length) {
      for (const f of m.files) content += '<div class="chat-file-badge">📄 ' + escHtml(f.name) + '</div>';
    }
    return '<div class="chat-msg user" data-msg-id="' + m.id + '">'
      + '<div class="chat-avatar user-av">👤</div>'
      + '<div class="chat-bubble user-bubble">' + content + '</div></div>';
  }
  if (m.type === 'system') {
    return '<div class="chat-msg system" data-msg-id="' + m.id + '">'
      + '<div class="chat-bubble system-bubble">' + escHtml(m.text) + '</div></div>';
  }
  // ── Assistant response (final result, like Claude/ChatGPT) ──
  if (m.type === 'assistant') {
    const resultText = m.result || m.text || '';
    // Format the result nicely
    let bodyHtml = formatResultBody(resultText);
    // Critique / Score line — V0.02 CritiqueSpec > critique > legacy score
    let scoreHtml = '';
    if (m.critiqueSpec) {
      // V0.02: Full 5D CritiqueSpec
      try {
        const cs = typeof m.critiqueSpec === 'string' ? JSON.parse(m.critiqueSpec) : m.critiqueSpec;
        const d = cs.dimensions || {};
        const verdict = cs.verdict || 'N/A';
        const composite = cs.composite_score != null ? cs.composite_score : 'N/A';
        const verdictColor = verdict === 'LGTM' ? 'var(--green)' : 'var(--red)';
        const verdictBg = verdict === 'LGTM' ? 'rgba(34,197,94,.12)' : 'rgba(239,68,68,.12)';
        const verdictIcon = verdict === 'LGTM' ? '✓' : '⚠';
        scoreHtml = '<div style="margin-top:8px">'
          + '<span class="chat-score" style="background:' + verdictBg + ';color:' + verdictColor + '">'
          + verdictIcon + ' ' + escHtml(verdict) + ' (' + composite + '/10)</span>'
          + '<div style="font-size:10px;color:var(--fg3);margin-top:4px">'
          + 'Acc=' + (d.accuracy||'?') + ' Comp=' + (d.completeness||'?')
          + ' Tech=' + (d.technical||'?') + ' Cal=' + (d.calibration||'?')
          + ' Eff=' + (d.efficiency||'?') + '</div>';
        const items = cs.items || [];
        if (items.length) {
          scoreHtml += '<ul style="margin:4px 0 0 16px;font-size:11px;color:var(--fg2)">';
          for (const it of items) {
            scoreHtml += '<li>[' + escHtml(it.dimension||'') + '] ' + escHtml(it.issue||'');
            if (it.suggestion) scoreHtml += ' → ' + escHtml(it.suggestion);
            scoreHtml += '</li>';
          }
          scoreHtml += '</ul>';
        }
        scoreHtml += '</div>';
      } catch(e) { /* fall through */ }
    }
    if (!scoreHtml && m.critique) {
      // V0.02 critique object (without full spec)
      const cr = m.critique;
      if (cr.passed) {
        scoreHtml = '<div style="margin-top:8px"><span class="chat-score" style="background:rgba(34,197,94,.12);color:var(--green)">✓ Approved</span>';
        if (cr.comment) scoreHtml += ' <span style="font-size:11px;color:var(--fg2)">' + escHtml(truncate(cr.comment, 120)) + '</span>';
        scoreHtml += '</div>';
      } else {
        scoreHtml = '<div style="margin-top:8px"><span class="chat-score" style="background:rgba(239,68,68,.12);color:var(--red)">⚠ Revised</span>';
        if (cr.comment) scoreHtml += ' <span style="font-size:11px;color:var(--fg2)">' + escHtml(truncate(cr.comment, 120)) + '</span>';
        if (cr.suggestions && cr.suggestions.length) {
          scoreHtml += '<ul style="margin:4px 0 0 16px;font-size:11px;color:var(--fg2)">';
          for (const s of cr.suggestions) scoreHtml += '<li>' + escHtml(s) + '</li>';
          scoreHtml += '</ul>';
        }
        scoreHtml += '</div>';
      }
    }
    if (!scoreHtml && m.score != null) {
      // V0.01 legacy: score/100
      const c = scoreColor(m.score);
      scoreHtml = '<div style="margin-top:8px"><span class="chat-score" style="background:rgba(55,115,255,.1);color:' + c + '">'
        + m.score + '/100</span>';
      if (m.scoreComment) scoreHtml += ' <span style="font-size:11px;color:var(--fg2)">' + escHtml(truncate(m.scoreComment, 120)) + '</span>';
      scoreHtml += '</div>';
    }
    // Search results
    let searchHtml = '';
    if (m.searchResults && m.searchResults.length) {
      searchHtml = '<div class="chat-search-results" style="margin-top:8px">';
      for (const sr of m.searchResults) {
        searchHtml += '<div class="chat-search-card"><a href="' + escHtml(sr.url) + '" target="_blank">' + escHtml(sr.title) + '</a>';
        if (sr.snippet) searchHtml += '<div class="search-snippet">' + escHtml(truncate(sr.snippet, 120)) + '</div>';
        searchHtml += '</div>';
      }
      searchHtml += '</div>';
    }
    // Token footer
    let tokenHtml = '';
    if (m.promptTokens || m.completionTokens) {
      tokenHtml = '<div class="asst-tokens">'
        + '<span>↑ ' + fmtNum(m.promptTokens||0) + ' in</span>'
        + '<span>↓ ' + fmtNum(m.completionTokens||0) + ' out</span>'
        + '</div>';
    }
    const aM = agentMeta(m.agent || '');
    const agentLabel = capitalize(m.agent) || 'Cleo';
    const avatarContent = avatarHtml(aM, 28);
    const avatarBg = m.agent ? aM.color : 'linear-gradient(135deg,var(--accent),var(--cyan))';
    // Wrap long content in a collapsible container
    const isLong = (resultText.length > 500);
    const wrapCls = isLong ? 'asst-body-wrap collapsed expandable' : 'asst-body-wrap';
    const expandBtn = isLong ? '<button class="msg-expand-btn" onclick="toggleMsgExpand(this)">▼ Show more</button>' : '';
    return '<div class="chat-msg assistant" data-msg-id="' + m.id + '">'
      + '<div class="chat-avatar ' + aM.cls + '">' + avatarContent + '</div>'
      + '<div class="chat-bubble assistant-bubble">'
      + '<div class="asst-header"><span class="asst-label" style="color:' + aM.color + '">' + escHtml(agentLabel) + '</span></div>'
      + '<div class="' + wrapCls + '"><div class="asst-body">' + bodyHtml + '</div></div>'
      + expandBtn
      + scoreHtml + searchHtml + tokenHtml
      + '</div></div>';
  }
  return '';
}

// ── Rendering caches (hot-path optimization) ──
const _stripCache = new Map();
function stripLlmTagsCached(text) {
  if (!text) return '';
  const key = text.length + ':' + text.slice(0, 60) + ':' + text.slice(-60);
  const cached = _stripCache.get(key);
  if (cached !== undefined) return cached;
  const result = stripLlmTags(text);
  if (_stripCache.size > 300) _stripCache.clear();
  _stripCache.set(key, result);
  return result;
}

// Shared helper: strip injected conversation history from task descriptions / results
function _stripConversationHistory(text) {
  // Full sweep: "## 对话历史 (Conversation History)" through "## 当前消息 (Current Message)"
  text = text.replace(/##\s*(?:对话历史|Conversation History)\s*(?:\(Conversation History\))?[\s\S]*?##\s*(?:当前消息|Current Message)\s*(?:\(Current Message\))?\s*\n?/g, '');
  // Fallback: history block without current message marker
  text = text.replace(/##\s*(?:对话历史|Conversation History)[\s\S]*?---\s*\n*/g, '');
  text = text.replace(/##\s*(?:当前消息|Current Message)\s*(?:\(Current Message\))?\s*\n?/g, '');
  // Strip **[username]** session context lines
  text = text.replace(/^\*\*\[[^\]]+\]\*\*.*$/gm, '');
  return text;
}

// Format result text into nice readable HTML — lightweight markdown renderer
function stripLlmTags(text) {
  // Strip <think>...</think> blocks (complete)
  text = text.replace(/<think>[\s\S]*?<\/think>/g, '');
  // Strip <think> without closing tag (streaming — still thinking)
  text = text.replace(/<think>[\s\S]*$/g, '');
  // Strip <tool_code>...</tool_code> blocks (complete)
  text = text.replace(/<tool_code>[\s\S]*?<\/tool_code>/g, '');
  // Strip <tool_code> without closing tag (streaming — tool being written)
  text = text.replace(/<tool_code>[\s\S]*$/g, '');
  // Strip other common LLM tags (open or closed)
  text = text.replace(/<tool_call>[\s\S]*?(<\/tool_call>|$)/g, '');
  text = text.replace(/<function_calls>[\s\S]*?(<\/function_calls>|$)/g, '');
  text = text.replace(/<tool_result>[\s\S]*?(<\/tool_result>|$)/g, '');
  // Strip Minimax-specific tool call XML (complete or streaming)
  text = text.replace(/<minimax:tool_call>[\s\S]*?(<\/minimax:tool_call>|$)/g, '');
  // Strip <artifact>...</artifact> blocks (routed to sidebar)
  text = text.replace(/<artifact(?:\s[^>]*)?>[\s\S]*?(<\/artifact>|$)/g, '');
  // Strip generic XML tool patterns: <invoke>, <parameter>, <tool_use>
  text = text.replace(/<invoke[\s\S]*?(<\/invoke>|$)/g, '');
  text = text.replace(/<parameter[\s\S]*?(<\/parameter>|$)/g, '');
  text = text.replace(/<tool_use[\s\S]*?(<\/tool_use>|$)/g, '');
  // Strip raw JSON tool objects that leak through ({"tool": "...", "params": ...})
  text = text.replace(/^\s*\{"tool"\s*:\s*"[^"]*"[\s\S]*$/gm, '');
  // Strip orchestration artifacts (TASK:, COMPLEXITY:, Phase headers)
  text = text.replace(/^TASK:\s*.+$/gm, '');
  text = text.replace(/^COMPLEXITY:\s*.+$/gm, '');
  text = text.replace(/^##\s*Phase\s+\d+.*$/gm, '');
  text = text.replace(/^\*\*TASK:\*\*\s*.+$/gm, '');
  text = text.replace(/^\*\*COMPLEXITY:\*\*\s*.+$/gm, '');
  // Strip conversation history injection (delegates to shared helper)
  text = _stripConversationHistory(text);
  // Strip agent comment markers (<!-- agent:xxx task:xxx -->)
  text = text.replace(/<!--\s*agent:[\s\S]*?-->/g, '');
  // Strip task status lines (■ 当前状 — 1/1, ● task description)
  text = text.replace(/^[■●]\s+.{0,120}$/gm, '');
  // Strip --- separator lines (orchestration artifacts)
  text = text.replace(/^---\s*$/gm, '');
  // Clean up excessive blank lines left after stripping
  text = text.replace(/\n{3,}/g, '\n\n');
  return text.trim();
}

/* Convert HTML formatting tags (from Telegram adapter / LLM output) to Markdown
   so the downstream renderMarkdown() can process them properly. */
function htmlToMd(text) {
  // Code blocks: <pre><code>...</code></pre> → ```...```
  text = text.replace(/<pre[^>]*><code[^>]*>([\s\S]*?)<\/code><\/pre>/gi, (_,c)=>'```\n'+c+'\n```');
  text = text.replace(/<pre[^>]*>([\s\S]*?)<\/pre>/gi, (_,c)=>'```\n'+c+'\n```');
  // Inline code
  text = text.replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`');
  // Bold
  text = text.replace(/<(?:b|strong)[^>]*>(.*?)<\/(?:b|strong)>/gi, '**$1**');
  // Italic
  text = text.replace(/<(?:i|em)[^>]*>(.*?)<\/(?:i|em)>/gi, '*$1*');
  // Strikethrough
  text = text.replace(/<(?:s|del)[^>]*>(.*?)<\/(?:s|del)>/gi, '~~$1~~');
  // Links
  text = text.replace(/<a\s+href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
  // Line breaks
  text = text.replace(/<br\s*\/?>/gi, '\n');
  // List items → bullet
  text = text.replace(/<li[^>]*>(.*?)<\/li>/gi, '• $1\n');
  text = text.replace(/<\/?[uo]l[^>]*>/gi, '\n');
  // Blockquote
  text = text.replace(/<blockquote[^>]*>([\s\S]*?)<\/blockquote>/gi, (_,c)=>c.split('\n').map(l=>'> '+l.trim()).join('\n'));
  // Strip remaining tags (div, span, p, etc.)
  text = text.replace(/<\/?(?:div|span|p|h[1-6]|section|article|header|footer|nav)[^>]*>/gi, '\n');
  text = text.replace(/<[^>]+>/g, '');
  // Decode common HTML entities the model may emit
  text = text.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'");
  text = text.replace(/\n{3,}/g, '\n\n');
  return text.trim();
}

function _buildResultStepsHtml(rawText) {
  // Build Claude-style process steps for completed results
  const steps = [];
  const thinkBlocks = rawText.match(/<think>[\s\S]*?<\/think>/g);
  if (thinkBlocks) steps.push({icon:'💭', label:'Thought', count:thinkBlocks.length});
  // Standard <tool_code> JSON format
  const toolBlocks = rawText.match(/<tool_code>[\s\S]*?<\/tool_code>/g);
  if (toolBlocks) {
    for (const tc of toolBlocks) {
      let label = 'Used Tool';
      try { const obj = JSON.parse(tc.replace(/<\/?tool_code>/g,'')); if(obj.tool) label='Used '+titleCase(obj.tool.replace(/[_-]/g,' ')); } catch(e){}
      steps.push({icon:'✓', label});
    }
  }
  // Minimax <minimax:tool_call> XML format
  const mmBlocks = rawText.match(/<minimax:tool_call>[\s\S]*?<\/minimax:tool_call>/g);
  if (mmBlocks) {
    for (const mc of mmBlocks) {
      let label = 'Used Tool';
      const nameMatch = mc.match(/<invoke\s+name="([^"]+)"/);
      if (nameMatch) label = 'Used ' + titleCase(nameMatch[1].replace(/[_-]/g, ' '));
      steps.push({icon:'✓', label});
    }
  }
  if (!steps.length) return '';
  let html = '<div class="stream-steps" style="margin-bottom:10px">';
  for (const s of steps) {
    html += '<div class="stream-step step-done"><span class="step-icon">'+s.icon+'</span><span class="step-label">'+escHtml(s.label)+'</span></div>';
  }
  html += '</div>';
  return html;
}

function formatResultBody(text) {
  if (!text) return '';
  const rawText = text;
  // Strip LLM artifacts before rendering
  text = stripLlmTags(text);
  // Convert HTML tags (from Telegram adapter output) to Markdown
  text = htmlToMd(text);
  const stepsHtml = _buildResultStepsHtml(rawText);
  if (!text) {
    // Entire output was tool calls / thinking — show steps + friendly status
    if (rawText.includes('<tool_code>') || rawText.includes('{"tool"') || rawText.includes('<minimax:tool_call>'))
      return stepsHtml + '<span style="color:var(--fg2)">✓ Done — results sent to planner for synthesis.</span>';
    return '<span style="color:var(--fg2)">✓ Completed</span>';
  }
  // Try JSON — render task arrays as cards, other JSON as pretty-print
  try {
    const obj = JSON.parse(text);
    // Task decomposition array: [{"task": "...", "role": "..."}]
    if (Array.isArray(obj) && obj.length && obj[0].task) {
      let html = '<div class="task-decomp">';
      for (let i = 0; i < obj.length; i++) {
        const t = obj[i];
        const roleIcon = t.role === 'implement' ? '⚡' : t.role === 'research' ? '🔍' : t.role === 'review' ? '🧠' : '📋';
        const roleBadge = t.role ? '<span class="task-role-badge">' + escHtml(t.role) + '</span>' : '';
        html += '<div class="task-decomp-item">'
          + '<span class="task-decomp-num">' + roleIcon + '</span>'
          + '<span class="task-decomp-text">' + escHtml(t.task) + '</span>'
          + roleBadge + '</div>';
      }
      html += '</div>';
      return stepsHtml + html;
    }
    return '<pre>' + escHtml(JSON.stringify(obj, null, 2)) + '</pre>';
  } catch(e) {}
  // Render markdown then enhance with file/image detection
  let html = renderMarkdown(text);
  // Detect file paths in the rendered output and make them actionable
  html = enhanceFilePaths(html, text);
  return stepsHtml + html;
}

function enhanceFilePaths(html, rawText) {
  // Detect file paths mentioned in the raw text (before HTML rendering)
  const filePattern = /(?:^|\s)(\/[\w\-\.\/]+\.(pdf|png|jpg|jpeg|gif|csv|xlsx|json|txt|md|py|js|html|svg))(?:\s|$|[,;])/gi;
  const matches = [...new Set((rawText.match(filePattern) || []).map(m => m.trim().replace(/[,;]$/, '')))];
  if (!matches.length) return html;

  // Add file cards at the end
  let fileCards = '<div class="chat-file-cards" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px">';
  for (const fpath of matches) {
    const fname = fpath.split('/').pop();
    const ext = fname.split('.').pop().toLowerCase();
    const isImage = ['png','jpg','jpeg','gif','svg','webp'].includes(ext);
    const isPdf = ext === 'pdf';
    const isData = ['csv','xlsx','json'].includes(ext);
    const icon = isImage ? '🖼️' : isPdf ? '📄' : isData ? '📊' : '📎';
    const downloadUrl = '/v1/file?path=' + encodeURIComponent(fpath);
    fileCards += '<a class="chat-file-card" href="' + downloadUrl + '" target="_blank" rel="noopener" title="' + escHtml(fpath) + '">'
      + '<span class="file-icon">' + icon + '</span>'
      + '<span class="file-info"><span class="file-name">' + escHtml(fname) + '</span>'
      + '<span class="file-path">' + escHtml(fpath) + '</span></span>'
      + '</a>';
  }
  fileCards += '</div>';
  return html + fileCards;
}

function renderMarkdown(src) {
  // 1) Extract fenced code blocks (protect from processing)
  const codeBlocks = [];
  let _cbId = 0;
  let s = src.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    // Subtask specs → render as styled cards instead of code blocks
    if (lang === 'subtask') {
      try {
        const spec = JSON.parse(code.trim());
        const cplx = spec.complexity || 'normal';
        const cplxColor = cplx === 'complex' ? 'var(--red)' : cplx === 'simple' ? 'var(--green)' : 'var(--fg2)';
        const constraints = (spec.constraints || []).map(c => '<span class="subtask-constraint">' + escHtml(c) + '</span>').join('');
        const tools = (spec.tool_hint || []).map(t => '<span class="subtask-tool">' + escHtml(t) + '</span>').join('');
        const outFmt = spec.output_format ? '<span class="subtask-output">' + escHtml(spec.output_format) + '</span>' : '';
        const metaParts = [constraints, tools, outFmt].filter(Boolean).join('');
        const metaHtml = metaParts ? '<div class="subtask-meta">' + metaParts + '</div>' : '';
        const cardHtml = '<div class="subtask-card">'
          + '<div class="subtask-header">'
          + '<span class="subtask-icon">\uD83D\uDCCB</span>'
          + '<span class="subtask-objective">' + escHtml(spec.objective || '') + '</span>'
          + '<span class="subtask-complexity" style="color:' + cplxColor + '">' + escHtml(cplx) + '</span>'
          + '</div>' + metaHtml + '</div>';
        const idx = codeBlocks.length;
        codeBlocks.push(cardHtml);
        return '\x00CB' + idx + '\x00';
      } catch(e) { /* fall through to normal code block */ }
    }
    const i = codeBlocks.length;
    const cbid = 'cb_' + (++_cbId) + '_' + Date.now();
    const langLabel = lang || 'code';
    const header = '<div class="code-block-header"><span class="code-lang">' + escHtml(langLabel) + '</span>'
      + '<button class="code-copy-btn" onclick="copyCodeBlock(this,\'' + cbid + '\')" title="Copy">Copy</button></div>';
    codeBlocks.push(header + '<pre id="' + cbid + '"><code' + (lang ? ' class="lang-'+escHtml(lang)+'"' : '') + '>' + escHtml(code.trimEnd()) + '</code></pre>');
    return '\x00CB' + i + '\x00';
  });

  const lines = s.split('\n');
  let html = '';
  let inList = false, listType = '';
  let i = 0;

  function closeList() { if (inList) { html += '</' + listType + '>'; inList = false; } }

  while (i < lines.length) {
    let line = lines[i];

    // Code block placeholder
    const cbMatch = line.match(/^\x00CB(\d+)\x00$/);
    if (cbMatch) { closeList(); html += codeBlocks[parseInt(cbMatch[1])]; i++; continue; }

    // Table: detect header row + separator row (| --- | --- |)
    if (line.trim().startsWith('|') && i + 1 < lines.length && /^\|[\s:]*-{2,}[\s:]*(\|[\s:]*-{2,}[\s:]*)*\|?\s*$/.test(lines[i+1])) {
      closeList();
      const parseRow = (r) => r.replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim());
      // Parse alignment from separator
      const sepCols = parseRow(lines[i+1]);
      const aligns = sepCols.map(c => {
        if (c.startsWith(':') && c.endsWith(':')) return 'center';
        if (c.endsWith(':')) return 'right';
        return 'left';
      });
      const hdrCols = parseRow(line);
      html += '<table><thead><tr>';
      for (let c = 0; c < hdrCols.length; c++) {
        const a = aligns[c] || 'left';
        html += '<th style="text-align:' + a + '">' + inlineFmt(hdrCols[c]) + '</th>';
      }
      html += '</tr></thead><tbody>';
      i += 2; // skip header + separator
      while (i < lines.length && lines[i].trim().startsWith('|')) {
        const cols = parseRow(lines[i]);
        html += '<tr>';
        for (let c = 0; c < cols.length; c++) {
          const a = aligns[c] || 'left';
          html += '<td style="text-align:' + a + '">' + inlineFmt(cols[c]) + '</td>';
        }
        html += '</tr>';
        i++;
      }
      html += '</tbody></table>';
      continue;
    }

    // Headers h1-h6
    const hMatch = line.match(/^(#{1,6})\s+(.+)$/);
    if (hMatch) { closeList(); const lvl = hMatch[1].length; html += '<h' + lvl + '>' + inlineFmt(hMatch[2]) + '</h' + lvl + '>'; i++; continue; }

    // Task list (checkbox)
    const taskMatch = line.match(/^[\s]*[-*\u2022]\s+\[([ xX])\]\s+(.+)$/);
    if (taskMatch) {
      if (!inList || listType !== 'ul') { closeList(); html += '<ul style="list-style:none;padding-left:4px">'; inList = true; listType = 'ul'; }
      const checked = taskMatch[1] !== ' ';
      const icon = checked ? '<span style="color:var(--green);margin-right:6px">☑</span>' : '<span style="color:var(--fg3);margin-right:6px">☐</span>';
      html += '<li style="display:flex;align-items:flex-start;gap:0">' + icon + '<span' + (checked?' style="color:var(--fg3);text-decoration:line-through"':'') + '>' + inlineFmt(taskMatch[2]) + '</span></li>';
      i++; continue;
    }

    // Unordered list
    const ulMatch = line.match(/^[\s]*[-*\u2022\u2023\u25E6\u2043\u2219]\s+(.+)$/);
    if (ulMatch) {
      if (!inList || listType !== 'ul') { closeList(); html += '<ul>'; inList = true; listType = 'ul'; }
      html += '<li>' + inlineFmt(ulMatch[1]) + '</li>'; i++; continue;
    }

    // Ordered list — render number manually to avoid monospace font ambiguity (1 vs l)
    const olMatch = line.match(/^[\s]*(\d+)[.)]\s+(.+)$/);
    if (olMatch) {
      const olNum = parseInt(olMatch[1], 10);
      if (!inList || listType !== 'ol') {
        closeList();
        html += '<ol class="md-ol">';
        inList = true; listType = 'ol';
      }
      html += '<li><span class="ol-num">' + olNum + '.</span> ' + inlineFmt(olMatch[2]) + '</li>'; i++; continue;
    }

    // Non-list line closes any open list
    if (inList) closeList();

    // Horizontal rule
    if (/^[-*_]{3,}\s*$/.test(line.trim())) { html += '<hr>'; i++; continue; }

    // Blockquote (multi-line)
    const bqMatch = line.match(/^>\s?(.*)$/);
    if (bqMatch) {
      let bqContent = inlineFmt(bqMatch[1]);
      while (i + 1 < lines.length && /^>\s?/.test(lines[i + 1])) {
        i++;
        bqContent += '<br>' + inlineFmt(lines[i].replace(/^>\s?/, ''));
      }
      html += '<blockquote>' + bqContent + '</blockquote>';
      i++; continue;
    }

    // Empty line
    if (line.trim() === '') { i++; continue; }

    // Normal paragraph
    html += '<p>' + inlineFmt(line) + '</p>';
    i++;
  }
  closeList();
  return html;
}

function inlineFmt(s) {
  s = escHtml(s);
  // images: ![alt](url)
  s = s.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" class="md-img" loading="lazy">');
  // links: [text](url)
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  // bold+italic
  s = s.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  // bold
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // italic
  s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // strikethrough
  s = s.replace(/~~(.+?)~~/g, '<del>$1</del>');
  // inline code
  s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
  // bare URLs → clickable links (only if not already in an href or src)
  s = s.replace(/(?<!="|=')((https?:\/\/)[^\s<"']+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
  return s;
}

function copyCodeBlock(btn, preId) {
  const pre = document.getElementById(preId);
  if (!pre) return;
  const text = pre.textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    btn.textContent = 'Failed';
    setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
  });
}

function toggleMsgExpand(btn) {
  const wrap = btn.previousElementSibling;
  if (!wrap) return;
  const isCollapsed = wrap.classList.contains('collapsed');
  if (isCollapsed) {
    wrap.style.maxHeight = wrap.scrollHeight + 'px';
    wrap.classList.remove('collapsed');
    btn.textContent = '▲ Show less';
    setTimeout(() => { wrap.style.maxHeight = 'none'; }, 360);
  } else {
    wrap.style.maxHeight = wrap.scrollHeight + 'px';
    requestAnimationFrame(() => {
      wrap.style.maxHeight = '260px';
      wrap.classList.add('collapsed');
      btn.textContent = '▼ Show more';
    });
  }
}

// ── Incremental render for chat messages (bottom panel) ──
function renderChat() {
  const container = document.getElementById('chatMessages');
  if (!chatMsgs.length) {
    chatLastRenderedIdx = 0;
    container.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">⬡</div>'
      + '<div class="chat-welcome-text">What can I help you with?</div>'
      + '<div class="chat-welcome-sub">Your task will be planned, executed, and reviewed by the Cleo agent team</div></div>';
    return;
  }
  // First render: replace welcome
  if (chatLastRenderedIdx === 0 && container.querySelector('.chat-welcome')) {
    container.innerHTML = '';
  }
  const newMsgs = chatMsgs.slice(chatLastRenderedIdx);
  if (newMsgs.length) {
    const frag = document.createDocumentFragment();
    for (const m of newMsgs) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = renderChatMsgHtml(m);
      while (wrapper.firstChild) frag.appendChild(wrapper.firstChild);
    }
    container.appendChild(frag);
    chatLastRenderedIdx = chatMsgs.length;
    // Use rAF to scroll after DOM paint for reliable positioning
    requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
  }
}

function toggleChatResult(id, el) {
  const div = document.getElementById(id);
  if (!div) return;
  div.classList.toggle('open');
  el.textContent = div.classList.contains('open') ? '▾ hide' : '▸ detail';
}

// ══════════════════════════════════════════════════════════════════
//  FILE UPLOAD
// ══════════════════════════════════════════════════════════════════

function handleFileSelect(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    const reader = new FileReader();
    const isImage = file.type.startsWith('image/');
    reader.onload = () => {
      chatAttachments.push({
        name: file.name, type: file.type,
        dataUrl: reader.result, isImage, size: file.size
      });
      renderAttachments();
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function removeAttachment(idx) {
  chatAttachments.splice(idx, 1);
  renderAttachments();
}

function renderAttachments() {
  const container = document.getElementById('chatAttachments');
  if (!chatAttachments.length) { container.style.display = 'none'; return; }
  container.style.display = 'flex';
  let html = '';
  chatAttachments.forEach((a, i) => {
    html += '<div class="chat-attach-thumb">';
    html += '<span class="chat-attach-remove" onclick="removeAttachment(' + i + ')">×</span>';
    if (a.isImage) {
      html += '<img src="' + a.dataUrl + '" alt="' + escHtml(a.name) + '">';
    } else {
      html += '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:18px">📄</div>';
    }
    html += '<div class="chat-attach-name">' + escHtml(a.name) + '</div></div>';
  });
  container.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════
//  SEARCH MODE (Brave Search)
// ══════════════════════════════════════════════════════════════════

function toggleSearchMode() {
  searchMode = !searchMode;
  const btn = document.getElementById('searchToggle');
  btn.classList.toggle('active', searchMode);
  const input = document.getElementById('chatInput');
  input.placeholder = searchMode ? '🔍 Enter search query…' : 'Message Cleo…';
}

async function braveSearch(query) {
  try {
    const result = await apiPost('/v1/search', {query});
    if (result && result.results) return result.results;
    return null;
  } catch(e) { return null; }
}

// ══════════════════════════════════════════════════════════════════
//  SUBMIT TASK — routes user msg → bottom, task creation → top
// ══════════════════════════════════════════════════════════════════

async function chatSubmit() {
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('chatSend');
  const desc = input.value.trim();
  if (!desc) return;

  const images = chatAttachments.filter(a => a.isImage);
  const files = chatAttachments.filter(a => !a.isImage);

  // User message → BOTTOM chatbox
  addChatMsg('user', desc, {images: images.length ? images : null, files: files.length ? files : null});
  renderChat();
  input.value = '';
  input.style.height = 'auto';
  btn.disabled = true;
  chatAttachments = [];
  renderAttachments();

  // ── Search mode ──
  if (searchMode) {
    addDispatch('🔍', 'search', 'Searching: ' + truncate(desc, 60));
    renderDispatch();

    const results = await braveSearch(desc);
    if (results && results.length) {
      addDispatch('✓', 'search', 'Found ' + results.length + ' results');
      renderDispatch();

      // Show search results in bottom chatbox as assistant message
      addChatMsg('assistant', 'Found ' + results.length + ' results for "' + truncate(desc, 40) + '"', {
        agent: 'search', searchResults: results.slice(0, 5)
      });
      renderChat();

      // Submit enriched task
      const context = results.slice(0, 3).map(r => r.title + ': ' + (r.snippet||'')).join('\n');
      const enrichedDesc = desc + '\n\n[Search Context]\n' + context;
      const result = await apiPost('/v1/task', {description: enrichedDesc});
      if (result && result.task_id) {
        addDispatch('📤', 'system', 'Task created with search context: ' + result.task_id.slice(0,8) + '…', {taskId: result.task_id});
        chatTaskMap[result.task_id] = new Set(['created']);
        renderDispatch();
      }
    } else {
      addDispatch('⚠', 'search', 'No results found, submitting without context');
      const result = await apiPost('/v1/task', {description: desc});
      if (result && result.task_id) {
        addDispatch('📤', 'system', 'Task created: ' + result.task_id.slice(0,8) + '…', {taskId: result.task_id});
        chatTaskMap[result.task_id] = new Set(['created']);
      }
      renderDispatch();
    }
    btn.disabled = false;
    setTimeout(pollChatUpdates, 500);
    return;
  }

  // ── Auto-create session if none selected ──
  if (!currentSessionId) {
    const autoTitle = desc.length > 50 ? desc.substring(0, 47) + '…' : desc;
    const ns = await apiPost('/v1/sessions', {title: autoTitle});
    if (ns && ns.session_id) {
      currentSessionId = ns.session_id;
      localStorage.setItem('cleo_current_session', currentSessionId);
      loadSessions();
    }
  }

  // ── Normal mode ──
  let taskDesc = desc;
  if (files.length) {
    const fileContexts = files.map(f => {
      const base64 = f.dataUrl.split(',')[1] || '';
      try { return '[File: ' + f.name + ']\n' + atob(base64); } catch(e) { return '[File: ' + f.name + ']'; }
    });
    taskDesc += '\n\n' + fileContexts.join('\n\n');
  }
  if (images.length) {
    taskDesc += '\n\n[' + images.length + ' image(s) attached]';
  }

  const payload = {description: taskDesc};
  if (currentSessionId) payload.session_id = currentSessionId;
  const result = await apiPost('/v1/task', payload);
  if (result && result.task_id) {
    // Task creation goes to TOP dispatch
    addDispatch('📤', 'system', 'Task Submitted: ' + result.task_id.slice(0,8) + '…', {taskId: result.task_id});
    chatTaskMap[result.task_id] = new Set(['created']);
    // Start SSE token-level streaming for this task
    startTaskStream(result.task_id);
  } else {
    addChatMsg('system', '✗ Failed to submit task');
    renderChat();
  }
  renderDispatch();
  btn.disabled = false;
  setTimeout(pollChatUpdates, 500);
}

// ══════════════════════════════════════════════════════════════════
//  DASHBOARD SESSIONS
// ══════════════════════════════════════════════════════════════════

async function loadSessions() {
  const data = await api('/v1/sessions');
  if (!data || !data.sessions) return;
  dashboardSessions = data.sessions;
  renderSessionList();
}

function renderSessionList() {
  const container = document.getElementById('sessionList');
  if (!container) return;
  if (!dashboardSessions.length) {
    container.innerHTML = '<div style="padding:8px 10px;color:var(--fg3);font-size:11px">No sessions yet</div>';
    return;
  }
  const sorted = [...dashboardSessions].sort((a, b) => {
    if (a.pinned !== b.pinned) return b.pinned ? 1 : -1;
    return b.last_active - a.last_active;
  });
  container.innerHTML = sorted.map(s => {
    const isActive = s.session_id === currentSessionId;
    const timeAgo = fmtTimeAgo(s.last_active);
    const title = escHtml(s.title || 'New Chat');
    const sid = escHtml(s.session_id);
    return '<div class="session-item' + (isActive ? ' active' : '') + '" '
      + 'onclick="switchSession(\'' + sid + '\')" '
      + 'data-session-id="' + sid + '">'
      + '<span class="session-title">' + (s.pinned ? '📌 ' : '') + title + '</span>'
      + '<span class="session-time">' + timeAgo + '</span>'
      + '<span class="session-actions">'
      + '<button class="session-action-btn" onclick="event.stopPropagation();renameSession(\'' + sid + '\')" title="Rename">✏️</button>'
      + '<button class="session-action-btn" onclick="event.stopPropagation();deleteSession(\'' + sid + '\')" title="Delete">🗑</button>'
      + '</span></div>';
  }).join('');
}

async function createNewSession() {
  const data = await apiPost('/v1/sessions', {title: ''});
  if (!data || !data.session_id) return;
  currentSessionId = data.session_id;
  localStorage.setItem('cleo_current_session', currentSessionId);
  resetChatState();
  await loadSessions();
  switchPanel('overview');
}

async function switchSession(sessionId) {
  if (sessionId === currentSessionId) return;
  currentSessionId = sessionId;
  localStorage.setItem('cleo_current_session', sessionId);

  // Load session messages from backend
  const data = await api('/v1/sessions/' + encodeURIComponent(sessionId));
  if (!data) return;

  resetChatState();
  if (data.messages && data.messages.length) {
    for (const msg of data.messages) {
      addChatMsg(msg.role === 'user' ? 'user' : 'assistant', msg.content, {
        ts: msg.ts ? msg.ts * 1000 : Date.now(),
        agent: msg.role === 'assistant' ? 'cleo' : undefined
      });
    }
  }
  renderChat();
  renderSessionList();
  switchPanel('overview');
}

function resetChatState() {
  stopAllTaskStreams();
  clearArtifacts();
  chatMsgs = [];
  chatPrevSnapshot = {};
  chatTaskMap = {};
  chatMsgCounter = 0;
  dispatchEntries = [];
  dispatchLastIdx = 0;
  const chatEl = document.getElementById('chatMessages');
  if (chatEl) {
    chatEl.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">⬡</div>'
      + '<div class="chat-welcome-text">What can I help you with?</div>'
      + '<div class="chat-welcome-sub">Your task will be planned, executed, and reviewed by the Cleo agent team</div></div>';
  }
  const dispEl = document.getElementById('dispatchLog');
  if (dispEl) dispEl.innerHTML = '';
}

async function renameSession(sessionId) {
  const current = dashboardSessions.find(s => s.session_id === sessionId);
  const newTitle = prompt('Rename session:', current?.title || 'New Chat');
  if (newTitle === null) return;
  await apiPut('/v1/sessions/' + encodeURIComponent(sessionId), {title: newTitle});
  await loadSessions();
}

async function deleteSession(sessionId) {
  if (!confirm('Delete this session?')) return;
  await apiDelete('/v1/sessions/' + encodeURIComponent(sessionId));
  if (currentSessionId === sessionId) {
    currentSessionId = null;
    localStorage.removeItem('cleo_current_session');
    resetChatState();
  }
  await loadSessions();
}

function fmtTimeAgo(ts) {
  if (!ts) return '';
  const diff = (Date.now() / 1000) - ts;
  if (diff < 60) return 'now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h';
  if (diff < 604800) return Math.floor(diff / 86400) + 'd';
  return new Date(ts * 1000).toLocaleDateString();
}

// Save assistant message to session when task completes
function persistAssistantMessage(content) {
  if (!currentSessionId || !content) return;
  apiPost('/v1/sessions/' + encodeURIComponent(currentSessionId) + '/message', {
    role: 'assistant', content: content
  });
}

// ══════════════════════════════════════════════════════════════════
//  POLL & DIFF — routes to dual panels
// ══════════════════════════════════════════════════════════════════

function findTokensForAgent(agentId, claimedAt, completedAt) {
  const out = {execIn:0, execOut:0, reviewIn:0, reviewOut:0};
  if (!recentUsageCalls.length) return out;
  const aid = (agentId||'').toLowerCase();
  const start = claimedAt || 0;
  const end = completedAt || (Date.now()/1000 + 60);
  for (const c of recentUsageCalls) {
    const ts = c.ts || 0;
    if (ts < start - 1 || ts > end + 5) continue;
    const cAid = (c.agent_id||'').toLowerCase();
    if (cAid === aid || (!aid && cAid)) {
      out.execIn += c.prompt_tokens || 0;
      out.execOut += c.completion_tokens || 0;
    }
    if ((cAid === 'alic' || cAid === 'advisor') && aid !== 'alic' && aid !== 'advisor') {
      out.reviewIn += c.prompt_tokens || 0;
      out.reviewOut += c.completion_tokens || 0;
    }
  }
  return out;
}

async function pollChatUpdates() {
  const [data, hbData, usageData] = await Promise.all([
    api('/v1/status'),
    api('/v1/heartbeat'),
    api('/v1/usage/recent'),
  ]);
  if (!data) return;

  const tasks = data.tasks || {};
  allTasks = tasks;

  if (usageData && usageData.calls) recentUsageCalls = usageData.calls;

  // Update live agent status from heartbeat
  if (hbData && hbData.agents) {
    const prevLive = JSON.stringify(liveStatusAgents);
    liveStatusAgents = {};
    for (const hb of hbData.agents) {
      if (hb.online && hb.status === 'working') {
        const elapsed = hb.age != null ? hb.age : 0;
        liveStatusAgents[hb.agent_id] = {
          status: hb.status, task_id: hb.task_id,
          elapsed: Math.round(elapsed),
        };
      }
    }
    if (JSON.stringify(liveStatusAgents) !== prevLive) {
      renderLiveStatus();
    }
  }

  const prevDispLen = dispatchEntries.length;
  const prevChatLen = chatMsgs.length;

  diffAndRoute(chatPrevSnapshot, tasks);
  updateWorkflow(tasks);
  renderTaskRoute(tasks);
  chatPrevSnapshot = JSON.parse(JSON.stringify(tasks));

  if (dispatchEntries.length > prevDispLen) renderDispatch();
  if (chatMsgs.length > prevChatLen) renderChat();
  renderLiveStatus();
}

// ── Live Status → TOP dispatch panel ──
function renderLiveStatus() {
  const container = document.getElementById('dispatchLog');
  if (!container) return;
  // Remove old live indicators
  container.querySelectorAll('.dispatch-live-row').forEach(el => el.remove());

  const working = Object.entries(liveStatusAgents);
  if (!working.length) return;

  for (const [aid, info] of working) {
    const meta = agentMeta(aid);
    const el = document.createElement('div');
    el.className = 'dispatch-entry dispatch-live-row';
    // Check if there's streaming text for a richer status
    const tid = info.task_id;
    const streamLen = tid && _streamingFullText[tid] ? stripLlmTagsCached(_streamingFullText[tid]).length : 0;
    const statusText = streamLen > 0 ? 'Generating · ' + streamLen + ' chars' : 'Generating…';
    el.innerHTML = '<span class="dispatch-icon"><span class="dispatch-live-dot" style="background:' + meta.color + '"></span></span>'
      + '<span class="dispatch-agent ' + meta.cls + '-d">' + escHtml(capitalize(aid)) + '</span>'
      + '<span class="dispatch-text"><span class="dispatch-live">' + statusText + '</span></span>'
      + '<span class="dispatch-time" style="color:' + meta.color + '">' + info.elapsed + 's</span>';
    container.appendChild(el);
  }
  container.scrollTop = container.scrollHeight;
}

// ══════════════════════════════════════════════════════════════════
//  SSE TOKEN-LEVEL STREAMING (EventSource per task)
// ══════════════════════════════════════════════════════════════════

const _taskStreams = {};       // task_id → EventSource
const _taskStreamText = {};    // task_id → accumulated text

function startTaskStream(taskId) {
  if (_taskStreams[taskId]) return;
  const url = API + '/v1/stream/' + taskId
    + (TOKEN ? '?token=' + encodeURIComponent(TOKEN) : '');
  const es = new EventSource(url);
  _taskStreamText[taskId] = '';

  es.addEventListener('chunk', function(e) {
    try {
      const data = JSON.parse(e.data);
      _taskStreamText[taskId] += data.c;
      // Determine agent for this task from cached allTasks
      const agent = (allTasks[taskId] && allTasks[taskId].agent_id) || 'system';
      updateStreamingBubble(taskId, agent, _taskStreamText[taskId]);
    } catch(err) { /* skip malformed chunk */ }
  });

  es.addEventListener('done', function() {
    es.close();
    delete _taskStreams[taskId];
    delete _taskStreamText[taskId];
  });

  es.addEventListener('timeout', function() {
    es.close();
    delete _taskStreams[taskId];
    delete _taskStreamText[taskId];
  });

  es.onerror = function() {
    es.close();
    delete _taskStreams[taskId];
    // Reconnect after 2 s if task is still active
    setTimeout(function() {
      if (!_taskStreams[taskId] && allTasks[taskId]
          && !['completed','failed','cancelled'].includes(allTasks[taskId].status)) {
        startTaskStream(taskId);
      }
    }, 2000);
  };

  _taskStreams[taskId] = es;
}

function stopTaskStream(taskId) {
  if (_taskStreams[taskId]) {
    _taskStreams[taskId].close();
    delete _taskStreams[taskId];
  }
  delete _taskStreamText[taskId];
}

function stopAllTaskStreams() {
  for (const tid of Object.keys(_taskStreams)) {
    stopTaskStream(tid);
  }
}

// ══════════════════════════════════════════════════════════════════
//  STREAMING — live partial results in ChatBox
// ══════════════════════════════════════════════════════════════════

// Store full streaming content
const _streamingFullText = {};
let _streamRenderRAF = {};

function updateStreamingBubble(taskId, agent, partial) {
  const container = document.getElementById('chatMessages');
  if (!container) return;

  // Store full text
  _streamingFullText[taskId] = partial;

  let bubble = document.getElementById('stream-' + taskId);
  if (!bubble) {
    // Remove welcome message if present
    const welcome = container.querySelector('.chat-welcome');
    if (welcome) welcome.remove();
    // Create streaming bubble with full markdown rendering area
    const meta = agentMeta(agent);
    const wrapper = document.createElement('div');
    wrapper.className = 'chat-msg assistant';
    wrapper.id = 'stream-' + taskId;
    wrapper.setAttribute('data-task-id', taskId);
    wrapper.innerHTML = '<div class="chat-avatar ' + meta.cls + '">' + avatarHtml(meta, 28) + '</div>'
      + '<div class="chat-bubble assistant-bubble ' + meta.cls + '-bubble">'
      + '<div class="asst-header"><span class="asst-label" style="color:' + meta.color + '">' + escHtml(capitalize(agent)) + '</span></div>'
      + '<div class="stream-body"></div>'
      + '<div class="stream-meta">'
      + '<span class="stream-agent-status">Generating</span>'
      + '<span class="char-count"></span>'
      + '</div></div>';
    container.appendChild(wrapper);
    // Auto-scroll when a new agent starts responding
    requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
  }

  // Throttle render — 60ms interval (~16fps) for smooth streaming
  if (_streamRenderRAF[taskId]) return;
  _streamRenderRAF[taskId] = setTimeout(() => {
    delete _streamRenderRAF[taskId];
    _renderStreamContent(taskId);
  }, 60);
}

function _parseStreamSteps(partial) {
  // Extract tool/think steps from raw LLM output for Claude-style display
  const steps = [];

  // ── Completed <think>...</think> ──
  const thinkComplete = partial.match(/<think>([\s\S]*?)<\/think>/g);
  if (thinkComplete) {
    for (const t of thinkComplete) {
      const content = t.replace(/<\/?think>/g, '').trim();
      const preview = content.length > 80 ? content.slice(0, 80) + '…' : content;
      steps.push({type: 'think', status: 'done', label: 'Thought', preview,
        fullContent: content});
    }
  }

  // ── Completed <tool_code>...</tool_code> (JSON format) ──
  const toolComplete = partial.match(/<tool_code>([\s\S]*?)<\/tool_code>/g);
  if (toolComplete) {
    for (const tc of toolComplete) {
      const inner = tc.replace(/<\/?tool_code>/g, '').trim();
      let label = 'Used Tool';
      try { const obj = JSON.parse(inner); if (obj.tool) label = 'Used ' + titleCase(obj.tool.replace(/[_-]/g, ' ')); } catch(e) {}
      steps.push({type: 'tool', status: 'done', label});
    }
  }

  // ── Completed <minimax:tool_call>...<invoke name="X">...</minimax:tool_call> ──
  const mmComplete = partial.match(/<minimax:tool_call>([\s\S]*?)<\/minimax:tool_call>/g);
  if (mmComplete) {
    for (const mc of mmComplete) {
      let label = 'Used Tool';
      const nameMatch = mc.match(/<invoke\s+name="([^"]+)"/);
      if (nameMatch) label = 'Used ' + titleCase(nameMatch[1].replace(/[_-]/g, ' '));
      steps.push({type: 'tool', status: 'done', label});
    }
  }

  // ── Detect currently open (incomplete / streaming) tags ──
  const hasOpenThink = /<think>(?![\s\S]*<\/think>)[\s\S]*$/.test(partial);
  const hasOpenTool = /<tool_code>(?![\s\S]*<\/tool_code>)[\s\S]*$/.test(partial);
  const hasOpenToolCall = /<tool_call>(?![\s\S]*<\/tool_call>)[\s\S]*$/.test(partial);
  const hasOpenMinimax = /<minimax:tool_call>(?![\s\S]*<\/minimax:tool_call>)[\s\S]*$/.test(partial);
  const hasRawJson = /^\s*\{"tool"\s*:/m.test(partial.split('</tool_code>').pop());

  if (hasOpenThink) steps.push({type: 'think', status: 'active', label: 'Thinking…'});
  if (hasOpenTool || hasOpenToolCall || hasRawJson) {
    steps.push({type: 'tool', status: 'active', label: 'Executing…'});
  }
  if (hasOpenMinimax) {
    // Try to extract tool name from in-progress Minimax block
    const tail = partial.split(/<minimax:tool_call>/).pop();
    const nameMatch = tail.match(/<invoke\s+name="([^"]+)"/);
    const toolName = nameMatch ? titleCase(nameMatch[1].replace(/[_-]/g, ' ')) : 'Tool';
    steps.push({type: 'tool', status: 'active', label: 'Calling ' + toolName + '…'});
  }

  // ── Completed <artifact>...</artifact> ──
  const artifactComplete = partial.match(/<artifact(?:\s[^>]*)?>[\s\S]*?<\/artifact>/g);
  if (artifactComplete) {
    for (const a of artifactComplete) {
      const typeMatch = a.match(/type="([^"]+)"/);
      const titleMatch = a.match(/title="([^"]+)"/);
      const aType = typeMatch ? typeMatch[1] : 'code';
      const aTitle = titleMatch ? titleMatch[1] : 'Artifact';
      const inner = a.replace(/<artifact[^>]*>/, '').replace(/<\/artifact>/, '').trim();
      steps.push({type: 'artifact', status: 'done', label: aTitle,
        artifactType: aType, content: inner});
    }
  }
  // ── Streaming <artifact> (open, not closed) ──
  const hasOpenArtifact = /<artifact(?:\s[^>]*)?>(?![\s\S]*<\/artifact>)[\s\S]*$/.test(partial);
  if (hasOpenArtifact) {
    steps.push({type: 'artifact', status: 'active', label: 'Creating artifact…'});
  }

  return steps;
}

// ── Sanitize partial markdown for safe rendering during streaming ──
function _sanitizePartialMarkdown(text) {
  // Close unclosed code fences
  const fenceCount = (text.match(/^```/gm) || []).length;
  if (fenceCount % 2 !== 0) text += '\n```';
  // Close unclosed inline code backticks
  const backtickCount = (text.match(/`/g) || []).length;
  if (backtickCount % 2 !== 0) text += '`';
  // Close unclosed bold markers
  const boldCount = (text.match(/\*\*/g) || []).length;
  if (boldCount % 2 !== 0) text += '**';
  return text;
}

function _renderStreamContent(taskId) {
  const bubble = document.getElementById('stream-' + taskId);
  if (!bubble) return;
  const body = bubble.querySelector('.stream-body');
  const charCount = bubble.querySelector('.char-count');
  const statusEl = bubble.querySelector('.stream-agent-status');
  const partial = _streamingFullText[taskId] || '';
  if (body) {
    const cleaned = _sanitizePartialMarkdown(htmlToMd(stripLlmTagsCached(partial)));
    const steps = _parseStreamSteps(partial);
    let stepsHtml = '';
    if (steps.length) {
      stepsHtml = '<div class="stream-steps">';
      for (let si = 0; si < steps.length; si++) {
        const s = steps[si];
        let icon, cls;
        if (s.type === 'artifact') {
          icon = s.status === 'done' ? '📎' : '📝';
        } else if (s.type === 'think') {
          icon = '💭';
        } else {
          icon = s.status === 'done' ? '<span style="color:var(--green)">✓</span>' : '⚡';
        }
        cls = s.status === 'done' ? 'step-done' : 'step-active';
        let previewHtml = '';
        if (s.preview && s.status === 'done') {
          if (s.type === 'think' && s.fullContent) {
            // Expandable think block
            const thinkId = 'think-' + taskId + '-' + si;
            previewHtml = '<span class="step-preview think-toggle" onclick="toggleThinkContent(\'' + thinkId + '\')">'
              + escHtml(s.preview) + ' ▸</span>'
              + '<div class="think-full" id="' + thinkId + '" style="display:none;margin:6px 0 2px 22px;padding:8px 10px;background:var(--bg1);border-radius:6px;font-size:12px;line-height:1.5;max-height:300px;overflow-y:auto">'
              + renderMarkdown(s.fullContent) + '</div>';
          } else {
            previewHtml = '<span class="step-preview">' + escHtml(s.preview) + '</span>';
          }
        }
        // Route completed artifacts to sidebar
        if (s.type === 'artifact' && s.status === 'done' && s.content) {
          showArtifact(s.artifactType || 'code', s.label, s.content);
        }
        stepsHtml += '<div class="stream-step ' + cls + '">'
          + '<span class="step-icon">' + icon + '</span>'
          + '<span class="step-label">' + escHtml(s.label) + '</span>'
          + previewHtml
          + (s.status === 'active' ? '<span class="step-spinner"></span>' : '')
          + '</div>';
      }
      stepsHtml += '</div>';
    }
    // Update status text based on what's happening
    if (statusEl) {
      const activeStep = steps.find(s => s.status === 'active');
      if (activeStep) {
        statusEl.textContent = activeStep.label;
      } else if (cleaned) {
        statusEl.textContent = 'Writing';
      } else {
        statusEl.textContent = 'Generating';
      }
    }
    if (cleaned) {
      body.innerHTML = stepsHtml + renderMarkdown(cleaned) + '<span class="stream-cursor"></span>';
    } else if (steps.length) {
      body.innerHTML = stepsHtml + '<span class="stream-cursor"></span>';
    } else if (partial.length > 0) {
      body.innerHTML = '<span style="color:var(--fg3)">Working…</span><span class="stream-cursor"></span>';
    } else {
      body.innerHTML = '<span style="color:var(--fg3)">Waiting for response…</span><span class="stream-cursor"></span>';
    }
  }
  if (charCount) {
    const cleaned = stripLlmTagsCached(partial);
    const len = cleaned.length || partial.length;
    if (len > 0) {
      const estTokens = Math.ceil(len / 3.5);  // rough estimate for mixed CJK/code
      charCount.textContent = len.toLocaleString() + ' chars \u00b7 ~' + estTokens.toLocaleString() + ' tokens';
    } else {
      charCount.textContent = '';
    }
  }
  const container = document.getElementById('chatMessages');
  if (container) {
    const atBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 300;
    if (atBottom) requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
  }
}

function removeStreamingBubble(taskId) {
  _cleanupStreamRAF(taskId);
  const el = document.getElementById('stream-' + taskId);
  if (el) el.remove();
  delete _streamingFullText[taskId];
}

// ── Streaming cleanup on completion ──
function _cleanupStreamRAF(taskId) {
  if (_streamRenderRAF[taskId]) {
    clearTimeout(_streamRenderRAF[taskId]);
    delete _streamRenderRAF[taskId];
  }
}

// ── Think block expand/collapse ──
function toggleThinkContent(thinkId) {
  const el = document.getElementById(thinkId);
  if (!el) return;
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

// ── Artifacts sidebar ──
let _artifactCounter = 0;

function showArtifact(type, title, content) {
  const sidebar = document.getElementById('artifactsSidebar');
  const list = document.getElementById('artifactsList');
  if (!sidebar || !list) return;

  _artifactCounter++;
  const cardId = 'artifact-' + _artifactCounter;

  // Check if an artifact with same title already exists (update it)
  const existing = list.querySelector('[data-artifact-title="' + escHtml(title) + '"]');
  if (existing) {
    const body = existing.querySelector('.artifact-card-body');
    if (body) {
      body.innerHTML = (type === 'code' || type === 'application/code')
        ? '<pre><code>' + escHtml(content) + '</code></pre>'
        : renderMarkdown(content);
    }
    sidebar.style.display = 'flex';
    return;
  }

  const card = document.createElement('div');
  card.className = 'artifact-card';
  card.setAttribute('data-artifact-title', title);

  const icon = type === 'code' || type === 'application/code' ? '💻'
    : type === 'markdown' || type === 'text/markdown' ? '📄'
    : type === 'html' || type === 'text/html' ? '🌐' : '📎';

  let bodyContent;
  if (type === 'code' || type === 'application/code') {
    bodyContent = '<pre><code>' + escHtml(content) + '</code></pre>';
  } else {
    bodyContent = renderMarkdown(content);
  }

  card.innerHTML = '<div class="artifact-card-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'block\':\'none\'">'
    + '<span>' + icon + '</span>'
    + '<span>' + escHtml(title) + '</span>'
    + '<span style="margin-left:auto;font-size:10px;color:var(--fg3)">' + escHtml(type) + '</span>'
    + '</div>'
    + '<div class="artifact-card-body">' + bodyContent + '</div>';

  list.appendChild(card);
  sidebar.style.display = 'flex';
}

function toggleArtifacts() {
  const sidebar = document.getElementById('artifactsSidebar');
  if (!sidebar) return;
  sidebar.style.display = sidebar.style.display === 'none' ? 'flex' : 'none';
}

function clearArtifacts() {
  const list = document.getElementById('artifactsList');
  if (list) list.innerHTML = '';
  _artifactCounter = 0;
  const sidebar = document.getElementById('artifactsSidebar');
  if (sidebar) sidebar.style.display = 'none';
}

function updateCostBadge(taskId, costUsd) {
  // Find the completed message bubble for this task and add cost
  const msgs = document.querySelectorAll('[data-task-id="' + taskId + '"]');
  for (const msg of msgs) {
    if (msg.querySelector('.cost-badge')) continue;
    const tokens = msg.querySelector('.asst-tokens') || msg.querySelector('.chat-tokens');
    if (tokens) {
      const badge = document.createElement('span');
      badge.className = 'cost-badge';
      badge.style.cssText = 'margin-left:8px;color:var(--green);font-weight:600';
      badge.textContent = '~$' + costUsd.toFixed(4);
      tokens.appendChild(badge);
    }
  }
}

// ══════════════════════════════════════════════════════════════════
//  SUBTASK TREE — visual decomposition of leo subtasks
// ══════════════════════════════════════════════════════════════════

let _taskRouteCollapsed = false;  // track global collapsed state

function renderTaskRoute(tasks) {
  const container = document.getElementById('subtaskTree');
  if (!container) return;

  // Build parent→children map
  const childrenOf = {};
  const allIds = new Set(Object.keys(tasks));
  for (const [tid, t] of Object.entries(tasks)) {
    const pid = t.parent_id;
    if (pid) {
      if (!childrenOf[pid]) childrenOf[pid] = [];
      childrenOf[pid].push(tid);
    }
  }

  // Find root tasks (no parent or parent not in current board)
  const roots = [];
  for (const [tid, t] of Object.entries(tasks)) {
    if (!t.parent_id || !allIds.has(t.parent_id)) {
      roots.push(tid);
    }
  }

  // Only show if there's at least one parent→child relationship
  if (Object.keys(childrenOf).length === 0) {
    container.classList.remove('has-tree');
    container.innerHTML = '';
    return;
  }
  container.classList.add('has-tree');

  // Count all tasks by status
  const allTasks = Object.values(tasks);
  const total = allTasks.length;
  const completed = allTasks.filter(t => t.status === 'completed').length;
  const active = allTasks.filter(t => t.status === 'claimed' || t.status === 'review' || t.status === 'critique').length;
  const pending = total - completed - active - allTasks.filter(t => t.status === 'failed').length;

  // Render a single task row
  function renderNode(tid, depth, isLast) {
    const t = tasks[tid];
    if (!t) return '';
    const st = t.status || 'pending';
    const desc = cleanTaskDesc(t.description || '').substring(0, 60);
    const agent = t.agent_id || '';
    const kids = childrenOf[tid] || [];
    const hasKids = kids.length > 0;
    const maxDepth = 4;

    // Build connector prefix based on depth
    let prefix = '';
    if (depth > 0) {
      // Simple tree connectors
      prefix = '  '.repeat(depth - 1) + (isLast ? '└─' : '├─');
    }

    let html = '<div class="tr-row">';
    if (prefix) {
      html += '<span class="tr-connector">' + prefix + '</span>';
    }
    html += '<span class="tr-dot ' + st + '"></span>';
    html += '<span class="tr-desc" title="' + escHtml(t.description || '') + '">' + escHtml(desc) + '</span>';
    if (agent) {
      html += '<span class="tr-agent ' + agent.toLowerCase() + '">' + escHtml(agent) + '</span>';
    }
    // Show source for root tasks
    if (depth === 0 && t.source) {
      html += '<span class="tr-source">' + escHtml(t.source) + '</span>';
    }
    html += '</div>';

    // Render children recursively (cap at maxDepth)
    if (hasKids && depth < maxDepth) {
      for (let i = 0; i < kids.length; i++) {
        html += renderNode(kids[i], depth + 1, i === kids.length - 1);
      }
    } else if (hasKids && depth >= maxDepth) {
      html += '<div class="tr-row">'
        + '<span class="tr-connector">' + '  '.repeat(depth) + '└─</span>'
        + '<span class="tr-desc" style="color:var(--fg3);font-style:italic">+' + kids.length + ' more…</span>'
        + '</div>';
    }
    return html;
  }

  // Build the tree
  let treeHtml = '';
  for (let i = 0; i < roots.length; i++) {
    treeHtml += renderNode(roots[i], 0, i === roots.length - 1);
  }

  let html = '<div class="tr-block">';
  // Summary header with stats
  html += '<div class="tr-summary" onclick="toggleTaskRoute()">';
  html += '<span class="tr-chevron' + (_taskRouteCollapsed ? '' : ' open') + '">▸</span>';
  html += '<span class="tr-summary-text">Task Route</span>';
  html += '<span class="tr-stats">';
  if (completed > 0) html += '<span class="tr-stat"><span class="dot done"></span>' + completed + '</span>';
  if (active > 0) html += '<span class="tr-stat"><span class="dot active"></span>' + active + '</span>';
  if (pending > 0) html += '<span class="tr-stat"><span class="dot wait"></span>' + pending + '</span>';
  html += '<span class="tr-stat" style="color:var(--fg3)">' + total + ' total</span>';
  html += '</span></div>';
  // Collapsible body
  html += '<div class="tr-body' + (_taskRouteCollapsed ? ' collapsed' : '') + '">';
  html += '<div class="tr-inner">' + treeHtml + '</div>';
  html += '</div></div>';

  container.innerHTML = html;
}

function toggleTaskRoute() {
  _taskRouteCollapsed = !_taskRouteCollapsed;
  const body = document.querySelector('.tr-body');
  const chevron = document.querySelector('.tr-chevron');
  if (body) body.classList.toggle('collapsed', _taskRouteCollapsed);
  if (chevron) chevron.classList.toggle('open', !_taskRouteCollapsed);
}

// ── Clean task description for display (strip injected conversation history) ──
function cleanTaskDesc(desc) {
  if (!desc) return '';
  desc = _stripConversationHistory(desc);
  desc = desc.replace(/^[■●]\s+.{0,120}$/gm, '');
  desc = desc.replace(/\n{2,}/g, '\n');
  return desc.trim();
}

// ── Extract submitter username from task description ──
function extractSubmitter(desc) {
  if (!desc) return null;
  // Look for **[username]** patterns — pick the last user entry (not 助手)
  const re = /\*\*\[([^\]]+)\]\*\*/g;
  let match, last = null;
  while ((match = re.exec(desc)) !== null) {
    if (match[1] !== '助手' && match[1] !== 'assistant') last = match[1];
  }
  return last;
}

// ══════════════════════════════════════════════════════════════════
//  DIFF & ROUTE — agent activity → top, final results → bottom
// ══════════════════════════════════════════════════════════════════

function diffAndRoute(prev, current) {
  for (const [taskId, task] of Object.entries(current)) {
    const old = prev[taskId];
    const oldStatus = old ? old.status : null;
    const newStatus = task.status;

    // Streaming: update partial result bubble even when status unchanged
    if (task.partial_result && (newStatus === 'claimed' || newStatus === 'review')) {
      updateStreamingBubble(taskId, task.agent_id || 'system', task.partial_result);
    }

    // Show cost badge as soon as cost is available (streaming or completed)
    if (task.cost_usd != null) {
      updateCostBadge(taskId, task.cost_usd);
    }

    if (oldStatus === newStatus && old) continue;

    // Remove streaming bubble + close SSE when task completes
    if (newStatus === 'completed' || newStatus === 'failed') {
      removeStreamingBubble(taskId);
      stopTaskStream(taskId);
    }

    if (!chatTaskMap[taskId]) chatTaskMap[taskId] = new Set();
    const seen = chatTaskMap[taskId];
    const agent = task.agent_id || 'system';

    // ── New task detected → TOP dispatch ──
    if (!oldStatus && !seen.has('created')) {
      seen.add('created');
      const submitter = dashboardUser || extractSubmitter(task.description) || 'You';
      addDispatch('📋', submitter, truncate(cleanTaskDesc(task.description), 80), {taskId});
    }

    // ── Agent claimed task → TOP dispatch ──
    if (newStatus === 'claimed' && oldStatus !== 'claimed' && !seen.has('claimed')) {
      seen.add('claimed');
      addDispatch('⚡', agent, 'Working on Task…', {taskId});
      const aidLower = (agent || '').toLowerCase();
      if (aidLower === 'jerry') firePacket(1, 'leo');
    }

    // ── Sent to review → TOP dispatch (with intermediate result) ──
    if (newStatus === 'review' && oldStatus !== 'review' && !seen.has('review')) {
      seen.add('review');
      const agentTokens = findTokensForAgent(agent, task.claimed_at);
      const isSimple = (task.complexity === 'simple');
      if (task.result) {
        seen.add('result_shown');
        addDispatch('📝', agent, isSimple ? 'Done (Auto-Completed)' : 'Done → Advisor Review', {
          taskId, result: task.result,
          promptTokens: agentTokens.execIn, completionTokens: agentTokens.execOut,
        });
      } else {
        addDispatch('📤', agent, '🧠 Sent to Advisor', {taskId});
      }
      if (!isSimple) firePacket(2, 'alic');
    }

    // ── Critique → jerry needs to fix ──
    if (newStatus === 'critique' && oldStatus !== 'critique' && !seen.has('critique')) {
      seen.add('critique');
      const critique = task.critique || {};
      const sugCount = (critique.suggestions || []).length;
      const preview = sugCount ? sugCount + ' Suggestion' + (sugCount > 1 ? 's' : '') : '';
      addDispatch('⚠', critique.reviewer || 'advisor', 'Needs Revision: ' + preview, {taskId});
    }

    // ── Completed → critique/review result → TOP, final result → BOTTOM ──
    if (newStatus === 'completed' && !seen.has('completed')) {
      seen.add('completed');
      const agentTokens = findTokensForAgent(agent, task.claimed_at, task.completed_at);

      // Critique/review result → TOP dispatch
      const critique = task.critique;
      if (critique) {
        const advisorId = critique.reviewer || 'advisor';
        if (critique.passed) {
          addDispatch('✓', advisorId, 'Approved ✓', {
            taskId, critiqueSpec: task.critique_spec || null,
            promptTokens: agentTokens.reviewIn, completionTokens: agentTokens.reviewOut,
          });
        } else {
          addDispatch('🧠', advisorId, 'Revised & Completed', {
            taskId, critiqueSpec: task.critique_spec || null,
          });
        }
      } else {
        // Legacy: numeric scores
        const scores = task.review_scores || [];
        if (scores.length) {
          const last = scores[scores.length - 1];
          addDispatch('⭐', last.reviewer || 'alic', 'Reviewed', {
            taskId, score: last.score, scoreComment: last.comment,
            promptTokens: agentTokens.reviewIn, completionTokens: agentTokens.reviewOut,
          });
        }
      }

      // Simple task marker
      if (task.complexity === 'simple') {
        addDispatch('⚡', agent, 'Simple Task Auto-Completed', {taskId});
      } else {
        addDispatch('✓', agent, 'Task Completed', {taskId});
      }

      // ── FINAL RESULT → BOTTOM chatbox as assistant message ──
      if (task.result) {
        seen.add('result_shown');
        const totalIn = agentTokens.execIn + agentTokens.reviewIn;
        const totalOut = agentTokens.execOut + agentTokens.reviewOut;
        addChatMsg('assistant', task.result, {
          agent, taskId, result: task.result,
          critique: critique || null,
          critiqueSpec: task.critique_spec || null,
          score: critique ? null : (task.review_scores && task.review_scores.length ? task.review_scores[task.review_scores.length-1].score : null),
          scoreComment: critique ? null : (task.review_scores && task.review_scores.length ? task.review_scores[task.review_scores.length-1].comment : null),
          promptTokens: totalIn || null,
          completionTokens: totalOut || null,
        });
        // Persist to session history
        persistAssistantMessage(task.result);
      }
    }

    // ── Failed → TOP dispatch + BOTTOM system msg ──
    if (newStatus === 'failed' && !seen.has('failed')) {
      seen.add('failed');
      const errFlag = (task.evolution_flags||[]).find(f => f.startsWith('failed:'));
      const errText = errFlag ? errFlag.slice(7) : 'Unknown error';
      addDispatch('✗', agent, 'Failed: ' + truncate(errText, 80), {taskId});
      addChatMsg('system', '✗ Task failed: ' + truncate(errText, 100), {taskId});
    }

    // ── Leo direct completion (pending → completed, no review) ──
    if (newStatus === 'completed' && oldStatus === 'pending' && !seen.has('review') && task.result && !seen.has('leo_direct')) {
      seen.add('leo_direct');
      const agentTokens = findTokensForAgent(agent, task.claimed_at, task.completed_at);
      addDispatch('📋', agent, 'Plan Generated', {
        taskId, result: task.result,
        promptTokens: agentTokens.execIn, completionTokens: agentTokens.execOut,
      });
      firePacket(1, 'leo');
    }
  }
}

// ══════════════════════════════════════════════════════════════════
//  WORKFLOW PIPELINE + DATA PACKET ANIMATION
// ══════════════════════════════════════════════════════════════════

function firePacket(connIdx, packetType) {
  const packet = document.getElementById('wfPacket' + connIdx);
  if (!packet) return;
  packet.classList.remove('animating');
  packet.className = 'wf-packet ' + packetType + '-packet';
  void packet.offsetWidth;
  packet.classList.add('animating');
  const targetNode = connIdx === 1
    ? document.getElementById('wfExecutor')
    : document.getElementById('wfReviewer');
  if (targetNode) {
    setTimeout(() => {
      targetNode.classList.add('receiving');
      setTimeout(() => targetNode.classList.remove('receiving'), 700);
    }, 900);
  }
}

let wfPrevState = {leo:false, jerry:false, alic:false};

function updateWorkflow(tasks) {
  const entries = Object.values(tasks);
  let done=0, working=0, failed=0, total=entries.length;
  let activePlanner=false, activeExecutor=false, activeReviewer=false;

  entries.forEach(t => {
    if (t.status === 'completed') done++;
    else if (t.status === 'failed') failed++;
    else if (t.status === 'claimed' || t.status === 'review' || t.status === 'critique') {
      working++;
      const aid = (t.agent_id || '').toLowerCase();
      if (aid === 'leo') activePlanner = true;
      else if (aid === 'jerry') activeExecutor = true;
      else if (aid === 'alic') activeReviewer = true;
      if (t.status === 'review') activeReviewer = true;
      if (t.status === 'critique') { activeExecutor = true; }
    }
  });

  for (const [aid, hb] of Object.entries(heartbeatData)) {
    if (hb.online && hb.status === 'working') {
      if (aid === 'leo') activePlanner = true;
      if (aid === 'jerry') activeExecutor = true;
      if (aid === 'alic') activeReviewer = true;
    }
  }

  // Update legacy hidden workflow nodes (for compatibility)
  const pn = document.getElementById('wfPlanner');
  const en = document.getElementById('wfExecutor');
  const rn = document.getElementById('wfReviewer');
  if (pn) pn.className = 'wf-node' + (activePlanner ? ' active' : '');
  if (en) en.className = 'wf-node' + (activeExecutor ? ' active jerry' : '');
  if (rn) rn.className = 'wf-node' + (activeReviewer ? ' active alic' : '');

  const ps = document.getElementById('wfPlannerStatus');
  const es = document.getElementById('wfExecutorStatus');
  const rs = document.getElementById('wfReviewerStatus');
  if (ps) ps.textContent = activePlanner ? 'working' : 'idle';
  if (es) es.textContent = activeExecutor ? 'working' : 'idle';
  if (rs) rs.textContent = activeReviewer ? 'working' : 'idle';

  const c1 = document.getElementById('wfConn1');
  const c2 = document.getElementById('wfConn2');
  if (c1) c1.className = 'wf-connector' + ((activePlanner || activeExecutor) ? ' active' : '');
  if (c2) c2.className = 'wf-connector' + ((activeExecutor || activeReviewer) ? ' active' : '');

  wfPrevState = {leo:activePlanner, jerry:activeExecutor, alic:activeReviewer};

  const statsEl = document.getElementById('wfStats');
  if (statsEl) {
    if (!total) statsEl.textContent = 'Ready';
    else {
      const parts = [total + ' task' + (total!==1?'s':'')];
      if (done) parts.push(done + ' done');
      if (working) parts.push(working + ' working');
      if (failed) parts.push(failed + ' failed');
      statsEl.textContent = parts.join(' · ');
    }
  }

  // ── Update header bar agent chips ──
  const cp = document.getElementById('chipPlanner');
  const ce = document.getElementById('chipExecutor');
  const cr = document.getElementById('chipReviewer');
  if (cp) cp.className = 'ov-agent-chip' + (activePlanner ? ' active' : '');
  if (ce) ce.className = 'ov-agent-chip' + (activeExecutor ? ' active jerry' : '');
  if (cr) cr.className = 'ov-agent-chip' + (activeReviewer ? ' active alic' : '');
}

// ══════════════════════════════════════════════════════════════════
//  RESIZABLE DIVIDER (drag to resize top/bottom panels)
// ══════════════════════════════════════════════════════════════════
(function initDivider() {
  const divider = document.getElementById('ovDivider');
  const top = document.getElementById('ovTop');
  if (!divider || !top) return;
  let dragging = false, startY = 0, startH = 0;

  divider.addEventListener('mousedown', (e) => {
    e.preventDefault();
    dragging = true;
    startY = e.clientY;
    startH = top.offsetHeight;
    document.body.style.cursor = 'row-resize';
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    const delta = e.clientY - startY;
    const newH = Math.max(80, Math.min(startH + delta, window.innerHeight * 0.7));
    top.style.height = newH + 'px';
    top.style.maxHeight = 'none';
  });

  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  });
})();

// ── Backward compat ──
async function pollTasks() { await pollChatUpdates(); }
async function submitTask() { await chatSubmit(); }

// ── Textarea auto-height + Enter to send ──
(function() {
  const input = document.getElementById('chatInput');
  if (!input) return;
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      chatSubmit();
    }
  });
})();

// ══════════════════════════════════════════════════════════════════
//  AGENTS — View + Edit
// ══════════════════════════════════════════════════════════════════

function buildSparkline(history) {
  if (!history || history.length < 2) return '';
  const values = history.map(h => h.composite || 0);
  const min = Math.min(...values) - 2;
  const max = Math.max(...values) + 2;
  const range = max - min || 1;
  const w = 120;
  const h = 24;
  const step = w / (values.length - 1);

  const points = values.map((v, i) =>
    (i * step).toFixed(1) + ',' + (h - ((v - min) / range) * h).toFixed(1)
  ).join(' ');

  // Color based on trend: compare last vs first
  const trend = values[values.length - 1] - values[0];
  const color = trend >= 0 ? 'var(--green)' : 'var(--red)';

  return '<div class="sparkline-wrap">'
    + '<svg viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none">'
    + '<polyline fill="none" stroke="' + color + '" stroke-width="1.5" '
    + 'stroke-linecap="round" stroke-linejoin="round" points="' + points + '"/>'
    + '</svg></div>';
}

function renderRadarChart(containerId, dims) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const keys = ['task_completion','output_quality','improvement_rate','consistency','review_accuracy'];
  const labels = ['Completion','Quality','Improvement','Consistency','Review'];
  const vals = keys.map(k => dims[k] || 0);
  const n = 5;
  const S = 230, cx = S/2, cy = S/2 + 2, R = 72, labelR = R + 22;
  const ang = [];
  for (let i = 0; i < n; i++) ang.push(-Math.PI/2 + (2*Math.PI*i)/n);
  const px = (r,a) => (cx + r*Math.cos(a)).toFixed(1);
  const py = (r,a) => (cy + r*Math.sin(a)).toFixed(1);

  let svg = '<svg width="'+S+'" height="'+S+'" viewBox="0 0 '+S+' '+S+'">';
  // grid rings — outer ring brighter
  for (let lv = 1; lv <= 5; lv++) {
    const r = R*lv/5;
    const isOuter = lv === 5;
    let d = 'M';
    for (let i = 0; i < n; i++) d += (i?' L':'')+px(r,ang[i])+','+py(r,ang[i]);
    svg += '<path d="'+d+' Z" fill="none" stroke="var(--fg2)" stroke-width="'+(isOuter?'1':'0.5')+'" opacity="'+(isOuter?'0.4':'0.15')+'"/>';
  }
  // axis lines
  for (let i = 0; i < n; i++)
    svg += '<line x1="'+cx+'" y1="'+cy+'" x2="'+px(R,ang[i])+'" y2="'+py(R,ang[i])+'" stroke="var(--fg2)" stroke-width="0.4" opacity="0.12"/>';
  // gradient def
  svg += '<defs><linearGradient id="radarGrad_'+containerId+'" x1="0" y1="0" x2="0" y2="1">'
    + '<stop offset="0%" stop-color="var(--accent)" stop-opacity="0.35"/>'
    + '<stop offset="100%" stop-color="var(--accent)" stop-opacity="0.05"/></linearGradient></defs>';
  // data polygon
  let dp = 'M';
  for (let i = 0; i < n; i++) {
    const r = R*vals[i]/100;
    dp += (i?' L':'')+px(r,ang[i])+','+py(r,ang[i]);
  }
  svg += '<path d="'+dp+' Z" fill="url(#radarGrad_'+containerId+')" stroke="var(--accent)" stroke-width="1.5" stroke-linejoin="round"/>';
  // data dots
  for (let i = 0; i < n; i++) {
    const r = R*vals[i]/100;
    svg += '<circle cx="'+px(r,ang[i])+'" cy="'+py(r,ang[i])+'" r="3" fill="var(--accent)" stroke="var(--bg2)" stroke-width="1.5"/>';
  }
  // labels + values
  for (let i = 0; i < n; i++) {
    const lx = parseFloat(px(labelR,ang[i]));
    const ly = parseFloat(py(labelR,ang[i]));
    const anchor = Math.abs(lx-cx)<5?'middle':(lx<cx?'end':'start');
    const ady = i===0?-4:(i>=2&&i<=3)?6:0;
    const col = scoreColor(vals[i]);
    svg += '<text x="'+lx+'" y="'+(ly+ady)+'" text-anchor="'+anchor+'" dominant-baseline="middle" fill="var(--fg2)" font-size="9" font-weight="600">'+labels[i]+'</text>';
    svg += '<text x="'+lx+'" y="'+(ly+ady+11)+'" text-anchor="'+anchor+'" dominant-baseline="middle" fill="'+col+'" font-size="10" font-weight="700" font-family="var(--mono)">'+vals[i].toFixed(0)+'</text>';
  }
  svg += '</svg>';
  el.innerHTML = svg;
}

function renderTrendChart(containerId, history) {
  const el = document.getElementById(containerId);
  if (!el || !history || history.length < 2) return;
  // Only show the most recent 10 data points
  if (history.length > 10) history = history.slice(-10);
  const W = el.clientWidth || 500;
  const H = 100;
  const PAD = {t:8, r:12, b:22, l:34};
  const cw = W - PAD.l - PAD.r;
  const ch = H - PAD.t - PAD.b;

  const values = history.map(h => h.composite || 0);
  const times = history.map(h => h.ts ? new Date(h.ts * 1000) : new Date());
  const vMin = Math.max(0, Math.min(...values) - 5);
  const vMax = Math.min(100, Math.max(...values) + 5);
  const vRange = vMax - vMin || 1;

  const x = (i) => PAD.l + (i / (values.length - 1)) * cw;
  const y = (v) => PAD.t + ch - ((v - vMin) / vRange) * ch;

  let svg = '<svg width="'+W+'" height="'+H+'" viewBox="0 0 '+W+' '+H+'">';

  // Horizontal grid lines + Y labels
  const gridSteps = 4;
  for (let i = 0; i <= gridSteps; i++) {
    const gy = PAD.t + (i / gridSteps) * ch;
    const gv = (vMax - (i / gridSteps) * vRange).toFixed(0);
    svg += '<line x1="'+PAD.l+'" y1="'+gy+'" x2="'+(W-PAD.r)+'" y2="'+gy+'" class="grid-line"/>';
    svg += '<text x="'+(PAD.l-4)+'" y="'+(gy+3)+'" text-anchor="end" class="axis-label">'+gv+'</text>';
  }

  // X axis time labels (show ~4-5 evenly spaced, skip overlaps)
  const labelCount = Math.min(5, times.length);
  const labelStep = Math.max(1, Math.floor((times.length - 1) / (labelCount - 1)));
  const minLabelGap = 70; // minimum px between labels to avoid overlap
  let lastLabelX = -999;
  const fmtTime = (d) => (d.getMonth()+1)+'/'+d.getDate()+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
  for (let i = 0; i < times.length; i += labelStep) {
    const tx = x(i);
    if (tx - lastLabelX < minLabelGap && lastLabelX > 0) continue;
    svg += '<text x="'+tx.toFixed(1)+'" y="'+(H-2)+'" text-anchor="middle" class="axis-label">'+fmtTime(times[i])+'</text>';
    lastLabelX = tx;
  }
  // Always show last label if far enough from previous
  if ((times.length - 1) % labelStep !== 0) {
    const lastX = x(times.length - 1);
    if (lastX - lastLabelX >= minLabelGap) {
      svg += '<text x="'+lastX.toFixed(1)+'" y="'+(H-2)+'" text-anchor="middle" class="axis-label">'+fmtTime(times[times.length-1])+'</text>';
    }
  }

  // Area fill
  const pts = values.map((v, i) => x(i).toFixed(1)+','+y(v).toFixed(1));
  const areaPath = 'M'+pts[0]+' L'+pts.join(' L')+' L'+x(values.length-1).toFixed(1)+','+(PAD.t+ch)+' L'+PAD.l+','+(PAD.t+ch)+' Z';
  const trend = values[values.length-1] - values[0];
  const lineColor = trend >= 0 ? 'var(--green)' : 'var(--red)';
  svg += '<path d="'+areaPath+'" fill="url(#areaGrad_'+containerId+')" opacity="0.15"/>';
  svg += '<defs><linearGradient id="areaGrad_'+containerId+'" x1="0" y1="0" x2="0" y2="1">';
  svg += '<stop offset="0%" stop-color="'+lineColor+'"/>';
  svg += '<stop offset="100%" stop-color="'+lineColor+'" stop-opacity="0"/>';
  svg += '</linearGradient></defs>';

  // Line
  svg += '<polyline fill="none" stroke="'+lineColor+'" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="'+pts.join(' ')+'"/>';

  // Dots
  for (let i = 0; i < values.length; i++) {
    const d = times[i];
    const lbl = values[i].toFixed(1) + ' — ' + (d.getMonth()+1)+'/'+d.getDate()+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    svg += '<circle class="trend-dot" cx="'+x(i).toFixed(1)+'" cy="'+y(values[i]).toFixed(1)+'" '
      + 'onmouseenter="showTrendTip(this,\''+lbl+'\')" onmouseleave="hideTrendTip()"/>';
  }

  svg += '</svg>';
  svg += '<div class="trend-tooltip" id="trendTip"></div>';
  el.innerHTML = svg;
}

function showTrendTip(dot, text) {
  const tip = document.getElementById('trendTip');
  if (!tip) return;
  const chart = dot.closest('.trend-chart');
  const rect = chart.getBoundingClientRect();
  const cx = parseFloat(dot.getAttribute('cx'));
  const cy = parseFloat(dot.getAttribute('cy'));
  tip.textContent = text;
  tip.style.left = cx + 'px';
  tip.style.top = (cy - 24) + 'px';
  tip.style.opacity = '1';
  tip.style.transform = 'translateX(-50%)';
}
function hideTrendTip() {
  const tip = document.getElementById('trendTip');
  if (tip) tip.style.opacity = '0';
}

async function loadAgents() {
  const [agentData, scoreData, skillsResp, chainData, historyData] = await Promise.all([
    api('/v1/agents'), api('/v1/scores'), api('/v1/skills'), api('/v1/chain/status'), api('/v1/scores/history')
  ]);
  const grid = document.getElementById('agentGrid');
  const agents = agentData?.agents || [];
  const scores = scoreData?.scores || {};
  const allSkills = skillsResp?.shared || [];
  const sharedSkillNames = new Set(allSkills.map(s => s.name || s.file?.replace('.md','')));
  const agentPrivateSkills = skillsResp?.agents || {};
  const rawChainAgents = chainData?.agents || {};
  // Map legacy chain IDs (planner/executor/reviewer) to current agent IDs
  const CHAIN_ID_MAP = {planner:'leo', executor:'jerry', reviewer:'alic'};
  const chainAgents = {};
  for (const [cid, cdata] of Object.entries(rawChainAgents)) {
    const mapped = CHAIN_ID_MAP[cid] || cid;
    chainAgents[mapped] = cdata;
  }
  const scoreHistory = historyData?.agents || {};

  if (!agents.length) { grid.innerHTML = '<div class="empty">No agents configured</div>'; return; }

  let html = '';
  for (const a of agents) {
    const sc = scores[a.id] || {};
    const composite = sc.composite || 0;
    const dims = sc.dimensions || {};
    const hb = heartbeatData[a.id];
    const isOnline = hb && hb.online;

    // ── Card surface: compact, consistent ──
    const aM = agentMeta(a.id);
    html += '<div class="agent-card" onclick="editAgent(\'' + escHtml(a.id) + '\')">';
    // Row 1: Avatar + Name + status
    html += '<div class="agent-card-header">';
    html += avatarHtml(aM, 24);
    html += '<span class="hb-dot ' + (isOnline ? 'online' : 'offline') + '" data-agent-id="' + escHtml(a.id) + '"></span>';
    html += '<span class="agent-name">' + escHtml(capitalize(a.id)) + '</span>';
    if (isOnline && hb.status === 'working') html += '<span class="agent-working">Working</span>';
    html += '<span style="flex:1"></span>';
    // API Key indicator (compact)
    const isKeySet = a.api_key_set;
    if (isKeySet) html += '<span class="key-dot set" title="API key set"></span>';
    else if (a.api_key_env) html += '<span class="key-dot unset" title="API key not set"></span>';
    html += '</div>';

    // Row 2: Model + Provider
    html += '<div class="agent-card-model">' + escHtml(a.model||'—')
      + ' <span class="agent-provider">' + escHtml(a.provider||'') + '</span></div>';

    // Row 3: Skills tags (private only — shared skills hidden)
    const privateSkills = (a.skills || []).filter(s => !sharedSkillNames.has(s));
    if (privateSkills.length) {
      html += '<div class="agent-card-skills">';
      for (const s of privateSkills) html += '<span class="skill-tag">' + escHtml(s) + '</span>';
      html += '</div>';
    }

    // Row 4: Chain identity + wallet + balance
    const chain = chainAgents[a.id];
    if (chain && (chain.registered || chain.pkp_address)) {
      const addr = chain.pkp_address || '';
      const shortAddr = addr ? addr.slice(0, 6) + '…' + addr.slice(-4) : '';
      const chainId = chain.erc8004_agent_id != null ? '#' + chain.erc8004_agent_id : '';
      const scanUrl = 'https://basescan.org/address/' + addr;
      const balance = chain.usdc_balance != null ? parseFloat(chain.usdc_balance).toFixed(2) : null;
      html += '<div class="agent-card-chain">';
      html += '<div class="agent-card-chain-row">';
      if (chain.registered) html += '<span>⛓ On-chain ' + chainId + '</span>';
      if (addr) html += '<a href="' + scanUrl + '" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="' + escHtml(addr) + '">' + escHtml(shortAddr) + '</a>';
      html += '</div>';
      if (balance !== null) {
        html += '<div class="agent-card-chain-row">';
        html += '<span style="color:var(--fg3)">Balance</span> <span style="color:var(--green);font-family:var(--mono);font-weight:600">' + balance + ' USDC</span>';
        html += '</div>';
      }
      html += '</div>';
    }

    // Row 5: Score bar (if has scores)
    if (composite > 0) {
      html += '<div class="agent-score">'
        + '<div class="score-bar"><div class="score-fill" style="width:'+composite+'%;background:'+scoreColor(composite)+'"></div></div>'
        + '<div class="score-num" style="color:'+scoreColor(composite)+'">' + composite.toFixed(1) + '</div>'
        + '</div>';
    }

    // Row 6: Reputation sparkline (if history exists)
    const agentHistory = scoreHistory[a.id] || [];
    if (agentHistory.length >= 2) {
      html += buildSparkline(agentHistory);
    }

    html += '</div>'; // .agent-card
  }
  grid.innerHTML = html;

  // Render modal if editing
  const modalContainer = document.getElementById('agentModalContainer');
  if (editingAgent) {
    const a = agents.find(x => x.id === editingAgent);
    if (a) {
      const sc = scores[a.id] || {};
      const composite = sc.composite || 0;
      const dims = sc.dimensions || {};
      const hb = heartbeatData[a.id];
      const isOnline = hb && hb.online;
      const activeTab = window._agentModalTab || 'overview';
      let mhtml = '<div class="agent-modal-overlay" onclick="closeAgentEditor()">';
      mhtml += '<div class="agent-modal" onclick="event.stopPropagation()">';

      // Header with avatar (click to upload new)
      const modalMeta = agentMeta(a.id);
      mhtml += '<div class="agent-modal-header">';
      mhtml += '<span class="agent-modal-title" style="display:flex;align-items:center;gap:8px">';
      mhtml += '<span style="cursor:pointer;position:relative" onclick="document.getElementById(\'editAvatarInput\').click()" title="Click to change avatar">'
        + avatarHtml(modalMeta, 32)
        + '<span style="position:absolute;bottom:-2px;right:-2px;font-size:10px;background:var(--bg2);border-radius:50%;padding:1px;line-height:1">✏️</span>'
        + '</span>';
      mhtml += '<input type="file" id="editAvatarInput" accept="image/png" style="display:none" onchange="uploadAgentAvatar(\'' + escHtml(a.id) + '\', this)">';
      mhtml += '<span class="hb-dot ' + (isOnline ? 'online' : 'offline') + '"></span> '
        + escHtml(capitalize(a.id));
      mhtml += '</span>';
      mhtml += '<button class="agent-modal-close" onclick="closeAgentEditor()">✕</button></div>';

      // Tabs
      mhtml += '<div class="modal-tabs">';
      mhtml += '<button class="modal-tab' + (activeTab==='overview'?' active':'') + '" onclick="switchAgentTab(\'overview\')">Overview</button>';
      mhtml += '<button class="modal-tab' + (activeTab==='edit'?' active':'') + '" onclick="switchAgentTab(\'edit\')">Edit</button>';
      mhtml += '<button class="modal-tab' + (activeTab==='files'?' active':'') + '" onclick="switchAgentTab(\'files\');loadAgentFiles(\'' + escHtml(a.id) + '\')">Files</button>';
      mhtml += '<button class="modal-tab' + (activeTab==='tools'?' active':'') + '" onclick="switchAgentTab(\'tools\');loadAgentTools(\'' + escHtml(a.id) + '\')">Tools</button>';
      mhtml += '</div>';

      // ═══ OVERVIEW TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='overview'?' active':'') + '" data-tab="overview">';

      // ── Card 1: Reputation + Trend Chart ──
      if (composite > 0) {
        const agentHist = scoreHistory[a.id] || [];
        mhtml += '<div class="overview-card">';
        const dimNames = {task_completion:'Completion',output_quality:'Quality',improvement_rate:'Improvement',consistency:'Consistency',review_accuracy:'Review'};
        // Top row: big score left + radar chart right
        mhtml += '<div class="rep-top">';
        mhtml += '<div class="rep-left">';
        mhtml += '<div class="rep-big">' + composite.toFixed(1) + '</div>';
        mhtml += '<div class="rep-sub">Reputation Score</div>';
        mhtml += '<div class="dim-badges">';
        for (const [k,label] of Object.entries(dimNames)) {
          const v = dims[k] || 0;
          mhtml += '<div class="dim-badge"><span class="dim-dot" style="background:'+scoreColor(v)+'"></span><span style="color:var(--fg2)">'+label+'</span><span style="color:'+scoreColor(v)+';font-family:var(--mono)">'+v.toFixed(0)+'</span></div>';
        }
        mhtml += '</div></div>';
        mhtml += '<div class="radar-wrap" id="radar_' + a.id + '"></div>';
        mhtml += '</div>';
        // Trend chart with time axis
        if (agentHist.length >= 2) {
          mhtml += '<div class="trend-chart" id="trendChart_' + a.id + '"></div>';
        }
        mhtml += '</div>';
      }

      // ── Card 2: Configuration ──
      mhtml += '<div class="overview-card">';
      mhtml += '<div class="overview-label">Configuration</div>';
      mhtml += '<div class="config-grid">';
      mhtml += '<div><div class="cfg-key">Model</div><div class="cfg-val">' + escHtml(a.model||'—') + '</div></div>';
      mhtml += '<div><div class="cfg-key">Provider</div><div class="cfg-val">' + escHtml(a.provider||'—') + '</div></div>';
      const modalPrivateSkills = (a.skills||[]).filter(s => !sharedSkillNames.has(s));
      mhtml += '<div><div class="cfg-key">Skills</div><div class="cfg-val">' + (a.skills||[]).length + ' active</div></div>';
      if (a.fallback_models && a.fallback_models.length) {
        mhtml += '<div><div class="cfg-key">Fallbacks</div><div class="cfg-val">' + escHtml(a.fallback_models.join(', ')) + '</div></div>';
      }
      mhtml += '</div></div>';

      // ── Card 3: Role ──
      mhtml += '<div class="overview-card">';
      mhtml += '<div class="overview-label">Role</div>';
      mhtml += '<div class="overview-role">' + escHtml(a.role||'No role defined') + '</div>';
      mhtml += '</div>';

      // ── Card 4: Wallet (if available) ──
      const chainInfo = chainAgents[a.id];
      if (chainInfo && (chainInfo.registered || chainInfo.pkp_address)) {
        const wa = chainInfo.pkp_address || '';
        const waBal = chainInfo.usdc_balance != null ? parseFloat(chainInfo.usdc_balance).toFixed(2) : '—';
        const waScan = 'https://basescan.org/address/' + wa;
        const waChainId = chainInfo.erc8004_agent_id != null ? ' #' + chainInfo.erc8004_agent_id : '';
        mhtml += '<div class="overview-card">';
        mhtml += '<div class="overview-label">Wallet' + (chainInfo.registered ? ' ⛓' + waChainId : '') + '</div>';
        mhtml += '<div style="display:flex;align-items:center;justify-content:space-between">';
        if (wa) mhtml += '<a href="' + waScan + '" target="_blank" rel="noopener" style="color:var(--accent2);font-size:11px;font-family:var(--mono)">' + escHtml(wa.slice(0,6) + '…' + wa.slice(-4)) + '</a>';
        mhtml += '<span style="color:var(--green);font-size:16px;font-weight:700">' + waBal + ' USDC</span>';
        mhtml += '</div></div>';
      }

      // ── Card 5: Current Task ──
      const ct = a.current_task;
      if (ct) {
        mhtml += '<div class="overview-card" style="border-color:var(--accent,#6c9fff)">';
        mhtml += '<div class="overview-label">Current Task</div>';
        mhtml += '<div class="overview-task"><span class="overview-task-id">#' + escHtml(ct.id) + '</span> ';
        mhtml += escHtml(ct.description);
        mhtml += ' <span style="color:var(--fg3)">(' + escHtml(ct.status) + ')</span></div></div>';
      }

      // ── Card 6: Recent Activity ──
      const logs = a.recent_logs || [];
      if (logs.length) {
        mhtml += '<div class="overview-card">';
        mhtml += '<div class="overview-label">Recent Activity</div>';
        mhtml += '<ul class="overview-logs">';
        for (const line of logs) mhtml += '<li>' + escHtml(line) + '</li>';
        mhtml += '</ul></div>';
      }

      mhtml += '</div>'; // overview tab

      // ═══ EDIT TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='edit'?' active':'') + '" data-tab="edit">';
      mhtml += '<div class="agent-editor">';

      // Basic settings
      mhtml += '<div class="field-row">';
      mhtml += '<div class="field"><label>Model</label>'
        + '<div style="display:flex;gap:4px;align-items:center;position:relative">'
        + '<input class="input" id="editModel" value="' + escHtml(a.model||'') + '" style="flex:1" autocomplete="off" onclick="toggleModelDropdown()" readonly>'
        + '<button class="btn" onclick="fetchModels()" style="padding:4px 10px;font-size:11px;white-space:nowrap" title="Fetch models from provider">Fetch</button>'
        + '<div id="modelDropdown" class="model-dropdown" style="display:none"></div>'
        + '</div>'
        + '<div id="modelFetchStatus" style="font-size:10px;color:var(--fg3);margin-top:2px"></div>'
        + '</div>';
      mhtml += '<div class="field"><label>Provider</label><select class="input" id="editProvider" onchange="syncProviderBaseUrl(\'editProvider\',\'editBaseUrl\')">';
      for (const p of ['flock','openai','minimax','ollama','anthropic','deepseek','custom']) {
        mhtml += '<option' + (p===(a.provider||'') ? ' selected' : '') + '>' + p + '</option>';
      }
      mhtml += '</select></div>';
      mhtml += '</div>';
      mhtml += '<div class="field"><label>Role</label><textarea class="input" id="editRole" rows="3">' + escHtml(a.role||'') + '</textarea></div>';

      // Skills — collapsible section with search
      const agentSkills = new Set(a.skills||[]);
      const enabledCount = agentSkills.size;
      const totalCount = allSkills.length;
      mhtml += '<div class="field"><label>Skills</label>';
      mhtml += '<div class="skills-collapse">';
      // Header (click to toggle)
      mhtml += '<div class="skills-header" onclick="toggleSkills(this)">';
      mhtml += '<span class="skills-summary"><span class="skills-count" id="skillsCount">' + enabledCount + '/' + totalCount + '</span> skills enabled</span>';
      mhtml += '<span class="skills-chevron">▼</span>';
      mhtml += '</div>';
      // Body (collapsed by default)
      mhtml += '<div class="skills-body" id="editSkillsBody">';
      mhtml += '<input class="skills-search" placeholder="Search skills..." oninput="filterEditSkills(this.value)">';
      mhtml += '<div class="skills-grid" id="editSkillsBox">';
      for (const sk of allSkills) {
        const checked = agentSkills.has(sk.name) ? ' checked' : '';
        mhtml += '<label data-skill="' + escHtml(sk.name) + '">'
          + '<input type="checkbox" class="edit-skill-cb" value="' + escHtml(sk.name) + '"' + checked
          + ' onchange="updateSkillCount()">' + escHtml(sk.name) + '</label>';
      }
      mhtml += '</div></div></div></div>';

      // Fallback Models
      mhtml += '<div class="field"><label>Fallback Models (comma-separated)</label><input class="input" id="editFallbacks" value="' + escHtml((a.fallback_models||[]).join(', ')) + '"></div>';

      // API Key + Base URL
      mhtml += '<div style="border-top:1px solid var(--bg4);margin:10px 0;padding-top:10px">';
      mhtml += '<div style="font-size:11px;font-weight:700;color:var(--fg2);text-transform:uppercase;margin-bottom:8px">API Configuration</div>';
      mhtml += '<div class="field-row">';
      const keyPlaceholder = a.api_key_masked ? 'Current: ' + a.api_key_masked : 'sk-xxxxxxxx';
      mhtml += '<div class="field"><label>API Key</label><input class="input" id="editApiKey" type="password" value="" placeholder="' + escHtml(keyPlaceholder) + '"><div style="font-size:10px;color:var(--fg3);margin-top:2px">Leave empty to keep current key</div></div>';
      const editProviderDefault = PROVIDER_BASE_URLS[a.provider||'flock'] || 'https://api.openai.com/v1';
      mhtml += '<div class="field"><label>Base URL</label><input class="input" id="editBaseUrl" value="' + escHtml(a.base_url||'') + '" placeholder="' + escHtml(editProviderDefault) + '"></div>';
      mhtml += '</div>';
      mhtml += '</div>';

      mhtml += '<div class="actions" style="justify-content:space-between">';
      mhtml += '<button class="btn-delete-agent" onclick="deleteAgent(\'' + escHtml(a.id) + '\')">Delete Agent</button>';
      mhtml += '<div style="display:flex;gap:8px">';
      mhtml += '<button class="btn btn-outline btn-sm" onclick="closeAgentEditor()">Cancel</button>';
      mhtml += '<button class="btn btn-green btn-sm" onclick="saveAgent(\'' + escHtml(a.id) + '\')">Save</button>';
      mhtml += '</div></div>';
      mhtml += '</div>'; // .agent-editor
      mhtml += '</div>'; // edit tab

      // ═══ FILES TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='files'?' active':'') + '" data-tab="files">';
      mhtml += '<div id="agentFilesContent" style="min-height:200px"><div class="empty" style="padding:16px">Click to load files…</div></div>';
      mhtml += '</div>'; // files tab

      // ═══ TOOLS TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='tools'?' active':'') + '" data-tab="tools">';
      mhtml += '<div id="agentToolsContent" style="min-height:200px"><div class="empty" style="padding:16px">Click to load tools…</div></div>';
      mhtml += '</div>'; // tools tab

      mhtml += '</div>'; // .agent-modal
      mhtml += '</div>'; // .agent-modal-overlay
      modalContainer.innerHTML = mhtml;
      // Render radar charts + trend charts after DOM insertion
      for (const ag of agents) {
        const agSc = scores[ag.id] || {};
        const agDims = agSc.dimensions || {};
        requestAnimationFrame(() => renderRadarChart('radar_' + ag.id, agDims));
        const hist = scoreHistory[ag.id] || [];
        if (hist.length >= 2) {
          requestAnimationFrame(() => renderTrendChart('trendChart_' + ag.id, hist));
        }
      }
    }
  } else {
    modalContainer.innerHTML = '';
  }
}

/* ── Skills collapse helpers ─────────────────────── */
function toggleSkills(header) {
  const body = header.nextElementSibling;
  const isOpen = header.classList.toggle('open');
  if (isOpen) {
    body.classList.add('open');
    // Measure natural height then animate
    body.style.maxHeight = body.scrollHeight + 'px';
    // Re-measure after content may shift
    setTimeout(() => { if (body.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px'; }, 360);
  } else {
    body.style.maxHeight = body.scrollHeight + 'px';
    // Force reflow then collapse
    body.offsetHeight;
    body.style.maxHeight = '0';
    body.classList.remove('open');
  }
}
function filterEditSkills(query) {
  const q = query.toLowerCase();
  document.querySelectorAll('#editSkillsBox label').forEach(lbl => {
    const name = (lbl.dataset.skill || '').toLowerCase();
    lbl.classList.toggle('hidden', q && !name.includes(q));
  });
  // Re-adjust body height
  const body = document.getElementById('editSkillsBody');
  if (body && body.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px';
}
function updateSkillCount() {
  const total = document.querySelectorAll('.edit-skill-cb').length;
  const checked = document.querySelectorAll('.edit-skill-cb:checked').length;
  const el = document.getElementById('skillsCount');
  if (el) el.textContent = checked + '/' + total;
}

function switchAgentTab(tab) {
  window._agentModalTab = tab;
  const tabMap = {'overview': 'Overview', 'edit': 'Edit', 'files': 'Files', 'tools': 'Tools'};
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.toggle('active', t.textContent === tabMap[tab]));
  document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.toggle('active', c.dataset.tab === tab));
}

function editAgent(id) {
  editingAgent = editingAgent === id ? null : id;
  loadAgents();
}

function closeAgentEditor() {
  editingAgent = null;
  document.getElementById('agentModalContainer').innerHTML = '';
}

const PROVIDER_BASE_URLS = {
  flock:     'https://api.flock.io/v1',
  openai:    'https://api.openai.com/v1',
  minimax:   'https://api.minimax.io/v1',
  ollama:    'http://localhost:11434/v1',
  anthropic: 'https://api.anthropic.com/v1',
  deepseek:  'https://api.deepseek.com/v1',
  custom:    '',
};
function syncProviderBaseUrl(selectId, urlInputId) {
  const provider = document.getElementById(selectId).value;
  const urlInput = document.getElementById(urlInputId);
  const defaultUrl = PROVIDER_BASE_URLS[provider] || '';
  urlInput.value = defaultUrl;
  urlInput.placeholder = defaultUrl || 'https://api.example.com/v1';
}

let _fetchedModels = [];

async function fetchModels() {
  const provider = document.getElementById('editProvider').value;
  const baseUrl = document.getElementById('editBaseUrl').value.trim();
  const apiKey = document.getElementById('editApiKey').value.trim();
  const status = document.getElementById('modelFetchStatus');
  const modelInput = document.getElementById('editModel');

  status.textContent = 'Fetching models…';
  status.style.color = 'var(--fg3)';
  _fetchedModels = [];

  let url = '/v1/models?provider=' + encodeURIComponent(provider);
  if (baseUrl) url += '&base_url=' + encodeURIComponent(baseUrl);
  if (apiKey) url += '&api_key=' + encodeURIComponent(apiKey);

  try {
    const res = await api(url);
    if (res && res.models && res.models.length) {
      _fetchedModels = res.models.map(m => m.id);
      status.textContent = res.models.length + ' models found — click input to select';
      status.style.color = 'var(--green)';
      // Auto-open dropdown
      showModelDropdown();
    } else if (res && res.error) {
      status.textContent = res.error;
      status.style.color = 'var(--red)';
    } else {
      status.textContent = 'No models returned';
      status.style.color = 'var(--yellow)';
    }
  } catch (e) {
    status.textContent = 'Fetch failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

function showModelDropdown() {
  const dd = document.getElementById('modelDropdown');
  const current = document.getElementById('editModel').value;
  if (!dd || !_fetchedModels.length) return;
  dd.innerHTML = '';
  for (const m of _fetchedModels) {
    const cls = m === current ? 'model-option selected' : 'model-option';
    dd.innerHTML += '<div class="' + cls + '" onclick="selectModel(\'' + escHtml(m) + '\')">' + escHtml(m) + '</div>';
  }
  dd.style.display = 'block';
  // Close on outside click
  setTimeout(() => document.addEventListener('click', _closeModelDropdown, {once: true}), 50);
}

function toggleModelDropdown() {
  const dd = document.getElementById('modelDropdown');
  if (!dd) return;
  if (dd.style.display === 'block') { dd.style.display = 'none'; return; }
  if (_fetchedModels.length) showModelDropdown();
}

function selectModel(modelId) {
  document.getElementById('editModel').value = modelId;
  const dd = document.getElementById('modelDropdown');
  if (dd) dd.style.display = 'none';
}

function _closeModelDropdown(e) {
  const dd = document.getElementById('modelDropdown');
  if (dd && !dd.contains(e.target) && e.target.id !== 'editModel') dd.style.display = 'none';
}

async function saveAgent(id) {
  const model = document.getElementById('editModel').value.trim();
  const provider = document.getElementById('editProvider').value;
  const role = document.getElementById('editRole').value.trim();
  const fallbacks = document.getElementById('editFallbacks').value.split(',').map(s=>s.trim()).filter(Boolean);
  const skills = Array.from(document.querySelectorAll('.edit-skill-cb:checked')).map(cb => cb.value);
  const apiKey = document.getElementById('editApiKey').value.trim();
  const baseUrl = document.getElementById('editBaseUrl').value.trim();

  const body = {model, provider, role, fallback_models: fallbacks, skills};
  if (apiKey) body.api_key = apiKey;
  if (baseUrl) body.base_url = baseUrl;

  const res = await apiPut('/v1/agents/' + id, body);
  if (res && res.ok) {
    toast('Agent ' + id + ' updated');
    editingAgent = null;
    loadAgents();
  } else {
    toast(res?.error || 'Failed to update agent', 'error');
  }
}

function showCreateAgentModal() {
  const container = document.getElementById('agentModalContainer');
  let mhtml = '<div class="agent-modal-overlay" onclick="closeAgentEditor()">';
  mhtml += '<div class="agent-modal" onclick="event.stopPropagation()">';
  mhtml += '<div class="agent-modal-header"><span class="agent-modal-title">Create Agent</span>'
    + '<button class="agent-modal-close" onclick="closeAgentEditor()">✕</button></div>';
  mhtml += '<div class="agent-editor">';

  // Avatar upload
  mhtml += '<div class="field" style="text-align:center;margin-bottom:12px">';
  mhtml += '<div id="newAgentAvatarPreview" style="width:64px;height:64px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;cursor:pointer;border:2px dashed var(--bg4);font-size:24px;transition:border-color .2s" onclick="document.getElementById(\'newAgentAvatarInput\').click()" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--bg4)\'">📷</div>';
  mhtml += '<input type="file" id="newAgentAvatarInput" accept="image/png" style="display:none" onchange="previewNewAvatar(this)">';
  mhtml += '<div style="font-size:10px;color:var(--fg3)">Click to upload avatar (PNG, max 500KB)</div>';
  mhtml += '</div>';

  // ID
  mhtml += '<div class="field"><label>Agent ID (lowercase, no spaces)</label><input class="input" id="newAgentId" placeholder="e.g. researcher"></div>';

  // Role
  mhtml += '<div class="field"><label>Role</label><textarea class="input" id="newAgentRole" rows="2" placeholder="e.g. Research analyst who gathers and synthesizes information"></textarea></div>';

  // Model + Provider
  mhtml += '<div class="field-row">';
  mhtml += '<div class="field"><label>Model</label><input class="input" id="newAgentModel" placeholder="e.g. gpt-4o"></div>';
  mhtml += '<div class="field"><label>Provider</label><select class="input" id="newAgentProvider" onchange="syncProviderBaseUrl(\'newAgentProvider\',\'newAgentBaseUrl\')">';
  for (const p of ['flock','openai','minimax','ollama','anthropic','deepseek','custom']) {
    mhtml += '<option>' + p + '</option>';
  }
  mhtml += '</select></div>';
  mhtml += '</div>';

  // Tools Profile
  mhtml += '<div class="field"><label>Tool Profile</label>';
  mhtml += '<div style="display:flex;gap:8px;align-items:center">';
  mhtml += '<select class="input" id="newAgentToolProfile" style="flex:1">';
  for (const p of ['coding','minimal','full']) {
    mhtml += '<option value="'+p+'"' + (p==='coding'?' selected':'') + '>' + p + '</option>';
  }
  mhtml += '</select>';
  mhtml += '<label style="font-size:12px;white-space:nowrap;cursor:pointer"><input type="checkbox" id="newAgentSelectAllTools" onchange="toggleSelectAllTools(this)"> Select All</label>';
  mhtml += '</div></div>';

  // API Key + Base URL (optional)
  mhtml += '<div style="border-top:1px solid var(--bg4);margin:10px 0;padding-top:10px">';
  mhtml += '<div style="font-size:11px;font-weight:700;color:var(--fg2);text-transform:uppercase;margin-bottom:8px">API Configuration (optional)</div>';
  mhtml += '<div class="field-row">';
  mhtml += '<div class="field"><label>API Key</label><input class="input" id="newAgentApiKey" type="password" placeholder="Leave empty to use global key"></div>';
  mhtml += '<div class="field"><label>Base URL</label><input class="input" id="newAgentBaseUrl" placeholder="Leave empty for default"></div>';
  mhtml += '</div></div>';

  mhtml += '<div class="actions">';
  mhtml += '<button class="btn btn-outline btn-sm" onclick="closeAgentEditor()">Cancel</button>';
  mhtml += '<button class="btn btn-green btn-sm" onclick="createAgent()">Create</button>';
  mhtml += '</div>';
  mhtml += '</div></div></div>';
  container.innerHTML = mhtml;
}

async function createAgent() {
  const id = (document.getElementById('newAgentId').value||'').trim().toLowerCase().replace(/\s+/g, '_');
  const role = (document.getElementById('newAgentRole').value||'').trim();
  const model = (document.getElementById('newAgentModel').value||'').trim();
  const provider = document.getElementById('newAgentProvider').value;
  const apiKey = (document.getElementById('newAgentApiKey').value||'').trim();
  const baseUrl = (document.getElementById('newAgentBaseUrl').value||'').trim();

  if (!id) { toast('Agent ID is required', 'error'); return; }
  if (!model) { toast('Model is required', 'error'); return; }
  if (!/^[a-zA-Z0-9_-]+$/.test(id)) { toast('ID must be alphanumeric (a-z, 0-9, _ or -)', 'error'); return; }

  // Build tools config
  const selectAll = document.getElementById('newAgentSelectAllTools')?.checked;
  const toolProfile = selectAll ? 'full' : (document.getElementById('newAgentToolProfile')?.value || 'coding');

  const body = { id, role: role || 'general assistant', model, provider, skills: ['_base'], tools: { profile: toolProfile } };
  if (apiKey) body.api_key = apiKey;
  if (baseUrl) body.base_url = baseUrl;

  const res = await apiPost('/v1/agents', body);
  if (res && res.ok) {
    // Upload avatar if selected
    const avatarInput = document.getElementById('newAgentAvatarInput');
    if (avatarInput && avatarInput.files[0]) {
      const formData = new FormData();
      formData.append('avatar', avatarInput.files[0]);
      try {
        await fetch('/v1/agents/' + id + '/avatar', {
          method: 'POST',
          headers: {'X-Api-Key': localStorage.getItem('cleo_api_key') || ''},
          body: formData
        });
      } catch(e) { console.warn('Avatar upload failed:', e); }
    }
    toast('Agent ' + id + ' created');
    closeAgentEditor();
    loadAgents();
  } else {
    toast(res?.error || 'Failed to create agent', 'error');
  }
}

async function deleteAgent(id) {
  if (!confirm('Delete agent "' + id + '"? This removes it from the config but preserves skill files and cognition docs.')) return;
  const res = await apiDelete('/v1/agents/' + id);
  if (res && res.ok) {
    toast('Agent ' + id + ' deleted');
    closeAgentEditor();
    loadAgents();
  } else {
    toast(res?.error || 'Failed to delete agent', 'error');
  }
}

// ── Avatar helpers ──
function previewNewAvatar(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 512000) { toast('Avatar too large (max 500KB)', 'error'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    const preview = document.getElementById('newAgentAvatarPreview');
    if (preview) preview.innerHTML = '<img src="'+e.target.result+'" style="width:64px;height:64px;border-radius:50%;object-fit:cover">';
  };
  reader.readAsDataURL(file);
}

function toggleSelectAllTools(cb) {
  const sel = document.getElementById('newAgentToolProfile');
  if (cb.checked) {
    if (sel) { sel.value = 'full'; sel.disabled = true; }
  } else {
    if (sel) { sel.value = 'coding'; sel.disabled = false; }
  }
}

async function uploadAgentAvatar(agentId, input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 512000) { toast('Avatar too large (max 500KB)', 'error'); return; }
  const formData = new FormData();
  formData.append('avatar', file);
  try {
    const res = await fetch('/v1/agents/' + agentId + '/avatar', {
      method: 'POST',
      headers: {'X-Api-Key': localStorage.getItem('cleo_api_key') || ''},
      body: formData
    });
    const data = await res.json();
    if (data.ok) {
      toast('Avatar updated');
      // Update cache-busted avatar in meta
      if (AGENT_META[agentId]) AGENT_META[agentId].avatar = data.avatar + '?t=' + Date.now();
      loadAgents();
    } else {
      toast(data.error || 'Upload failed', 'error');
    }
  } catch(e) { toast('Upload failed: ' + e.message, 'error'); }
}

// ══════════════════════════════════════════════════════════════════
//  SKILLS — List + Editor
// ══════════════════════════════════════════════════════════════════

async function loadSkills() {
  const [skills, agentData] = await Promise.all([api('/v1/skills'), api('/v1/agents')]);
  skillsData = skills;
  if (!skillsData) return;

  // Populate agent filter dropdown
  const sel = document.getElementById('skillAgentFilter');
  const prev = sel.value;
  sel.innerHTML = '<option value="">All agents</option>';
  const agents = agentData?.agents || [];
  for (const a of agents) {
    const agentSkills = (a.skills || []);
    sel.innerHTML += '<option value="' + escHtml(a.id) + '">' + escHtml(a.id) + ' (' + agentSkills.length + ' skills)</option>';
  }
  sel.value = prev; // preserve selection across reloads
  // Store agent skill assignments for filtering
  skillsData._agentAssignments = {};
  for (const a of agents) {
    skillsData._agentAssignments[a.id] = new Set(a.skills || []);
  }
  renderSkillsList();
}

function renderSkillsList() {
  const body = document.getElementById('skillsListBody');
  const filter = (document.getElementById('skillSearch').value||'').toLowerCase();
  const agentFilter = (document.getElementById('skillAgentFilter')?.value||'');
  const assignments = skillsData._agentAssignments || {};
  let html = '';

  // Helper: check if a skill name is assigned to the filtered agent
  function agentHasSkill(skillName) {
    if (!agentFilter) return true;  // no filter = show all
    const agentSkills = assignments[agentFilter];
    return agentSkills && (agentSkills.has(skillName) || agentSkills.has('_base'));
  }

  // Team skill (always visible if _base is in scope)
  if (skillsData.team && skillsData.team.exists) {
    const match = (!filter || '_team'.includes(filter) || 'team'.includes(filter)) && agentHasSkill('_team');
    if (match) {
      html += '<div class="skill-group-title">Team</div>';
      html += '<div class="skill-item' + (currentSkill?.key === 'team:_team' ? ' active' : '') + '" onclick="selectSkill(\'team\',\'_team\')">';
      html += '<span>_team</span><span class="skill-scope">team</span></div>';
    }
  }

  // Shared skills — highlight which ones are assigned to filtered agent
  const shared = (skillsData.shared || []).filter(s =>
    (!filter || s.name.toLowerCase().includes(filter)) && agentHasSkill(s.name)
  );
  if (shared.length) {
    html += '<div class="skill-group-title">Shared' + (agentFilter ? ' → ' + escHtml(agentFilter) : '') + '</div>';
    for (const s of shared) {
      const isAssigned = agentFilter && assignments[agentFilter]?.has(s.name);
      const badge = isAssigned ? ' <span style="color:var(--green);font-size:9px">●</span>' : '';
      html += '<div class="skill-item' + (currentSkill?.key === 'shared:'+s.name ? ' active' : '') + '" onclick="selectSkill(\'shared\',\'' + escHtml(s.name) + '\')">';
      html += '<span>' + escHtml(s.name) + badge + '</span><span class="skill-scope">shared</span></div>';
    }
  }

  // Agent-specific skill files
  const agents = skillsData.agents || {};
  for (const [aid, skills] of Object.entries(agents).sort()) {
    if (agentFilter && aid !== agentFilter) continue;  // skip agents not matching filter
    const filtered = skills.filter(s => !filter || s.name.toLowerCase().includes(filter) || aid.includes(filter));
    if (!filtered.length) continue;
    html += '<div class="skill-group-title">Agent: ' + escHtml(aid) + '</div>';
    for (const s of filtered) {
      const key = 'agent:' + aid + ':' + s.name;
      html += '<div class="skill-item' + (currentSkill?.key === key ? ' active' : '') + '" onclick="selectSkill(\'agent\',\'' + escHtml(s.name) + '\',\'' + escHtml(aid) + '\')">';
      html += '<span>' + escHtml(s.name) + '</span><span class="skill-scope">' + escHtml(aid) + '</span></div>';
    }
  }

  if (!html) html = '<div class="empty">No skills found</div>';
  body.innerHTML = html;
}

function filterSkills() { renderSkillsList(); }

async function selectSkill(scope, name, agentId) {
  // Check unsaved changes
  if (skillsDirty && !confirm('You have unsaved changes. Discard?')) return;
  skillsDirty = false;

  let path, key;
  if (scope === 'team') {
    path = '/v1/skills/team';
    key = 'team:_team';
  } else if (scope === 'agent') {
    path = '/v1/skills/agents/' + agentId + '/' + name;
    key = 'agent:' + agentId + ':' + name;
  } else {
    path = '/v1/skills/' + name;
    key = 'shared:' + name;
  }

  const data = await api(path);
  if (!data) { toast('Failed to load skill', 'error'); return; }

  currentSkill = {scope, name, agentId, key, data};

  const editor = document.getElementById('skillsEditor');
  let h = '<div class="skills-toolbar">';
  h += '<span class="skill-filename">' + escHtml(data.file || name + '.md') + '</span>';
  h += '<span style="font-size:11px;color:var(--fg3);margin-left:4px">(' + (data.size||0) + ' bytes)</span>';
  h += '<span style="flex:1"></span>';

  // Save button
  h += '<button class="btn btn-green btn-sm" onclick="saveSkill()">Save</button>';

  // Download button
  h += '<button class="btn btn-outline btn-sm" onclick="downloadSkill()">↓ Download</button>';

  // Delete button (not for team or system skills)
  if (scope !== 'team' && !name.startsWith('_')) {
    h += '<button class="btn btn-danger btn-sm" onclick="deleteSkill()">Delete</button>';
  }

  // Regen button for team
  if (scope === 'team') {
    h += '<button class="btn btn-outline btn-sm" onclick="regenerateTeamSkill()">↻ Regenerate</button>';
  }

  h += '</div>';

  // ── Assignment panel for shared skills ──
  if (scope === 'shared' && !name.startsWith('_')) {
    const agentsResp = await api('/v1/agents');
    const agentsList = agentsResp?.agents || [];
    if (agentsList.length) {
      h += '<div class="skill-assign-bar">';
      h += '<span class="skill-assign-label">Assigned to:</span>';
      for (const ag of agentsList) {
        const hasSkill = (ag.skills || []).includes(name);
        h += '<label class="skill-assign-cb"><input type="checkbox" class="assign-agent-cb" value="' + escHtml(ag.id) + '"'
          + (hasSkill ? ' checked' : '') + ' onchange="updateSkillAssignment()">'
          + '<span>' + escHtml(ag.id) + '</span></label>';
      }
      h += '</div>';
    }
  }

  h += '<textarea class="mono" id="skillContent" oninput="skillsDirty=true">' + escHtml(data.content||'') + '</textarea>';
  editor.innerHTML = h;

  // Mark active in list
  renderSkillsList();
}

async function saveSkill() {
  if (!currentSkill) return;
  const content = document.getElementById('skillContent').value;

  let path;
  if (currentSkill.scope === 'team') {
    path = '/v1/skills/team';
  } else if (currentSkill.scope === 'agent') {
    path = '/v1/skills/agents/' + currentSkill.agentId + '/' + currentSkill.name;
  } else {
    path = '/v1/skills/' + currentSkill.name;
  }

  const res = await apiPut(path, {content});
  if (res && res.ok) {
    toast('Skill saved');
    skillsDirty = false;
  } else {
    toast(res?.error || 'Failed to save', 'error');
  }
}

// Update which agents have this shared skill assigned
async function updateSkillAssignment() {
  if (!currentSkill || currentSkill.scope !== 'shared') return;
  const skillName = currentSkill.name;
  const agentsResp = await api('/v1/agents');
  const agentsList = agentsResp?.agents || [];
  const checkboxes = document.querySelectorAll('.assign-agent-cb');

  for (const cb of checkboxes) {
    const agentId = cb.value;
    const shouldHave = cb.checked;
    const agent = agentsList.find(a => a.id === agentId);
    if (!agent) continue;
    const currentSkills = new Set(agent.skills || []);
    const hasIt = currentSkills.has(skillName);
    if (shouldHave === hasIt) continue; // no change needed
    if (shouldHave) currentSkills.add(skillName);
    else currentSkills.delete(skillName);
    await apiPut('/v1/agents/' + agentId, {skills: Array.from(currentSkills)});
  }
  toast('Skill assignment updated');
}

async function deleteSkill() {
  if (!currentSkill) return;
  if (!confirm('Delete skill "' + currentSkill.name + '"? This cannot be undone.')) return;

  let path;
  if (currentSkill.scope === 'agent') {
    path = '/v1/skills/agents/' + currentSkill.agentId + '/' + currentSkill.name;
  } else {
    path = '/v1/skills/' + currentSkill.name;
  }

  const res = await apiDelete(path);
  if (res && res.ok) {
    toast('Skill deleted');
    currentSkill = null;
    skillsDirty = false;
    document.getElementById('skillsEditor').innerHTML = '<div class="skills-empty">Select a skill from the list</div>';
    loadSkills();
  } else {
    toast(res?.error || 'Failed to delete', 'error');
  }
}

function downloadSkill() {
  if (!currentSkill) return;
  const content = document.getElementById('skillContent').value;
  const blob = new Blob([content], {type: 'text/markdown'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (currentSkill.name || 'skill') + '.md';
  a.click();
  URL.revokeObjectURL(url);
}

function uploadSkill(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function() {
    const content = reader.result;
    const name = file.name.replace(/\.md$/, '');

    // Create as shared skill
    const res = await apiPut('/v1/skills/' + name, {content});
    if (res && res.ok) {
      // Auto-assign to all agents
      const agentsResp = await api('/v1/agents');
      if (agentsResp?.agents) {
        for (const ag of agentsResp.agents) {
          const skills = new Set(ag.skills || []);
          if (!skills.has(name)) {
            skills.add(name);
            await apiPut('/v1/agents/' + ag.id, {skills: Array.from(skills)});
          }
        }
      }
      toast('Skill "' + name + '" uploaded and assigned to all agents');
      await loadSkills();
      selectSkill('shared', name);
    } else {
      toast(res?.error || 'Upload failed', 'error');
    }
  };
  reader.readAsText(file);
  input.value = '';
}

async function regenerateTeamSkill() {
  const res = await apiPost('/v1/skills/team/regenerate', {});
  if (res && res.ok) {
    toast('Team skill regenerated');
    if (currentSkill?.scope === 'team') {
      selectSkill('team', '_team');
    }
  } else {
    toast(res?.error || 'Failed to regenerate', 'error');
  }
}

// ── Cleo Files ──────────────────────────────────────────────────────

async function loadCfFiles() {
  cfData = await api('/v1/cleo-files');
  if (!cfData) return;
  renderCfList();
}

function renderCfList() {
  const body = document.getElementById('cfListBody');
  const filter = (document.getElementById('cfSearch').value || '').toLowerCase();
  let html = '';

  // Global files
  const global = (cfData.global || []).filter(f =>
    !filter || f.name.toLowerCase().includes(filter));
  if (global.length) {
    html += '<div class="skill-group-title">Global</div>';
    for (const f of global) {
      const active = currentCfFile?.scope === 'global' && currentCfFile?.name === f.name;
      html += '<div class="skill-item' + (active ? ' active' : '') + '" onclick="selectCfFile(\'global\',\'' + escHtml(f.name) + '\')">';
      html += '<span>' + escHtml(f.name) + '</span>';
      html += '<span class="skill-scope">' + formatBytes(f.size) + '</span></div>';
    }
  }

  // Per-agent files
  const agents = cfData.agents || {};
  for (const aid of Object.keys(agents).sort()) {
    const files = agents[aid].filter(f =>
      !filter || f.name.toLowerCase().includes(filter));
    if (!files.length) continue;
    html += '<div class="skill-group-title">' + escHtml(aid) + '</div>';
    for (const f of files) {
      const scope = 'agent-' + aid;
      const active = currentCfFile?.scope === scope && currentCfFile?.name === f.name;
      html += '<div class="skill-item' + (active ? ' active' : '') + '" onclick="selectCfFile(\'' + escHtml(scope) + '\',\'' + escHtml(f.name) + '\')">';
      html += '<span>' + escHtml(f.name) + '</span>';
      html += '<span class="skill-scope">' + formatBytes(f.size) + '</span></div>';
    }
  }

  if (!html) html = '<div class="empty">No files found</div>';
  body.innerHTML = html;
}

function filterCfFiles() { renderCfList(); }

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  return (bytes / 1024).toFixed(1) + ' KB';
}

async function selectCfFile(scope, name) {
  if (cfDirty && !confirm('You have unsaved changes. Discard?')) return;
  cfDirty = false;

  const data = await api('/v1/cleo-files/' + scope + '/' + name);
  if (!data) { toast('Failed to load file', 'error'); return; }

  currentCfFile = {scope, name, content: data.content};

  const editor = document.getElementById('cfEditor');
  let h = '<div class="skills-toolbar">';
  h += '<span class="skill-filename">' + escHtml(data.path || name) + '</span>';
  h += '<span style="font-size:11px;color:var(--fg3);margin-left:4px">(' + formatBytes(data.size) + ')</span>';
  h += '<span style="flex:1"></span>';
  h += '<button class="btn btn-green btn-sm" onclick="saveCfFile()">Save</button>';
  h += '</div>';
  h += '<textarea class="mono" id="cfContent" oninput="cfDirty=true">' + escHtml(data.content || '') + '</textarea>';
  editor.innerHTML = h;

  renderCfList(); // update active highlight
}

async function saveCfFile() {
  if (!currentCfFile) return;
  const content = document.getElementById('cfContent').value;
  const res = await apiPut('/v1/cleo-files/' + currentCfFile.scope + '/' + currentCfFile.name, {content});
  if (res && res.ok) {
    toast('Saved ' + currentCfFile.name);
    cfDirty = false;
    currentCfFile.content = content;
    loadCfFiles(); // refresh sizes
  } else {
    toast(res?.error || 'Save failed', 'error');
  }
}

// ── Skills Create Dialog ────────────────────────────────────────────

function showCreateDialog() {
  // Populate agent scope options
  const sel = document.getElementById('newSkillScope');
  sel.innerHTML = '<option value="shared">Shared (all agents)</option>';
  if (skillsData?.agents) {
    for (const aid of Object.keys(skillsData.agents).sort()) {
      sel.innerHTML += '<option value="agent:' + escHtml(aid) + '">Agent: ' + escHtml(aid) + '</option>';
    }
  }
  // Also add agents from /v1/agents
  api('/v1/agents').then(d => {
    if (!d?.agents) return;
    for (const a of d.agents) {
      if (!skillsData?.agents?.[a.id]) {
        sel.innerHTML += '<option value="agent:' + escHtml(a.id) + '">Agent: ' + escHtml(a.id) + '</option>';
      }
    }
  });
  document.getElementById('newSkillName').value = '';
  document.getElementById('createDialog').style.display = 'flex';
}

function closeCreateDialog() {
  document.getElementById('createDialog').style.display = 'none';
}

async function createSkill() {
  const name = document.getElementById('newSkillName').value.trim().replace(/[^a-zA-Z0-9_-]/g, '');
  if (!name) { toast('Please enter a skill name', 'error'); return; }

  const scopeVal = document.getElementById('newSkillScope').value;
  const template = '---\nname: ' + name + '\ndescription: \ntags: []\n---\n\n# ' + name + '\n\nSkill content here.\n';

  let path;
  if (scopeVal.startsWith('agent:')) {
    const aid = scopeVal.slice(6);
    path = '/v1/skills/agents/' + aid + '/' + name;
  } else {
    path = '/v1/skills/' + name;
  }

  const res = await apiPut(path, {content: template});
  if (res && res.ok) {
    // Auto-assign shared skills to all agents
    if (!scopeVal.startsWith('agent:')) {
      const agentsResp = await api('/v1/agents');
      if (agentsResp?.agents) {
        for (const ag of agentsResp.agents) {
          const skills = new Set(ag.skills || []);
          if (!skills.has(name)) {
            skills.add(name);
            await apiPut('/v1/agents/' + ag.id, {skills: Array.from(skills)});
          }
        }
      }
    }
    toast('Skill "' + name + '" created');
    closeCreateDialog();
    await loadSkills();
    if (scopeVal.startsWith('agent:')) {
      const aid = scopeVal.slice(6);
      selectSkill('agent', name, aid);
    } else {
      selectSkill('shared', name);
    }
  } else {
    toast(res?.error || 'Failed to create', 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  TOOLS
// ══════════════════════════════════════════════════════════════════

async function loadTools() {
  const data = await api('/v1/tools');
  if (!data) return;

  const tools = data.tools || [];
  const available = tools.filter(t => t.available).length;
  const groups = Object.keys(data.groups || {}).length;

  document.getElementById('tAvail').textContent = available;
  document.getElementById('tTotal').textContent = tools.length;
  document.getElementById('tGroups').textContent = groups;

  // Group tools by group
  const byGroup = {};
  for (const t of tools) {
    const g = t.group || 'other';
    if (!byGroup[g]) byGroup[g] = [];
    byGroup[g].push(t);
  }

  const groupLabels = {web:'Web Tools',automation:'Automation',media:'Media & Devices',fs:'Filesystem',memory:'Memory & Knowledge',task:'Task Management',messaging:'Messaging',other:'Other'};
  const groupIcons = {web:'🌐',automation:'⚡',media:'📷',fs:'📁',memory:'🧠',task:'📋',messaging:'✉️',other:'🔧'};

  let h = '';
  for (const [gname, gtools] of Object.entries(byGroup)) {
    const label = groupLabels[gname] || gname;
    const icon = groupIcons[gname] || '🔧';
    h += '<div class="card" style="padding:16px">';
    h += '<h3 style="margin:0 0 12px;font-size:14px">' + icon + ' ' + escHtml(label) + '</h3>';
    h += '<div style="display:flex;flex-direction:column;gap:8px">';
    for (const t of gtools) {
      const statusColor = t.available ? 'var(--green)' : 'var(--muted)';
      const statusIcon = t.available ? '✓' : '✗';
      const envHint = !t.available && t.requires_env && t.requires_env.length
        ? ' <span style="color:var(--muted);font-size:11px">(needs ' + escHtml(t.requires_env.join(', ')) + ')</span>'
        : '';
      const params = Object.keys(t.parameters || {});
      const paramsStr = params.length ? params.join(', ') : 'none';
      h += '<div style="display:flex;align-items:start;gap:10px;padding:8px;border-radius:6px;background:rgba(255,255,255,0.02)">';
      h += '<span style="color:' + statusColor + ';font-weight:bold;min-width:18px">' + statusIcon + '</span>';
      h += '<div style="flex:1">';
      h += '<div style="font-weight:600;font-size:13px">' + escHtml(t.name) + envHint + '</div>';
      h += '<div style="font-size:11px;color:var(--muted);margin-top:2px">' + escHtml(t.description) + '</div>';
      h += '<div style="font-size:10px;color:var(--muted);margin-top:2px">Params: ' + escHtml(paramsStr) + '</div>';
      h += '</div></div>';
    }
    h += '</div></div>';
  }

  // Profiles reference
  h += '<div class="card" style="padding:16px">';
  h += '<h3 style="margin:0 0 12px;font-size:14px">📋 Tool Profiles</h3>';
  const profiles = data.profiles || {};
  for (const [pname, ptools] of Object.entries(profiles)) {
    const toolsStr = Array.isArray(ptools) ? ptools.join(', ') : ptools;
    h += '<div style="margin-bottom:6px"><span style="font-weight:600;color:var(--accent)">' + escHtml(pname) + '</span>';
    h += ' <span style="color:var(--muted);font-size:11px">— ' + escHtml(String(toolsStr)) + '</span></div>';
  }
  h += '<div style="margin-top:10px;font-size:11px;color:var(--muted)">Configure in agents.yaml under each agent\'s <code>tools:</code> key, or use <code>cleo configure --section tools</code></div>';
  h += '</div>';

  document.getElementById('toolsContent').innerHTML = h;
}

// ══════════════════════════════════════════════════════════════════
//  USAGE
// ══════════════════════════════════════════════════════════════════

async function loadUsage() {
  const data = await api('/v1/usage');
  if (!data) return;

  const agg = data.aggregate || {};
  document.getElementById('uCalls').textContent = fmtNum(agg.total_calls);
  document.getElementById('uTokens').textContent = fmtNum(agg.total_tokens);
  document.getElementById('uCost').textContent = '$' + (agg.total_cost_usd||0).toFixed(4);
  document.getElementById('uRetries').textContent = fmtNum(agg.total_retries);

  // By agent — merge old role IDs into current agent names
  const rawAgent = data.by_agent || {};
  const USAGE_ID_MAP = {planner:'leo', executor:'jerry', reviewer:'alic'};
  const byAgent = {};
  for (const [id, s] of Object.entries(rawAgent)) {
    const mapped = USAGE_ID_MAP[id] || id;
    if (!byAgent[mapped]) byAgent[mapped] = {calls:0, tokens:0, cost:0};
    byAgent[mapped].calls  += s.calls  || 0;
    byAgent[mapped].tokens += s.tokens || 0;
    byAgent[mapped].cost   += s.cost   || 0;
  }
  const agentEl = document.getElementById('usageByAgent');
  if (Object.keys(byAgent).length) {
    let h = '<table class="usage-table"><thead><tr><th>Agent</th><th>Calls</th><th>Tokens</th><th>Cost</th></tr></thead><tbody>';
    for (const [id, s] of Object.entries(byAgent).sort((a,b)=>b[1].tokens-a[1].tokens)) {
      const am = agentMeta(id);
      const ava = am.avatar ? '<img src="'+am.avatar+'" style="width:16px;height:16px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:4px">' : '';
      h += '<tr><td style="font-weight:600">'+ava+escHtml(capitalize(id))+'</td><td class="mono">'+fmtNum(s.calls)+'</td><td class="mono">'+fmtNum(s.tokens)+'</td><td class="mono">$'+s.cost.toFixed(4)+'</td></tr>';
    }
    h += '</tbody></table>';
    agentEl.innerHTML = h;
  } else { agentEl.innerHTML = '<div class="empty">No usage data</div>'; }

  // By model
  const byModel = data.by_model || {};
  const modelEl = document.getElementById('usageByModel');
  if (Object.keys(byModel).length) {
    let h = '<table class="usage-table"><thead><tr><th>Model</th><th>Calls</th><th>Tokens</th><th>Cost</th></tr></thead><tbody>';
    for (const [id, s] of Object.entries(byModel).sort((a,b)=>b[1].tokens-a[1].tokens)) {
      h += '<tr><td style="font-weight:600">'+escHtml(id)+'</td><td class="mono">'+fmtNum(s.calls)+'</td><td class="mono">'+fmtNum(s.tokens)+'</td><td class="mono">$'+s.cost.toFixed(4)+'</td></tr>';
    }
    h += '</tbody></table>';
    modelEl.innerHTML = h;
  } else { modelEl.innerHTML = '<div class="empty">No usage data</div>'; }
}

// ══════════════════════════════════════════════════════════════════
//  CHANNELS
// ══════════════════════════════════════════════════════════════════

const CHANNEL_META = {
  telegram: {
    label: 'Telegram', sdk: 'python-telegram-bot', brand: '#26A5E4',
    svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm5.94 8.13l-1.97 9.28c-.15.67-.54.83-1.09.52l-3.01-2.22-1.45 1.4c-.16.16-.3.3-.61.3l.22-3.05 5.55-5.01c.24-.22-.05-.33-.37-.13L8.7 13.72l-2.97-.93c-.65-.2-.66-.65.14-.96l11.59-4.47c.54-.2 1.01.13.83.96l.04-.19z"/></svg>',
    tokenFields: ['bot_token'],
    guide: 'https://core.telegram.org/bots#how-do-i-create-a-bot',
    guideSteps: ['1. Message @BotFather on Telegram', '2. Send /newbot and follow prompts', '3. Copy the API token and paste below'],
  },
  discord: {
    label: 'Discord', sdk: 'discord.py', brand: '#5865F2',
    svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.32 4.37a19.8 19.8 0 00-4.89-1.52.07.07 0 00-.08.04c-.21.38-.44.87-.6 1.25a18.27 18.27 0 00-5.49 0 12.64 12.64 0 00-.62-1.25.08.08 0 00-.08-.04 19.74 19.74 0 00-4.89 1.52.07.07 0 00-.03.03C1.11 8.39.34 12.27.72 16.1a.08.08 0 00.03.06 19.9 19.9 0 005.99 3.03.08.08 0 00.09-.03c.46-.63.87-1.3 1.22-2a.08.08 0 00-.04-.11 13.1 13.1 0 01-1.87-.9.08.08 0 01-.01-.13c.13-.09.25-.19.37-.29a.08.08 0 01.08-.01c3.93 1.8 8.18 1.8 12.07 0a.08.08 0 01.08.01c.12.1.25.2.37.29a.08.08 0 01 0 .13c-.6.35-1.22.65-1.88.9a.08.08 0 00-.04.11c.36.7.77 1.37 1.22 2a.08.08 0 00.09.03 19.83 19.83 0 006-3.03.08.08 0 00.03-.05c.44-4.53-.73-8.46-3.1-11.95a.06.06 0 00-.03-.03zM8.02 13.72c-1.03 0-1.89-.95-1.89-2.12s.83-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12 0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.83-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12 0 1.17-.83 2.12-1.89 2.12z"/></svg>',
    tokenFields: ['bot_token'],
    guide: 'https://discord.com/developers/applications',
    guideSteps: ['1. Create app at Discord Developer Portal', '2. Go to Bot tab, Reset Token', '3. Enable Message Content Intent'],
  },
  feishu: {
    label: 'Feishu', sdk: 'lark-oapi', brand: '#3370FF',
    svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.57 3.67a.5.5 0 01.81-.17l5.56 4.83a3 3 0 01.9 1.7l.93 5.1a.5.5 0 01-.77.51L5.73 11.1a3 3 0 01-1.33-1.98l-.64-4.1a.5.5 0 01.2-.48l1.6-1.28-.01.41zm7.14 5.38l5.66 4.91a.5.5 0 01-.12.82l-7.27 3.78a3 3 0 01-2.37.14l-4.04-1.4a.5.5 0 01-.12-.87l8.26-7.38z"/></svg>',
    tokenFields: ['app_id', 'app_secret'],
    guide: 'https://open.feishu.cn/document/home/introduction-to-custom-app-development/self-built-application-development-process',
    guideSteps: ['1. Create app at Feishu Open Platform', '2. Copy App ID and App Secret', '3. Enable Bot capability under Features'],
  },
  slack: {
    label: 'Slack', sdk: 'slack-sdk', brand: '#E01E5A',
    svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.04 15.16a2.4 2.4 0 01-2.4 2.4 2.4 2.4 0 01-2.4-2.4 2.4 2.4 0 012.4-2.4h2.4v2.4zm1.2 0a2.4 2.4 0 012.4-2.4 2.4 2.4 0 012.4 2.4v6a2.4 2.4 0 01-2.4 2.4 2.4 2.4 0 01-2.4-2.4v-6zM8.64 5.04a2.4 2.4 0 01-2.4-2.4A2.4 2.4 0 018.64.24a2.4 2.4 0 012.4 2.4v2.4h-2.4zm0 1.2a2.4 2.4 0 012.4 2.4 2.4 2.4 0 01-2.4 2.4h-6a2.4 2.4 0 01-2.4-2.4 2.4 2.4 0 012.4-2.4h6zm10.12 2.4a2.4 2.4 0 012.4-2.4 2.4 2.4 0 012.4 2.4 2.4 2.4 0 01-2.4 2.4h-2.4v-2.4zm-1.2 0a2.4 2.4 0 01-2.4 2.4 2.4 2.4 0 01-2.4-2.4v-6a2.4 2.4 0 012.4-2.4 2.4 2.4 0 012.4 2.4v6zm-2.4 10.12a2.4 2.4 0 012.4 2.4 2.4 2.4 0 01-2.4 2.4 2.4 2.4 0 01-2.4-2.4v-2.4h2.4zm0-1.2a2.4 2.4 0 01-2.4-2.4 2.4 2.4 0 012.4-2.4h6a2.4 2.4 0 012.4 2.4 2.4 2.4 0 01-2.4 2.4h-6z"/></svg>',
    tokenFields: ['bot_token', 'app_token'],
    guide: 'https://api.slack.com/apps',
    guideSteps: ['1. Create app at Slack API portal', '2. Enable Socket Mode, copy App Token (xapp-...)', '3. Install to workspace, copy Bot Token (xoxb-...)'],
  },
};

let _channelData = [];

async function loadChannels() {
  const data = await api('/v1/channels');
  if (!data) return;

  _channelData = data.channels || [];
  const running = _channelData.filter(c => c.running).length;
  const enabled = _channelData.filter(c => c.enabled).length;
  const disabled = _channelData.filter(c => !c.enabled).length;

  document.getElementById('chTotal').textContent = _channelData.length;
  document.getElementById('chRunning').textContent = running;
  document.getElementById('chEnabled').textContent = enabled;
  document.getElementById('chDisabled').textContent = disabled;

  const grid = document.getElementById('channelGrid');
  if (!_channelData.length) {
    grid.innerHTML = '<div class="empty">No channels configured</div>';
    return;
  }

  let h = '';
  for (const ch of _channelData) {
    const meta = CHANNEL_META[ch.channel] || { label: ch.channel, sdk: '?', tokenFields: [], brand: 'var(--accent)', svg: '' };
    const dotCls = ch.running ? 'running' : ch.enabled ? 'enabled' : 'disabled';
    const statusColor = ch.running ? 'var(--green)' : ch.enabled ? 'var(--yellow)' : 'var(--fg3)';
    const statusText = ch.running ? 'Running' : ch.enabled ? 'Enabled' : 'Disabled';
    const tokenOk = ch.token_configured;
    const brandColor = meta.brand || 'var(--accent)';

    h += '<div class="ch-card" style="--ch-brand:' + brandColor + '">'
      + '<div class="ch-status-dot ' + dotCls + '"></div>'
      // Header: logo + name
      + '<div class="ch-header">'
      + '<div class="ch-logo" style="background:color-mix(in srgb,' + brandColor + ' 14%,transparent);color:' + brandColor + '">'
      + (meta.svg || '') + '</div>'
      + '<div><div class="ch-title">' + escHtml(meta.label) + '</div>'
      + '<div style="font-size:11px;color:' + statusColor + ';font-weight:600">' + statusText + '</div>'
      + '</div></div>'
      // Meta row
      + '<div class="ch-meta">'
      + '<span class="key-badge ' + (tokenOk ? 'set' : 'unset') + '">'
      + (tokenOk ? 'Token Set' : 'Token Not Set') + '</span>'
      + '<span>SDK: <code>' + escHtml(meta.sdk) + '</code></span>'
      + '</div>';

    // Config details
    if (ch.config) {
      const mention = ch.mention_required !== undefined ? ch.mention_required : true;
      h += '<div style="font-size:11px;color:var(--fg3)">'
        + 'Mention required: ' + (mention ? 'Yes' : 'No') + '</div>';
    }

    // Action buttons
    h += '<div class="ch-actions">';
    if (ch.enabled) {
      h += '<button class="btn btn-sm btn-danger" onclick="toggleChannel(\'' + ch.channel + '\',false)">Disable</button>';
    } else {
      h += '<button class="btn btn-sm btn-green" onclick="toggleChannel(\'' + ch.channel + '\',true)">Enable</button>';
    }
    h += '<button class="btn btn-sm btn-outline" onclick="showChannelConfig(\'' + ch.channel + '\')">Configure</button>';
    h += '</div></div>';
  }
  grid.innerHTML = h;
}

async function toggleChannel(name, enabled) {
  const resp = await apiPut('/v1/channels/' + name, { enabled: enabled });
  if (resp && resp.ok) {
    loadChannels();
  }
}

function showChannelConfig(name) {
  const ch = _channelData.find(c => c.channel === name);
  const meta = CHANNEL_META[name] || { label: name, tokenFields: [], guideSteps: [], brand: 'var(--accent)', svg: '' };

  let h = '<div class="agent-modal-overlay" onclick="if(event.target===this)this.remove()">';
  h += '<div class="agent-modal">';
  h += '<div class="agent-modal-header">';
  h += '<div class="agent-modal-title">'
    + '<span class="ch-logo" style="width:24px;height:24px;background:color-mix(in srgb,' + (meta.brand||'var(--accent)') + ' 14%,transparent);color:' + (meta.brand||'var(--accent)') + '">'
    + (meta.svg || '') + '</span>'
    + ' Configure ' + escHtml(meta.label) + '</div>';
  h += '<button class="agent-modal-close" onclick="this.closest(\'.agent-modal-overlay\').remove()">&times;</button>';
  h += '</div>';

  h += '<div class="agent-editor"><form id="chConfigForm" onsubmit="saveChannelConfig(\'' + name + '\');return false">';

  // Setup guide
  if (meta.guideSteps && meta.guideSteps.length) {
    h += '<div style="background:var(--bg2);border:1px solid var(--bg3);border-radius:8px;padding:10px 12px;margin-bottom:12px">';
    h += '<div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">Setup Guide</div>';
    for (const step of meta.guideSteps) {
      h += '<div style="font-size:11px;color:var(--fg2);margin:2px 0">' + escHtml(step) + '</div>';
    }
    if (meta.guide) {
      h += '<a href="' + meta.guide + '" target="_blank" rel="noopener" '
        + 'style="font-size:11px;color:var(--accent);text-decoration:none;display:inline-block;margin-top:4px">'
        + 'Open Developer Portal &rarr;</a>';
    }
    h += '</div>';
  }

  // Token fields
  for (const field of meta.tokenFields) {
    const label = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    h += '<div class="field">';
    h += '<label>' + escHtml(label) + '</label>';
    h += '<input class="input" type="password" id="ch_' + field + '" placeholder="Enter ' + label + '…" autocomplete="off">';
    h += '<div style="font-size:10px;color:var(--fg3);margin-top:2px">Leave empty to keep current value</div>';
    h += '</div>';
  }

  // Test token button + result area
  h += '<div style="margin:8px 0">';
  h += '<button type="button" class="btn btn-sm btn-outline" onclick="testChannelToken(\'' + name + '\')" id="ch_test_btn">Test Connection</button>';
  h += '<span id="ch_test_result" style="font-size:12px;margin-left:8px"></span>';
  h += '</div>';

  // Mention required
  const mention = ch ? (ch.mention_required !== undefined ? ch.mention_required : true) : true;
  h += '<div class="field">';
  h += '<label>Mention Required (groups)</label>';
  h += '<select class="input" id="ch_mention" style="width:120px">';
  h += '<option value="true"' + (mention ? ' selected' : '') + '>Yes</option>';
  h += '<option value="false"' + (!mention ? ' selected' : '') + '>No</option>';
  h += '</select>';
  h += '</div>';

  // Enabled toggle
  const enabled = ch ? ch.enabled : false;
  h += '<div class="field">';
  h += '<label>Enabled</label>';
  h += '<select class="input" id="ch_enabled" style="width:120px">';
  h += '<option value="true"' + (enabled ? ' selected' : '') + '>Yes</option>';
  h += '<option value="false"' + (!enabled ? ' selected' : '') + '>No</option>';
  h += '</select>';
  h += '</div>';

  h += '<div class="actions">';
  h += '<button type="button" class="btn btn-outline" onclick="this.closest(\'.agent-modal-overlay\').remove()">Cancel</button>';
  h += '<button type="submit" class="btn">Save</button>';
  h += '</div></form></div></div></div>';

  document.body.insertAdjacentHTML('beforeend', h);
}

async function testChannelToken(name) {
  const meta = CHANNEL_META[name] || { tokenFields: [] };
  const btn = document.getElementById('ch_test_btn');
  const result = document.getElementById('ch_test_result');

  btn.disabled = true;
  btn.textContent = 'Testing...';
  result.innerHTML = '';

  const body = {};
  for (const field of meta.tokenFields) {
    const val = document.getElementById('ch_' + field).value.trim();
    if (val) body[field.replace('bot_', '')] = val;
    if (field === 'bot_token' && val) body.token = val;
    if (field === 'app_id' && val) body.token = val;
  }

  try {
    const resp = await apiPost('/v1/channels/' + name + '/test', body);
    if (resp && resp.ok) {
      result.innerHTML = '<span style="color:var(--green)">&#10003; ' + escHtml(resp.message || 'Connected') + '</span>';
    } else {
      result.innerHTML = '<span style="color:var(--red)">&#10007; ' + escHtml((resp && resp.error) || 'Connection failed') + '</span>';
    }
  } catch (e) {
    result.innerHTML = '<span style="color:var(--red)">&#10007; Network error</span>';
  }

  btn.disabled = false;
  btn.textContent = 'Test Connection';
}

async function saveChannelConfig(name) {
  const meta = CHANNEL_META[name] || { tokenFields: [] };
  const body = {
    enabled: document.getElementById('ch_enabled').value === 'true',
    mention_required: document.getElementById('ch_mention').value === 'true',
  };

  // Add token values if provided
  for (const field of meta.tokenFields) {
    const val = document.getElementById('ch_' + field).value.trim();
    if (val) body[field] = val;
  }

  const resp = await apiPut('/v1/channels/' + name, body);
  if (resp && resp.ok) {
    // Close modal
    const overlay = document.querySelector('.agent-modal-overlay');
    if (overlay) overlay.remove();
    loadChannels();
    // Show success toast
    showToast(resp.message || ('Channel ' + name + ' saved.'), 'success');
  } else {
    showToast((resp && resp.error) || 'Save failed', 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  CONFIG (read-only)
// ══════════════════════════════════════════════════════════════════

async function loadConfig() {
  const data = await api('/v1/config');
  if (!data) return;

  // Agent config
  const cfg = data.config || {};
  const agents = cfg.agents || [];
  let agentText = '';
  for (const a of agents) {
    agentText += '- ' + (a.id||'?') + '\n'
      + '  model: ' + (a.model||'—') + '\n'
      + '  provider: ' + ((a.llm||{}).provider||'—') + '\n'
      + '  skills: [' + (a.skills||[]).join(', ') + ']\n'
      + '  fallbacks: [' + (a.fallback_models||[]).join(', ') + ']\n\n';
  }
  document.getElementById('configView').textContent = agentText || 'No agents configured';

  // Resilience
  const res = cfg.resilience || {};
  const compact = cfg.compaction || {};
  const mem = cfg.memory || {};
  let resText = 'Resilience:\n'
    + '  max_retries: ' + (res.max_retries ?? 3) + '\n'
    + '  base_delay: ' + (res.base_delay ?? 1.0) + 's\n'
    + '  max_delay: ' + (res.max_delay ?? 30.0) + 's\n'
    + '  jitter: ' + (res.jitter ?? 0.5) + '\n'
    + '  circuit_breaker_threshold: ' + (res.circuit_breaker_threshold ?? 3) + '\n'
    + '  circuit_breaker_cooldown: ' + (res.circuit_breaker_cooldown ?? 120) + 's\n\n'
    + 'Compaction:\n'
    + '  enabled: ' + (compact.enabled ?? true) + '\n'
    + '  max_context_tokens: ' + (compact.max_context_tokens ?? 8000) + '\n'
    + '  keep_recent_turns: ' + (compact.keep_recent_turns ?? 4) + '\n\n'
    + 'Memory:\n'
    + '  backend: ' + (mem.backend ?? 'chroma') + '\n';
  document.getElementById('resilienceView').textContent = resText;
}

// ══════════════════════════════════════════════════════════════════
//  GATEWAY — Token Management
// ══════════════════════════════════════════════════════════════════

async function loadGatewayInfo() {
  // Always show basic info from /health (no auth needed)
  try {
    const hRes = await fetch('/health');
    const hData = await hRes.json();
    if (hData && hData.status === 'ok') {
      document.getElementById('gwPort').textContent = hData.port || '—';
      document.getElementById('gwUptime').textContent = fmtTime(hData.uptime_seconds);
      document.getElementById('gwStatus').textContent = 'Online';
      document.getElementById('gwStatus').style.color = 'var(--green)';
    }
  } catch(e) {
    document.getElementById('gwStatus').textContent = 'Offline';
    document.getElementById('gwStatus').style.color = 'var(--red)';
  }
  // Fetch token (requires auth)
  const data = await apiPut('/v1/config/gateway', {action:'get_token'});
  if (data && data.token) {
    document.getElementById('gatewayToken').textContent = data.token;
  }
}

function copyToken() {
  const token = document.getElementById('gatewayToken').textContent;
  navigator.clipboard.writeText(token).then(() => toast('Token copied')).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = token;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    toast('Token copied');
  });
}

async function regenerateToken() {
  if (!confirm('Regenerate token? All existing clients will be disconnected.')) return;
  const data = await apiPut('/v1/config/gateway', {action:'regenerate_token'});
  if (data && data.ok) {
    TOKEN = data.token;
    localStorage.setItem('cleo_token', TOKEN);
    toast('Token regenerated');
    loadGatewayInfo();
  } else {
    toast(data?.error || 'Failed to regenerate', 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  HEALTH
// ══════════════════════════════════════════════════════════════════

async function loadDoctor() {
  // Fetch gateway status (public, no auth) and doctor checks in parallel
  const [healthData, data] = await Promise.all([
    (async () => { try { const r = await fetch('/health'); return await r.json(); } catch(e) { return null; } })(),
    api('/v1/doctor'),
  ]);

  // Populate gateway status cards
  if (healthData && healthData.status === 'ok') {
    document.getElementById('hGateway').textContent = 'Online';
    document.getElementById('hGateway').style.color = 'var(--green)';
    document.getElementById('hUptime').textContent = fmtTime(healthData.uptime_seconds);
    document.getElementById('hPort').textContent = ':' + (healthData.port || '—');
    document.getElementById('hAgents').textContent = healthData.agents || 0;
  } else {
    document.getElementById('hGateway').textContent = 'Offline';
    document.getElementById('hGateway').style.color = 'var(--red)';
  }

  // Populate diagnostic checks
  const el = document.getElementById('healthChecks');
  if (!data || !data.checks) { el.innerHTML = '<li class="empty">Could not run health checks</li>'; return; }

  let html = '';
  for (const c of data.checks) {
    const ok = c.ok !== undefined ? c.ok : c[0];
    const label = c.label || c[1] || '';
    const detail = c.detail || c[2] || '';
    const icon = ok ? '<span class="check-icon" style="color:var(--green)">✓</span>' : '<span class="check-icon" style="color:var(--red)">✗</span>';
    html += '<li>' + icon + '<span class="check-label">' + escHtml(label) + '</span><span class="check-detail">' + escHtml(detail) + '</span></li>';
  }
  el.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════
//  LOGS
// ══════════════════════════════════════════════════════════════════

async function initLogs() {
  // Populate agent selector
  const sel = document.getElementById('logAgentSelect');
  const prev = sel.value;
  const data = await api('/v1/agents');
  if (!data) return;

  sel.innerHTML = '<option value="">Select agent…</option>';
  for (const a of (data.agents||[])) {
    sel.innerHTML += '<option value="' + escHtml(a.id) + '"' + (a.id===prev?' selected':'') + '>' + escHtml(capitalize(a.id)) + '</option>';
  }
  // Add system log options
  sel.innerHTML += '<option value="exec"' + ('exec'===prev?' selected':'') + '>Exec</option>';
  sel.innerHTML += '<option value="gateway"' + ('gateway'===prev?' selected':'') + '>Gateway</option>';
  sel.innerHTML += '<option value="orchestrator"' + ('orchestrator'===prev?' selected':'') + '>Orchestrator</option>';

  if (sel.value) loadLogs();
}

async function loadLogs() {
  const agentId = document.getElementById('logAgentSelect').value;
  if (!agentId) {
    document.getElementById('logContent').textContent = 'Select an agent to view logs.';
    return;
  }

  const search = document.getElementById('logSearch').value;
  let url = '/v1/logs/' + agentId + '?lines=300';
  if (logLevel) url += '&level=' + logLevel;
  if (search) url += '&search=' + encodeURIComponent(search);

  const data = await api(url);
  const el = document.getElementById('logContent');

  if (!data || data.error) {
    el.textContent = data?.error || 'Failed to load logs';
    if (data?.available) {
      el.textContent += '\n\nAvailable logs: ' + data.available.join(', ');
    }
    return;
  }

  if (!data.lines || !data.lines.length) {
    el.textContent = 'No log entries found.';
    return;
  }

  // Render with color-coded lines
  let html = '';
  for (const line of data.lines) {
    let cls = 'log-line-info';
    if (/ERROR|CRITICAL/i.test(line)) cls = 'log-line-error';
    else if (/WARN/i.test(line)) cls = 'log-line-warn';
    html += '<div class="' + cls + '">' + escHtml(line) + '</div>';
  }
  el.innerHTML = html;

  // Auto-scroll to bottom
  el.scrollTop = el.scrollHeight;
}

function setLogLevel(btn) {
  document.querySelectorAll('.log-level-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  logLevel = btn.dataset.level;
  loadLogs();
}

function toggleLogAutoRefresh() {
  const checked = document.getElementById('logAutoRefresh').checked;
  if (logAutoRefreshTimer) { clearInterval(logAutoRefreshTimer); logAutoRefreshTimer = null; }
  if (checked) {
    logAutoRefreshTimer = setInterval(loadLogs, 3000);
  }
}

// ══════════════════════════════════════════════════════════════════
//  CHAIN PANEL
// ══════════════════════════════════════════════════════════════════

async function loadChain() {
  const data = await api('/v1/chain/status');
  if (!data) {
    document.getElementById('chainNetwork').textContent = 'Disabled';
    document.getElementById('chainNetwork').className = 'stat-value';
    document.getElementById('chainLitNet').textContent = '—';
    document.getElementById('chainAgents').textContent = '—';
    document.getElementById('chainAgents').className = 'stat-value';
    document.getElementById('chainX402').textContent = '—';
    document.getElementById('chainAgentsBody').innerHTML = '<tr><td colspan="6" class="empty">Chain not enabled</td></tr>';
    document.getElementById('chainTxList').textContent = 'Chain not enabled';
    return;
  }

  // Agent name mapping (legacy chain IDs → current agent names)
  const CHAIN_NAME_MAP = {planner:'Leo', executor:'Jerry', reviewer:'Alic', leo:'Leo', jerry:'Jerry', alic:'Alic'};

  // Stats cards
  document.getElementById('chainNetwork').textContent = data.network || '—';
  document.getElementById('chainLitNet').textContent = data.lit_network || '—';
  const agents = data.agents || {};
  const registered = Object.values(agents).filter(a => a.registered).length;
  const total = Object.keys(agents).length;
  document.getElementById('chainAgents').textContent = registered + '/' + total;
  document.getElementById('chainAgents').className = 'stat-value ' + (registered === total && total > 0 ? 'green' : registered > 0 ? 'cyan' : '');
  const x402El = document.getElementById('chainX402');
  x402El.textContent = data.x402_enabled ? 'Enabled' : 'Disabled';
  x402El.className = 'stat-value ' + (data.x402_enabled ? 'green' : '');

  // Agent table
  const scanBase = 'https://basescan.org/address/';
  const tbody = document.getElementById('chainAgentsBody');
  if (total === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty">No agents initialized on-chain</td></tr>';
  } else {
    let html = '';
    for (const [aid, info] of Object.entries(agents)) {
      const displayName = CHAIN_NAME_MAP[aid] || aid;
      const statusDot = info.registered
        ? '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-right:6px"></span>'
        : '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--fg3);margin-right:6px"></span>';
      const statusText = info.registered ? 'Registered' : 'Not registered';
      const pkp = info.pkp_address
        ? '<a href="' + scanBase + escHtml(info.pkp_address) + '" target="_blank" rel="noopener" '
          + 'style="font-family:var(--mono);font-size:11px;color:var(--accent2);text-decoration:none" '
          + 'title="' + escHtml(info.pkp_address) + '">'
          + escHtml(info.pkp_address.slice(0,6)) + '…' + escHtml(info.pkp_address.slice(-4)) + '</a>'
        : '<span style="color:var(--fg3)">—</span>';
      const chainId = info.erc8004_agent_id != null
        ? '<span style="font-family:var(--mono);color:var(--cyan)">#' + info.erc8004_agent_id + '</span>'
        : '<span style="color:var(--fg3)">—</span>';
      const bal = parseFloat(info.usdc_balance || 0).toFixed(2);
      const balColor = parseFloat(bal) > 0 ? 'var(--green)' : 'var(--fg3)';
      const action = info.registered
        ? '<span style="color:var(--fg3);font-size:11px">✓ ready</span>'
        : '<button class="btn btn-sm" onclick="chainInit(\'' + escHtml(aid) + '\')">Initialize</button>';
      html += '<tr>'
        + '<td><strong style="color:var(--fg)">' + escHtml(displayName) + '</strong>'
        + ' <span style="color:var(--fg3);font-size:11px">(' + escHtml(capitalize(aid)) + ')</span></td>'
        + '<td>' + statusDot + statusText + '</td>'
        + '<td>' + pkp + '</td>'
        + '<td style="text-align:center">' + chainId + '</td>'
        + '<td style="font-family:var(--mono);color:' + balColor + '">' + bal + ' <span style="font-size:10px;color:var(--fg3)">USDC</span></td>'
        + '<td style="text-align:right">' + action + '</td></tr>';
    }
    tbody.innerHTML = html;
  }

  // Recent transactions
  const txList = document.getElementById('chainTxList');
  const txs = data.recent_transactions || [];
  if (txs.length === 0) {
    txList.innerHTML = '<div style="text-align:center;color:var(--fg3);padding:20px">No transactions yet</div>';
  } else {
    let html = '<div style="display:grid;grid-template-columns:auto 1fr auto auto;gap:0;font-size:12px">';
    // Header
    html += '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3)">Action</div>'
          + '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3)">Agent</div>'
          + '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3)">Tx Hash</div>'
          + '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3);text-align:right">Time</div>';
    for (const tx of txs.slice(-12).reverse()) {
      const ts = tx.timestamp ? new Date(tx.timestamp * 1000).toLocaleString(undefined, {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '—';
      const rawHash = tx.tx_hash || '';
      const isError = rawHash.startsWith('0x_error') || rawHash.startsWith('0x_err');
      const hashDisplay = rawHash ? rawHash.slice(0, 10) + '…' : '—';
      const hashEl = !isError && rawHash.length === 66
        ? '<a href="https://basescan.org/tx/' + escHtml(rawHash) + '" target="_blank" rel="noopener" '
          + 'style="font-family:var(--mono);color:var(--accent2);text-decoration:none">' + hashDisplay + '</a>'
        : '<span style="font-family:var(--mono);color:' + (isError ? 'var(--red)' : 'var(--fg3)') + '">' + hashDisplay + '</span>';
      const agentName = CHAIN_NAME_MAP[tx.agent_id] || tx.agent_id || '';
      const rowBorder = 'border-bottom:1px solid var(--bg3)';
      html += '<div style="padding:6px 8px;' + rowBorder + '">'
            + '<span style="color:var(--accent2)">' + escHtml(tx.action || '?') + '</span></div>'
            + '<div style="padding:6px 8px;' + rowBorder + ';color:var(--fg)">' + escHtml(agentName) + '</div>'
            + '<div style="padding:6px 8px;' + rowBorder + '">' + hashEl + '</div>'
            + '<div style="padding:6px 8px;' + rowBorder + ';text-align:right;color:var(--fg3)">' + ts + '</div>';
    }
    html += '</div>';
    txList.innerHTML = html;
  }
}

async function chainInit(agentId) {
  if (!confirm('Initialize ' + agentId + ' on-chain? This will mint a PKP and register on ERC-8004.')) return;
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Working...';
  try {
    const data = await api('/v1/chain/init/' + agentId, 'POST');
    if (data && data.status === 'initialized') {
      alert('Agent ' + agentId + ' initialized successfully!');
    } else {
      alert('Error: ' + JSON.stringify(data));
    }
  } catch(e) {
    alert('Init failed: ' + e);
  }
  loadChain();
}

// ══════════════════════════════════════════════════════════════════
//  MEMORY PANEL (Enhanced)
// ══════════════════════════════════════════════════════════════════

let _memActiveTab = 'episodes';
let _memStatusCache = null;

function _getMemAgent() {
  const sel = document.getElementById('memAgentSelect');
  return sel ? sel.value : 'all';
}

async function loadMemory() {
  // Load status (stats) for all agents
  const statusData = await api('/v1/memory/status');
  _memStatusCache = statusData;

  if (statusData) {
    const agents = statusData.agents || {};
    const agent = _getMemAgent();
    let totalEps = 0, totalCases = 0, totalPats = 0;
    if (agent === 'all') {
      Object.values(agents).forEach(a => {
        totalEps += a.episodes || 0;
        totalCases += a.cases || 0;
        totalPats += a.patterns || 0;
      });
    } else {
      const a = agents[agent] || {};
      totalEps = a.episodes || 0;
      totalCases = a.cases || 0;
      totalPats = a.patterns || 0;
    }
    document.getElementById('memEpisodes').textContent = totalEps;
    document.getElementById('memCases').textContent = totalCases;
    document.getElementById('memPatterns').textContent = totalPats;
    const kb = statusData.knowledge_base || {};
    document.getElementById('memNotes').textContent = kb.notes || 0;
  }

  // Load active tab data
  switchMemoryTab(_memActiveTab);
}

function switchMemoryTab(tab) {
  _memActiveTab = tab;
  // Update tab highlight
  document.querySelectorAll('#memTabs .modal-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.memtab === tab);
  });
  // Load data for the selected tab
  const agent = _getMemAgent();
  if (tab === 'episodes') loadMemoryEpisodes(agent);
  else if (tab === 'cases') loadMemoryCases(agent);
  else if (tab === 'daily') loadMemoryDaily(agent);
  else if (tab === 'kb') loadMemoryKB();
}

async function loadMemoryEpisodes(agent) {
  const area = document.getElementById('memDataArea');
  if (agent === 'all') {
    // Load for all agents
    const agents = ['leo', 'jerry', 'alic'];
    let allEps = [];
    const results = await Promise.all(agents.map(a => api('/v1/memory/episodes/' + a)));
    results.forEach((data, i) => {
      (data?.episodes || []).forEach(ep => { ep._agent = agents[i]; allEps.push(ep); });
    });
    allEps.sort((a, b) => (b.ts || 0) - (a.ts || 0));
    renderEpisodesTable(area, allEps, true);
  } else {
    const data = await api('/v1/memory/episodes/' + agent);
    const eps = (data?.episodes || []).map(ep => { ep._agent = agent; return ep; });
    eps.sort((a, b) => (b.ts || 0) - (a.ts || 0));
    renderEpisodesTable(area, eps, false);
  }
}

function renderEpisodesTable(area, episodes, showAgent) {
  if (!episodes.length) {
    area.innerHTML = '<div class="card"><div class="empty">No episodes found</div></div>';
    return;
  }
  let html = '<div class="card"><table class="data-table"><thead><tr>';
  if (showAgent) html += '<th>Agent</th>';
  html += '<th>Task</th><th>Date</th><th>Time</th><th>Outcome</th><th>Score</th><th></th>';
  html += '</tr></thead><tbody>';
  episodes.slice(0, 50).forEach((ep, i) => {
    const desc = escHtml((ep.task_description || ep.description || ep.task_id || '—').substring(0, 80));
    const date = ep.ts ? new Date(ep.ts * 1000).toLocaleDateString() : '—';
    const timeStr = ep.ts ? new Date(ep.ts * 1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '—';
    const outcome = ep.outcome || ep.status || '—';
    const score = ep.score != null ? ep.score : '—';
    const outcomeColor = outcome === 'success' ? 'var(--green)' : outcome === 'failure' ? 'var(--red)' : 'var(--fg2)';
    html += '<tr style="cursor:pointer" onclick="toggleMemDetail(\'ep-' + i + '\')">';
    if (showAgent) html += '<td><strong>' + escHtml(capitalize(ep._agent)) + '</strong></td>';
    html += '<td>' + desc + '</td>';
    html += '<td style="white-space:nowrap">' + date + '</td>';
    html += '<td style="white-space:nowrap;color:var(--fg3)">' + timeStr + '</td>';
    html += '<td style="color:' + outcomeColor + '">' + escHtml(outcome) + '</td>';
    html += '<td>' + score + '</td>';
    html += '<td><button class="btn btn-sm btn-outline" onclick="event.stopPropagation();showMemoryEditModal(\'episode\',' + JSON.stringify(ep._agent).replace(/"/g, '&quot;') + ',' + JSON.stringify(ep.task_id || '').replace(/"/g, '&quot;') + ',' + i + ')">Edit</button></td>';
    html += '</tr>';
    // Expandable detail row
    html += '<tr id="ep-' + i + '" style="display:none"><td colspan="' + (showAgent ? 7 : 6) + '" style="padding:12px;background:var(--bg3);font-size:12px">';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    html += '<div><strong>Task ID:</strong> ' + escHtml(ep.task_id || '—') + '</div>';
    html += '<div><strong>Duration:</strong> ' + (ep.duration ? ep.duration + 's' : '—') + '</div>';
    if (ep.tools_used) html += '<div><strong>Tools:</strong> ' + escHtml(Array.isArray(ep.tools_used) ? ep.tools_used.join(', ') : ep.tools_used) + '</div>';
    if (ep.tags) html += '<div><strong>Tags:</strong> ' + escHtml(Array.isArray(ep.tags) ? ep.tags.join(', ') : ep.tags) + '</div>';
    html += '</div>';
    if (ep.notes) html += '<div style="margin-top:8px;color:var(--fg2)"><strong>Notes:</strong> ' + escHtml(ep.notes) + '</div>';
    if (ep.lesson) html += '<div style="margin-top:4px;color:var(--cyan)"><strong>Lesson:</strong> ' + escHtml(ep.lesson) + '</div>';
    html += '</td></tr>';
  });
  html += '</tbody></table>';
  if (episodes.length > 50) html += '<div style="padding:8px;color:var(--fg3);font-size:12px">Showing 50 of ' + episodes.length + ' episodes</div>';
  html += '</div>';
  area.innerHTML = html;
}

async function loadMemoryCases(agent) {
  const area = document.getElementById('memDataArea');
  if (agent === 'all') {
    const agents = ['leo', 'jerry', 'alic'];
    let allCases = [];
    const results = await Promise.all(agents.map(a => api('/v1/memory/cases/' + a)));
    results.forEach((data, i) => {
      (data?.cases || []).forEach(c => { c._agent = agents[i]; allCases.push(c); });
    });
    allCases.sort((a, b) => (b.use_count || 0) - (a.use_count || 0));
    renderCasesTable(area, allCases, true);
  } else {
    const data = await api('/v1/memory/cases/' + agent);
    const cases = (data?.cases || []).map(c => { c._agent = agent; return c; });
    cases.sort((a, b) => (b.use_count || 0) - (a.use_count || 0));
    renderCasesTable(area, cases, false);
  }
}

function renderCasesTable(area, cases, showAgent) {
  if (!cases.length) {
    area.innerHTML = '<div class="card"><div class="empty">No cases found</div></div>';
    return;
  }
  let html = '<div class="card"><table class="data-table"><thead><tr>';
  if (showAgent) html += '<th>Agent</th>';
  html += '<th>Problem</th><th>Uses</th><th>Tags</th><th></th>';
  html += '</tr></thead><tbody>';
  cases.slice(0, 50).forEach((c, i) => {
    const problem = escHtml((c.problem || c.description || '—').substring(0, 100));
    const uses = c.use_count || 0;
    const tags = (c.tags || []).map(t => '<span style="background:var(--bg4);padding:1px 6px;border-radius:3px;font-size:10px;color:var(--fg2)">' + escHtml(t) + '</span>').join(' ');
    html += '<tr style="cursor:pointer" onclick="toggleMemDetail(\'cs-' + i + '\')">';
    if (showAgent) html += '<td><strong>' + escHtml(capitalize(c._agent)) + '</strong></td>';
    html += '<td>' + problem + '</td>';
    html += '<td>' + uses + '</td>';
    html += '<td>' + (tags || '—') + '</td>';
    html += '<td><button class="btn btn-sm btn-outline" onclick="event.stopPropagation();showMemoryEditModal(\'case\',' + JSON.stringify(c._agent).replace(/"/g, '&quot;') + ',' + JSON.stringify(c.hash || c.id || '').replace(/"/g, '&quot;') + ',' + i + ')">Edit</button></td>';
    html += '</tr>';
    // Expandable detail
    html += '<tr id="cs-' + i + '" style="display:none"><td colspan="' + (showAgent ? 5 : 4) + '" style="padding:12px;background:var(--bg3);font-size:12px">';
    html += '<div><strong>Solution:</strong></div>';
    html += '<div style="color:var(--fg2);margin-top:4px;white-space:pre-wrap">' + escHtml(c.solution || '—') + '</div>';
    if (c.context) html += '<div style="margin-top:8px"><strong>Context:</strong> ' + escHtml(typeof c.context === 'string' ? c.context : JSON.stringify(c.context)) + '</div>';
    if (c.notes) html += '<div style="margin-top:4px;color:var(--cyan)"><strong>Notes:</strong> ' + escHtml(c.notes) + '</div>';
    html += '</td></tr>';
  });
  html += '</tbody></table>';
  if (cases.length > 50) html += '<div style="padding:8px;color:var(--fg3);font-size:12px">Showing 50 of ' + cases.length + ' cases</div>';
  html += '</div>';
  area.innerHTML = html;
}

function cleanDailyLogContent(raw) {
  if (!raw) return '';
  // Strip <tool_code>...</tool_code> blocks (including unclosed)
  raw = raw.replace(/<tool_code>[\s\S]*?(<\/tool_code>|$)/g, '');
  // Strip ```subtask or ```tool code blocks (including unclosed)
  raw = raw.replace(/```(?:subtask|tool)\s*\n[\s\S]*?(?:```|$)/g, '');
  // Strip inline tool JSON: tool{"tool":...}
  raw = raw.replace(/\btool\s*\{[^}]*"tool"\s*:[^}]*\}/g, '');
  // Strip <tool_code> opening tags with <parameter> children
  raw = raw.replace(/<tool_code>[^<]*/g, '');
  raw = raw.replace(/<parameter[^>]*>[^<]*<\/parameter>/g, '');
  // Strip result lines that are just "..."
  raw = raw.replace(/\*\*Result:\*\*\s*\.{3}\s*$/gm, '');
  // Clean up excessive blank lines
  raw = raw.replace(/\n{3,}/g, '\n\n');
  return raw.trim();
}

async function loadMemoryDaily(agent) {
  const area = document.getElementById('memDataArea');
  if (agent === 'all') {
    const agents = ['leo', 'jerry', 'alic'];
    const results = await Promise.all(agents.map(a => api('/v1/memory/daily/' + a)));
    let html = '';
    results.forEach((data, i) => {
      const log = cleanDailyLogContent(data?.daily_log || '');
      if (log.trim()) {
        html += '<div class="card" style="margin-bottom:12px">';
        html += '<div class="card-title" style="margin-bottom:10px">' + capitalize(agents[i]) + ' — Daily Log</div>';
        html += '<div class="daily-log-content">' + renderKbMarkdown(log) + '</div>';
        html += '</div>';
      }
    });
    if (!html) html = '<div class="card"><div class="empty">No daily log entries found</div></div>';
    area.innerHTML = html;
  } else {
    const data = await api('/v1/memory/daily/' + agent);
    const log = cleanDailyLogContent(data?.daily_log || '');
    if (log.trim()) {
      area.innerHTML = '<div class="card"><div class="daily-log-content">' + renderKbMarkdown(log) + '</div></div>';
    } else {
      area.innerHTML = '<div class="card"><div class="empty">No daily log entries found</div></div>';
    }
  }
}

// ── KB Markdown renderer (lightweight) ──
function renderKbMarkdown(raw) {
  if (!raw) return '';
  let s = escHtml(raw);
  // Code blocks (``` ... ```)
  s = s.replace(/```(\w*)\n([\s\S]*?)```/g, function(_, lang, code) {
    return '<pre>' + code.trim() + '</pre>';
  });
  // Inline code
  s = s.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  // Headers (### before ##)
  s = s.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
  s = s.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
  s = s.replace(/^##\s+(.+)$/gm, '<h3>$1</h3>');
  // Bold
  s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  // Horizontal rule
  s = s.replace(/^---+$/gm, '<hr>');
  // Unordered list items
  s = s.replace(/^[\s]*[-•]\s+(.+)$/gm, '<li>$1</li>');
  // Wrap consecutive <li> in <ul>
  s = s.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
  // Paragraphs — double newline → paragraph break
  s = s.replace(/\n{2,}/g, '</p><p>');
  // Single newline → line break (except inside pre/ul)
  s = s.replace(/\n/g, '<br>');
  // Clean up spurious <br> inside block elements
  s = s.replace(/<br><(h[34]|pre|ul|hr|li)/g, '<$1');
  s = s.replace(/<\/(h[34]|pre|ul|hr|li)><br>/g, '</$1>');
  s = s.replace(/<br><\/p><p><br>/g, '</p><p>');
  return '<p>' + s + '</p>';
}

// Tag color assignment (deterministic by tag name)
const _kbTagColors = ['blue','purple','green','orange','pink','cyan'];
function kbTagColor(tag) {
  let h = 0;
  for (let i = 0; i < tag.length; i++) h = ((h << 5) - h + tag.charCodeAt(i)) | 0;
  return _kbTagColors[Math.abs(h) % _kbTagColors.length];
}

// Topic icon (deterministic by slug)
const _kbIcons = ['📝','📚','🔬','💡','🌐','⚙️','🧠','📊','🔗','🛠️','📋','🎯'];
function kbIcon(slug) {
  let h = 0;
  for (let i = 0; i < slug.length; i++) h = ((h << 5) - h + slug.charCodeAt(i)) | 0;
  return _kbIcons[Math.abs(h) % _kbIcons.length];
}

async function loadMemoryKB() {
  const area = document.getElementById('memDataArea');
  const [kbData, insightsData] = await Promise.all([
    api('/v1/memory/kb/notes'),
    api('/v1/memory/kb/insights'),
  ]);

  let html = '';

  // KB Notes — card grid
  html += '<div class="card" style="margin-bottom:16px">';
  html += '<div class="card-title" style="margin-bottom:14px">Knowledge Base Notes';
  if (kbData && kbData.notes) html += ' <span style="color:var(--fg3);font-weight:400">(' + kbData.notes.length + ')</span>';
  html += '</div>';

  if (kbData && kbData.notes && kbData.notes.length > 0) {
    html += '<div class="kb-grid">';
    kbData.notes.forEach((note, idx) => {
      const topic = note.topic || note.slug || 'Untitled';
      const slug = note.slug || '';
      const content = note.content || '';
      const tags = note.tags || [];
      const contributors = (note.contributors || []).map(c => capitalize(c));
      const updCount = note.update_count || 1;
      const density = (note.density || '').toUpperCase();
      const updatedAt = note.updated_at
        ? new Date(note.updated_at * 1000).toLocaleDateString()
        : '';
      html += '<div class="kb-note">';

      // Head: icon + title
      html += '<div class="kb-note-head">';
      html += '<div class="kb-note-icon">' + kbIcon(slug) + '</div>';
      html += '<div class="kb-note-title">' + escHtml(topic) + '</div>';
      html += '</div>';

      // Tags row
      if (tags.length > 0) {
        html += '<div class="kb-note-tags">';
        tags.forEach(t => {
          html += '<span class="kb-tag kb-tag-' + kbTagColor(t) + '">' + escHtml(t) + '</span>';
        });
        if (density) {
          const dc = density === 'HIGH' ? 'high' : density === 'LOW' ? 'low' : 'normal';
          html += '<span class="kb-density kb-density-' + dc + '">' + density + '</span>';
        }
        html += '</div>';
      }

      // Body (markdown rendered)
      html += '<div class="kb-note-body" id="kb-body-' + idx + '">';
      html += renderKbMarkdown(content);
      html += '</div>';

      // Footer
      html += '<div class="kb-note-footer">';
      html += '<span>';
      if (contributors.length) html += '<span class="contributor">' + escHtml(contributors.join(', ')) + '</span> · ';
      html += updCount + ' update' + (updCount > 1 ? 's' : '');
      html += '</span>';
      if (updatedAt) html += '<span>' + updatedAt + '</span>';
      html += '</div>';

      html += '</div>'; // .kb-note
    });
    html += '</div>'; // .kb-grid
  } else {
    html += '<div class="empty">No knowledge notes yet</div>';
  }
  html += '</div>'; // .card

  // Insights — styled cards
  html += '<div class="card"><div class="card-title" style="margin-bottom:14px">Cross-Agent Insights';
  if (insightsData && insightsData.insights) html += ' <span style="color:var(--fg3);font-weight:400">(' + insightsData.insights.length + ')</span>';
  html += '</div>';

  if (insightsData && insightsData.insights && insightsData.insights.length > 0) {
    html += '<div style="display:flex;flex-direction:column;gap:10px">';
    insightsData.insights.slice(-20).reverse().forEach(ins => {
      const ts = new Date(ins.ts * 1000).toLocaleDateString();
      const insightTags = ins.tags || [];
      html += '<div style="display:flex;gap:10px;align-items:flex-start;padding:10px 12px;background:rgba(6,182,212,0.04);border-radius:10px;border:1px solid rgba(6,182,212,0.08)">';
      html += '<span style="font-size:16px;flex-shrink:0">💡</span>';
      html += '<div style="flex:1;min-width:0">';
      html += '<div style="font-size:12.5px;color:var(--fg1);line-height:1.5">' + escHtml(ins.insight) + '</div>';
      html += '<div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">';
      html += '<span style="font-size:10px;color:var(--accent);font-weight:500">' + escHtml(capitalize(ins.agent_id)) + '</span>';
      html += '<span style="font-size:10px;color:var(--fg3)">' + ts + '</span>';
      insightTags.forEach(t => {
        html += '<span class="kb-tag kb-tag-' + kbTagColor(t) + '">' + escHtml(t) + '</span>';
      });
      html += '</div></div></div>';
    });
    html += '</div>';
  } else {
    html += '<div class="empty">No cross-agent insights yet</div>';
  }
  html += '</div>';

  area.innerHTML = html;
}

function toggleMemDetail(id) {
  const row = document.getElementById(id);
  if (!row) return;
  row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}

// ── Memory Edit Modal ──

function showMemoryEditModal(type, agent, id, idx) {
  // Find the data from the current table
  const container = document.getElementById('memEditModalContainer');
  let title = type === 'case' ? 'Edit Case' : 'Edit Episode';

  let html = '<div class="agent-modal-overlay" onclick="closeMemoryEditModal()">';
  html += '<div class="agent-modal" onclick="event.stopPropagation()" style="width:min(650px,90vw)">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
  html += '<span style="font-size:16px;font-weight:600">' + title + ' — ' + escHtml(capitalize(agent)) + '</span>';
  html += '<button style="background:none;border:none;color:var(--fg3);font-size:18px;cursor:pointer" onclick="closeMemoryEditModal()">✕</button>';
  html += '</div>';

  if (type === 'case') {
    html += '<div style="display:flex;flex-direction:column;gap:12px">';
    html += '<div><label style="font-size:11px;color:var(--fg3);display:block;margin-bottom:4px">Solution</label>';
    html += '<textarea id="memEditSolution" class="input" style="width:100%;height:120px;font-family:var(--mono);font-size:12px" placeholder="Solution..."></textarea></div>';
    html += '<div><label style="font-size:11px;color:var(--fg3);display:block;margin-bottom:4px">Tags (comma-separated)</label>';
    html += '<input id="memEditTags" class="input" style="width:100%" placeholder="tag1, tag2, ..." /></div>';
    html += '<div><label style="font-size:11px;color:var(--fg3);display:block;margin-bottom:4px">Notes</label>';
    html += '<textarea id="memEditNotes" class="input" style="width:100%;height:60px" placeholder="Notes..."></textarea></div>';
    html += '</div>';
  } else {
    html += '<div style="display:flex;flex-direction:column;gap:12px">';
    html += '<div><label style="font-size:11px;color:var(--fg3);display:block;margin-bottom:4px">Outcome</label>';
    html += '<select id="memEditOutcome" class="input"><option value="success">success</option><option value="failure">failure</option><option value="partial">partial</option></select></div>';
    html += '<div><label style="font-size:11px;color:var(--fg3);display:block;margin-bottom:4px">Tags (comma-separated)</label>';
    html += '<input id="memEditTags" class="input" style="width:100%" placeholder="tag1, tag2, ..." /></div>';
    html += '<div><label style="font-size:11px;color:var(--fg3);display:block;margin-bottom:4px">Notes</label>';
    html += '<textarea id="memEditNotes" class="input" style="width:100%;height:80px" placeholder="Notes..."></textarea></div>';
    html += '</div>';
  }

  html += '<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">';
  html += '<button class="btn btn-outline" onclick="closeMemoryEditModal()">Cancel</button>';
  html += '<button class="btn" onclick="saveMemoryEdit(\'' + type + '\',\'' + agent + '\',\'' + escHtml(id) + '\')">Save</button>';
  html += '</div>';
  html += '</div></div>';

  container.innerHTML = html;
}

function closeMemoryEditModal() {
  document.getElementById('memEditModalContainer').innerHTML = '';
}

async function saveMemoryEdit(type, agent, id) {
  const tags = (document.getElementById('memEditTags')?.value || '').split(',').map(t => t.trim()).filter(Boolean);
  const notes = document.getElementById('memEditNotes')?.value || '';
  let body = { tags, notes };

  if (type === 'case') {
    body.solution = document.getElementById('memEditSolution')?.value || '';
    const res = await apiPut('/v1/memory/cases/' + agent + '/' + id, body);
    if (res && !res.error) {
      showToast('Case updated', 'success');
      closeMemoryEditModal();
      loadMemory();
    } else {
      showToast('Failed to update case: ' + (res?.error || 'unknown'), 'error');
    }
  } else {
    body.outcome = document.getElementById('memEditOutcome')?.value || '';
    const res = await apiPut('/v1/memory/episodes/' + agent + '/' + id, body);
    if (res && !res.error) {
      showToast('Episode updated', 'success');
      closeMemoryEditModal();
      loadMemory();
    } else {
      showToast('Failed to update episode: ' + (res?.error || 'unknown'), 'error');
    }
  }
}

// ── Memory Export ──

async function exportMemory() {
  const agent = _getMemAgent();
  if (agent === 'all') {
    showToast('Select a specific agent to export', 'error');
    return;
  }
  const data = await apiPost('/v1/memory/export/' + agent, {});
  if (data && !data.error) {
    // Download as JSON file
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = agent + '_memory_export.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Memory exported for ' + capitalize(agent), 'success');
  } else {
    showToast('Export failed: ' + (data?.error || 'unknown'), 'error');
  }
}

// ── Memo Export ─────────────────────────────────────────────────

function showMemoExportDialog() {
  document.getElementById('memoExportResult').style.display = 'none';
  document.getElementById('memoExportBtn').disabled = false;
  document.getElementById('memoExportBtn').textContent = 'Export';
  // Sync currently selected agent from Memory panel
  const sel = document.getElementById('memoExportAgent');
  const memAgent = document.getElementById('memAgentSelect').value;
  if (memAgent && memAgent !== 'all') {
    sel.value = memAgent;
  } else {
    sel.value = '';
  }
  // Auto-fill export name based on selected agent
  if (sel.value) {
    document.getElementById('memoExportName').value = sel.value + '_memo';
  } else {
    document.getElementById('memoExportName').value = '';
  }
  document.getElementById('memoExportDialog').style.display = 'flex';
  // Update export name when agent changes
  sel.onchange = function() {
    const v = this.value;
    if (v) document.getElementById('memoExportName').value = v + '_memo';
  };
}

function closeMemoExportDialog() {
  document.getElementById('memoExportDialog').style.display = 'none';
}

async function executeMemoExport() {
  const btn = document.getElementById('memoExportBtn');
  btn.disabled = true;
  btn.textContent = 'Exporting...';

  const agent = document.getElementById('memoExportAgent').value;
  if (!agent) {
    showToast('Please select a specific agent', 'error');
    btn.disabled = false;
    btn.textContent = 'Export';
    return;
  }
  const exportName = document.getElementById('memoExportName').value.trim() || (agent + '_memo');
  const memoType = document.getElementById('memoExportType').value;
  const minQuality = parseFloat(document.getElementById('memoExportMinQuality').value) || 0.6;
  const minScore = parseInt(document.getElementById('memoExportMinScore').value) || 7;
  const dryRun = document.getElementById('memoExportDryRun').checked;
  const upload = document.getElementById('memoExportUpload').checked;

  const body = {
    agent: agent,
    export_name: exportName,
    memo_type: memoType || null,
    min_quality: minQuality,
    min_score: minScore,
    dry_run: dryRun,
    upload: upload,
  };

  const data = await apiPost('/v1/memo/export', body);
  btn.disabled = false;
  btn.textContent = 'Export';

  const resultDiv = document.getElementById('memoExportResult');
  if (data && !data.error) {
    const r = data;
    resultDiv.innerHTML =
      '<div style="color:var(--green);margin-bottom:8px">✓ Export Complete' + (dryRun ? ' (Dry Run)' : '') + '</div>' +
      'Scanned: <b>' + r.total_scanned + '</b><br>' +
      'Eligible: <b>' + r.total_eligible + '</b><br>' +
      'Exported: <b>' + r.total_exported + '</b> memories<br>' +
      'Skipped (quality): ' + r.skipped_quality + '<br>' +
      'Skipped (duplicate): ' + r.skipped_duplicate + '<br>' +
      (r.skipped_error ? 'Skipped (error): ' + r.skipped_error + '<br>' : '') +
      'Duration: ' + r.duration_seconds + 's';
    resultDiv.style.display = 'block';

    // If not dry run, trigger browser "Save As" dialog
    if (!dryRun && r.file_content) {
      const fileName = exportName + '.json';
      await triggerMemoSaveDialog(r.file_content, fileName);
    } else if (dryRun) {
      showToast('Dry run: ' + r.total_exported + ' memories would be exported', 'success');
    }
  } else {
    resultDiv.innerHTML = '<div style="color:var(--red)">✗ Export failed: ' + (data?.error || 'unknown') + '</div>';
    resultDiv.style.display = 'block';
    showToast('Memo export failed', 'error');
  }
}

async function triggerMemoSaveDialog(fileContent, defaultName) {
  const jsonStr = JSON.stringify(fileContent, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });

  // Prefer File System Access API (allows choosing save location)
  if (window.showSaveFilePicker) {
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: defaultName,
        types: [{ description: 'JSON File', accept: { 'application/json': ['.json'] } }],
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      showToast('✓ Memory file saved successfully', 'success');
      return;
    } catch (e) {
      if (e.name === 'AbortError') { showToast('Save cancelled', 'info'); return; }
    }
  }
  // Fallback: auto-download
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = defaultName;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('✓ Memory file downloaded: ' + defaultName, 'success');
}

// ══════════════════════════════════════════════════════════════════
//  CRON JOBS
// ══════════════════════════════════════════════════════════════════

async function loadCron() {
  const data = await api('/v1/cron');
  const jobs = data?.jobs || [];
  const tbody = document.getElementById('cronJobsBody');
  const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };

  el('cronTotal', jobs.length);
  el('cronActive', jobs.filter(j => j.enabled).length);
  el('cronRuns', jobs.reduce((s, j) => s + (j.run_count || 0), 0));

  if (!jobs.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty">No cron jobs configured. Click "+ New Job" to create one.</td></tr>';
    return;
  }
  let html = '';
  jobs.forEach(j => {
    const lastRun = j.last_run ? new Date(typeof j.last_run === 'number' ? j.last_run * 1000 : j.last_run).toLocaleString() : '—';
    html += '<tr>'
      + '<td><strong>' + escHtml(j.name || j.id) + '</strong></td>'
      + '<td><code>' + escHtml(j.action || '?') + '</code></td>'
      + '<td><code>' + escHtml(j.schedule || '?') + '</code></td>'
      + '<td>' + lastRun + '</td>'
      + '<td>' + (j.run_count || 0) + '</td>'
      + '<td>' + (j.enabled ? '✅' : '⏸️') + '</td>'
      + '<td>'
      + '<button class="btn btn-small" onclick="runCronJob(\'' + j.id + '\')">▶ Run</button> '
      + '<button class="btn btn-small" onclick="deleteCronJob(\'' + j.id + '\')" style="color:var(--red)">✕</button>'
      + '</td></tr>';
  });
  tbody.innerHTML = html;
}

async function runCronJob(id) {
  const res = await apiPost('/v1/cron/' + id + '/run');
  if (res && !res.error) { toast('Job triggered'); loadCron(); }
  else toast('Failed: ' + (res?.error || 'unknown'), 'error');
}

async function deleteCronJob(id) {
  if (!confirm('Delete this cron job?')) return;
  const res = await apiDelete('/v1/cron/' + id);
  if (res && !res.error) { toast('Job deleted'); loadCron(); }
  else toast('Failed: ' + (res?.error || 'unknown'), 'error');
}

function showNewCronModal() {
  const overlay = document.createElement('div');
  overlay.className = 'agent-modal-overlay';
  overlay.id = 'cronModalOverlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = '<div class="agent-modal" style="width:500px" onclick="event.stopPropagation()">'
    + '<div style="padding:16px 20px;border-bottom:1px solid var(--bg4)"><h3 style="margin:0;font-size:15px">New Cron Job</h3></div>'
    + '<div style="padding:16px 20px">'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Name<br>'
    + '<input id="cronName" class="input" style="width:100%;margin-top:4px" placeholder="my-daily-task"></label>'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Action Type<br>'
    + '<select id="cronAction" class="input" style="width:100%;margin-top:4px"><option value="task">task (submit task)</option><option value="exec">exec (shell command)</option><option value="webhook">webhook (HTTP POST)</option></select></label>'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Payload<br>'
    + '<textarea id="cronPayload" class="input" style="width:100%;margin-top:4px;height:60px;font-family:var(--mono);font-size:12px" placeholder="task description or command"></textarea></label>'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Schedule Type<br>'
    + '<select id="cronSchedType" class="input" style="width:100%;margin-top:4px"><option value="interval">interval (e.g. 3600)</option><option value="cron">cron (e.g. 0 */2 * * *)</option><option value="once">once (ISO datetime)</option></select></label>'
    + '<label style="display:block;margin-bottom:16px;font-size:13px;color:var(--fg2)">Schedule Value<br>'
    + '<input id="cronSchedVal" class="input" style="width:100%;margin-top:4px" placeholder="3600"></label>'
    + '<div style="text-align:right"><button class="btn" onclick="document.getElementById(\'cronModalOverlay\').remove()">Cancel</button> '
    + '<button class="btn btn-accent" onclick="createCronJob()">Create</button></div>'
    + '</div></div>';
  document.body.appendChild(overlay);
}

async function createCronJob() {
  const name = document.getElementById('cronName').value.trim();
  const action = document.getElementById('cronAction').value;
  const payload = document.getElementById('cronPayload').value.trim();
  const schedType = document.getElementById('cronSchedType').value;
  const schedVal = document.getElementById('cronSchedVal').value.trim();
  if (!name || !payload || !schedVal) { toast('Fill all fields', 'error'); return; }

  const body = { name, action, payload, schedule_type: schedType, schedule: schedVal };
  const res = await api('/v1/cron', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (res && !res.error) {
    toast('Cron job created');
    document.getElementById('cronModalOverlay').remove();
    loadCron();
  } else {
    toast('Failed: ' + (res?.error || 'unknown'), 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  RUNTIME PANEL
// ══════════════════════════════════════════════════════════════════

const RUNTIME_MODE_DESC = {
  process: '<strong>Process Mode</strong> — Each agent runs as an independent OS process (mp.Process). Full isolation, highest reliability. Default mode.',
  in_process: '<strong>In-Process Mode</strong> — Agents run as asyncio tasks within a single process. Fast startup (~1s), great for development. Shared memory.',
  lazy: '<strong>Lazy Mode</strong> — Agents start on-demand when tasks arrive. Always-on agents stay running; others idle-stop after timeout. Saves ~67% memory for simple queries.',
};

async function loadRuntime() {
  const data = await api('/v1/runtime');
  const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  const elc = (id, v, cls) => { const e = document.getElementById(id); if (e) { e.textContent = v; e.className = 'stat-value ' + (cls||''); } };

  if (!data) {
    el('rtMode', '—'); el('rtAlive', '—'); el('rtAlwaysOn', '—'); el('rtIdleShutdown', '—');
    document.getElementById('rtModeDesc').textContent = 'Unable to load runtime status';
    document.getElementById('rtAgentsBody').innerHTML = '<tr><td colspan="5" class="empty">No data</td></tr>';
    return;
  }

  const mode = data.mode || 'process';
  elc('rtMode', mode, mode === 'lazy' ? 'cyan' : mode === 'in_process' ? 'magenta' : 'green');

  const agents = data.agents || [];
  const alive = agents.filter(a => a.alive).length;
  elc('rtAlive', alive + '/' + agents.length, alive === agents.length ? 'green' : alive > 0 ? 'cyan' : 'red');
  el('rtAlwaysOn', (data.always_on || []).length > 0 ? data.always_on.join(', ') : 'none');
  el('rtIdleShutdown', mode === 'lazy' ? data.idle_shutdown + 's' : '—');

  document.getElementById('rtModeDesc').innerHTML = RUNTIME_MODE_DESC[mode] || 'Unknown mode: ' + escHtml(mode);

  const tbody = document.getElementById('rtAgentsBody');
  if (!agents.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty">No agents configured</td></tr>';
    return;
  }
  let html = '';
  agents.forEach(a => {
    const statusLabel = a.status || (a.alive ? 'running' : 'idle');
    const isActive = a.alive || statusLabel === 'busy' || statusLabel === 'running';
    const dot = isActive
      ? '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-right:6px;box-shadow:0 0 6px rgba(34,197,94,.4)"></span>'
      : '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--fg3);margin-right:6px"></span>';
    const statusColor = statusLabel === 'busy' ? 'var(--yellow)' : isActive ? 'var(--green)' : 'var(--fg3)';
    const hb = a.last_heartbeat ? new Date(typeof a.last_heartbeat === 'number' ? a.last_heartbeat * 1000 : a.last_heartbeat).toLocaleTimeString() : '—';
    const aon = a.always_on ? '<span style="color:var(--cyan)">✓</span>' : '—';
    const task = a.current_task ? '<code style="font-size:10px;color:var(--accent)">' + escHtml(a.current_task.slice(0,12)) + '</code>' : '<span style="color:var(--fg3)">—</span>';
    html += '<tr>'
      + '<td><strong style="color:var(--fg)">' + escHtml(capitalize(a.id)) + '</strong></td>'
      + '<td>' + dot + '<span style="color:' + statusColor + '">' + escHtml(capitalize(statusLabel)) + '</span></td>'
      + '<td><code style="font-size:11px">' + escHtml(a.model) + '</code></td>'
      + '<td>' + task + '</td>'
      + '<td style="text-align:center">' + aon + '</td>'
      + '<td style="font-size:11px;color:var(--fg3)">' + hb + '</td>'
      + '</tr>';
  });
  tbody.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════
//  A2A PANEL
// ══════════════════════════════════════════════════════════════════

const TRUST_COLORS = { verified: 'green', community: 'cyan', untrusted: 'red' };

async function loadA2A() {
  const data = await api('/v1/a2a/status');
  const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  const elc = (id, v, cls) => { const e = document.getElementById(id); if (e) { e.textContent = v; e.className = 'stat-value ' + (cls||''); } };

  if (!data) {
    el('a2aServerStatus', '—'); el('a2aClientStatus', '—'); el('a2aRemotes', '—'); el('a2aTaskMap', '—');
    document.getElementById('a2aServerInfo').textContent = 'Unable to load A2A status';
    document.getElementById('a2aClientInfo').textContent = 'Unable to load A2A status';
    return;
  }

  const srv = data.server || {};
  const cli = data.client || {};

  // Stats
  elc('a2aServerStatus', srv.active ? 'Active' : srv.enabled ? 'Enabled' : 'Disabled',
      srv.active ? 'green' : srv.enabled ? 'cyan' : '');
  elc('a2aClientStatus', cli.enabled ? 'Enabled' : 'Disabled', cli.enabled ? 'green' : '');
  elc('a2aRemotes', (cli.remotes || []).length, 'cyan');
  el('a2aTaskMap', data.task_map_count || 0);

  // Server card
  document.getElementById('a2aServerInfo').innerHTML = srv.enabled
    ? '<div>Status: <span style="color:var(--green)">Enabled' + (srv.active ? ' ✓ Active' : '') + '</span></div>'
      + '<div>RPC Endpoint: <code>' + escHtml(srv.path || '/a2a') + '</code></div>'
      + '<div>Agent Card: <code>' + escHtml(srv.agent_card_path || '/.well-known/agent.json') + '</code></div>'
      + '<div style="margin-top:8px;font-size:11px;color:var(--fg3)">External agents can discover and call Cleo via the A2A protocol.</div>'
    : '<div style="color:var(--fg3)">A2A Server is disabled.<br>Set <code>a2a.server.enabled: true</code> in agents.yaml to enable.</div>';

  // Client card
  document.getElementById('a2aClientInfo').innerHTML = cli.enabled
    ? '<div>Status: <span style="color:var(--green)">Enabled</span></div>'
      + '<div>Remotes: <strong>' + (cli.remotes || []).length + '</strong> agents registered</div>'
      + '<div>Registries: <strong>' + (cli.registries || []).length + '</strong> discovery sources</div>'
      + '<div style="margin-top:8px;font-size:11px;color:var(--fg3)">Jerry can delegate tasks to external agents via <code>a2a_delegate</code> tool.</div>'
    : '<div style="color:var(--fg3)">A2A Client is disabled.<br>Set <code>a2a.client.enabled: true</code> in agents.yaml to enable.</div>';

  // Remotes table
  const remotes = cli.remotes || [];
  const rtbody = document.getElementById('a2aRemotesBody');
  if (!remotes.length) {
    rtbody.innerHTML = '<tr><td colspan="4" class="empty">No remote agents registered</td></tr>';
  } else {
    let html = '';
    remotes.forEach(r => {
      const tc = TRUST_COLORS[r.trust_level] || '';
      const skills = (r.skills || []).map(s => '<span style="background:var(--bg4);padding:1px 6px;border-radius:4px;font-size:10px">' + escHtml(s) + '</span>').join(' ');
      const auth = r.auth_configured
        ? '<span style="color:var(--green)">✓ ' + escHtml(r.auth_scheme || '') + '</span>'
        : r.auth_scheme ? '<span style="color:var(--red)">✗ missing token</span>' : '<span style="color:var(--fg3)">none</span>';
      html += '<tr>'
        + '<td><code style="font-size:11px">' + escHtml(r.url) + '</code></td>'
        + '<td><span style="color:var(--' + tc + ')">' + escHtml(r.trust_level) + '</span></td>'
        + '<td>' + (skills || '—') + '</td>'
        + '<td>' + auth + '</td>'
        + '</tr>';
    });
    rtbody.innerHTML = html;
  }

  // Registries table
  const regs = cli.registries || [];
  const regBody = document.getElementById('a2aRegistriesBody');
  if (!regs.length) {
    regBody.innerHTML = '<tr><td colspan="3" class="empty">No registries configured</td></tr>';
  } else {
    let html = '';
    regs.forEach(r => {
      const tc = TRUST_COLORS[r.trust_level] || '';
      html += '<tr>'
        + '<td><code style="font-size:11px">' + escHtml(r.url) + '</code></td>'
        + '<td><span style="color:var(--' + tc + ')">' + escHtml(r.trust_level) + '</span></td>'
        + '<td>' + (r.refresh_interval || 3600) + 's</td>'
        + '</tr>';
    });
    regBody.innerHTML = html;
  }

  // Security info
  const sec = cli.security || {};
  document.getElementById('a2aSecurityInfo').innerHTML =
    '<div>Max Timeout: <code>' + (sec.max_timeout || 600) + 's</code></div>'
    + '<div>Redact Patterns: ' + (sec.redact_patterns ? '<span style="color:var(--green)">✓ Enabled</span>' : '<span style="color:var(--red)">✗ Disabled</span>') + '</div>'
    + '<div>Untrusted Confirmation: ' + (sec.untrusted_require_confirmation ? '<span style="color:var(--green)">✓ Required</span>' : '<span style="color:var(--yellow)">⚠ Not required</span>') + '</div>'
    + '<div style="margin-top:8px;font-size:11px;color:var(--fg3)">3-tier trust model: <span style="color:var(--green)">verified</span> → <span style="color:var(--cyan)">community</span> → <span style="color:var(--red)">untrusted</span></div>';
}

// ══════════════════════════════════════════════════════════════════
//  AGENT FILES & TOOLS TABS
// ══════════════════════════════════════════════════════════════════

async function loadAgentFiles(agentId) {
  const data = await api('/v1/agents');
  const agents = data?.agents || [];
  const ag = agents.find(a => a.id === agentId);
  const files = ag?.files || [];

  const container = document.getElementById('agentFilesContent');
  if (!container) return;
  if (!files.length) {
    container.innerHTML = '<div class="empty" style="padding:16px">No files found for this agent. Create <code>skills/agents/' + escHtml(agentId) + '/soul.md</code> to get started.</div>';
    return;
  }

  let html = '<div style="display:flex;flex-direction:column;gap:8px;padding:12px">';
  files.forEach(f => {
    const name = f.name || f.path || 'unknown';
    const size = f.size ? (f.size < 1024 ? f.size + 'B' : (f.size / 1024).toFixed(1) + 'KB') : '?';
    html += '<div class="card" style="padding:10px 14px;cursor:pointer" onclick="viewAgentFile(\'' + escHtml(agentId) + '\',\'' + escHtml(name) + '\')">'
      + '<div style="display:flex;align-items:center;justify-content:space-between">'
      + '<div><strong style="color:var(--fg)">📄 ' + escHtml(name) + '</strong></div>'
      + '<div style="font-size:11px;color:var(--fg3)">' + size + '</div>'
      + '</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

async function viewAgentFile(agentId, fileName) {
  // API expects name without .md extension
  const apiName = fileName.endsWith('.md') ? fileName.slice(0, -3) : fileName;
  const res = await api('/v1/skills/agents/' + agentId + '/' + encodeURIComponent(apiName));
  const content = res?.content || res?.text || '(empty)';
  const container = document.getElementById('agentFilesContent');
  if (!container) return;
  container.innerHTML = '<div style="padding:12px">'
    + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">'
    + '<button class="btn btn-small" onclick="loadAgentFiles(\'' + escHtml(agentId) + '\')">← Back</button>'
    + '<strong>' + escHtml(fileName) + '</strong>'
    + '</div>'
    + '<textarea id="agentFileEditor" class="input" style="width:100%;height:300px;font-family:var(--mono);font-size:12px;background:var(--bg);color:var(--fg);border:1px solid var(--bg4);border-radius:6px;padding:12px">' + escHtml(content) + '</textarea>'
    + '<div style="text-align:right;margin-top:8px">'
    + '<button class="btn btn-accent" onclick="saveAgentFile(\'' + escHtml(agentId) + '\',\'' + escHtml(fileName) + '\')">Save</button>'
    + '</div></div>';
}

async function saveAgentFile(agentId, fileName) {
  const editor = document.getElementById('agentFileEditor');
  if (!editor) return;
  const apiName = fileName.endsWith('.md') ? fileName.slice(0, -3) : fileName;
  const res = await api('/v1/skills/agents/' + agentId + '/' + encodeURIComponent(apiName), {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ content: editor.value })
  });
  if (res && !res.error) toast('File saved');
  else toast('Save failed: ' + (res?.error || 'unknown'), 'error');
}

function loadAgentTools(agentId) {
  const container = document.getElementById('agentToolsContent');
  if (!container) return;
  Promise.all([api('/v1/agents'), api('/v1/tools')]).then(([agentData, tdata]) => {
    const agents = agentData?.agents || [];
    const ag = agents.find(a => a.id === agentId);
    if (!ag) { container.innerHTML = '<div class="empty">Agent not found</div>'; return; }
    const tools = ag.tools || {};
    const profile = tools.profile || 'minimal';
    const allow = new Set(tools.allow || []);
    const deny = new Set(tools.deny || []);
    const allTools = tdata?.tools || [];
    const profiles = tdata?.profiles || {};

    let html = '<div style="padding:12px">';
    // Profile selector + Select All
    html += '<div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap">';
    html += '<strong>Profile:</strong> <select class="input" id="toolProfileSelect" style="width:auto">';
    for (const p of ['minimal','coding','full']) {
      html += '<option' + (p===profile ? ' selected' : '') + '>' + p + '</option>';
    }
    html += '</select>';
    html += '<label style="font-size:12px;cursor:pointer;white-space:nowrap"><input type="checkbox" id="toolSelectAll"' + (profile==='full' ? ' checked' : '') + ' onchange="toggleAllToolCbs(this)"> Select All</label>';
    html += '<span style="flex:1"></span>';
    html += '<button class="btn btn-green btn-sm" onclick="saveAgentTools(\'' + escHtml(agentId) + '\')">Save Tools</button>';
    html += '</div>';

    // Tool grid
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:4px" id="toolCheckboxGrid">';
    const profileSet = profiles[profile];
    allTools.forEach(t => {
      const name = t.name || t;
      let isEnabled;
      if (allow.size) isEnabled = allow.has(name);
      else if (profile === 'full' || profileSet === 'all') isEnabled = !deny.has(name);
      else isEnabled = Array.isArray(profileSet) ? profileSet.includes(name) && !deny.has(name) : !deny.has(name);
      html += '<label style="padding:4px 8px;background:var(--bg);border-radius:4px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:4px">'
        + '<input type="checkbox" class="tool-cb" value="' + escHtml(name) + '"' + (isEnabled ? ' checked' : '') + '>'
        + '<code>' + escHtml(name) + '</code></label>';
    });
    html += '</div></div>';
    container.innerHTML = html;
  });
}

async function saveAgentTools(agentId) {
  const profile = document.getElementById('toolProfileSelect')?.value || 'minimal';
  // Collect checked and unchecked tools to build allow/deny lists
  const checked = [];
  const unchecked = [];
  document.querySelectorAll('.tool-cb').forEach(cb => {
    if (cb.checked) checked.push(cb.value);
    else unchecked.push(cb.value);
  });
  const body = { tools: { profile, allow: checked, deny: unchecked } };
  const res = await apiPut('/v1/agents/' + agentId, body);
  if (res && res.ok) {
    toast('Tools updated');
    loadAgentTools(agentId);
  } else {
    toast(res?.error || 'Failed to save tools', 'error');
  }
}

function toggleAllToolCbs(masterCb) {
  document.querySelectorAll('.tool-cb').forEach(cb => cb.checked = masterCb.checked);
  const sel = document.getElementById('toolProfileSelect');
  if (sel && masterCb.checked) sel.value = 'full';
}

// ══════════════════════════════════════════════════════════════════
//  WEBSOCKET — real-time state updates (replaces 2s HTTP polling)
// ══════════════════════════════════════════════════════════════════

let _ws = null;
let _wsConnected = false;
let _wsLastUpdate = 0;

function initWebSocket() {
  if (!TOKEN) {
    console.log('[ws] no token available, skipping WebSocket connection');
    return;
  }
  try {
    // WS gateway runs on HTTP port + 1 (19789 → 19790)
    const httpPort = parseInt(API.split(':').pop()) || 19789;
    let wsUrl = 'ws://' + location.hostname + ':' + (httpPort + 1);
    wsUrl += '?token=' + encodeURIComponent(TOKEN);
    _ws = new WebSocket(wsUrl);
    _ws.onopen = () => {
      _wsConnected = true;
      console.log('[ws] connected to', wsUrl);
    };
    _ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.event === 'state' && msg.data) {
          _wsLastUpdate = Date.now();
          handleWsSnapshot(msg.data);
        }
      } catch(err) {}
    };
    _ws.onclose = () => {
      _wsConnected = false;
      console.log('[ws] disconnected, reconnecting in 3s');
      setTimeout(initWebSocket, 3000);
    };
    _ws.onerror = () => {
      _wsConnected = false;
    };
  } catch(e) {
    _wsConnected = false;
  }
}

function handleWsSnapshot(data) {
  const tasks = {};
  // Expand compact WS format to full format used by diffAndRoute
  for (const [tid, ct] of Object.entries(data.tasks || {})) {
    tasks[tid] = {
      status: ct.s, agent_id: ct.a, description: ct.d,
      claimed_at: ct.ca, completed_at: ct.co, retry_count: ct.rc || 0,
      partial_result: ct.pr || '', cost_usd: ct.cost,
      parent_id: ct.pid || null, critique_spec: ct.cs || null,
    };
    if (ct.rs != null) tasks[tid].review_score_avg = ct.rs;
  }
  allTasks = tasks;
  const prevDispLen = dispatchEntries.length;
  const prevChatLen = chatMsgs.length;
  diffAndRoute(chatPrevSnapshot, tasks);
  updateWorkflow(tasks);
  renderTaskRoute(tasks);
  chatPrevSnapshot = JSON.parse(JSON.stringify(tasks));
  if (dispatchEntries.length > prevDispLen) renderDispatch();
  if (chatMsgs.length > prevChatLen) renderChat();
  renderLiveStatus();
}

// ══════════════════════════════════════════════════════════════════
//  INIT & POLLING
// ══════════════════════════════════════════════════════════════════

pollHealth();
pollChatUpdates();
initWebSocket();

// Restore session on page load
(async function restoreSession() {
  await loadSessions();
  const saved = localStorage.getItem('cleo_current_session');
  if (saved && dashboardSessions.find(s => s.session_id === saved)) {
    await switchSession(saved);
  }
})();

setInterval(pollHealth, 5000);
// Use slower HTTP polling when WS connected; faster when disconnected
setInterval(() => {
  if (_wsConnected && Date.now() - _wsLastUpdate < 5000) return;
  pollChatUpdates();
}, _wsConnected ? 5000 : 2000);
</script>
</body>
</html>
