<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cleo Dashboard</title>
<style>
/* ── Reset & Base ─────────────────────────────────────────────── */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#000000;--bg2:#0a0a0a;--bg3:#161616;--bg4:#222222;
  --fg:#ffffff;--fg2:#a0a0a0;--fg3:#666666;
  --accent:#3773FF;--accent2:#5a8fff;
  --green:#22c55e;--cyan:#03BFD4;--red:#ef4444;--yellow:#eab308;
  --magenta:#9C59F3;--orange:#FF8B00;
  --radius:10px;--shadow:0 2px 12px rgba(0,0,0,.6);
  --font:'TWK Everett','Inter','SF Pro Display','Helvetica Neue','Arial',sans-serif;
  --mono:"SF Mono","Fira Code","JetBrains Mono",Menlo,monospace;
  --sidebar-w:220px;
}
html,body{background:var(--bg);color:var(--fg);font:14px/1.6 var(--font);height:100%;overflow:hidden}
a{color:var(--accent2);text-decoration:none}

/* ── App Layout: sidebar + content ────────────────────────────── */
.app{display:flex;height:100vh}

/* ── Sidebar ──────────────────────────────────────────────────── */
.sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--bg3);display:flex;flex-direction:column;overflow-y:auto}
.sidebar-logo{padding:16px 18px;font-size:16px;font-weight:700;letter-spacing:-.3px;border-bottom:1px solid var(--bg3);display:flex;align-items:center;gap:8px}
.sidebar-logo span{color:var(--accent)}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--fg3);display:inline-block}
.status-dot.online{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.offline{background:var(--red);box-shadow:0 0 6px var(--red)}

/* ── Heartbeat Dot (on agent cards) ──────────────────────────── */
.hb-dot{width:9px;height:9px;border-radius:50%;display:inline-block;background:var(--fg3);transition:.3s}
.hb-dot.online{background:var(--green);box-shadow:0 0 6px var(--green);animation:hbPulse 2s infinite}
.hb-dot.offline{background:var(--fg3)}
@keyframes hbPulse{0%,100%{opacity:1}50%{opacity:.5}}

/* ── API Key Badge ───────────────────────────────────────────── */
.key-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:2px 7px;border-radius:10px;font-family:var(--mono)}
.key-badge.set{background:rgba(34,197,94,.12);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.key-badge.unset{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.key-badge.shared{background:rgba(55,115,255,.1);color:var(--accent2);border:1px solid rgba(55,115,255,.2)}

.nav-section{padding:12px 0 4px}
.nav-section-title{padding:0 18px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--fg3)}
.nav-item{display:flex;align-items:center;gap:10px;padding:7px 18px;cursor:pointer;color:var(--fg2);font-size:13px;font-weight:500;transition:.12s;border-left:3px solid transparent}
.nav-item:hover{color:var(--fg);background:var(--bg3)}
.nav-item.active{color:var(--accent2);background:rgba(55,115,255,.08);border-left-color:var(--accent)}
.nav-item .icon{font-size:15px;width:20px;text-align:center}

.sidebar-footer{margin-top:auto;padding:12px 18px;border-top:1px solid var(--bg3);font-size:11px;color:var(--fg3);line-height:1.8}
.sidebar-footer code{font-family:var(--mono);background:var(--bg3);padding:1px 5px;border-radius:3px;font-size:10px}

/* ── Main Content ─────────────────────────────────────────────── */
.content{flex:1;overflow-y:auto;padding:20px 28px;min-width:0;min-height:0}
.panel{display:none}
.panel.active{display:block}

.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.page-title{font-size:18px;font-weight:700}
.page-actions{display:flex;gap:8px}

/* ── Cards ────────────────────────────────────────────────────── */
.card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card-title{font-size:13px;font-weight:600;color:var(--fg2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.card-row{display:flex;gap:12px;flex-wrap:wrap}
.card-row>.card{flex:1;min-width:200px}

/* ── Stats Row ────────────────────────────────────────────────── */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.stat{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:12px 14px;text-align:center}
.stat-value{font-size:24px;font-weight:700;color:var(--fg);font-family:var(--mono)}
.stat-label{font-size:11px;color:var(--fg2);margin-top:2px}
.stat-value.green{color:var(--green)}
.stat-value.red{color:var(--red)}
.stat-value.cyan{color:var(--cyan)}

/* ── Buttons ──────────────────────────────────────────────────── */
.btn{background:var(--accent);color:#fff;border:none;padding:7px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:.15s;font-family:var(--font)}
.btn:hover{background:var(--accent2)}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px}
.btn-danger{background:var(--red)}
.btn-danger:hover{background:#dc2626}
.btn-outline{background:transparent;border:1px solid var(--bg4);color:var(--fg2)}
.btn-outline:hover{border-color:var(--accent);color:var(--fg)}
.btn-green{background:var(--green)}
.btn-green:hover{background:#16a34a}

/* ── Inputs ───────────────────────────────────────────────────── */
.input{background:var(--bg3);border:1px solid var(--bg4);color:var(--fg);padding:8px 12px;border-radius:8px;font-size:13px;font-family:var(--font);outline:none;width:100%}
.input:focus{border-color:var(--accent)}
.input::placeholder{color:var(--fg3)}
select.input{cursor:pointer}
textarea.input{resize:vertical;min-height:80px;line-height:1.5}
textarea.mono{font-family:var(--mono);font-size:12px;line-height:1.6}

/* ── Task Table ───────────────────────────────────────────────── */
.task-table{width:100%;border-collapse:collapse}
.task-table th{text-align:left;font-size:11px;font-weight:600;color:var(--fg3);text-transform:uppercase;padding:6px 8px;border-bottom:1px solid var(--bg3)}
.task-table td{padding:7px 8px;border-bottom:1px solid var(--bg3);font-size:13px;vertical-align:middle}
.task-table tr:last-child td{border-bottom:none}
.task-table tbody tr{cursor:pointer;transition:.1s}
.task-table tbody tr:hover{background:var(--bg3)}
.data-table{width:100%;border-collapse:collapse;table-layout:fixed}
.data-table th{text-align:left;font-size:11px;font-weight:600;color:var(--fg3);text-transform:uppercase;padding:8px 12px;border-bottom:1px solid var(--bg3)}
.data-table td{padding:8px 12px;border-bottom:1px solid var(--bg3);font-size:13px;vertical-align:middle}
.data-table tr:last-child td{border-bottom:none}
.data-table tbody tr:hover{background:var(--bg3);transition:.1s}
.status-icon{font-size:14px;width:20px;display:inline-block;text-align:center}
.status-working{color:var(--cyan)}
.status-done{color:var(--green)}
.status-failed{color:var(--red)}
.status-pending{color:var(--fg3)}
.status-review{color:var(--magenta)}
.status-critique{color:var(--yellow,#f59e0b)}
.task-desc{max-width:340px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.task-time{font-family:var(--mono);font-size:12px;color:var(--fg2)}
.task-agent{font-weight:500}
.task-error{color:var(--red);font-size:11px;opacity:.85}

/* ── Task Detail ──────────────────────────────────────────────── */
.task-detail{background:var(--bg3);padding:12px 14px;font-size:12px;border-radius:0 0 8px 8px;animation:slideDown .15s ease}
.task-detail pre{background:var(--bg);padding:8px 10px;border-radius:6px;font-family:var(--mono);font-size:11px;line-height:1.5;overflow-x:auto;white-space:pre-wrap;max-height:200px;overflow-y:auto;margin:6px 0}
.task-detail-row{display:flex;gap:8px;margin:4px 0;align-items:flex-start}
.task-detail-label{font-weight:600;min-width:90px;color:var(--fg2)}
.error-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;background:rgba(239,68,68,.15);color:var(--red)}
.score-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
@keyframes slideDown{from{opacity:0;max-height:0}to{opacity:1;max-height:500px}}

/* ── Submit Box ───────────────────────────────────────────────── */
.submit-box{display:flex;gap:8px;margin-top:12px}
.submit-box input{flex:1}
.submit-msg{font-size:12px;color:var(--fg2);margin-top:6px}

/* ── Summary Bar ──────────────────────────────────────────────── */
.summary-bar{font-size:12px;color:var(--fg2);padding:8px 0;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.summary-bar .dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:3px;vertical-align:middle}

/* ── Agent Cards ──────────────────────────────────────────────── */
.agent-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.agent-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:14px 16px;transition:.2s;cursor:pointer;display:flex;flex-direction:column;gap:6px}
.agent-card:hover{border-color:var(--accent);box-shadow:0 0 20px rgba(55,115,255,.1)}
.agent-card.editing{border-color:var(--accent);box-shadow:0 0 20px rgba(55,115,255,.15);border-bottom-left-radius:0;border-bottom-right-radius:0}
.agent-card-header{display:flex;align-items:center;gap:6px}
.agent-name{font-size:15px;font-weight:700}
.agent-working{font-size:10px;color:var(--cyan);font-weight:400;background:rgba(3,191,212,.1);padding:1px 6px;border-radius:4px}
.agent-card-model{font-family:var(--mono);font-size:12px;color:var(--accent2)}
.agent-provider{color:var(--fg3);font-size:11px}
.agent-card-skills{display:flex;flex-wrap:wrap;gap:4px}
.skill-tag{display:inline-block;background:var(--bg3);color:var(--fg2);padding:2px 8px;border-radius:4px;font-size:11px}
.agent-card-chain{font-size:11px;color:var(--fg2);display:flex;flex-direction:column;gap:3px}
.agent-card-chain-row{display:flex;align-items:center;gap:6px}
.agent-card-chain a{font-family:var(--mono);color:var(--accent2);text-decoration:none;font-size:11px}
.sparkline-wrap{height:28px;width:100%;margin-top:2px}
.sparkline-wrap svg{width:100%;height:100%}
.key-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.key-dot.set{background:var(--green)}
.key-dot.unset{background:var(--red)}
.agent-score{display:flex;align-items:center;gap:8px;padding-top:6px;border-top:1px solid var(--bg3)}
.score-bar{flex:1;height:6px;background:var(--bg4);border-radius:3px;overflow:hidden}
.score-fill{height:100%;border-radius:3px;transition:width .5s}
.score-num{font-family:var(--mono);font-size:14px;font-weight:700;min-width:36px;text-align:right}

/* ── Agent Editor (popup modal) ───────────────────────────────── */
.agent-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);z-index:1000;display:flex;align-items:center;justify-content:center;animation:fadeIn .18s ease}
.agent-modal{background:var(--bg2);border:1px solid var(--bg3);border-radius:12px;padding:24px;width:min(600px,90vw);max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.4);animation:scaleIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes scaleIn{from{transform:scale(.95) translateY(10px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.agent-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.agent-modal-title{font-size:16px;font-weight:700;color:var(--fg)}
.agent-modal-close{background:none;border:none;color:var(--fg3);font-size:18px;cursor:pointer;padding:4px 8px;border-radius:4px}
.agent-modal-close:hover{background:var(--bg3);color:var(--fg)}
/* ── Modal tabs ── */
.modal-tabs{display:flex;gap:0;margin-bottom:16px;border-bottom:1px solid var(--bg4)}
.modal-tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--fg3);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.modal-tab:hover{color:var(--fg2)}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.modal-tab-content{display:none}
.modal-tab-content.active{display:block}
/* ── Overview tab ── */
.overview-section{margin-bottom:14px}
.overview-label{font-size:10px;font-weight:700;color:var(--fg3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.overview-value{font-size:13px;color:var(--fg);line-height:1.5}
.overview-role{font-size:12px;color:var(--fg2);line-height:1.6;white-space:pre-wrap;max-height:80px;overflow-y:auto}
.overview-task{background:var(--bg3);border-radius:6px;padding:8px 10px;font-size:12px;color:var(--fg)}
.overview-task-id{font-family:var(--mono);color:var(--accent);font-size:11px}
.overview-logs{list-style:none;padding:0;margin:0}
.overview-logs li{font-size:11px;color:var(--fg3);font-family:var(--mono);padding:2px 0;border-bottom:1px solid var(--bg3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.overview-score-row{display:flex;align-items:center;gap:6px;margin:3px 0;font-size:11px;color:var(--fg2)}
.overview-score-label{min-width:76px}
.overview-score-bar{flex:1;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.overview-score-fill{height:100%;border-radius:2px;transition:width .3s}
.overview-score-num{min-width:28px;text-align:right;font-family:var(--mono)}
.agent-editor .field{margin-bottom:12px}
.agent-editor .field label{display:block;font-size:11px;font-weight:600;color:var(--fg2);text-transform:uppercase;margin-bottom:4px}
.agent-editor .field-row{display:flex;gap:12px}
.agent-editor .field-row>.field{flex:1}
.agent-editor .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid var(--bg3)}
.model-dropdown{position:absolute;top:100%;left:0;right:60px;background:var(--bg2);border:1px solid var(--bg4);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:100;max-height:200px;overflow-y:auto;margin-top:4px}
.model-dropdown .model-option{padding:8px 12px;font-size:13px;color:var(--fg);cursor:pointer;border-bottom:1px solid var(--bg3);transition:background .1s}
.model-dropdown .model-option:last-child{border-bottom:none}
.model-dropdown .model-option:hover{background:var(--bg3)}
.model-dropdown .model-option.selected{background:rgba(55,115,255,.1);color:var(--accent)}
.btn-create-agent{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-create-agent:hover{filter:brightness(1.15);transform:translateY(-1px)}
.btn-delete-agent{background:none;border:1px solid #e74c3c;color:#e74c3c;border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;transition:all .15s}
.btn-delete-agent:hover{background:#e74c3c;color:#fff}

/* ── Skills Layout ────────────────────────────────────────────── */
.skills-layout{display:flex;gap:16px;height:calc(100vh - 120px)}
.skills-list{width:260px;min-width:260px;background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden}
.skills-list-header{padding:10px 12px;border-bottom:1px solid var(--bg3)}
.skills-list-body{overflow-y:auto;flex:1}
.skill-group-title{padding:8px 12px 4px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--fg3);letter-spacing:.5px}
.skill-item{padding:7px 12px;cursor:pointer;font-size:13px;color:var(--fg2);transition:.1s;border-left:3px solid transparent;display:flex;align-items:center;justify-content:space-between}
.skill-item:hover{background:var(--bg3);color:var(--fg)}
.skill-item.active{background:rgba(55,115,255,.08);color:var(--accent2);border-left-color:var(--accent)}
.skill-item .skill-scope{font-size:10px;padding:1px 5px;border-radius:3px;background:var(--bg4);color:var(--fg3)}

.skills-editor{flex:1;display:flex;flex-direction:column;min-width:0}
.skills-toolbar{display:flex;align-items:center;gap:8px;padding:10px 0;flex-wrap:wrap}
.skills-toolbar .skill-filename{font-family:var(--mono);font-size:13px;color:var(--fg2)}
.skills-editor textarea{flex:1;background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);color:var(--fg);font-family:var(--mono);font-size:12px;line-height:1.6;padding:14px;resize:none;outline:none;min-height:300px}
.skills-editor textarea:focus{border-color:var(--accent)}
.skills-empty{display:flex;align-items:center;justify-content:center;flex:1;color:var(--fg3);font-size:14px}
.skill-assign-bar{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--bg3);flex-wrap:wrap}
.skill-assign-label{font-size:11px;font-weight:600;color:var(--fg2);text-transform:uppercase;flex-shrink:0}
.skill-assign-cb{display:flex;align-items:center;gap:3px;font-size:12px;color:var(--fg2);cursor:pointer}
.skill-assign-cb span{user-select:none}

/* ── Health Checks ────────────────────────────────────────────── */
.checks{list-style:none}
.checks li{padding:6px 0;border-bottom:1px solid var(--bg3);font-size:13px;display:flex;align-items:center;gap:8px}
.checks li:last-child{border-bottom:none}
.check-icon{font-size:14px;width:16px}
.check-label{font-weight:600;min-width:100px}
.check-detail{color:var(--fg2);font-size:12px}

/* ── Config View ──────────────────────────────────────────────── */
.config-pre{background:var(--bg3);border-radius:8px;padding:14px;font-family:var(--mono);font-size:12px;line-height:1.7;overflow-x:auto;color:var(--fg2);white-space:pre-wrap;max-height:400px;overflow-y:auto}

/* ── Gateway Panel ────────────────────────────────────────────── */
.token-display{display:flex;align-items:center;gap:8px;margin:8px 0}
.token-display code{flex:1;font-family:var(--mono);font-size:12px;background:var(--bg3);padding:8px 12px;border-radius:6px;word-break:break-all;user-select:all}
.info-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:12px}
.info-item{padding:10px;background:var(--bg3);border-radius:8px}
.info-item .info-label{font-size:11px;color:var(--fg3);text-transform:uppercase;margin-bottom:2px}
.info-item .info-value{font-family:var(--mono);font-size:14px;font-weight:600}

/* ── Logs Panel ───────────────────────────────────────────────── */
.logs-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.logs-controls select{width:160px}
.log-levels{display:flex;gap:2px}
.log-level-btn{padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;background:var(--bg3);color:var(--fg2);border:1px solid var(--bg4);transition:.12s}
.log-level-btn:hover{border-color:var(--fg3)}
.log-level-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.log-content{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:12px;font-family:var(--mono);font-size:11px;line-height:1.6;overflow:auto;max-height:calc(100vh - 220px);white-space:pre-wrap}
.log-line-error{color:var(--red)}
.log-line-warn{color:var(--yellow)}
.log-line-info{color:var(--fg2)}
.auto-refresh-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fg2);cursor:pointer}
.auto-refresh-toggle input{accent-color:var(--accent)}

/* ── Usage Table ──────────────────────────────────────────────── */
.usage-table{width:100%;border-collapse:collapse;font-size:13px}
.usage-table th{text-align:left;font-size:11px;font-weight:600;color:var(--fg3);text-transform:uppercase;padding:6px 10px;border-bottom:1px solid var(--bg3)}
.usage-table td{padding:6px 10px;border-bottom:1px solid var(--bg3)}
.usage-table td.mono{font-family:var(--mono)}
.usage-table tr:hover{background:var(--bg3)}

/* ── Empty State ──────────────────────────────────────────────── */
.empty{text-align:center;color:var(--fg3);padding:30px 0;font-size:13px}

/* ── Toast ────────────────────────────────────────────────────── */
.toast{position:fixed;bottom:24px;right:24px;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:500;color:#fff;z-index:999;animation:toastIn .25s ease;pointer-events:none}
.toast.success{background:var(--green)}
.toast.error{background:var(--red)}
.toast.info{background:var(--accent)}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ── Dialog ───────────────────────────────────────────────────── */
.dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:flex;align-items:center;justify-content:center}
.dialog{background:var(--bg2);border:1px solid var(--bg3);border-radius:12px;padding:24px;min-width:360px;max-width:500px}
.dialog-title{font-size:16px;font-weight:700;margin-bottom:14px}
.dialog .field{margin-bottom:12px}
.dialog .field label{display:block;font-size:11px;font-weight:600;color:var(--fg2);text-transform:uppercase;margin-bottom:4px}
.dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* ── Overview: Split Layout (top orchestration + bottom chat) ── */
#panel-overview.active{display:flex!important;flex-direction:column;height:calc(100vh - 44px);gap:0}
/* ── Overview: Header Bar (statuses left, agents right) ────── */
.ov-header{display:flex;align-items:center;gap:8px;flex-shrink:0;padding:5px 8px;background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);margin-bottom:8px;min-height:36px}
.ov-statuses{flex:1;display:flex;gap:4px;min-width:0;align-items:center;overflow:hidden}
.ov-status-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--fg2);padding:4px 10px;background:var(--bg3);border-radius:6px;overflow:hidden;max-width:260px;height:26px;box-sizing:border-box}
.ov-status-item .status-icon{font-size:11px;flex-shrink:0;width:14px;height:14px;display:flex;align-items:center;justify-content:center}
.ov-status-item .status-icon img{width:14px;height:14px;border-radius:50%;object-fit:cover}
.ov-status-item .status-agent{font-weight:600;flex-shrink:0;font-size:11px;text-transform:capitalize}
.ov-status-item .status-agent.leo-d{color:var(--accent)}
.ov-status-item .status-agent.jerry-d{color:var(--cyan)}
.ov-status-item .status-agent.alic-d{color:var(--magenta)}
.ov-status-item .status-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px}
.ov-status-empty{font-size:11px;color:var(--fg3);padding:0 8px}
.ov-header-sep{width:1px;height:20px;background:var(--bg4);flex-shrink:0}
.ov-agents{display:flex;gap:4px;flex-shrink:0;align-items:center}
.ov-agent-chip{display:flex;align-items:center;gap:5px;padding:3px 10px;background:var(--bg3);border:1px solid transparent;border-radius:6px;height:26px;box-sizing:border-box;transition:.3s}
.ov-agent-chip.active{border-color:var(--accent);background:rgba(55,115,255,.06)}
.ov-agent-chip.active.jerry{border-color:var(--cyan);background:rgba(3,191,212,.06)}
.ov-agent-chip.active.alic{border-color:var(--magenta);background:rgba(156,89,243,.06)}
.ov-agent-chip .chip-avatar{width:14px;height:14px;border-radius:50%;object-fit:cover;flex-shrink:0}
.ov-agent-chip .chip-name{font-size:11px;font-weight:600;color:var(--fg2);text-transform:capitalize}
.ov-agent-chip.active .chip-name{color:var(--fg)}
.ov-agent-chip .chip-dot{width:5px;height:5px;border-radius:50%;background:var(--fg3);flex-shrink:0}
.ov-agent-chip.active .chip-dot{background:var(--accent);animation:livePulse 1.2s infinite}
.ov-agent-chip.active.jerry .chip-dot{background:var(--cyan)}
.ov-agent-chip.active.alic .chip-dot{background:var(--magenta)}

/* ── Subtask Tree ─────────────────────────────────────────── */
.subtask-tree{flex-shrink:0;padding:0 4px;margin-bottom:8px;display:none}
.subtask-tree.has-tree{display:block}
.st-toggle{font-size:10px;color:var(--fg3);cursor:pointer;padding:4px 8px;user-select:none}
.st-toggle:hover{color:var(--fg2)}
.st-container{display:flex;flex-wrap:wrap;gap:6px;padding:6px 0}
.st-node{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:10px;border:1px solid var(--bg4);background:var(--bg3);max-width:220px;overflow:hidden}
.st-node .st-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.st-node .st-dot.pending{background:var(--fg3)}
.st-node .st-dot.claimed{background:var(--yellow);animation:livePulse 1.2s infinite}
.st-node .st-dot.review{background:var(--magenta)}
.st-node .st-dot.completed{background:var(--green)}
.st-node .st-dot.failed{background:var(--red)}
.st-node .st-dot.critique{background:var(--yellow)}
.st-node .st-desc{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--fg2)}
.st-node .st-agent{font-weight:600;color:var(--fg3);flex-shrink:0;font-size:9px}
.st-edge{color:var(--fg3);font-size:10px;align-self:center}
.st-group{display:flex;flex-direction:column;gap:4px;padding:4px 0 4px 16px;border-left:1.5px solid var(--bg4)}
.st-parent-label{font-size:10px;font-weight:600;color:var(--fg3);padding:2px 6px}

.ov-bottom{display:flex;flex-direction:column;flex:1;min-height:200px;overflow:hidden}

/* ── (Legacy ov-top/divider kept for non-overview panels) ──── */
.ov-top{display:none}
.ov-divider{display:none}
.workflow-viz{display:none}
.wf-pipeline{display:flex;align-items:center;justify-content:center;gap:0;padding:4px 0 10px}
.wf-node{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:90px;padding:10px 14px;border-radius:10px;border:1.5px solid var(--bg4);background:var(--bg3);transition:.3s}
.wf-node.active{border-color:var(--accent);box-shadow:0 0 18px rgba(55,115,255,.15)}
.wf-node.active.jerry{border-color:var(--cyan);box-shadow:0 0 18px rgba(3,191,212,.15)}
.wf-node.active.alic{border-color:var(--magenta);box-shadow:0 0 18px rgba(156,89,243,.15)}
.wf-avatar{font-size:22px;line-height:1}
.wf-name{font-size:12px;font-weight:700;color:var(--fg)}
.wf-status{font-size:10px;color:var(--fg3);font-family:var(--mono);transition:.3s}
.wf-node.active .wf-status{color:var(--accent)}
.wf-node.active.jerry .wf-status{color:var(--cyan)}
.wf-node.active.alic .wf-status{color:var(--magenta)}
.wf-connector{display:flex;align-items:center;width:80px;height:2px;position:relative;margin:0 2px}
.wf-line{width:100%;height:2px;background:var(--bg4);border-radius:1px;position:relative;overflow:visible}
.wf-connector.active .wf-line{background:linear-gradient(90deg,var(--accent),var(--cyan))}
.wf-arrow{position:absolute;right:-3px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--fg3)}
.wf-connector.active .wf-arrow{color:var(--accent)}
.wf-stats{text-align:center;font-size:11px;color:var(--fg2);font-family:var(--mono);padding-top:2px}

/* ── Dispatch Log (top panel, compact) ───────────────────────── */
.ov-dispatch{flex:1;overflow-y:auto;background:var(--bg2);border:1px solid var(--bg3);border-top:none;border-radius:0 0 var(--radius) var(--radius);padding:6px 10px;min-height:0}
.ov-dispatch::-webkit-scrollbar{width:4px}
.ov-dispatch::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}
.dispatch-entry{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px;color:var(--fg2);border-bottom:1px solid rgba(255,255,255,.03);animation:chatIn .15s ease}
.dispatch-entry:last-child{border-bottom:none}
.dispatch-icon{width:16px;text-align:center;font-size:12px;flex-shrink:0}
.dispatch-agent{font-weight:600;min-width:56px;flex-shrink:0}
.dispatch-agent.leo-d{color:var(--accent)}
.dispatch-agent.jerry-d{color:var(--cyan)}
.dispatch-agent.alic-d{color:var(--magenta)}
.dispatch-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dispatch-tokens{font-family:var(--mono);font-size:9px;color:var(--fg3);flex-shrink:0}
.dispatch-tokens .tok-in{color:var(--cyan)}
.dispatch-tokens .tok-out{color:var(--green)}
.dispatch-time{font-family:var(--mono);font-size:9px;color:var(--fg3);min-width:36px;text-align:right;flex-shrink:0}
.dispatch-live{display:inline-flex;align-items:center;gap:3px}
.dispatch-live-dot{width:5px;height:5px;border-radius:50%;animation:livePulse 1.2s infinite}
.dispatch-toggle{display:flex;align-items:center;justify-content:center;gap:4px;padding:2px 8px;cursor:pointer;font-size:10px;color:var(--fg3);background:var(--bg2);border:1px solid var(--bg3);border-radius:0 0 6px 6px;margin:-1px auto 0;width:fit-content;transition:.15s}
.dispatch-toggle:hover{color:var(--fg);border-color:var(--accent)}

/* ── Workflow: Data Packet Animation ─────────────────────────── */
.wf-packet{position:absolute;top:50%;transform:translate(-50%,-50%);width:10px;height:10px;border-radius:50%;opacity:0;pointer-events:none;filter:blur(0px);z-index:5}
.wf-packet.animating{animation:wfPacketMove 1s ease-in-out forwards}
.wf-packet.leo-packet{background:var(--accent);box-shadow:0 0 10px var(--accent),0 0 20px rgba(55,115,255,.3)}
.wf-packet.jerry-packet{background:var(--cyan);box-shadow:0 0 10px var(--cyan),0 0 20px rgba(3,191,212,.3)}
.wf-packet.alic-packet{background:var(--magenta);box-shadow:0 0 10px var(--magenta),0 0 20px rgba(156,89,243,.3)}
@keyframes wfPacketMove{0%{left:0;opacity:0;transform:translate(-50%,-50%) scale(.4)}10%{opacity:1;transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.2)}90%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{left:100%;opacity:0;transform:translate(-50%,-50%) scale(.4)}}

/* ── Workflow: Pulse ring on receiving node ───────────────────── */
.wf-node.receiving{animation:wfReceivePulse .6s ease}
@keyframes wfReceivePulse{0%{box-shadow:0 0 0 0 rgba(55,115,255,.4)}50%{box-shadow:0 0 0 12px rgba(55,115,255,0)}100%{box-shadow:none}}
.wf-node.receiving.jerry{animation-name:wfReceivePulseCyan}
@keyframes wfReceivePulseCyan{0%{box-shadow:0 0 0 0 rgba(3,191,212,.4)}50%{box-shadow:0 0 0 12px rgba(3,191,212,0)}100%{box-shadow:none}}
.wf-node.receiving.alic{animation-name:wfReceivePulsePurple}
@keyframes wfReceivePulsePurple{0%{box-shadow:0 0 0 0 rgba(156,89,243,.4)}50%{box-shadow:0 0 0 12px rgba(156,89,243,0)}100%{box-shadow:none}}

/* ── Overview: Chat Messages (bottom panel) ──────────────────── */
.chat-messages{flex:1;overflow-y:auto;padding:16px 12px;display:flex;flex-direction:column;gap:12px;min-height:0}
.chat-messages::-webkit-scrollbar{width:5px}
.chat-messages::-webkit-scrollbar-track{background:transparent}
.chat-messages::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
.chat-welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:10px;color:var(--fg3);min-height:200px}
.chat-welcome-icon{font-size:42px;opacity:.4}
.chat-welcome-text{font-size:20px;font-weight:700;color:var(--fg)}
.chat-welcome-sub{font-size:13px;max-width:320px;text-align:center;line-height:1.6}

.chat-msg{display:flex;gap:10px;max-width:88%;animation:chatIn .2s ease}
.chat-msg.user{align-self:flex-end;flex-direction:row-reverse;max-width:75%}
.chat-msg.system{align-self:center;max-width:90%}
.chat-msg.agent{align-self:flex-start}
.chat-msg.assistant{align-self:flex-start;max-width:100%}
@keyframes chatIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.chat-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;background:var(--bg4);margin-top:2px}
.chat-avatar.leo{background:rgba(55,115,255,.12);border:1px solid rgba(55,115,255,.25)}
.chat-avatar.jerry{background:rgba(3,191,212,.12);border:1px solid rgba(3,191,212,.25)}
.chat-avatar.alic{background:rgba(156,89,243,.12);border:1px solid rgba(156,89,243,.25)}
.chat-avatar.user-av{background:rgba(55,115,255,.12);border:1px solid rgba(55,115,255,.25)}

.chat-bubble{padding:8px 12px;border-radius:10px;font-size:13px;line-height:1.55;word-break:break-word}
.chat-bubble.user-bubble{background:var(--bg3);color:var(--fg);border-bottom-right-radius:3px;border:1px solid var(--bg4)}
.chat-bubble.agent-bubble{background:var(--bg2);border:1px solid var(--bg3);border-bottom-left-radius:3px}
.chat-bubble.agent-bubble.leo-bubble{border-left:3px solid var(--accent)}
.chat-bubble.agent-bubble.jerry-bubble{border-left:3px solid var(--cyan)}
.chat-bubble.agent-bubble.alic-bubble{border-left:3px solid var(--magenta)}
.chat-bubble.system-bubble{background:var(--bg3);color:var(--fg2);font-size:12px;padding:5px 12px;border-radius:14px}
.chat-bubble.assistant-bubble{background:transparent;border:none;border-radius:0;padding:0 0 0 2px;font-size:14px;line-height:1.75}
.chat-bubble.assistant-bubble .asst-header{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:12px;color:var(--fg3)}
.chat-bubble.assistant-bubble .asst-header .asst-label{font-weight:700;color:var(--fg);font-size:13px}
.stream-body{max-width:100%;font-size:13px;color:var(--fg);line-height:1.7;word-break:break-word;overflow-y:auto;max-height:60vh;min-height:20px}
.stream-body p{margin:2px 0}
.stream-body h1,.stream-body h2,.stream-body h3{color:var(--fg);margin:10px 0 4px;font-size:14px;font-weight:700}
.stream-body h1{font-size:16px}
.stream-body ul,.stream-body ol{margin:4px 0 4px 20px;padding:0}
.stream-body li{margin:2px 0;line-height:1.5}
.stream-body strong{color:var(--fg);font-weight:700}
.stream-body code{background:var(--bg);padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:12px}
.stream-body pre{background:var(--bg);padding:10px 12px;border-radius:6px;font-family:var(--mono);font-size:11px;line-height:1.5;overflow-x:auto;white-space:pre-wrap;max-height:300px;overflow-y:auto;margin:8px 0}
.stream-body blockquote{border-left:3px solid var(--accent);padding:4px 12px;margin:6px 0;color:var(--fg2);background:rgba(55,115,255,.04);border-radius:0 4px 4px 0}
.stream-body table{width:100%;border-collapse:collapse;margin:8px 0;font-size:12px}
.stream-body th{background:var(--bg3);color:var(--fg);font-weight:700;padding:6px 10px;border:1px solid var(--bg4)}
.stream-body td{padding:5px 10px;border:1px solid var(--bg4);color:var(--fg2)}
.stream-body a{color:var(--accent2)}
.stream-body hr{border:none;border-top:1px solid var(--bg4);margin:8px 0}
.stream-cursor{display:inline-block;width:2px;height:14px;background:var(--accent);animation:cursorBlink 1s step-end infinite;vertical-align:text-bottom;margin-left:2px}
@keyframes cursorBlink{0%,100%{opacity:1}50%{opacity:0}}
.stream-steps{display:flex;flex-direction:column;gap:3px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bg3)}
.stream-step{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--fg2);padding:5px 10px;border-radius:8px;background:var(--bg);transition:all .25s ease;animation:stepSlideIn .3s ease both}
.stream-step.step-done{color:var(--fg3);opacity:.7}
.stream-step.step-done .step-icon{opacity:.5}
.stream-step.step-active{color:var(--fg);background:rgba(55,115,255,.07);border:1px solid rgba(55,115,255,.15);box-shadow:0 0 8px rgba(55,115,255,.06)}
.step-icon{font-size:12px;flex-shrink:0;width:16px;text-align:center}
.step-label{font-weight:500;white-space:nowrap}
.step-preview{color:var(--fg3);font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:280px;margin-left:4px}
.step-spinner{width:10px;height:10px;border:1.5px solid var(--bg4);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-left:auto;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes stepSlideIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.stream-meta{font-size:10px;color:var(--fg3);margin-top:6px;display:flex;align-items:center;gap:8px;padding-top:6px;border-top:1px solid var(--bg3)}
.stream-meta .char-count{opacity:.6;font-family:var(--mono);font-size:9px}
.stream-meta .stream-agent-status{color:var(--cyan);font-weight:600;display:flex;align-items:center;gap:4px}
.stream-meta .stream-agent-status::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--cyan);animation:statusPulse 1.5s ease-in-out infinite}
@keyframes statusPulse{0%,100%{opacity:1}50%{opacity:.3}}
.chat-bubble.assistant-bubble .asst-body{word-break:break-word;color:var(--fg)}
.chat-bubble.assistant-bubble .asst-body p{margin:6px 0}
.chat-bubble.assistant-bubble .asst-body h1,.chat-bubble.assistant-bubble .asst-body h2,.chat-bubble.assistant-bubble .asst-body h3,.chat-bubble.assistant-bubble .asst-body h4,.chat-bubble.assistant-bubble .asst-body h5,.chat-bubble.assistant-bubble .asst-body h6{color:var(--fg);margin:16px 0 8px;font-weight:700}
.chat-bubble.assistant-bubble .asst-body h1{font-size:18px;letter-spacing:-.3px}
.chat-bubble.assistant-bubble .asst-body h2{font-size:16px}
.chat-bubble.assistant-bubble .asst-body h3{font-size:15px}
.chat-bubble.assistant-bubble .asst-body h4{font-size:14px;color:var(--fg2)}
.chat-bubble.assistant-bubble .asst-body h5,.chat-bubble.assistant-bubble .asst-body h6{font-size:12px;color:var(--fg2);text-transform:uppercase;letter-spacing:.3px}
.chat-bubble.assistant-bubble .asst-body ul,.chat-bubble.assistant-bubble .asst-body ol{margin:6px 0 6px 22px;padding:0}
.chat-bubble.assistant-bubble .asst-body li{margin:3px 0;line-height:1.65}
.chat-bubble.assistant-bubble .asst-body strong{color:var(--fg);font-weight:700}
.chat-bubble.assistant-bubble .asst-body em{color:var(--fg2);font-style:italic}
.chat-bubble.assistant-bubble .asst-body code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:12.5px;color:var(--cyan)}
.chat-bubble.assistant-bubble .asst-body hr{border:none;border-top:1px solid var(--bg4);margin:12px 0}
.chat-bubble.assistant-bubble .asst-body del{color:var(--fg3);text-decoration:line-through}
.chat-bubble.assistant-bubble .asst-body blockquote{border-left:3px solid var(--accent);padding:6px 14px;margin:8px 0;color:var(--fg2);background:rgba(55,115,255,.04);border-radius:0 6px 6px 0}
.chat-bubble.assistant-bubble .asst-body table{width:100%;border-collapse:collapse;margin:10px 0;font-size:13px}
.chat-bubble.assistant-bubble .asst-body th{background:var(--bg3);color:var(--fg);font-weight:700;padding:8px 12px;border:1px solid var(--bg4);font-size:12px;text-transform:uppercase;letter-spacing:.3px}
.chat-bubble.assistant-bubble .asst-body td{padding:6px 12px;border:1px solid var(--bg4);color:var(--fg2)}
.chat-bubble.assistant-bubble .asst-body tr:hover td{background:rgba(255,255,255,.02)}
.chat-bubble.assistant-bubble .asst-body .md-img{max-width:100%;border-radius:8px;margin:8px 0;border:1px solid var(--bg4)}
.chat-bubble.assistant-bubble .asst-body a{color:var(--accent2);text-decoration:none;border-bottom:1px dotted rgba(90,143,255,.3)}
.chat-bubble.assistant-bubble .asst-body a:hover{border-bottom-color:var(--accent2)}
.chat-bubble.assistant-bubble pre,.stream-body pre{position:relative;background:var(--bg);padding:10px 12px;border-radius:8px;font-family:var(--mono);font-size:11.5px;line-height:1.6;overflow-x:auto;white-space:pre-wrap;max-height:400px;overflow-y:auto;margin:8px 0;border:1px solid var(--bg3)}
.code-block-header{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;background:var(--bg3);border-radius:8px 8px 0 0;border:1px solid var(--bg4);border-bottom:none;margin:8px 0 0}
.code-block-header+pre{margin-top:0;border-radius:0 0 8px 8px;border-top:none}
.code-lang{font-family:var(--mono);font-size:10px;color:var(--fg3);text-transform:lowercase;letter-spacing:.3px}
.code-copy-btn{background:transparent;border:1px solid var(--bg4);color:var(--fg3);font-size:10px;padding:2px 8px;border-radius:4px;cursor:pointer;font-family:var(--font);transition:.15s}
.code-copy-btn:hover{background:var(--bg4);color:var(--fg)}
.code-copy-btn.copied{color:var(--green);border-color:var(--green)}
.chat-bubble.assistant-bubble .asst-tokens{display:flex;gap:10px;margin-top:12px;padding-top:8px;border-top:1px solid var(--bg3);font-family:var(--mono);font-size:10px;color:var(--fg3)}

.chat-bubble pre{background:var(--bg);padding:8px 10px;border-radius:6px;font-family:var(--mono);font-size:11px;line-height:1.5;overflow-x:auto;white-space:pre-wrap;max-height:200px;overflow-y:auto;margin:6px 0 2px}
.chat-bubble .chat-agent-name{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.chat-bubble .chat-agent-name.leo-name{color:var(--accent)}
.chat-bubble .chat-agent-name.jerry-name{color:var(--cyan)}
.chat-bubble .chat-agent-name.alic-name{color:var(--magenta)}
.chat-bubble .chat-score{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-top:4px}
.chat-bubble .chat-task-id{font-family:var(--mono);font-size:10px;color:var(--fg3);margin-top:2px}
.chat-bubble .chat-tokens{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:9px;color:var(--fg3);margin-top:3px;padding:2px 6px;background:var(--bg);border-radius:4px}
.chat-bubble .chat-tokens .tok-in{color:var(--cyan)}
.chat-bubble .chat-tokens .tok-out{color:var(--green)}
.chat-bubble .chat-tokens .tok-sep{color:var(--fg3);margin:0 1px}
.chat-result-toggle{font-size:11px;color:var(--accent2);cursor:pointer;margin-top:4px;user-select:none}
.chat-result-toggle:hover{text-decoration:underline}
.chat-result-content{display:none}
.chat-result-content.open{display:block}

.chat-typing{display:flex;gap:4px;padding:4px 12px;align-items:center}
.chat-typing-dot{width:5px;height:5px;border-radius:50%;background:var(--fg3);animation:typingBounce .8s infinite}
.chat-typing-dot:nth-child(2){animation-delay:.15s}
.chat-typing-dot:nth-child(3){animation-delay:.3s}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* ── Live agent status indicator ─────────────────────────────── */
.chat-live-status{display:flex;gap:8px;max-width:85%;animation:chatIn .2s ease;align-self:flex-start}
.chat-live-inner{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--bg2);border:1px solid var(--bg3);border-radius:10px;border-bottom-left-radius:3px;font-size:12px;color:var(--fg2)}
.chat-live-inner .live-dot{width:7px;height:7px;border-radius:50%;animation:livePulse 1.2s infinite}
.chat-live-inner.leo-live{border-left:3px solid var(--accent)}
.chat-live-inner.leo-live .live-dot{background:var(--accent)}
.chat-live-inner.jerry-live{border-left:3px solid var(--cyan)}
.chat-live-inner.jerry-live .live-dot{background:var(--cyan)}
.chat-live-inner.alic-live{border-left:3px solid var(--magenta)}
.chat-live-inner.alic-live .live-dot{background:var(--magenta)}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ── Overview: Chat Input (Claude Code style) ────────────────── */
.chat-input-area{padding:10px 0 4px;flex-shrink:0}
.chat-attachments{display:flex;gap:6px;flex-wrap:wrap;padding-bottom:6px}
.chat-attach-thumb{position:relative;width:56px;height:56px;border-radius:8px;overflow:hidden;border:1px solid var(--bg4);background:var(--bg3)}
.chat-attach-thumb img{width:100%;height:100%;object-fit:cover}
.chat-attach-thumb .chat-attach-name{position:absolute;bottom:0;left:0;right:0;font-size:8px;background:rgba(0,0,0,.7);color:var(--fg);padding:1px 3px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
.chat-attach-remove{position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:var(--red);color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1.5px solid var(--bg);z-index:1}
.chat-input-box{display:flex;flex-direction:column;background:var(--bg2);border:1.5px solid var(--bg4);border-radius:16px;transition:border-color .15s,box-shadow .15s;overflow:hidden}
.chat-input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(55,115,255,.08)}
.chat-textarea{flex:1;background:transparent;border:none;color:var(--fg);padding:12px 16px 4px;font-size:14px;font-family:var(--font);outline:none;resize:none;line-height:1.5;max-height:160px;overflow-y:auto;min-height:24px}
.chat-textarea::placeholder{color:var(--fg3)}
.chat-input-bottom{display:flex;align-items:center;justify-content:space-between;padding:4px 6px 6px}
.chat-input-actions{display:flex;gap:1px;flex-shrink:0}
.chat-action-btn{width:32px;height:32px;border-radius:8px;border:none;background:transparent;color:var(--fg3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:.12s;flex-shrink:0}
.chat-action-btn:hover{color:var(--fg);background:var(--bg3)}
.chat-action-btn.active{color:var(--accent2);background:rgba(55,115,255,.1)}
.chat-send{padding:6px 16px;border-radius:10px;height:32px;display:flex;align-items:center;gap:4px;font-size:13px;font-weight:600}
.chat-send:disabled{opacity:.2;cursor:not-allowed}

/* ── Chat: Search indicator ──────────────────────────────────── */
.chat-search-indicator{display:flex;align-items:center;gap:6px;padding:4px 10px;margin-bottom:4px;font-size:11px;color:var(--cyan);background:rgba(3,191,212,.06);border:1px solid rgba(3,191,212,.15);border-radius:8px}
.chat-search-indicator .search-spinner{width:12px;height:12px;border:2px solid rgba(3,191,212,.2);border-top-color:var(--cyan);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── Chat: Image in messages ─────────────────────────────────── */
.chat-bubble .chat-images{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.chat-bubble .chat-images img{max-width:200px;max-height:150px;border-radius:6px;cursor:pointer;border:1px solid var(--bg4)}
.chat-bubble .chat-images img:hover{border-color:var(--accent)}
.chat-bubble .chat-file-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;background:var(--bg3);font-size:11px;color:var(--fg2);margin-top:4px}
.chat-file-card{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg3);border:1px solid var(--bg4);border-radius:8px;text-decoration:none;color:var(--fg);transition:.15s;min-width:180px;max-width:280px}
.chat-file-card:hover{border-color:var(--accent);background:rgba(55,115,255,.05)}
.chat-file-card .file-icon{font-size:20px;flex-shrink:0}
.chat-file-card .file-info{display:flex;flex-direction:column;min-width:0}
.chat-file-card .file-name{font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.chat-file-card .file-path{font-size:9px;color:var(--fg3);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ── Chat: Search result cards ───────────────────────────────── */
.chat-search-results{margin-top:6px}
.chat-search-card{background:var(--bg);border:1px solid var(--bg4);border-radius:6px;padding:8px 10px;margin:3px 0;font-size:12px}
.chat-search-card a{color:var(--accent2);font-weight:600;font-size:12px}
.chat-search-card .search-snippet{color:var(--fg2);font-size:11px;margin-top:2px;line-height:1.4}

/* ── Responsive ───────────────────────────────────────────────── */
@media(max-width:800px){
  .sidebar{width:56px;min-width:56px}
  .nav-section-title,.nav-item span:not(.icon),.sidebar-footer,.sidebar-logo span,.sidebar-logo div:not(:first-child){display:none}
  .nav-item{justify-content:center;padding:10px 0}
  .nav-item .icon{margin:0}
  .content{padding:12px 14px}
  .skills-layout{flex-direction:column;height:auto}
  .skills-list{width:100%;min-width:0;max-height:200px}
  .agent-grid{grid-template-columns:1fr}
  .ov-header{flex-direction:column;gap:6px}
  .ov-header-sep{display:none}
  .ov-statuses{flex-wrap:wrap;justify-content:center}
  .ov-agents{justify-content:center}
  .chat-bubble.assistant-bubble .asst-body table{font-size:11px}
  .chat-bubble.assistant-bubble .asst-body th,.chat-bubble.assistant-bubble .asst-body td{padding:4px 6px}
  .chat-msg{max-width:92%}
}
</style>
</head>
<body>
<div class="app">

<!-- ═══════════════ Sidebar ═══════════════ -->
<nav class="sidebar">
  <div class="sidebar-logo">
    ⬡ <span>Cleo</span>
    <span class="status-dot" id="statusDot"></span>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Monitor</div>
    <div class="nav-item active" data-panel="overview" onclick="switchPanel('overview')">
      <span class="icon">📊</span><span>Overview</span>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">Manage</div>
    <div class="nav-item" data-panel="agents" onclick="switchPanel('agents')">
      <span class="icon">🤖</span><span>Agents</span>
    </div>
    <div class="nav-item" data-panel="skills" onclick="switchPanel('skills')">
      <span class="icon">📝</span><span>Skills</span>
    </div>
    <div class="nav-item" data-panel="cleo-files" onclick="switchPanel('cleo-files')">
      <span class="icon">📋</span><span>Files</span>
    </div>
    <div class="nav-item" data-panel="tools" onclick="switchPanel('tools')">
      <span class="icon">🔧</span><span>Tools</span>
    </div>
    <div class="nav-item" data-panel="usage" onclick="switchPanel('usage')">
      <span class="icon">📈</span><span>Usage</span>
    </div>
    <div class="nav-item" data-panel="channels" onclick="switchPanel('channels')">
      <span class="icon">📡</span><span>Channels</span>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-section-title">System</div>
    <div class="nav-item" data-panel="config" onclick="switchPanel('config')">
      <span class="icon">⚙️</span><span>Config</span>
    </div>
    <div class="nav-item" data-panel="gateway" onclick="switchPanel('gateway')">
      <span class="icon">🔑</span><span>Gateway</span>
    </div>
    <div class="nav-item" data-panel="health" onclick="switchPanel('health')">
      <span class="icon">💚</span><span>Health</span>
    </div>
    <div class="nav-item" data-panel="logs" onclick="switchPanel('logs')">
      <span class="icon">📋</span><span>Logs</span>
    </div>
    <div class="nav-item" data-panel="chain" onclick="switchPanel('chain')">
      <span class="icon">⛓️</span><span>Chain</span>
    </div>
    <div class="nav-item" data-panel="memory" onclick="switchPanel('memory')">
      <span class="icon">🧠</span><span>Memory</span>
    </div>
    <div class="nav-item" data-panel="cron" onclick="switchPanel('cron')">
      <span class="icon">⏰</span><span>Cron Jobs</span>
    </div>
  </div>

  <div class="sidebar-footer">
    <div id="footerAgents">0/0 agents online</div>
    <div id="footerUptime">uptime —</div>
    <div><code id="footerPort">:19789</code></div>
  </div>
</nav>

<!-- ═══════════════ Main Content ═══════════════ -->
<main class="content">

<!-- ── Panel: Overview ── -->
<div class="panel active" id="panel-overview">
  <!-- ═══ HEADER BAR: Latest statuses (left) | Agent chips (right) ═══ -->
  <div class="ov-header">
    <div class="ov-statuses" id="ovStatuses">
      <span class="ov-status-empty">Ready — Submit a task to start</span>
    </div>
    <div class="ov-header-sep"></div>
    <div class="ov-agents" id="ovAgents">
      <div class="ov-agent-chip" id="chipPlanner"><img class="chip-avatar" src="/avatars/leo.png" alt="Leo"><span class="chip-name">Leo</span><span class="chip-dot"></span></div>
      <div class="ov-agent-chip" id="chipExecutor"><img class="chip-avatar" src="/avatars/jerry.png" alt="Jerry"><span class="chip-name">Jerry</span><span class="chip-dot"></span></div>
      <div class="ov-agent-chip" id="chipReviewer"><img class="chip-avatar" src="/avatars/alic.png" alt="Alic"><span class="chip-name">Alic</span><span class="chip-dot"></span></div>
    </div>
  </div>

  <!-- Hidden legacy elements for JS compatibility -->
  <div style="display:none">
    <div id="ovTop"></div><div id="ovDivider"></div><div id="dispatchLog"></div>
    <div id="wfPlanner"></div><div id="wfExecutor"></div><div id="wfReviewer"></div>
    <div id="wfPlannerStatus"></div><div id="wfExecutorStatus"></div><div id="wfReviewerStatus"></div>
    <div id="wfConn1"></div><div id="wfConn2"></div><div id="wfStats"></div>
    <div id="wfPacket1"></div><div id="wfPacket2"></div>
  </div>

  <!-- ═══ SUBTASK TREE (shows when leo decomposes a task) ═══ -->
  <div class="subtask-tree" id="subtaskTree"></div>

  <!-- ═══ CHATBOX (takes most of the space) ═══ -->
  <div class="ov-bottom">
    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome">
        <div class="chat-welcome-icon">⬡</div>
        <div class="chat-welcome-text">What can I help you with?</div>
        <div class="chat-welcome-sub">Your task will be planned, executed, and reviewed by the Cleo agent team</div>
      </div>
    </div>
    <div class="chat-input-area">
      <div class="chat-attachments" id="chatAttachments" style="display:none"></div>
      <div class="chat-input-box">
        <textarea class="chat-textarea" id="chatInput" rows="1"
                  placeholder="Message Cleo…"></textarea>
        <div class="chat-input-bottom">
          <div class="chat-input-actions">
            <button class="chat-action-btn" title="Attach file" onclick="document.getElementById('chatFileInput').click()">📎</button>
            <button class="chat-action-btn" id="searchToggle" title="Web search (Brave)" onclick="toggleSearchMode()">🔍</button>
            <input type="file" id="chatFileInput" multiple accept="image/*,.pdf,.txt,.md,.json,.csv,.py,.js,.ts" style="display:none" onchange="handleFileSelect(this)">
          </div>
          <button class="btn chat-send" id="chatSend" onclick="chatSubmit()">Send ↑</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ── Panel: Agents ── -->
<div class="panel" id="panel-agents">
  <div class="page-header" style="display:flex;align-items:center;justify-content:space-between">
    <div>
      <div class="page-title">Agents</div>
      <div style="font-size:12px;color:var(--fg3)">Click an agent card to edit</div>
    </div>
    <button class="btn-create-agent" onclick="showCreateAgentModal()">+ Create Agent</button>
  </div>
  <div class="agent-grid" id="agentGrid">
    <div class="empty">Loading agents…</div>
  </div>
  <div id="agentModalContainer"></div>
</div>

<!-- ── Panel: Skills ── -->
<div class="panel" id="panel-skills">
  <div class="page-header">
    <div class="page-title">Skills</div>
    <div class="page-actions">
      <button class="btn btn-sm btn-outline" onclick="showCreateDialog()">+ New Skill</button>
      <label class="btn btn-sm btn-outline" style="cursor:pointer">
        ↑ Upload <input type="file" accept=".md" style="display:none" onchange="uploadSkill(this)">
      </label>
    </div>
  </div>
  <div class="skills-layout">
    <div class="skills-list">
      <div class="skills-list-header">
        <input class="input" type="text" placeholder="Search skills…" id="skillSearch" oninput="filterSkills()">
        <select class="input" id="skillAgentFilter" onchange="filterSkills()" style="margin-top:6px;font-size:11px">
          <option value="">All agents</option>
        </select>
      </div>
      <div class="skills-list-body" id="skillsListBody">
        <div class="empty">Loading…</div>
      </div>
    </div>
    <div class="skills-editor" id="skillsEditor">
      <div class="skills-empty">Select a skill from the list</div>
    </div>
  </div>
</div>

<!-- ── Panel: Cleo Files ── -->
<div class="panel" id="panel-cleo-files">
  <div class="page-header">
    <div class="page-title">Files</div>
    <div class="page-actions">
      <span style="font-size:12px;color:var(--fg3)">Agent config, memory, and identity files</span>
    </div>
  </div>
  <div class="skills-layout">
    <div class="skills-list">
      <div class="skills-list-header">
        <input class="input" type="text" placeholder="Search files…" id="cfSearch" oninput="filterCfFiles()">
      </div>
      <div class="skills-list-body" id="cfListBody">
        <div class="empty">Loading…</div>
      </div>
    </div>
    <div class="skills-editor" id="cfEditor">
      <div class="skills-empty">Select a file from the list to view or edit</div>
    </div>
  </div>
</div>

<!-- ── Panel: Tools ── -->
<div class="panel" id="panel-tools">
  <div class="page-header">
    <div class="page-title">Built-in Tools</div>
    <div style="font-size:12px;color:var(--fg3)">Agent tool registry — Web Search, Shell Exec, Cron, Media, Filesystem</div>
  </div>
  <div class="stats" id="toolsStats">
    <div class="stat"><div class="stat-value green" id="tAvail">0</div><div class="stat-label">Available</div></div>
    <div class="stat"><div class="stat-value" id="tTotal">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-value cyan" id="tGroups">0</div><div class="stat-label">Groups</div></div>
  </div>
  <div id="toolsContent" class="card-row" style="flex-direction:column;gap:12px"></div>
</div>

<!-- ── Panel: Usage ── -->
<div class="panel" id="panel-usage">
  <div class="page-header"><div class="page-title">Usage</div></div>
  <div class="stats" id="usageStats">
    <div class="stat"><div class="stat-value" id="uCalls">0</div><div class="stat-label">API Calls</div></div>
    <div class="stat"><div class="stat-value" id="uTokens">0</div><div class="stat-label">Tokens</div></div>
    <div class="stat"><div class="stat-value green" id="uCost">$0</div><div class="stat-label">Est. Cost</div></div>
    <div class="stat"><div class="stat-value cyan" id="uRetries">0</div><div class="stat-label">Retries</div></div>
  </div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">By Agent</div>
      <div id="usageByAgent"><div class="empty">No usage data</div></div>
    </div>
    <div class="card">
      <div class="card-title">By Model</div>
      <div id="usageByModel"><div class="empty">No usage data</div></div>
    </div>
  </div>
</div>

<!-- ── Panel: Channels ── -->
<div class="panel" id="panel-channels">
  <div class="page-header">
    <div class="page-title">Channels</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadChannels()">Refresh</button></div>
  </div>
  <div class="stats" id="channelStats">
    <div class="stat"><div class="stat-value cyan" id="chTotal">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-value green" id="chRunning">0</div><div class="stat-label">Running</div></div>
    <div class="stat"><div class="stat-value" id="chEnabled">0</div><div class="stat-label">Enabled</div></div>
  </div>
  <div class="agent-grid" id="channelGrid"><div class="empty">Loading…</div></div>
</div>

<!-- ── Panel: Config ── -->
<div class="panel" id="panel-config">
  <div class="page-header"><div class="page-title">Configuration</div></div>
  <div class="card-row">
    <div class="card">
      <div class="card-title">Agent Configuration</div>
      <pre class="config-pre" id="configView">Loading…</pre>
    </div>
    <div class="card">
      <div class="card-title">Resilience</div>
      <pre class="config-pre" id="resilienceView">Loading…</pre>
    </div>
  </div>
</div>

<!-- ── Panel: Gateway ── -->
<div class="panel" id="panel-gateway">
  <div class="page-header"><div class="page-title">Gateway</div></div>
  <div class="card">
    <div class="card-title">API Token</div>
    <div class="token-display">
      <code id="gatewayToken">Loading…</code>
      <button class="btn btn-sm" onclick="copyToken()">Copy</button>
      <button class="btn btn-sm btn-danger" onclick="regenerateToken()">Regenerate</button>
    </div>
    <div style="font-size:11px;color:var(--fg3);margin-top:4px">Use this token in Authorization header: <code>Bearer &lt;token&gt;</code></div>
  </div>
  <div class="card">
    <div class="card-title">Server Info</div>
    <div class="info-grid" id="gatewayInfo">
      <div class="info-item"><div class="info-label">Port</div><div class="info-value" id="gwPort">—</div></div>
      <div class="info-item"><div class="info-label">Uptime</div><div class="info-value" id="gwUptime">—</div></div>
      <div class="info-item"><div class="info-label">Status</div><div class="info-value" id="gwStatus" style="color:var(--green)">—</div></div>
    </div>
  </div>
</div>

<!-- ── Panel: Health ── -->
<div class="panel" id="panel-health">
  <div class="page-header">
    <div class="page-title">System Health</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadDoctor()">Re-check</button></div>
  </div>
  <div class="stat-grid" id="healthStats" style="margin-bottom:16px">
    <div class="stat-card"><div class="stat-value" id="hGateway" style="color:var(--green)">—</div><div class="stat-label">Gateway</div></div>
    <div class="stat-card"><div class="stat-value" id="hUptime">—</div><div class="stat-label">Uptime</div></div>
    <div class="stat-card"><div class="stat-value" id="hPort">—</div><div class="stat-label">Port</div></div>
    <div class="stat-card"><div class="stat-value" id="hAgents">—</div><div class="stat-label">Agents</div></div>
  </div>
  <div class="card">
    <div class="card-title">Diagnostic Checks</div>
    <ul class="checks" id="healthChecks"><li class="empty">Running checks…</li></ul>
  </div>
</div>

<!-- ── Panel: Logs ── -->
<div class="panel" id="panel-logs">
  <div class="page-header"><div class="page-title">Logs</div></div>
  <div class="logs-controls">
    <select class="input" id="logAgentSelect" onchange="loadLogs()" style="width:160px">
      <option value="">Select agent…</option>
    </select>
    <input class="input" type="text" id="logSearch" placeholder="Search…" style="width:180px" oninput="loadLogs()">
    <div class="log-levels">
      <div class="log-level-btn active" data-level="" onclick="setLogLevel(this)">All</div>
      <div class="log-level-btn" data-level="INFO" onclick="setLogLevel(this)">Info</div>
      <div class="log-level-btn" data-level="WARNING" onclick="setLogLevel(this)">Warn</div>
      <div class="log-level-btn" data-level="ERROR" onclick="setLogLevel(this)">Error</div>
    </div>
    <label class="auto-refresh-toggle">
      <input type="checkbox" id="logAutoRefresh" onchange="toggleLogAutoRefresh()"> Auto-refresh
    </label>
  </div>
  <div class="log-content" id="logContent">Select an agent to view logs</div>
</div>

<!-- ── Panel: Chain ── -->
<div class="panel" id="panel-chain">
  <div class="page-header">
    <div class="page-title">On-Chain Identity</div>
    <div class="page-actions"><button class="btn btn-sm" onclick="loadChain()">Refresh</button></div>
  </div>

  <div class="stats" id="chainStats" style="margin-bottom:18px">
    <div class="stat"><div class="stat-value cyan" id="chainNetwork">—</div><div class="stat-label">Network</div></div>
    <div class="stat"><div class="stat-value" id="chainLitNet">—</div><div class="stat-label">Lit Network</div></div>
    <div class="stat"><div class="stat-value green" id="chainAgents">—</div><div class="stat-label">Registered</div></div>
    <div class="stat"><div class="stat-value" id="chainX402">—</div><div class="stat-label">X402</div></div>
  </div>

  <div class="card">
    <div class="card-title">Agent Identities</div>
    <table class="data-table">
      <thead><tr>
        <th>Agent</th><th>Status</th><th>PKP Address</th><th>Chain ID</th><th>Balance</th><th></th>
      </tr></thead>
      <tbody id="chainAgentsBody"><tr><td colspan="6" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-title">Recent Transactions</div>
    <div id="chainTxList" style="font-size:12px;color:var(--fg2)">Loading…</div>
  </div>
</div>

<!-- ── Panel: Memory ── -->
<div class="panel" id="panel-memory">
  <div class="page-header">
    <div class="page-title">Agent Memory</div>
    <div class="page-actions"><button class="btn" onclick="loadMemory()">Refresh</button></div>
  </div>

  <div class="stat-grid" id="memStats" style="margin-bottom:18px">
    <div class="stat-card"><div class="stat-value" id="memEpisodes">—</div><div class="stat-label">Episodes</div></div>
    <div class="stat-card"><div class="stat-value" id="memCases">—</div><div class="stat-label">Cases</div></div>
    <div class="stat-card"><div class="stat-value" id="memPatterns">—</div><div class="stat-label">Patterns</div></div>
    <div class="stat-card"><div class="stat-value" id="memNotes">—</div><div class="stat-label">KB Notes</div></div>
  </div>

  <!-- Per-Agent Memory -->
  <div class="card">
    <div class="card-title">Per-Agent Memory</div>
    <table class="data-table">
      <thead><tr>
        <th>Agent</th><th>Episodes</th><th>Cases</th><th>Patterns</th><th>Daily Logs</th>
      </tr></thead>
      <tbody id="memAgentsBody"><tr><td colspan="5" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>

  <!-- Knowledge Base Notes -->
  <div class="card" style="margin-top:16px">
    <div class="card-title">Shared Knowledge Base</div>
    <div id="memKBList" style="font-family:var(--mono);font-size:12px;color:var(--fg2)">Loading…</div>
  </div>

  <!-- Recent Insights -->
  <div class="card" style="margin-top:16px">
    <div class="card-title">Cross-Agent Insights</div>
    <div id="memInsightsList" style="font-family:var(--mono);font-size:12px;color:var(--fg2)">Loading…</div>
  </div>
</div>

<!-- ═══════════════ Cron Jobs Panel ═══════════════ -->
<div class="panel" id="panel-cron">
  <div class="page-header">
    <div class="page-title">Cron Jobs</div>
    <div class="page-actions"><button class="btn" onclick="showNewCronModal()">+ New Job</button> <button class="btn" onclick="loadCron()">Refresh</button></div>
  </div>

  <div class="stat-grid" id="cronStats" style="margin-bottom:18px">
    <div class="stat-card"><div class="stat-value" id="cronTotal">—</div><div class="stat-label">Total Jobs</div></div>
    <div class="stat-card"><div class="stat-value" id="cronActive">—</div><div class="stat-label">Active</div></div>
    <div class="stat-card"><div class="stat-value" id="cronRuns">—</div><div class="stat-label">Total Runs</div></div>
  </div>

  <div class="card">
    <div class="card-title">Scheduled Jobs</div>
    <table class="data-table">
      <thead><tr>
        <th>Name</th><th>Action</th><th>Schedule</th><th>Last Run</th><th>Runs</th><th>Enabled</th><th>Actions</th>
      </tr></thead>
      <tbody id="cronJobsBody"><tr><td colspan="7" class="empty">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

</main>
</div><!-- .app -->

<!-- ═══════════════ Create Skill Dialog ═══════════════ -->
<div class="dialog-overlay" id="createDialog" style="display:none" onclick="if(event.target===this)closeCreateDialog()">
  <div class="dialog">
    <div class="dialog-title">Create New Skill</div>
    <div class="field">
      <label>Skill Name</label>
      <input class="input" id="newSkillName" placeholder="e.g. planning, code-review">
    </div>
    <div class="field">
      <label>Scope</label>
      <select class="input" id="newSkillScope">
        <option value="shared">Shared (all agents)</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn btn-outline" onclick="closeCreateDialog()">Cancel</button>
      <button class="btn" onclick="createSkill()">Create</button>
    </div>
  </div>
</div>

<script>
/* ══════════════════════════════════════════════════════════════════
   Cleo Dashboard — Vanilla JS
   ══════════════════════════════════════════════════════════════════ */

const API = '';  // same origin

// Migrate legacy 'swarm_token' → 'cleo_token' (one-time, non-destructive)
if (!localStorage.getItem('cleo_token') && localStorage.getItem('swarm_token')) {
  localStorage.setItem('cleo_token', localStorage.getItem('swarm_token'));
}

// Auto-login: prefer server-injected token > URL param > localStorage
let TOKEN = (function() {
  // 1. Token injected by gateway into <head> — highest priority
  if (window.__CLEO_TOKEN__) {
    localStorage.setItem('cleo_token', window.__CLEO_TOKEN__);
    return window.__CLEO_TOKEN__;
  }
  // 2. URL param (?token=xxx)
  const p = new URLSearchParams(window.location.search);
  const t = p.get('token');
  if (t) {
    localStorage.setItem('cleo_token', t);
    history.replaceState(null, '', window.location.pathname);
    return t;
  }
  // 3. localStorage fallback
  return localStorage.getItem('cleo_token') || '';
})();

// ── State ───────────────────────────────────────────────────────
let currentPanel = 'overview';
let editingAgent = null;
let currentSkill = null;
let skillsDirty = false;
let skillsData = null;
let cfData = null;           // Cleo Files list cache
let currentCfFile = null;    // Currently editing: {scope, name, content}
let cfDirty = false;         // Unsaved changes flag
let logLevel = '';
let logAutoRefreshTimer = null;
let expandedTaskId = null;
let allTasks = {};
let heartbeatData = {};  // {agent_id: {online, status, task_id, ...}}

// ── Chat state (Overview panel) ──
let chatMsgs = [];              // {id, type:'user'|'agent'|'system', agent, text, ts, taskId}
let chatPrevSnapshot = {};      // previous polling snapshot for diff
let chatTaskMap = {};           // taskId → Set of generated message types (dedup)
let chatMsgCounter = 0;        // unique msg id counter

// ══════════════════════════════════════════════════════════════════
//  AUTH & API HELPERS
// ══════════════════════════════════════════════════════════════════

function authHeaders() {
  const h = {'Content-Type':'application/json'};
  if (TOKEN) h['Authorization'] = 'Bearer ' + TOKEN;
  return h;
}

async function api(path) {
  try {
    const r = await fetch(API + path, {headers: authHeaders()});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return api(path); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

async function apiPost(path, body) {
  try {
    const r = await fetch(API + path, {method:'POST', headers: authHeaders(), body: JSON.stringify(body)});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return apiPost(path, body); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

async function apiPut(path, body) {
  try {
    const r = await fetch(API + path, {method:'PUT', headers: authHeaders(), body: JSON.stringify(body)});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return apiPut(path, body); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

async function apiDelete(path) {
  try {
    const r = await fetch(API + path, {method:'DELETE', headers: authHeaders()});
    if (r.status === 401) {
      const t = prompt('Enter Gateway token:');
      if (t) { TOKEN = t; localStorage.setItem('cleo_token', t); return apiDelete(path); }
      return null;
    }
    return await r.json();
  } catch(e) { return null; }
}

// ══════════════════════════════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════════════════════════════

function fmtTime(s) {
  if (!s || s <= 0) return '—';
  if (s < 60) return s.toFixed(1) + 's';
  const m = Math.floor(s/60), sec = Math.floor(s%60);
  if (m < 60) return m + 'm' + String(sec).padStart(2,'0') + 's';
  const h = Math.floor(m/60), rm = m%60;
  return h + 'h' + String(rm).padStart(2,'0') + 'm';
}
function fmtNum(n) { return n != null ? n.toLocaleString() : '0'; }
function truncate(s, n) { return s && s.length > n ? s.slice(0,n-1)+'…' : (s||''); }
function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function titleCase(s) { return (s||'').replace(/\b\w/g, c => c.toUpperCase()); }
function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

function showToast(msg, type) {
  const el = document.createElement('div');
  const bg = type === 'error' ? 'var(--red)' : type === 'success' ? 'var(--green)' : 'var(--accent)';
  el.style.cssText = 'position:fixed;bottom:24px;right:24px;padding:10px 18px;border-radius:8px;font-size:13px;color:#fff;z-index:10000;background:' + bg + ';box-shadow:0 4px 12px rgba(0,0,0,.3);transition:opacity .3s';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
}

function statusIcon(status) {
  switch(status) {
    case 'claimed': return '<span class="status-icon status-working">●</span>';
    case 'completed': return '<span class="status-icon status-done">✓</span>';
    case 'failed': return '<span class="status-icon status-failed">✗</span>';
    case 'review': return '<span class="status-icon status-review">◆</span>';
    case 'critique': return '<span class="status-icon status-critique">⚠</span>';
    default: return '<span class="status-icon status-pending">○</span>';
  }
}

function parseError(flags) {
  for (const f of (flags||[])) {
    if (!f.startsWith('failed:')) continue;
    const err = f.slice(7);
    if (err.includes('401')) return 'API Key Invalid (401)';
    if (err.includes('403')) return 'Permission Denied (403)';
    if (err.includes('429')) return 'Rate Limited (429)';
    if (/timeout|timed out/i.test(err)) return 'Request Timeout';
    if (/connect/i.test(err)) return 'Connection Failed';
    return truncate(err.split('\n')[0], 60);
  }
  return '';
}

function classifyError(err) {
  if (!err) return null;
  if (err.includes('401')) return {label:'API Key', color:'var(--red)'};
  if (err.includes('429')) return {label:'Rate Limit', color:'var(--orange)'};
  if (/timeout/i.test(err)) return {label:'Timeout', color:'var(--yellow)'};
  if (/connect/i.test(err)) return {label:'Connection', color:'var(--magenta)'};
  return {label:'Error', color:'var(--red)'};
}

function scoreColor(score) {
  if (score >= 80) return 'var(--green)';
  if (score >= 60) return 'var(--yellow)';
  if (score >= 40) return 'var(--orange)';
  return 'var(--red)';
}

function toast(msg, type='success') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
}

// ══════════════════════════════════════════════════════════════════
//  SIDEBAR NAVIGATION
// ══════════════════════════════════════════════════════════════════

function switchPanel(name) {
  currentPanel = name;
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.panel === name);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const p = document.getElementById('panel-' + name);
  if (p) p.classList.add('active');

  // Load data for panel
  if (name === 'agents') loadAgents();
  if (name === 'skills') loadSkills();
  if (name === 'cleo-files') loadCfFiles();
  if (name === 'tools') loadTools();
  if (name === 'usage') loadUsage();
  if (name === 'config') loadConfig();
  if (name === 'gateway') loadGatewayInfo();
  if (name === 'health') loadDoctor();
  if (name === 'logs') initLogs();
  if (name === 'chain') loadChain();
  if (name === 'memory') loadMemory();
  if (name === 'channels') loadChannels();
  if (name === 'cron') loadCron();
}

// ══════════════════════════════════════════════════════════════════
//  HEALTH POLLING
// ══════════════════════════════════════════════════════════════════

async function pollHealth() {
  const [data, hbData] = await Promise.all([api('/health'), api('/v1/heartbeat')]);
  const dot = document.getElementById('statusDot');
  if (data && data.status === 'ok') {
    dot.className = 'status-dot online';
    const onlineCount = hbData?.online || 0;
    const totalCount = data.agents || 0;
    document.getElementById('footerAgents').textContent = onlineCount + '/' + totalCount + ' agents online';
    document.getElementById('footerUptime').textContent = 'uptime ' + fmtTime(data.uptime_seconds);
    document.getElementById('footerPort').textContent = ':' + (data.port || 19789);
  } else {
    dot.className = 'status-dot offline';
  }
  // Cache heartbeat data for agent cards
  if (hbData && hbData.agents) {
    heartbeatData = {};
    for (const hb of hbData.agents) {
      heartbeatData[hb.agent_id] = hb;
    }
    // Update agent card status dots if panel is visible
    updateAgentStatusDots();
  }
}

function updateAgentStatusDots() {
  document.querySelectorAll('.agent-card .hb-dot').forEach(dot => {
    const aid = dot.dataset.agentId;
    const hb = heartbeatData[aid];
    if (hb && hb.online) {
      dot.className = 'hb-dot online';
      dot.title = hb.status === 'working' ? 'Working on: ' + (hb.task_id||'') : 'Idle';
    } else {
      dot.className = 'hb-dot offline';
      dot.title = 'Offline';
    }
  });
}

// ══════════════════════════════════════════════════════════════════
//  OVERVIEW — Dual Panel (Orchestration + ChatBox)
// ══════════════════════════════════════════════════════════════════

const AGENT_META = {
  leo:      {emoji:'📋', color:'var(--accent)',  cls:'leo',    label:'Leo',   avatar:'/avatars/leo.png'},
  jerry:    {emoji:'⚙️', color:'var(--cyan)',    cls:'jerry',  label:'Jerry', avatar:'/avatars/jerry.png'},
  alic:     {emoji:'🧠', color:'var(--magenta)', cls:'alic',   label:'Alic',  avatar:'/avatars/alic.png'},
  search:   {emoji:'🌐', color:'var(--accent)',  cls:'leo',    label:'Search'},
};

function agentMeta(agentId) {
  const id = (agentId||'').toLowerCase();
  const m = AGENT_META[id] || {emoji:'🤖', color:'var(--fg2)', cls:'jerry'};
  m.icon = m.emoji;
  return m;
}
function avatarHtml(meta, size) {
  size = size || 28;
  if (meta.avatar) return '<img src="'+meta.avatar+'" style="width:'+size+'px;height:'+size+'px;border-radius:50%;object-fit:cover;flex-shrink:0">';
  return '<span style="font-size:'+(size*0.5)+'px">'+meta.emoji+'</span>';
}

// ── State ──
let chatAttachments = [];
let searchMode = false;
let chatLastRenderedIdx = 0;
let recentUsageCalls = [];
let liveStatusAgents = {};
let dispatchEntries = [];   // top panel log entries
let dispatchLastIdx = 0;

// ══════════════════════════════════════════════════════════════════
//  DUAL PANEL — Top: Dispatch Log  |  Bottom: ChatBox
// ══════════════════════════════════════════════════════════════════
// Top panel (#dispatchLog):  all agent orchestration — scheduling,
//   claimed, working, intermediate I/O, review scores, tokens, live status
// Bottom panel (#chatMessages): user messages + final completed results
//   styled like ChatGPT / Claude — only the polished end product

// ── Add entry to TOP dispatch log ──
function addDispatch(icon, agentId, text, opts={}) {
  const meta = agentMeta(agentId);
  dispatchEntries.push({
    id: ++chatMsgCounter,
    icon: icon || '•',
    agent: agentId,
    agentCls: meta.cls,
    text,
    ts: Date.now(),
    taskId: opts.taskId || null,
    promptTokens: opts.promptTokens || null,
    completionTokens: opts.completionTokens || null,
    result: opts.result || null,
    score: opts.score || null,
    scoreComment: opts.scoreComment || null,
  });
}

// ── Add message to BOTTOM chatbox (user msgs + final AI results) ──
function addChatMsg(type, text, opts={}) {
  const msg = {
    id: ++chatMsgCounter,
    type, // 'user' | 'assistant' | 'system'
    agent: opts.agent || null,
    text,
    ts: Date.now(),
    taskId: opts.taskId || null,
    result: opts.result || null,
    score: opts.score || null,
    scoreComment: opts.scoreComment || null,
    images: opts.images || null,
    files: opts.files || null,
    searchResults: opts.searchResults || null,
    promptTokens: opts.promptTokens || null,
    completionTokens: opts.completionTokens || null,
  };
  chatMsgs.push(msg);
  return msg;
}

// ── Render a single dispatch entry (compact one-line, top panel) ──
function renderDispatchHtml(d) {
  let tokHtml = '';
  if (d.promptTokens || d.completionTokens) {
    tokHtml = '<span class="dispatch-tokens"><span class="tok-in">↑' + fmtNum(d.promptTokens||0)
      + '</span>/<span class="tok-out">↓' + fmtNum(d.completionTokens||0) + '</span></span>';
  }
  let text = escHtml(truncate(d.text, 120));
  // Expandable result for agent output in dispatch
  if (d.result) {
    const rid = 'dRes' + d.id;
    text += ' <span class="chat-result-toggle" onclick="toggleChatResult(\'' + rid + '\',this)" style="font-size:10px">▸ detail</span>'
      + '<div class="chat-result-content" id="' + rid + '" style="margin-top:3px"><pre style="font-size:10px;max-height:160px;overflow-y:auto;margin:0;padding:4px 6px">' + escHtml(d.result) + '</pre></div>';
  }
  if (d.score != null) {
    const c = scoreColor(d.score);
    text += ' <span style="font-size:10px;font-weight:700;color:' + c + '">' + d.score + '/100</span>';
    if (d.scoreComment) text += ' <span style="font-size:10px;color:var(--fg3)">' + escHtml(truncate(d.scoreComment, 60)) + '</span>';
  }
  const elapsed = ((Date.now() - d.ts) / 1000)|0;
  const timeStr = elapsed < 5 ? 'now' : elapsed < 60 ? elapsed + 's' : Math.floor(elapsed/60) + 'm';
  const dMeta = agentMeta(d.agent || '');
  const dAvIcon = dMeta.avatar ? '<img src="'+dMeta.avatar+'" style="width:14px;height:14px;border-radius:50%;object-fit:cover;vertical-align:middle">' : d.icon;
  return '<div class="dispatch-entry" data-d-id="' + d.id + '">'
    + '<span class="dispatch-icon">' + dAvIcon + '</span>'
    + '<span class="dispatch-agent ' + d.agentCls + '-d">' + escHtml(capitalize(d.agent || 'system')) + '</span>'
    + '<span class="dispatch-text">' + text + '</span>'
    + tokHtml
    + '<span class="dispatch-time">' + timeStr + '</span>'
    + '</div>';
}

// ── Incremental render for dispatch log (top panel) ──
function renderDispatch() {
  const container = document.getElementById('dispatchLog');
  if (container) {
    const newEntries = dispatchEntries.slice(dispatchLastIdx);
    if (newEntries.length) {
      const frag = document.createDocumentFragment();
      for (const d of newEntries) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = renderDispatchHtml(d);
        while (wrapper.firstChild) frag.appendChild(wrapper.firstChild);
      }
      container.appendChild(frag);
      container.scrollTop = container.scrollHeight;
    }
  }
  dispatchLastIdx = dispatchEntries.length;
  // Update header bar with latest 3 statuses
  updateHeaderStatuses();
}

function updateHeaderStatuses() {
  const el = document.getElementById('ovStatuses');
  if (!el) return;
  const latest = dispatchEntries.slice(-3);
  if (!latest.length) {
    el.innerHTML = '<span class="ov-status-empty">Ready — Submit a task to start</span>';
    return;
  }
  let html = '';
  for (const d of latest.reverse()) {
    const agentCls = d.agent ? d.agent.toLowerCase().replace(/[^a-z]/g,'') : '';
    const colorCls = agentCls.includes('leo') ? 'leo-d' : agentCls.includes('jerry') ? 'jerry-d' : agentCls.includes('alic') ? 'alic-d' : '';
    const sMeta = agentMeta(d.agent || '');
    const sIcon = sMeta.avatar ? '<img src="'+sMeta.avatar+'">' : '▸';
    const agentName = capitalize(d.agent || 'system');
    const statusText = titleCase(truncate(d.text || '', 30));
    html += '<div class="ov-status-item">'
      + '<span class="status-icon">' + sIcon + '</span>'
      + '<span class="status-agent ' + colorCls + '">' + escHtml(agentName) + '</span>'
      + '<span class="status-text">' + escHtml(statusText) + '</span>'
      + '</div>';
  }
  el.innerHTML = html;
}

// ── Render a single chat message (bottom panel, ChatGPT-style) ──
function renderChatMsgHtml(m) {
  if (m.type === 'user') {
    let content = escHtml(m.text);
    if (m.images && m.images.length) {
      content += '<div class="chat-images">';
      for (const img of m.images) content += '<img src="' + img.dataUrl + '" alt="' + escHtml(img.name) + '" onclick="window.open(this.src)">';
      content += '</div>';
    }
    if (m.files && m.files.length) {
      for (const f of m.files) content += '<div class="chat-file-badge">📄 ' + escHtml(f.name) + '</div>';
    }
    return '<div class="chat-msg user" data-msg-id="' + m.id + '">'
      + '<div class="chat-avatar user-av">👤</div>'
      + '<div class="chat-bubble user-bubble">' + content + '</div></div>';
  }
  if (m.type === 'system') {
    return '<div class="chat-msg system" data-msg-id="' + m.id + '">'
      + '<div class="chat-bubble system-bubble">' + escHtml(m.text) + '</div></div>';
  }
  // ── Assistant response (final result, like Claude/ChatGPT) ──
  if (m.type === 'assistant') {
    const resultText = m.result || m.text || '';
    // Format the result nicely
    let bodyHtml = formatResultBody(resultText);
    // Critique / Score line
    let scoreHtml = '';
    if (m.critique) {
      const cr = m.critique;
      if (cr.passed) {
        scoreHtml = '<div style="margin-top:8px"><span class="chat-score" style="background:rgba(34,197,94,.12);color:var(--green)">✓ Approved</span>';
        if (cr.comment) scoreHtml += ' <span style="font-size:11px;color:var(--fg2)">' + escHtml(truncate(cr.comment, 120)) + '</span>';
        scoreHtml += '</div>';
      } else {
        scoreHtml = '<div style="margin-top:8px"><span class="chat-score" style="background:rgba(239,68,68,.12);color:var(--red)">⚠ Revised</span>';
        if (cr.comment) scoreHtml += ' <span style="font-size:11px;color:var(--fg2)">' + escHtml(truncate(cr.comment, 120)) + '</span>';
        if (cr.suggestions && cr.suggestions.length) {
          scoreHtml += '<ul style="margin:4px 0 0 16px;font-size:11px;color:var(--fg2)">';
          for (const s of cr.suggestions) scoreHtml += '<li>' + escHtml(s) + '</li>';
          scoreHtml += '</ul>';
        }
        scoreHtml += '</div>';
      }
    } else if (m.score != null) {
      const c = scoreColor(m.score);
      scoreHtml = '<div style="margin-top:8px"><span class="chat-score" style="background:rgba(55,115,255,.1);color:' + c + '">'
        + m.score + '/100</span>';
      if (m.scoreComment) scoreHtml += ' <span style="font-size:11px;color:var(--fg2)">' + escHtml(truncate(m.scoreComment, 120)) + '</span>';
      scoreHtml += '</div>';
    }
    // Search results
    let searchHtml = '';
    if (m.searchResults && m.searchResults.length) {
      searchHtml = '<div class="chat-search-results" style="margin-top:8px">';
      for (const sr of m.searchResults) {
        searchHtml += '<div class="chat-search-card"><a href="' + escHtml(sr.url) + '" target="_blank">' + escHtml(sr.title) + '</a>';
        if (sr.snippet) searchHtml += '<div class="search-snippet">' + escHtml(truncate(sr.snippet, 120)) + '</div>';
        searchHtml += '</div>';
      }
      searchHtml += '</div>';
    }
    // Token footer
    let tokenHtml = '';
    if (m.promptTokens || m.completionTokens) {
      tokenHtml = '<div class="asst-tokens">'
        + '<span>↑ ' + fmtNum(m.promptTokens||0) + ' in</span>'
        + '<span>↓ ' + fmtNum(m.completionTokens||0) + ' out</span>'
        + '</div>';
    }
    const aM = agentMeta(m.agent || '');
    const agentLabel = capitalize(m.agent) || 'Cleo';
    const avatarContent = avatarHtml(aM, 28);
    const avatarBg = m.agent ? aM.color : 'linear-gradient(135deg,var(--accent),var(--cyan))';
    return '<div class="chat-msg assistant" data-msg-id="' + m.id + '">'
      + '<div class="chat-avatar ' + aM.cls + '">' + avatarContent + '</div>'
      + '<div class="chat-bubble assistant-bubble">'
      + '<div class="asst-header"><span class="asst-label" style="color:' + aM.color + '">' + escHtml(agentLabel) + '</span></div>'
      + '<div class="asst-body">' + bodyHtml + '</div>'
      + scoreHtml + searchHtml + tokenHtml
      + '</div></div>';
  }
  return '';
}

// Format result text into nice readable HTML — lightweight markdown renderer
function stripLlmTags(text) {
  // Strip <think>...</think> blocks (complete)
  text = text.replace(/<think>[\s\S]*?<\/think>/g, '');
  // Strip <think> without closing tag (streaming — still thinking)
  text = text.replace(/<think>[\s\S]*$/g, '');
  // Strip <tool_code>...</tool_code> blocks (complete)
  text = text.replace(/<tool_code>[\s\S]*?<\/tool_code>/g, '');
  // Strip <tool_code> without closing tag (streaming — tool being written)
  text = text.replace(/<tool_code>[\s\S]*$/g, '');
  // Strip other common LLM tags (open or closed)
  text = text.replace(/<tool_call>[\s\S]*?(<\/tool_call>|$)/g, '');
  text = text.replace(/<function_calls>[\s\S]*?(<\/function_calls>|$)/g, '');
  text = text.replace(/<tool_result>[\s\S]*?(<\/tool_result>|$)/g, '');
  // Strip Minimax-specific tool call XML (complete or streaming)
  text = text.replace(/<minimax:tool_call>[\s\S]*?(<\/minimax:tool_call>|$)/g, '');
  // Strip generic XML tool patterns: <invoke>, <parameter>, <tool_use>
  text = text.replace(/<invoke[\s\S]*?(<\/invoke>|$)/g, '');
  text = text.replace(/<parameter[\s\S]*?(<\/parameter>|$)/g, '');
  text = text.replace(/<tool_use[\s\S]*?(<\/tool_use>|$)/g, '');
  // Strip raw JSON tool objects that leak through ({"tool": "...", "params": ...})
  text = text.replace(/^\s*\{"tool"\s*:\s*"[^"]*"[\s\S]*$/gm, '');
  // Strip orchestration artifacts (TASK:, COMPLEXITY:, Phase headers)
  text = text.replace(/^TASK:\s*.+$/gm, '');
  text = text.replace(/^COMPLEXITY:\s*.+$/gm, '');
  text = text.replace(/^##\s*Phase\s+\d+.*$/gm, '');
  text = text.replace(/^\*\*TASK:\*\*\s*.+$/gm, '');
  text = text.replace(/^\*\*COMPLEXITY:\*\*\s*.+$/gm, '');
  // Strip --- separator lines (orchestration artifacts)
  text = text.replace(/^---\s*$/gm, '');
  // Clean up excessive blank lines left after stripping
  text = text.replace(/\n{3,}/g, '\n\n');
  return text.trim();
}

function _buildResultStepsHtml(rawText) {
  // Build Claude-style process steps for completed results
  const steps = [];
  const thinkBlocks = rawText.match(/<think>[\s\S]*?<\/think>/g);
  if (thinkBlocks) steps.push({icon:'💭', label:'Thought', count:thinkBlocks.length});
  // Standard <tool_code> JSON format
  const toolBlocks = rawText.match(/<tool_code>[\s\S]*?<\/tool_code>/g);
  if (toolBlocks) {
    for (const tc of toolBlocks) {
      let label = 'Used Tool';
      try { const obj = JSON.parse(tc.replace(/<\/?tool_code>/g,'')); if(obj.tool) label='Used '+titleCase(obj.tool.replace(/[_-]/g,' ')); } catch(e){}
      steps.push({icon:'✓', label});
    }
  }
  // Minimax <minimax:tool_call> XML format
  const mmBlocks = rawText.match(/<minimax:tool_call>[\s\S]*?<\/minimax:tool_call>/g);
  if (mmBlocks) {
    for (const mc of mmBlocks) {
      let label = 'Used Tool';
      const nameMatch = mc.match(/<invoke\s+name="([^"]+)"/);
      if (nameMatch) label = 'Used ' + titleCase(nameMatch[1].replace(/[_-]/g, ' '));
      steps.push({icon:'✓', label});
    }
  }
  if (!steps.length) return '';
  let html = '<div class="stream-steps" style="margin-bottom:10px">';
  for (const s of steps) {
    html += '<div class="stream-step step-done"><span class="step-icon">'+s.icon+'</span><span class="step-label">'+escHtml(s.label)+'</span></div>';
  }
  html += '</div>';
  return html;
}

function formatResultBody(text) {
  if (!text) return '';
  const rawText = text;
  // Strip LLM artifacts before rendering
  text = stripLlmTags(text);
  const stepsHtml = _buildResultStepsHtml(rawText);
  if (!text) {
    // Entire output was tool calls / thinking — show steps + friendly status
    if (rawText.includes('<tool_code>') || rawText.includes('{"tool"') || rawText.includes('<minimax:tool_call>'))
      return stepsHtml + '<span style="color:var(--fg2)">✓ Done — results sent to planner for synthesis.</span>';
    return '<span style="color:var(--fg2)">✓ Completed</span>';
  }
  // Try JSON pretty-print
  try {
    const obj = JSON.parse(text);
    return '<pre>' + escHtml(JSON.stringify(obj, null, 2)) + '</pre>';
  } catch(e) {}
  // Render markdown then enhance with file/image detection
  let html = renderMarkdown(text);
  // Detect file paths in the rendered output and make them actionable
  html = enhanceFilePaths(html, text);
  return stepsHtml + html;
}

function enhanceFilePaths(html, rawText) {
  // Detect file paths mentioned in the raw text (before HTML rendering)
  const filePattern = /(?:^|\s)(\/[\w\-\.\/]+\.(pdf|png|jpg|jpeg|gif|csv|xlsx|json|txt|md|py|js|html|svg))(?:\s|$|[,;])/gi;
  const matches = [...new Set((rawText.match(filePattern) || []).map(m => m.trim().replace(/[,;]$/, '')))];
  if (!matches.length) return html;

  // Add file cards at the end
  let fileCards = '<div class="chat-file-cards" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px">';
  for (const fpath of matches) {
    const fname = fpath.split('/').pop();
    const ext = fname.split('.').pop().toLowerCase();
    const isImage = ['png','jpg','jpeg','gif','svg','webp'].includes(ext);
    const isPdf = ext === 'pdf';
    const isData = ['csv','xlsx','json'].includes(ext);
    const icon = isImage ? '🖼️' : isPdf ? '📄' : isData ? '📊' : '📎';
    const downloadUrl = '/v1/file?path=' + encodeURIComponent(fpath);
    fileCards += '<a class="chat-file-card" href="' + downloadUrl + '" target="_blank" rel="noopener" title="' + escHtml(fpath) + '">'
      + '<span class="file-icon">' + icon + '</span>'
      + '<span class="file-info"><span class="file-name">' + escHtml(fname) + '</span>'
      + '<span class="file-path">' + escHtml(fpath) + '</span></span>'
      + '</a>';
  }
  fileCards += '</div>';
  return html + fileCards;
}

function renderMarkdown(src) {
  // 1) Extract fenced code blocks (protect from processing)
  const codeBlocks = [];
  let _cbId = 0;
  let s = src.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    const i = codeBlocks.length;
    const cbid = 'cb_' + (++_cbId) + '_' + Date.now();
    const langLabel = lang || 'code';
    const header = '<div class="code-block-header"><span class="code-lang">' + escHtml(langLabel) + '</span>'
      + '<button class="code-copy-btn" onclick="copyCodeBlock(this,\'' + cbid + '\')" title="Copy">Copy</button></div>';
    codeBlocks.push(header + '<pre id="' + cbid + '"><code' + (lang ? ' class="lang-'+escHtml(lang)+'"' : '') + '>' + escHtml(code.trimEnd()) + '</code></pre>');
    return '\x00CB' + i + '\x00';
  });

  const lines = s.split('\n');
  let html = '';
  let inList = false, listType = '';
  let i = 0;

  function closeList() { if (inList) { html += '</' + listType + '>'; inList = false; } }

  while (i < lines.length) {
    let line = lines[i];

    // Code block placeholder
    const cbMatch = line.match(/^\x00CB(\d+)\x00$/);
    if (cbMatch) { closeList(); html += codeBlocks[parseInt(cbMatch[1])]; i++; continue; }

    // Table: detect header row + separator row (| --- | --- |)
    if (line.trim().startsWith('|') && i + 1 < lines.length && /^\|[\s:]*-{2,}[\s:]*(\|[\s:]*-{2,}[\s:]*)*\|?\s*$/.test(lines[i+1])) {
      closeList();
      const parseRow = (r) => r.replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim());
      // Parse alignment from separator
      const sepCols = parseRow(lines[i+1]);
      const aligns = sepCols.map(c => {
        if (c.startsWith(':') && c.endsWith(':')) return 'center';
        if (c.endsWith(':')) return 'right';
        return 'left';
      });
      const hdrCols = parseRow(line);
      html += '<table><thead><tr>';
      for (let c = 0; c < hdrCols.length; c++) {
        const a = aligns[c] || 'left';
        html += '<th style="text-align:' + a + '">' + inlineFmt(hdrCols[c]) + '</th>';
      }
      html += '</tr></thead><tbody>';
      i += 2; // skip header + separator
      while (i < lines.length && lines[i].trim().startsWith('|')) {
        const cols = parseRow(lines[i]);
        html += '<tr>';
        for (let c = 0; c < cols.length; c++) {
          const a = aligns[c] || 'left';
          html += '<td style="text-align:' + a + '">' + inlineFmt(cols[c]) + '</td>';
        }
        html += '</tr>';
        i++;
      }
      html += '</tbody></table>';
      continue;
    }

    // Headers h1-h6
    const hMatch = line.match(/^(#{1,6})\s+(.+)$/);
    if (hMatch) { closeList(); const lvl = hMatch[1].length; html += '<h' + lvl + '>' + inlineFmt(hMatch[2]) + '</h' + lvl + '>'; i++; continue; }

    // Task list (checkbox)
    const taskMatch = line.match(/^[\s]*[-*]\s+\[([ xX])\]\s+(.+)$/);
    if (taskMatch) {
      if (!inList || listType !== 'ul') { closeList(); html += '<ul style="list-style:none;padding-left:4px">'; inList = true; listType = 'ul'; }
      const checked = taskMatch[1] !== ' ';
      const icon = checked ? '<span style="color:var(--green);margin-right:6px">☑</span>' : '<span style="color:var(--fg3);margin-right:6px">☐</span>';
      html += '<li style="display:flex;align-items:flex-start;gap:0">' + icon + '<span' + (checked?' style="color:var(--fg3);text-decoration:line-through"':'') + '>' + inlineFmt(taskMatch[2]) + '</span></li>';
      i++; continue;
    }

    // Unordered list
    const ulMatch = line.match(/^[\s]*[-*]\s+(.+)$/);
    if (ulMatch) {
      if (!inList || listType !== 'ul') { closeList(); html += '<ul>'; inList = true; listType = 'ul'; }
      html += '<li>' + inlineFmt(ulMatch[1]) + '</li>'; i++; continue;
    }

    // Ordered list
    const olMatch = line.match(/^[\s]*(\d+)[.)]\s+(.+)$/);
    if (olMatch) {
      if (!inList || listType !== 'ol') { closeList(); html += '<ol>'; inList = true; listType = 'ol'; }
      html += '<li>' + inlineFmt(olMatch[2]) + '</li>'; i++; continue;
    }

    // Non-list line closes any open list
    if (inList) closeList();

    // Horizontal rule
    if (/^[-*_]{3,}\s*$/.test(line.trim())) { html += '<hr>'; i++; continue; }

    // Blockquote (multi-line)
    const bqMatch = line.match(/^>\s?(.*)$/);
    if (bqMatch) {
      let bqContent = inlineFmt(bqMatch[1]);
      while (i + 1 < lines.length && /^>\s?/.test(lines[i + 1])) {
        i++;
        bqContent += '<br>' + inlineFmt(lines[i].replace(/^>\s?/, ''));
      }
      html += '<blockquote>' + bqContent + '</blockquote>';
      i++; continue;
    }

    // Empty line
    if (line.trim() === '') { i++; continue; }

    // Normal paragraph
    html += '<p>' + inlineFmt(line) + '</p>';
    i++;
  }
  closeList();
  return html;
}

function inlineFmt(s) {
  s = escHtml(s);
  // images: ![alt](url)
  s = s.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" class="md-img" loading="lazy">');
  // links: [text](url)
  s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  // bold+italic
  s = s.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  // bold
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // italic
  s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // strikethrough
  s = s.replace(/~~(.+?)~~/g, '<del>$1</del>');
  // inline code
  s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
  // bare URLs → clickable links (only if not already in an href or src)
  s = s.replace(/(?<!="|=')((https?:\/\/)[^\s<"']+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
  return s;
}

function copyCodeBlock(btn, preId) {
  const pre = document.getElementById(preId);
  if (!pre) return;
  const text = pre.textContent;
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    btn.textContent = 'Failed';
    setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
  });
}

// ── Incremental render for chat messages (bottom panel) ──
function renderChat() {
  const container = document.getElementById('chatMessages');
  if (!chatMsgs.length) {
    chatLastRenderedIdx = 0;
    container.innerHTML = '<div class="chat-welcome"><div class="chat-welcome-icon">⬡</div>'
      + '<div class="chat-welcome-text">What can I help you with?</div>'
      + '<div class="chat-welcome-sub">Your task will be planned, executed, and reviewed by the Cleo agent team</div></div>';
    return;
  }
  // First render: replace welcome
  if (chatLastRenderedIdx === 0 && container.querySelector('.chat-welcome')) {
    container.innerHTML = '';
  }
  const newMsgs = chatMsgs.slice(chatLastRenderedIdx);
  if (newMsgs.length) {
    const frag = document.createDocumentFragment();
    for (const m of newMsgs) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = renderChatMsgHtml(m);
      while (wrapper.firstChild) frag.appendChild(wrapper.firstChild);
    }
    container.appendChild(frag);
    chatLastRenderedIdx = chatMsgs.length;
    container.scrollTop = container.scrollHeight;
  }
}

function toggleChatResult(id, el) {
  const div = document.getElementById(id);
  if (!div) return;
  div.classList.toggle('open');
  el.textContent = div.classList.contains('open') ? '▾ hide' : '▸ detail';
}

// ══════════════════════════════════════════════════════════════════
//  FILE UPLOAD
// ══════════════════════════════════════════════════════════════════

function handleFileSelect(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    const reader = new FileReader();
    const isImage = file.type.startsWith('image/');
    reader.onload = () => {
      chatAttachments.push({
        name: file.name, type: file.type,
        dataUrl: reader.result, isImage, size: file.size
      });
      renderAttachments();
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function removeAttachment(idx) {
  chatAttachments.splice(idx, 1);
  renderAttachments();
}

function renderAttachments() {
  const container = document.getElementById('chatAttachments');
  if (!chatAttachments.length) { container.style.display = 'none'; return; }
  container.style.display = 'flex';
  let html = '';
  chatAttachments.forEach((a, i) => {
    html += '<div class="chat-attach-thumb">';
    html += '<span class="chat-attach-remove" onclick="removeAttachment(' + i + ')">×</span>';
    if (a.isImage) {
      html += '<img src="' + a.dataUrl + '" alt="' + escHtml(a.name) + '">';
    } else {
      html += '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:18px">📄</div>';
    }
    html += '<div class="chat-attach-name">' + escHtml(a.name) + '</div></div>';
  });
  container.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════
//  SEARCH MODE (Brave Search)
// ══════════════════════════════════════════════════════════════════

function toggleSearchMode() {
  searchMode = !searchMode;
  const btn = document.getElementById('searchToggle');
  btn.classList.toggle('active', searchMode);
  const input = document.getElementById('chatInput');
  input.placeholder = searchMode ? '🔍 Enter search query…' : 'Message Cleo…';
}

async function braveSearch(query) {
  try {
    const result = await apiPost('/v1/search', {query});
    if (result && result.results) return result.results;
    return null;
  } catch(e) { return null; }
}

// ══════════════════════════════════════════════════════════════════
//  SUBMIT TASK — routes user msg → bottom, task creation → top
// ══════════════════════════════════════════════════════════════════

async function chatSubmit() {
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('chatSend');
  const desc = input.value.trim();
  if (!desc) return;

  const images = chatAttachments.filter(a => a.isImage);
  const files = chatAttachments.filter(a => !a.isImage);

  // User message → BOTTOM chatbox
  addChatMsg('user', desc, {images: images.length ? images : null, files: files.length ? files : null});
  renderChat();
  input.value = '';
  input.style.height = 'auto';
  btn.disabled = true;
  chatAttachments = [];
  renderAttachments();

  // ── Search mode ──
  if (searchMode) {
    addDispatch('🔍', 'search', 'Searching: ' + truncate(desc, 60));
    renderDispatch();

    const results = await braveSearch(desc);
    if (results && results.length) {
      addDispatch('✓', 'search', 'Found ' + results.length + ' results');
      renderDispatch();

      // Show search results in bottom chatbox as assistant message
      addChatMsg('assistant', 'Found ' + results.length + ' results for "' + truncate(desc, 40) + '"', {
        agent: 'search', searchResults: results.slice(0, 5)
      });
      renderChat();

      // Submit enriched task
      const context = results.slice(0, 3).map(r => r.title + ': ' + (r.snippet||'')).join('\n');
      const enrichedDesc = desc + '\n\n[Search Context]\n' + context;
      const result = await apiPost('/v1/task', {description: enrichedDesc});
      if (result && result.task_id) {
        addDispatch('📤', 'system', 'Task created with search context: ' + result.task_id.slice(0,8) + '…', {taskId: result.task_id});
        chatTaskMap[result.task_id] = new Set(['created']);
        renderDispatch();
      }
    } else {
      addDispatch('⚠', 'search', 'No results found, submitting without context');
      const result = await apiPost('/v1/task', {description: desc});
      if (result && result.task_id) {
        addDispatch('📤', 'system', 'Task created: ' + result.task_id.slice(0,8) + '…', {taskId: result.task_id});
        chatTaskMap[result.task_id] = new Set(['created']);
      }
      renderDispatch();
    }
    btn.disabled = false;
    setTimeout(pollChatUpdates, 500);
    return;
  }

  // ── Normal mode ──
  let taskDesc = desc;
  if (files.length) {
    const fileContexts = files.map(f => {
      const base64 = f.dataUrl.split(',')[1] || '';
      try { return '[File: ' + f.name + ']\n' + atob(base64); } catch(e) { return '[File: ' + f.name + ']'; }
    });
    taskDesc += '\n\n' + fileContexts.join('\n\n');
  }
  if (images.length) {
    taskDesc += '\n\n[' + images.length + ' image(s) attached]';
  }

  const result = await apiPost('/v1/task', {description: taskDesc});
  if (result && result.task_id) {
    // Task creation goes to TOP dispatch
    addDispatch('📤', 'system', 'Task Submitted: ' + result.task_id.slice(0,8) + '…', {taskId: result.task_id});
    chatTaskMap[result.task_id] = new Set(['created']);
  } else {
    addChatMsg('system', '✗ Failed to submit task');
    renderChat();
  }
  renderDispatch();
  btn.disabled = false;
  setTimeout(pollChatUpdates, 500);
}

// ══════════════════════════════════════════════════════════════════
//  POLL & DIFF — routes to dual panels
// ══════════════════════════════════════════════════════════════════

function findTokensForAgent(agentId, claimedAt, completedAt) {
  const out = {execIn:0, execOut:0, reviewIn:0, reviewOut:0};
  if (!recentUsageCalls.length) return out;
  const aid = (agentId||'').toLowerCase();
  const start = claimedAt || 0;
  const end = completedAt || (Date.now()/1000 + 60);
  for (const c of recentUsageCalls) {
    const ts = c.ts || 0;
    if (ts < start - 1 || ts > end + 5) continue;
    const cAid = (c.agent_id||'').toLowerCase();
    if (cAid === aid || (!aid && cAid)) {
      out.execIn += c.prompt_tokens || 0;
      out.execOut += c.completion_tokens || 0;
    }
    if ((cAid === 'alic' || cAid === 'advisor') && aid !== 'alic' && aid !== 'advisor') {
      out.reviewIn += c.prompt_tokens || 0;
      out.reviewOut += c.completion_tokens || 0;
    }
  }
  return out;
}

async function pollChatUpdates() {
  const [data, hbData, usageData] = await Promise.all([
    api('/v1/status'),
    api('/v1/heartbeat'),
    api('/v1/usage/recent'),
  ]);
  if (!data) return;

  const tasks = data.tasks || {};
  allTasks = tasks;

  if (usageData && usageData.calls) recentUsageCalls = usageData.calls;

  // Update live agent status from heartbeat
  if (hbData && hbData.agents) {
    const prevLive = JSON.stringify(liveStatusAgents);
    liveStatusAgents = {};
    for (const hb of hbData.agents) {
      if (hb.online && hb.status === 'working') {
        const elapsed = hb.age != null ? hb.age : 0;
        liveStatusAgents[hb.agent_id] = {
          status: hb.status, task_id: hb.task_id,
          elapsed: Math.round(elapsed),
        };
      }
    }
    if (JSON.stringify(liveStatusAgents) !== prevLive) {
      renderLiveStatus();
    }
  }

  const prevDispLen = dispatchEntries.length;
  const prevChatLen = chatMsgs.length;

  diffAndRoute(chatPrevSnapshot, tasks);
  updateWorkflow(tasks);
  renderSubtaskTree(tasks);
  chatPrevSnapshot = JSON.parse(JSON.stringify(tasks));

  if (dispatchEntries.length > prevDispLen) renderDispatch();
  if (chatMsgs.length > prevChatLen) renderChat();
  renderLiveStatus();
}

// ── Live Status → TOP dispatch panel ──
function renderLiveStatus() {
  const container = document.getElementById('dispatchLog');
  if (!container) return;
  // Remove old live indicators
  container.querySelectorAll('.dispatch-live-row').forEach(el => el.remove());

  const working = Object.entries(liveStatusAgents);
  if (!working.length) return;

  for (const [aid, info] of working) {
    const meta = agentMeta(aid);
    const el = document.createElement('div');
    el.className = 'dispatch-entry dispatch-live-row';
    // Check if there's streaming text for a richer status
    const tid = info.task_id;
    const streamLen = tid && _streamingFullText[tid] ? stripLlmTags(_streamingFullText[tid]).length : 0;
    const statusText = streamLen > 0 ? 'Generating · ' + streamLen + ' chars' : 'Generating…';
    el.innerHTML = '<span class="dispatch-icon"><span class="dispatch-live-dot" style="background:' + meta.color + '"></span></span>'
      + '<span class="dispatch-agent ' + meta.cls + '-d">' + escHtml(capitalize(aid)) + '</span>'
      + '<span class="dispatch-text"><span class="dispatch-live">' + statusText + '</span></span>'
      + '<span class="dispatch-time" style="color:' + meta.color + '">' + info.elapsed + 's</span>';
    container.appendChild(el);
  }
  container.scrollTop = container.scrollHeight;
}

// ══════════════════════════════════════════════════════════════════
//  STREAMING — live partial results in ChatBox
// ══════════════════════════════════════════════════════════════════

// Store full streaming content
const _streamingFullText = {};
let _streamRenderRAF = {};

function updateStreamingBubble(taskId, agent, partial) {
  const container = document.getElementById('chatMessages');
  if (!container) return;

  // Store full text
  _streamingFullText[taskId] = partial;

  let bubble = document.getElementById('stream-' + taskId);
  if (!bubble) {
    // Remove welcome message if present
    const welcome = container.querySelector('.chat-welcome');
    if (welcome) welcome.remove();
    // Create streaming bubble with full markdown rendering area
    const meta = agentMeta(agent);
    const wrapper = document.createElement('div');
    wrapper.className = 'chat-msg assistant';
    wrapper.id = 'stream-' + taskId;
    wrapper.setAttribute('data-task-id', taskId);
    wrapper.innerHTML = '<div class="chat-avatar ' + meta.cls + '">' + avatarHtml(meta, 28) + '</div>'
      + '<div class="chat-bubble assistant-bubble ' + meta.cls + '-bubble">'
      + '<div class="asst-header"><span class="asst-label" style="color:' + meta.color + '">' + escHtml(capitalize(agent)) + '</span></div>'
      + '<div class="stream-body"></div>'
      + '<div class="stream-meta">'
      + '<span class="stream-agent-status">Generating</span>'
      + '<span class="char-count"></span>'
      + '</div></div>';
    container.appendChild(wrapper);
  }

  // Throttle render — 60ms interval (~16fps) for smooth streaming
  if (_streamRenderRAF[taskId]) return;
  _streamRenderRAF[taskId] = setTimeout(() => {
    delete _streamRenderRAF[taskId];
    _renderStreamContent(taskId);
  }, 60);
}

function _parseStreamSteps(partial) {
  // Extract tool/think steps from raw LLM output for Claude-style display
  const steps = [];

  // ── Completed <think>...</think> ──
  const thinkComplete = partial.match(/<think>([\s\S]*?)<\/think>/g);
  if (thinkComplete) {
    for (const t of thinkComplete) {
      const content = t.replace(/<\/?think>/g, '').trim();
      const preview = content.length > 80 ? content.slice(0, 80) + '…' : content;
      steps.push({type: 'think', status: 'done', label: 'Thought', preview});
    }
  }

  // ── Completed <tool_code>...</tool_code> (JSON format) ──
  const toolComplete = partial.match(/<tool_code>([\s\S]*?)<\/tool_code>/g);
  if (toolComplete) {
    for (const tc of toolComplete) {
      const inner = tc.replace(/<\/?tool_code>/g, '').trim();
      let label = 'Used Tool';
      try { const obj = JSON.parse(inner); if (obj.tool) label = 'Used ' + titleCase(obj.tool.replace(/[_-]/g, ' ')); } catch(e) {}
      steps.push({type: 'tool', status: 'done', label});
    }
  }

  // ── Completed <minimax:tool_call>...<invoke name="X">...</minimax:tool_call> ──
  const mmComplete = partial.match(/<minimax:tool_call>([\s\S]*?)<\/minimax:tool_call>/g);
  if (mmComplete) {
    for (const mc of mmComplete) {
      let label = 'Used Tool';
      const nameMatch = mc.match(/<invoke\s+name="([^"]+)"/);
      if (nameMatch) label = 'Used ' + titleCase(nameMatch[1].replace(/[_-]/g, ' '));
      steps.push({type: 'tool', status: 'done', label});
    }
  }

  // ── Detect currently open (incomplete / streaming) tags ──
  const hasOpenThink = /<think>(?![\s\S]*<\/think>)[\s\S]*$/.test(partial);
  const hasOpenTool = /<tool_code>(?![\s\S]*<\/tool_code>)[\s\S]*$/.test(partial);
  const hasOpenToolCall = /<tool_call>(?![\s\S]*<\/tool_call>)[\s\S]*$/.test(partial);
  const hasOpenMinimax = /<minimax:tool_call>(?![\s\S]*<\/minimax:tool_call>)[\s\S]*$/.test(partial);
  const hasRawJson = /^\s*\{"tool"\s*:/m.test(partial.split('</tool_code>').pop());

  if (hasOpenThink) steps.push({type: 'think', status: 'active', label: 'Thinking…'});
  if (hasOpenTool || hasOpenToolCall || hasRawJson) {
    steps.push({type: 'tool', status: 'active', label: 'Executing…'});
  }
  if (hasOpenMinimax) {
    // Try to extract tool name from in-progress Minimax block
    const tail = partial.split(/<minimax:tool_call>/).pop();
    const nameMatch = tail.match(/<invoke\s+name="([^"]+)"/);
    const toolName = nameMatch ? titleCase(nameMatch[1].replace(/[_-]/g, ' ')) : 'Tool';
    steps.push({type: 'tool', status: 'active', label: 'Calling ' + toolName + '…'});
  }
  return steps;
}

function _renderStreamContent(taskId) {
  const bubble = document.getElementById('stream-' + taskId);
  if (!bubble) return;
  const body = bubble.querySelector('.stream-body');
  const charCount = bubble.querySelector('.char-count');
  const statusEl = bubble.querySelector('.stream-agent-status');
  const partial = _streamingFullText[taskId] || '';
  if (body) {
    const cleaned = stripLlmTags(partial);
    const steps = _parseStreamSteps(partial);
    let stepsHtml = '';
    if (steps.length) {
      stepsHtml = '<div class="stream-steps">';
      for (const s of steps) {
        const icon = s.status === 'done'
          ? (s.type === 'think' ? '💭' : '<span style="color:var(--green)">✓</span>')
          : (s.type === 'think' ? '💭' : '⚡');
        const cls = s.status === 'done' ? 'step-done' : 'step-active';
        const previewHtml = (s.preview && s.status === 'done')
          ? '<span class="step-preview">' + escHtml(s.preview) + '</span>' : '';
        stepsHtml += '<div class="stream-step ' + cls + '">'
          + '<span class="step-icon">' + icon + '</span>'
          + '<span class="step-label">' + escHtml(s.label) + '</span>'
          + previewHtml
          + (s.status === 'active' ? '<span class="step-spinner"></span>' : '')
          + '</div>';
      }
      stepsHtml += '</div>';
    }
    // Update status text based on what's happening
    if (statusEl) {
      const activeStep = steps.find(s => s.status === 'active');
      if (activeStep) {
        statusEl.textContent = activeStep.label;
      } else if (cleaned) {
        statusEl.textContent = 'Writing';
      } else {
        statusEl.textContent = 'Generating';
      }
    }
    if (cleaned) {
      body.innerHTML = stepsHtml + renderMarkdown(cleaned) + '<span class="stream-cursor"></span>';
    } else if (steps.length) {
      body.innerHTML = stepsHtml + '<span class="stream-cursor"></span>';
    } else if (partial.length > 0) {
      body.innerHTML = '<span style="color:var(--fg3)">Working…</span><span class="stream-cursor"></span>';
    } else {
      body.innerHTML = '<span style="color:var(--fg3)">Waiting for response…</span><span class="stream-cursor"></span>';
    }
  }
  if (charCount) {
    const cleaned = stripLlmTags(partial);
    const len = cleaned.length || partial.length;
    charCount.textContent = len > 0 ? len.toLocaleString() + ' chars' : '';
  }
  const container = document.getElementById('chatMessages');
  if (container) {
    const atBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 120;
    if (atBottom) container.scrollTop = container.scrollHeight;
  }
}

function removeStreamingBubble(taskId) {
  _cleanupStreamRAF(taskId);
  const el = document.getElementById('stream-' + taskId);
  if (el) el.remove();
  delete _streamingFullText[taskId];
}

// ── Streaming cleanup on completion ──
function _cleanupStreamRAF(taskId) {
  if (_streamRenderRAF[taskId]) {
    clearTimeout(_streamRenderRAF[taskId]);
    delete _streamRenderRAF[taskId];
  }
}

function updateCostBadge(taskId, costUsd) {
  // Find the completed message bubble for this task and add cost
  const msgs = document.querySelectorAll('[data-task-id="' + taskId + '"]');
  for (const msg of msgs) {
    if (msg.querySelector('.cost-badge')) continue;
    const tokens = msg.querySelector('.asst-tokens') || msg.querySelector('.chat-tokens');
    if (tokens) {
      const badge = document.createElement('span');
      badge.className = 'cost-badge';
      badge.style.cssText = 'margin-left:8px;color:var(--green);font-weight:600';
      badge.textContent = '~$' + costUsd.toFixed(4);
      tokens.appendChild(badge);
    }
  }
}

// ══════════════════════════════════════════════════════════════════
//  SUBTASK TREE — visual decomposition of leo subtasks
// ══════════════════════════════════════════════════════════════════

function renderSubtaskTree(tasks) {
  const container = document.getElementById('subtaskTree');
  if (!container) return;

  // Find tasks that have children (parent tasks)
  const childrenOf = {};  // parentId -> [{id, task}]
  for (const [tid, t] of Object.entries(tasks)) {
    const pid = t.parent_id;
    if (pid) {
      if (!childrenOf[pid]) childrenOf[pid] = [];
      childrenOf[pid].push({ id: tid, ...t });
    }
  }

  // No subtask trees? Hide
  const parentIds = Object.keys(childrenOf);
  if (parentIds.length === 0) {
    container.classList.remove('has-tree');
    container.innerHTML = '';
    return;
  }

  container.classList.add('has-tree');

  // Build HTML for each parent group
  let html = '';
  for (const pid of parentIds) {
    const parent = tasks[pid];
    const parentDesc = parent ? (parent.description || '').substring(0, 50) : pid.substring(0, 8);
    const children = childrenOf[pid];

    // Count statuses
    const counts = { completed: 0, claimed: 0, review: 0, failed: 0 };
    for (const c of children) {
      const s = c.status || 'pending';
      if (counts[s] !== undefined) counts[s]++;
    }
    const total = children.length;
    const done = counts.completed;
    const progress = total > 0 ? Math.round((done / total) * 100) : 0;

    html += '<div class="st-parent-label">📋 ' + escHtml(parentDesc) + ' — '
      + done + '/' + total + ' (' + progress + '%)</div>';
    html += '<div class="st-group">';
    for (const child of children) {
      const st = child.status || 'pending';
      const desc = (child.description || '').substring(0, 40);
      const agent = child.agent_id || '';
      html += '<div class="st-node">'
        + '<span class="st-dot ' + st + '"></span>'
        + '<span class="st-desc" title="' + escHtml(child.description || '') + '">' + escHtml(desc) + '</span>'
        + (agent ? '<span class="st-agent">' + escHtml(capitalize(agent)) + '</span>' : '')
        + '</div>';
    }
    html += '</div>';
  }

  container.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════
//  DIFF & ROUTE — agent activity → top, final results → bottom
// ══════════════════════════════════════════════════════════════════

function diffAndRoute(prev, current) {
  for (const [taskId, task] of Object.entries(current)) {
    const old = prev[taskId];
    const oldStatus = old ? old.status : null;
    const newStatus = task.status;

    // Streaming: update partial result bubble even when status unchanged
    if (task.partial_result && (newStatus === 'claimed' || newStatus === 'review')) {
      updateStreamingBubble(taskId, task.agent_id || 'system', task.partial_result);
    }

    // Show cost on completed tasks
    if (task.cost_usd != null && newStatus === 'completed') {
      updateCostBadge(taskId, task.cost_usd);
    }

    if (oldStatus === newStatus && old) continue;

    // Remove streaming bubble when task completes
    if (newStatus === 'completed' || newStatus === 'failed') {
      removeStreamingBubble(taskId);
    }

    if (!chatTaskMap[taskId]) chatTaskMap[taskId] = new Set();
    const seen = chatTaskMap[taskId];
    const agent = task.agent_id || 'system';

    // ── New task detected → TOP dispatch ──
    if (!oldStatus && !seen.has('created')) {
      seen.add('created');
      addDispatch('📋', 'system', 'Task: ' + truncate(task.description, 80), {taskId});
    }

    // ── Agent claimed task → TOP dispatch ──
    if (newStatus === 'claimed' && oldStatus !== 'claimed' && !seen.has('claimed')) {
      seen.add('claimed');
      addDispatch('⚡', agent, 'Working on Task…', {taskId});
      const aidLower = (agent || '').toLowerCase();
      if (aidLower === 'jerry') firePacket(1, 'leo');
    }

    // ── Sent to review → TOP dispatch (with intermediate result) ──
    if (newStatus === 'review' && oldStatus !== 'review' && !seen.has('review')) {
      seen.add('review');
      const agentTokens = findTokensForAgent(agent, task.claimed_at);
      const isSimple = (task.complexity === 'simple');
      if (task.result) {
        seen.add('result_shown');
        addDispatch('📝', agent, isSimple ? 'Done (Auto-Completed)' : 'Done → Advisor Review', {
          taskId, result: task.result,
          promptTokens: agentTokens.execIn, completionTokens: agentTokens.execOut,
        });
      } else {
        addDispatch('📤', agent, '🧠 Sent to Advisor', {taskId});
      }
      if (!isSimple) firePacket(2, 'alic');
    }

    // ── Critique → jerry needs to fix ──
    if (newStatus === 'critique' && oldStatus !== 'critique' && !seen.has('critique')) {
      seen.add('critique');
      const critique = task.critique || {};
      const sugCount = (critique.suggestions || []).length;
      const preview = sugCount ? sugCount + ' Suggestion' + (sugCount > 1 ? 's' : '') : '';
      addDispatch('⚠', critique.reviewer || 'advisor', 'Needs Revision: ' + preview, {taskId});
    }

    // ── Completed → critique/review result → TOP, final result → BOTTOM ──
    if (newStatus === 'completed' && !seen.has('completed')) {
      seen.add('completed');
      const agentTokens = findTokensForAgent(agent, task.claimed_at, task.completed_at);

      // Critique/review result → TOP dispatch
      const critique = task.critique;
      if (critique) {
        const advisorId = critique.reviewer || 'advisor';
        if (critique.passed) {
          addDispatch('✓', advisorId, 'Approved ✓', {
            taskId,
            promptTokens: agentTokens.reviewIn, completionTokens: agentTokens.reviewOut,
          });
        } else {
          addDispatch('🧠', advisorId, 'Revised & Completed', {taskId});
        }
      } else {
        // Legacy: numeric scores
        const scores = task.review_scores || [];
        if (scores.length) {
          const last = scores[scores.length - 1];
          addDispatch('⭐', last.reviewer || 'alic', 'Reviewed', {
            taskId, score: last.score, scoreComment: last.comment,
            promptTokens: agentTokens.reviewIn, completionTokens: agentTokens.reviewOut,
          });
        }
      }

      // Simple task marker
      if (task.complexity === 'simple') {
        addDispatch('⚡', agent, 'Simple Task Auto-Completed', {taskId});
      } else {
        addDispatch('✓', agent, 'Task Completed', {taskId});
      }

      // ── FINAL RESULT → BOTTOM chatbox as assistant message ──
      if (task.result) {
        seen.add('result_shown');
        const totalIn = agentTokens.execIn + agentTokens.reviewIn;
        const totalOut = agentTokens.execOut + agentTokens.reviewOut;
        addChatMsg('assistant', task.result, {
          agent, taskId, result: task.result,
          critique: critique || null,
          score: critique ? null : (task.review_scores && task.review_scores.length ? task.review_scores[task.review_scores.length-1].score : null),
          scoreComment: critique ? null : (task.review_scores && task.review_scores.length ? task.review_scores[task.review_scores.length-1].comment : null),
          promptTokens: totalIn || null,
          completionTokens: totalOut || null,
        });
      }
    }

    // ── Failed → TOP dispatch + BOTTOM system msg ──
    if (newStatus === 'failed' && !seen.has('failed')) {
      seen.add('failed');
      const errFlag = (task.evolution_flags||[]).find(f => f.startsWith('failed:'));
      const errText = errFlag ? errFlag.slice(7) : 'Unknown error';
      addDispatch('✗', agent, 'Failed: ' + truncate(errText, 80), {taskId});
      addChatMsg('system', '✗ Task failed: ' + truncate(errText, 100), {taskId});
    }

    // ── Leo direct completion (pending → completed, no review) ──
    if (newStatus === 'completed' && oldStatus === 'pending' && !seen.has('review') && task.result && !seen.has('leo_direct')) {
      seen.add('leo_direct');
      const agentTokens = findTokensForAgent(agent, task.claimed_at, task.completed_at);
      addDispatch('📋', agent, 'Plan Generated', {
        taskId, result: task.result,
        promptTokens: agentTokens.execIn, completionTokens: agentTokens.execOut,
      });
      firePacket(1, 'leo');
    }
  }
}

// ══════════════════════════════════════════════════════════════════
//  WORKFLOW PIPELINE + DATA PACKET ANIMATION
// ══════════════════════════════════════════════════════════════════

function firePacket(connIdx, packetType) {
  const packet = document.getElementById('wfPacket' + connIdx);
  if (!packet) return;
  packet.classList.remove('animating');
  packet.className = 'wf-packet ' + packetType + '-packet';
  void packet.offsetWidth;
  packet.classList.add('animating');
  const targetNode = connIdx === 1
    ? document.getElementById('wfExecutor')
    : document.getElementById('wfReviewer');
  if (targetNode) {
    setTimeout(() => {
      targetNode.classList.add('receiving');
      setTimeout(() => targetNode.classList.remove('receiving'), 700);
    }, 900);
  }
}

let wfPrevState = {leo:false, jerry:false, alic:false};

function updateWorkflow(tasks) {
  const entries = Object.values(tasks);
  let done=0, working=0, failed=0, total=entries.length;
  let activePlanner=false, activeExecutor=false, activeReviewer=false;

  entries.forEach(t => {
    if (t.status === 'completed') done++;
    else if (t.status === 'failed') failed++;
    else if (t.status === 'claimed' || t.status === 'review' || t.status === 'critique') {
      working++;
      const aid = (t.agent_id || '').toLowerCase();
      if (aid === 'leo') activePlanner = true;
      else if (aid === 'jerry') activeExecutor = true;
      else if (aid === 'alic') activeReviewer = true;
      if (t.status === 'review') activeReviewer = true;
      if (t.status === 'critique') { activeExecutor = true; }
    }
  });

  for (const [aid, hb] of Object.entries(heartbeatData)) {
    if (hb.online && hb.status === 'working') {
      if (aid === 'leo') activePlanner = true;
      if (aid === 'jerry') activeExecutor = true;
      if (aid === 'alic') activeReviewer = true;
    }
  }

  // Update legacy hidden workflow nodes (for compatibility)
  const pn = document.getElementById('wfPlanner');
  const en = document.getElementById('wfExecutor');
  const rn = document.getElementById('wfReviewer');
  if (pn) pn.className = 'wf-node' + (activePlanner ? ' active' : '');
  if (en) en.className = 'wf-node' + (activeExecutor ? ' active jerry' : '');
  if (rn) rn.className = 'wf-node' + (activeReviewer ? ' active alic' : '');

  const ps = document.getElementById('wfPlannerStatus');
  const es = document.getElementById('wfExecutorStatus');
  const rs = document.getElementById('wfReviewerStatus');
  if (ps) ps.textContent = activePlanner ? 'working' : 'idle';
  if (es) es.textContent = activeExecutor ? 'working' : 'idle';
  if (rs) rs.textContent = activeReviewer ? 'working' : 'idle';

  const c1 = document.getElementById('wfConn1');
  const c2 = document.getElementById('wfConn2');
  if (c1) c1.className = 'wf-connector' + ((activePlanner || activeExecutor) ? ' active' : '');
  if (c2) c2.className = 'wf-connector' + ((activeExecutor || activeReviewer) ? ' active' : '');

  wfPrevState = {leo:activePlanner, jerry:activeExecutor, alic:activeReviewer};

  const statsEl = document.getElementById('wfStats');
  if (statsEl) {
    if (!total) statsEl.textContent = 'Ready';
    else {
      const parts = [total + ' task' + (total!==1?'s':'')];
      if (done) parts.push(done + ' done');
      if (working) parts.push(working + ' working');
      if (failed) parts.push(failed + ' failed');
      statsEl.textContent = parts.join(' · ');
    }
  }

  // ── Update header bar agent chips ──
  const cp = document.getElementById('chipPlanner');
  const ce = document.getElementById('chipExecutor');
  const cr = document.getElementById('chipReviewer');
  if (cp) cp.className = 'ov-agent-chip' + (activePlanner ? ' active' : '');
  if (ce) ce.className = 'ov-agent-chip' + (activeExecutor ? ' active jerry' : '');
  if (cr) cr.className = 'ov-agent-chip' + (activeReviewer ? ' active alic' : '');
}

// ══════════════════════════════════════════════════════════════════
//  RESIZABLE DIVIDER (drag to resize top/bottom panels)
// ══════════════════════════════════════════════════════════════════
(function initDivider() {
  const divider = document.getElementById('ovDivider');
  const top = document.getElementById('ovTop');
  if (!divider || !top) return;
  let dragging = false, startY = 0, startH = 0;

  divider.addEventListener('mousedown', (e) => {
    e.preventDefault();
    dragging = true;
    startY = e.clientY;
    startH = top.offsetHeight;
    document.body.style.cursor = 'row-resize';
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    const delta = e.clientY - startY;
    const newH = Math.max(80, Math.min(startH + delta, window.innerHeight * 0.7));
    top.style.height = newH + 'px';
    top.style.maxHeight = 'none';
  });

  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  });
})();

// ── Backward compat ──
async function pollTasks() { await pollChatUpdates(); }
async function submitTask() { await chatSubmit(); }

// ── Textarea auto-height + Enter to send ──
(function() {
  const input = document.getElementById('chatInput');
  if (!input) return;
  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      chatSubmit();
    }
  });
})();

// ══════════════════════════════════════════════════════════════════
//  AGENTS — View + Edit
// ══════════════════════════════════════════════════════════════════

function buildSparkline(history) {
  if (!history || history.length < 2) return '';
  const values = history.map(h => h.composite || 0);
  const min = Math.min(...values) - 2;
  const max = Math.max(...values) + 2;
  const range = max - min || 1;
  const w = 120;
  const h = 24;
  const step = w / (values.length - 1);

  const points = values.map((v, i) =>
    (i * step).toFixed(1) + ',' + (h - ((v - min) / range) * h).toFixed(1)
  ).join(' ');

  // Color based on trend: compare last vs first
  const trend = values[values.length - 1] - values[0];
  const color = trend >= 0 ? 'var(--green)' : 'var(--red)';

  return '<div class="sparkline-wrap">'
    + '<svg viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none">'
    + '<polyline fill="none" stroke="' + color + '" stroke-width="1.5" '
    + 'stroke-linecap="round" stroke-linejoin="round" points="' + points + '"/>'
    + '</svg></div>';
}

async function loadAgents() {
  const [agentData, scoreData, skillsResp, chainData, historyData] = await Promise.all([
    api('/v1/agents'), api('/v1/scores'), api('/v1/skills'), api('/v1/chain/status'), api('/v1/scores/history')
  ]);
  const grid = document.getElementById('agentGrid');
  const agents = agentData?.agents || [];
  const scores = scoreData?.scores || {};
  const allSkills = skillsResp?.shared || [];
  const sharedSkillNames = new Set(allSkills.map(s => s.name || s.file?.replace('.md','')));
  const agentPrivateSkills = skillsResp?.agents || {};
  const rawChainAgents = chainData?.agents || {};
  // Map legacy chain IDs (planner/executor/reviewer) to current agent IDs
  const CHAIN_ID_MAP = {planner:'leo', executor:'jerry', reviewer:'alic'};
  const chainAgents = {};
  for (const [cid, cdata] of Object.entries(rawChainAgents)) {
    const mapped = CHAIN_ID_MAP[cid] || cid;
    chainAgents[mapped] = cdata;
  }
  const scoreHistory = historyData?.agents || {};

  if (!agents.length) { grid.innerHTML = '<div class="empty">No agents configured</div>'; return; }

  let html = '';
  for (const a of agents) {
    const sc = scores[a.id] || {};
    const composite = sc.composite || 0;
    const dims = sc.dimensions || {};
    const hb = heartbeatData[a.id];
    const isOnline = hb && hb.online;

    // ── Card surface: compact, consistent ──
    const aM = agentMeta(a.id);
    html += '<div class="agent-card" onclick="editAgent(\'' + escHtml(a.id) + '\')">';
    // Row 1: Avatar + Name + status
    html += '<div class="agent-card-header">';
    html += avatarHtml(aM, 24);
    html += '<span class="hb-dot ' + (isOnline ? 'online' : 'offline') + '" data-agent-id="' + escHtml(a.id) + '"></span>';
    html += '<span class="agent-name">' + escHtml(capitalize(a.id)) + '</span>';
    if (isOnline && hb.status === 'working') html += '<span class="agent-working">Working</span>';
    html += '<span style="flex:1"></span>';
    // API Key indicator (compact)
    const isKeySet = a.api_key_set;
    if (isKeySet) html += '<span class="key-dot set" title="API key set"></span>';
    else if (a.api_key_env) html += '<span class="key-dot unset" title="API key not set"></span>';
    html += '</div>';

    // Row 2: Model + Provider
    html += '<div class="agent-card-model">' + escHtml(a.model||'—')
      + ' <span class="agent-provider">' + escHtml(a.provider||'') + '</span></div>';

    // Row 3: Skills tags (private only — shared skills hidden)
    const privateSkills = (a.skills || []).filter(s => !sharedSkillNames.has(s));
    if (privateSkills.length) {
      html += '<div class="agent-card-skills">';
      for (const s of privateSkills) html += '<span class="skill-tag">' + escHtml(s) + '</span>';
      html += '</div>';
    }

    // Row 4: Chain identity + wallet + balance
    const chain = chainAgents[a.id];
    if (chain && (chain.registered || chain.pkp_address)) {
      const addr = chain.pkp_address || '';
      const shortAddr = addr ? addr.slice(0, 6) + '…' + addr.slice(-4) : '';
      const chainId = chain.erc8004_agent_id != null ? '#' + chain.erc8004_agent_id : '';
      const scanUrl = 'https://sepolia.basescan.org/address/' + addr;
      const balance = chain.usdc_balance != null ? parseFloat(chain.usdc_balance).toFixed(2) : null;
      html += '<div class="agent-card-chain">';
      html += '<div class="agent-card-chain-row">';
      if (chain.registered) html += '<span>⛓ On-chain ' + chainId + '</span>';
      if (addr) html += '<a href="' + scanUrl + '" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="' + escHtml(addr) + '">' + escHtml(shortAddr) + '</a>';
      html += '</div>';
      if (balance !== null) {
        html += '<div class="agent-card-chain-row">';
        html += '<span style="color:var(--fg3)">Balance</span> <span style="color:var(--green);font-family:var(--mono);font-weight:600">' + balance + ' USDC</span>';
        html += '</div>';
      }
      html += '</div>';
    }

    // Row 5: Score bar (if has scores)
    if (composite > 0) {
      html += '<div class="agent-score">'
        + '<div class="score-bar"><div class="score-fill" style="width:'+composite+'%;background:'+scoreColor(composite)+'"></div></div>'
        + '<div class="score-num" style="color:'+scoreColor(composite)+'">' + composite.toFixed(1) + '</div>'
        + '</div>';
    }

    // Row 6: Reputation sparkline (if history exists)
    const agentHistory = scoreHistory[a.id] || [];
    if (agentHistory.length >= 2) {
      html += buildSparkline(agentHistory);
    }

    html += '</div>'; // .agent-card
  }
  grid.innerHTML = html;

  // Render modal if editing
  const modalContainer = document.getElementById('agentModalContainer');
  if (editingAgent) {
    const a = agents.find(x => x.id === editingAgent);
    if (a) {
      const sc = scores[a.id] || {};
      const composite = sc.composite || 0;
      const dims = sc.dimensions || {};
      const hb = heartbeatData[a.id];
      const isOnline = hb && hb.online;
      const activeTab = window._agentModalTab || 'overview';
      let mhtml = '<div class="agent-modal-overlay" onclick="closeAgentEditor()">';
      mhtml += '<div class="agent-modal" onclick="event.stopPropagation()">';

      // Header with avatar
      const modalMeta = agentMeta(a.id);
      mhtml += '<div class="agent-modal-header">';
      mhtml += '<span class="agent-modal-title">'
        + avatarHtml(modalMeta, 32) + ' '
        + '<span class="hb-dot ' + (isOnline ? 'online' : 'offline') + '"></span> '
        + escHtml(a.id) + '</span>';
      mhtml += '<button class="agent-modal-close" onclick="closeAgentEditor()">✕</button></div>';

      // Tabs
      mhtml += '<div class="modal-tabs">';
      mhtml += '<button class="modal-tab' + (activeTab==='overview'?' active':'') + '" onclick="switchAgentTab(\'overview\')">Overview</button>';
      mhtml += '<button class="modal-tab' + (activeTab==='edit'?' active':'') + '" onclick="switchAgentTab(\'edit\')">Edit</button>';
      mhtml += '<button class="modal-tab' + (activeTab==='files'?' active':'') + '" onclick="switchAgentTab(\'files\');loadAgentFiles(\'' + escHtml(a.id) + '\')">Files</button>';
      mhtml += '<button class="modal-tab' + (activeTab==='tools'?' active':'') + '" onclick="switchAgentTab(\'tools\');loadAgentTools(\'' + escHtml(a.id) + '\')">Tools</button>';
      mhtml += '</div>';

      // ═══ OVERVIEW TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='overview'?' active':'') + '" data-tab="overview">';

      // Role
      mhtml += '<div class="overview-section"><div class="overview-label">Role</div>';
      mhtml += '<div class="overview-role">' + escHtml(a.role||'No role defined') + '</div></div>';

      // Model + Provider + Skills
      mhtml += '<div class="overview-section"><div class="overview-label">Configuration</div>';
      mhtml += '<div class="overview-value" style="font-size:12px">';
      mhtml += '<strong>Model:</strong> ' + escHtml(a.model||'—') + ' <span style="color:var(--fg3)">(' + escHtml(a.provider||'') + ')</span><br>';
      const modalPrivateSkills = (a.skills||[]).filter(s => !sharedSkillNames.has(s));
      mhtml += '<strong>Skills:</strong> ' + (modalPrivateSkills.length ? modalPrivateSkills : ['(shared only)']).map(s => '<span class="skill-tag">' + escHtml(s) + '</span>').join(' ');
      if (a.fallback_models && a.fallback_models.length) {
        mhtml += '<br><strong>Fallbacks:</strong> <span style="color:var(--fg3)">' + escHtml(a.fallback_models.join(', ')) + '</span>';
      }
      mhtml += '</div></div>';

      // Wallet / Chain identity
      const chainInfo = chainAgents[a.id];
      if (chainInfo && (chainInfo.registered || chainInfo.pkp_address)) {
        const wa = chainInfo.pkp_address || '';
        const waBal = chainInfo.usdc_balance != null ? parseFloat(chainInfo.usdc_balance).toFixed(2) : '—';
        const waScan = 'https://sepolia.basescan.org/address/' + wa;
        const waChainId = chainInfo.erc8004_agent_id != null ? ' #' + chainInfo.erc8004_agent_id : '';
        mhtml += '<div class="overview-section"><div class="overview-label">Wallet' + (chainInfo.registered ? ' ⛓' + waChainId : '') + '</div>';
        mhtml += '<div class="overview-value" style="font-size:12px;font-family:var(--mono)">';
        if (wa) mhtml += '<a href="' + waScan + '" target="_blank" rel="noopener" style="color:var(--accent2)">' + escHtml(wa) + '</a><br>';
        mhtml += '<span style="color:var(--green);font-size:14px;font-weight:600">' + waBal + ' USDC</span>';
        mhtml += '</div></div>';
      }

      // Current Task
      const ct = a.current_task;
      if (ct) {
        mhtml += '<div class="overview-section"><div class="overview-label">Current Task</div>';
        mhtml += '<div class="overview-task"><span class="overview-task-id">#' + escHtml(ct.id) + '</span> ';
        mhtml += escHtml(ct.description);
        mhtml += ' <span style="color:var(--fg3)">(' + escHtml(ct.status) + ')</span></div></div>';
      }

      // Score breakdown
      if (composite > 0) {
        const dimNames = {task_completion:'Completion',output_quality:'Quality',improvement_rate:'Improvement',consistency:'Consistency',review_accuracy:'Review'};
        mhtml += '<div class="overview-section"><div class="overview-label">Reputation — ' + composite.toFixed(1) + '</div>';
        for (const [k,label] of Object.entries(dimNames)) {
          const v = dims[k] || 0;
          mhtml += '<div class="overview-score-row">'
            + '<span class="overview-score-label">' + label + '</span>'
            + '<div class="overview-score-bar"><div class="overview-score-fill" style="width:'+v+'%;background:'+scoreColor(v)+'"></div></div>'
            + '<span class="overview-score-num">' + v.toFixed(0) + '</span></div>';
        }
        // Sparkline if history exists
        const agentHist = scoreHistory[a.id] || [];
        if (agentHist.length >= 2) {
          mhtml += '<div style="margin-top:6px">' + buildSparkline(agentHist) + '</div>';
        }
        mhtml += '</div>';
      }

      // Recent Logs
      const logs = a.recent_logs || [];
      if (logs.length) {
        mhtml += '<div class="overview-section"><div class="overview-label">Recent Activity</div>';
        mhtml += '<ul class="overview-logs">';
        for (const line of logs) mhtml += '<li>' + escHtml(line) + '</li>';
        mhtml += '</ul></div>';
      }

      mhtml += '</div>'; // overview tab

      // ═══ EDIT TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='edit'?' active':'') + '" data-tab="edit">';
      mhtml += '<div class="agent-editor">';

      // Basic settings
      mhtml += '<div class="field-row">';
      mhtml += '<div class="field"><label>Model</label>'
        + '<div style="display:flex;gap:4px;align-items:center;position:relative">'
        + '<input class="input" id="editModel" value="' + escHtml(a.model||'') + '" style="flex:1" autocomplete="off" onclick="toggleModelDropdown()" readonly>'
        + '<button class="btn" onclick="fetchModels()" style="padding:4px 10px;font-size:11px;white-space:nowrap" title="Fetch models from provider">Fetch</button>'
        + '<div id="modelDropdown" class="model-dropdown" style="display:none"></div>'
        + '</div>'
        + '<div id="modelFetchStatus" style="font-size:10px;color:var(--fg3);margin-top:2px"></div>'
        + '</div>';
      mhtml += '<div class="field"><label>Provider</label><select class="input" id="editProvider" onchange="syncProviderBaseUrl(\'editProvider\',\'editBaseUrl\')">';
      for (const p of ['flock','openai','minimax','ollama','anthropic','deepseek','custom']) {
        mhtml += '<option' + (p===(a.provider||'') ? ' selected' : '') + '>' + p + '</option>';
      }
      mhtml += '</select></div>';
      mhtml += '</div>';
      mhtml += '<div class="field"><label>Role</label><textarea class="input" id="editRole" rows="3">' + escHtml(a.role||'') + '</textarea></div>';

      // Skills checkboxes
      mhtml += '<div class="field"><label>Skills</label><div id="editSkillsBox" style="display:flex;flex-wrap:wrap;gap:6px">';
      const agentSkills = new Set(a.skills||[]);
      for (const sk of allSkills) {
        const checked = agentSkills.has(sk.name) ? ' checked' : '';
        mhtml += '<label style="font-size:12px;color:var(--fg2);display:flex;align-items:center;gap:3px;cursor:pointer">'
          + '<input type="checkbox" class="edit-skill-cb" value="' + escHtml(sk.name) + '"' + checked + '>' + escHtml(sk.name) + '</label>';
      }
      mhtml += '</div></div>';

      // Fallback Models
      mhtml += '<div class="field"><label>Fallback Models (comma-separated)</label><input class="input" id="editFallbacks" value="' + escHtml((a.fallback_models||[]).join(', ')) + '"></div>';

      // API Key + Base URL
      mhtml += '<div style="border-top:1px solid var(--bg4);margin:10px 0;padding-top:10px">';
      mhtml += '<div style="font-size:11px;font-weight:700;color:var(--fg2);text-transform:uppercase;margin-bottom:8px">API Configuration</div>';
      mhtml += '<div class="field-row">';
      const keyPlaceholder = a.api_key_masked ? 'Current: ' + a.api_key_masked : 'sk-xxxxxxxx';
      mhtml += '<div class="field"><label>API Key</label><input class="input" id="editApiKey" type="password" value="" placeholder="' + escHtml(keyPlaceholder) + '"><div style="font-size:10px;color:var(--fg3);margin-top:2px">Leave empty to keep current key</div></div>';
      const editProviderDefault = PROVIDER_BASE_URLS[a.provider||'flock'] || 'https://api.openai.com/v1';
      mhtml += '<div class="field"><label>Base URL</label><input class="input" id="editBaseUrl" value="' + escHtml(a.base_url||'') + '" placeholder="' + escHtml(editProviderDefault) + '"></div>';
      mhtml += '</div>';
      mhtml += '</div>';

      mhtml += '<div class="actions" style="justify-content:space-between">';
      mhtml += '<button class="btn-delete-agent" onclick="deleteAgent(\'' + escHtml(a.id) + '\')">Delete Agent</button>';
      mhtml += '<div style="display:flex;gap:8px">';
      mhtml += '<button class="btn btn-outline btn-sm" onclick="closeAgentEditor()">Cancel</button>';
      mhtml += '<button class="btn btn-green btn-sm" onclick="saveAgent(\'' + escHtml(a.id) + '\')">Save</button>';
      mhtml += '</div></div>';
      mhtml += '</div>'; // .agent-editor
      mhtml += '</div>'; // edit tab

      // ═══ FILES TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='files'?' active':'') + '" data-tab="files">';
      mhtml += '<div id="agentFilesContent" style="min-height:200px"><div class="empty" style="padding:16px">Click to load files…</div></div>';
      mhtml += '</div>'; // files tab

      // ═══ TOOLS TAB ═══
      mhtml += '<div class="modal-tab-content' + (activeTab==='tools'?' active':'') + '" data-tab="tools">';
      mhtml += '<div id="agentToolsContent" style="min-height:200px"><div class="empty" style="padding:16px">Click to load tools…</div></div>';
      mhtml += '</div>'; // tools tab

      mhtml += '</div>'; // .agent-modal
      mhtml += '</div>'; // .agent-modal-overlay
      modalContainer.innerHTML = mhtml;
    }
  } else {
    modalContainer.innerHTML = '';
  }
}

function switchAgentTab(tab) {
  window._agentModalTab = tab;
  const tabMap = {'overview': 'Overview', 'edit': 'Edit', 'files': 'Files', 'tools': 'Tools'};
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.toggle('active', t.textContent === tabMap[tab]));
  document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.toggle('active', c.dataset.tab === tab));
}

function editAgent(id) {
  editingAgent = editingAgent === id ? null : id;
  loadAgents();
}

function closeAgentEditor() {
  editingAgent = null;
  document.getElementById('agentModalContainer').innerHTML = '';
}

const PROVIDER_BASE_URLS = {
  flock:     'https://api.flock.io/v1',
  openai:    'https://api.openai.com/v1',
  minimax:   'https://api.minimax.io/v1',
  ollama:    'http://localhost:11434/v1',
  anthropic: 'https://api.anthropic.com/v1',
  deepseek:  'https://api.deepseek.com/v1',
  custom:    '',
};
function syncProviderBaseUrl(selectId, urlInputId) {
  const provider = document.getElementById(selectId).value;
  const urlInput = document.getElementById(urlInputId);
  const defaultUrl = PROVIDER_BASE_URLS[provider] || '';
  urlInput.value = defaultUrl;
  urlInput.placeholder = defaultUrl || 'https://api.example.com/v1';
}

let _fetchedModels = [];

async function fetchModels() {
  const provider = document.getElementById('editProvider').value;
  const baseUrl = document.getElementById('editBaseUrl').value.trim();
  const apiKey = document.getElementById('editApiKey').value.trim();
  const status = document.getElementById('modelFetchStatus');
  const modelInput = document.getElementById('editModel');

  status.textContent = 'Fetching models…';
  status.style.color = 'var(--fg3)';
  _fetchedModels = [];

  let url = '/v1/models?provider=' + encodeURIComponent(provider);
  if (baseUrl) url += '&base_url=' + encodeURIComponent(baseUrl);
  if (apiKey) url += '&api_key=' + encodeURIComponent(apiKey);

  try {
    const res = await api(url);
    if (res && res.models && res.models.length) {
      _fetchedModels = res.models.map(m => m.id);
      status.textContent = res.models.length + ' models found — click input to select';
      status.style.color = 'var(--green)';
      // Auto-open dropdown
      showModelDropdown();
    } else if (res && res.error) {
      status.textContent = res.error;
      status.style.color = 'var(--red)';
    } else {
      status.textContent = 'No models returned';
      status.style.color = 'var(--yellow)';
    }
  } catch (e) {
    status.textContent = 'Fetch failed: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

function showModelDropdown() {
  const dd = document.getElementById('modelDropdown');
  const current = document.getElementById('editModel').value;
  if (!dd || !_fetchedModels.length) return;
  dd.innerHTML = '';
  for (const m of _fetchedModels) {
    const cls = m === current ? 'model-option selected' : 'model-option';
    dd.innerHTML += '<div class="' + cls + '" onclick="selectModel(\'' + escHtml(m) + '\')">' + escHtml(m) + '</div>';
  }
  dd.style.display = 'block';
  // Close on outside click
  setTimeout(() => document.addEventListener('click', _closeModelDropdown, {once: true}), 50);
}

function toggleModelDropdown() {
  const dd = document.getElementById('modelDropdown');
  if (!dd) return;
  if (dd.style.display === 'block') { dd.style.display = 'none'; return; }
  if (_fetchedModels.length) showModelDropdown();
}

function selectModel(modelId) {
  document.getElementById('editModel').value = modelId;
  const dd = document.getElementById('modelDropdown');
  if (dd) dd.style.display = 'none';
}

function _closeModelDropdown(e) {
  const dd = document.getElementById('modelDropdown');
  if (dd && !dd.contains(e.target) && e.target.id !== 'editModel') dd.style.display = 'none';
}

async function saveAgent(id) {
  const model = document.getElementById('editModel').value.trim();
  const provider = document.getElementById('editProvider').value;
  const role = document.getElementById('editRole').value.trim();
  const fallbacks = document.getElementById('editFallbacks').value.split(',').map(s=>s.trim()).filter(Boolean);
  const skills = Array.from(document.querySelectorAll('.edit-skill-cb:checked')).map(cb => cb.value);
  const apiKey = document.getElementById('editApiKey').value.trim();
  const baseUrl = document.getElementById('editBaseUrl').value.trim();

  const body = {model, provider, role, fallback_models: fallbacks, skills};
  if (apiKey) body.api_key = apiKey;
  if (baseUrl) body.base_url = baseUrl;

  const res = await apiPut('/v1/agents/' + id, body);
  if (res && res.ok) {
    toast('Agent ' + id + ' updated');
    editingAgent = null;
    loadAgents();
  } else {
    toast(res?.error || 'Failed to update agent', 'error');
  }
}

function showCreateAgentModal() {
  const container = document.getElementById('agentModalContainer');
  let mhtml = '<div class="agent-modal-overlay" onclick="closeAgentEditor()">';
  mhtml += '<div class="agent-modal" onclick="event.stopPropagation()">';
  mhtml += '<div class="agent-modal-header"><span class="agent-modal-title">Create Agent</span>'
    + '<button class="agent-modal-close" onclick="closeAgentEditor()">✕</button></div>';
  mhtml += '<div class="agent-editor">';

  // ID
  mhtml += '<div class="field"><label>Agent ID (lowercase, no spaces)</label><input class="input" id="newAgentId" placeholder="e.g. researcher"></div>';

  // Role
  mhtml += '<div class="field"><label>Role</label><textarea class="input" id="newAgentRole" rows="2" placeholder="e.g. Research analyst who gathers and synthesizes information"></textarea></div>';

  // Model + Provider
  mhtml += '<div class="field-row">';
  mhtml += '<div class="field"><label>Model</label><input class="input" id="newAgentModel" placeholder="e.g. gpt-4o"></div>';
  mhtml += '<div class="field"><label>Provider</label><select class="input" id="newAgentProvider" onchange="syncProviderBaseUrl(\'newAgentProvider\',\'newAgentBaseUrl\')">';
  for (const p of ['flock','openai','minimax','ollama','anthropic','deepseek','custom']) {
    mhtml += '<option>' + p + '</option>';
  }
  mhtml += '</select></div>';
  mhtml += '</div>';

  // API Key + Base URL (optional)
  mhtml += '<div style="border-top:1px solid var(--bg4);margin:10px 0;padding-top:10px">';
  mhtml += '<div style="font-size:11px;font-weight:700;color:var(--fg2);text-transform:uppercase;margin-bottom:8px">API Configuration (optional)</div>';
  mhtml += '<div class="field-row">';
  mhtml += '<div class="field"><label>API Key</label><input class="input" id="newAgentApiKey" type="password" placeholder="Leave empty to use global key"></div>';
  mhtml += '<div class="field"><label>Base URL</label><input class="input" id="newAgentBaseUrl" placeholder="Leave empty for default"></div>';
  mhtml += '</div></div>';

  mhtml += '<div class="actions">';
  mhtml += '<button class="btn btn-outline btn-sm" onclick="closeAgentEditor()">Cancel</button>';
  mhtml += '<button class="btn btn-green btn-sm" onclick="createAgent()">Create</button>';
  mhtml += '</div>';
  mhtml += '</div></div></div>';
  container.innerHTML = mhtml;
}

async function createAgent() {
  const id = (document.getElementById('newAgentId').value||'').trim().toLowerCase().replace(/\s+/g, '_');
  const role = (document.getElementById('newAgentRole').value||'').trim();
  const model = (document.getElementById('newAgentModel').value||'').trim();
  const provider = document.getElementById('newAgentProvider').value;
  const apiKey = (document.getElementById('newAgentApiKey').value||'').trim();
  const baseUrl = (document.getElementById('newAgentBaseUrl').value||'').trim();

  if (!id) { toast('Agent ID is required', 'error'); return; }
  if (!model) { toast('Model is required', 'error'); return; }
  if (!/^[a-zA-Z0-9_-]+$/.test(id)) { toast('ID must be alphanumeric (a-z, 0-9, _ or -)', 'error'); return; }

  const body = { id, role: role || 'general assistant', model, provider, skills: ['_base'] };
  if (apiKey) body.api_key = apiKey;
  if (baseUrl) body.base_url = baseUrl;

  const res = await apiPost('/v1/agents', body);
  if (res && res.ok) {
    toast('Agent ' + id + ' created');
    closeAgentEditor();
    loadAgents();
  } else {
    toast(res?.error || 'Failed to create agent', 'error');
  }
}

async function deleteAgent(id) {
  if (!confirm('Delete agent "' + id + '"? This removes it from the config but preserves skill files and cognition docs.')) return;
  const res = await apiDelete('/v1/agents/' + id);
  if (res && res.ok) {
    toast('Agent ' + id + ' deleted');
    closeAgentEditor();
    loadAgents();
  } else {
    toast(res?.error || 'Failed to delete agent', 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  SKILLS — List + Editor
// ══════════════════════════════════════════════════════════════════

async function loadSkills() {
  const [skills, agentData] = await Promise.all([api('/v1/skills'), api('/v1/agents')]);
  skillsData = skills;
  if (!skillsData) return;

  // Populate agent filter dropdown
  const sel = document.getElementById('skillAgentFilter');
  const prev = sel.value;
  sel.innerHTML = '<option value="">All agents</option>';
  const agents = agentData?.agents || [];
  for (const a of agents) {
    const agentSkills = (a.skills || []);
    sel.innerHTML += '<option value="' + escHtml(a.id) + '">' + escHtml(a.id) + ' (' + agentSkills.length + ' skills)</option>';
  }
  sel.value = prev; // preserve selection across reloads
  // Store agent skill assignments for filtering
  skillsData._agentAssignments = {};
  for (const a of agents) {
    skillsData._agentAssignments[a.id] = new Set(a.skills || []);
  }
  renderSkillsList();
}

function renderSkillsList() {
  const body = document.getElementById('skillsListBody');
  const filter = (document.getElementById('skillSearch').value||'').toLowerCase();
  const agentFilter = (document.getElementById('skillAgentFilter')?.value||'');
  const assignments = skillsData._agentAssignments || {};
  let html = '';

  // Helper: check if a skill name is assigned to the filtered agent
  function agentHasSkill(skillName) {
    if (!agentFilter) return true;  // no filter = show all
    const agentSkills = assignments[agentFilter];
    return agentSkills && (agentSkills.has(skillName) || agentSkills.has('_base'));
  }

  // Team skill (always visible if _base is in scope)
  if (skillsData.team && skillsData.team.exists) {
    const match = (!filter || '_team'.includes(filter) || 'team'.includes(filter)) && agentHasSkill('_team');
    if (match) {
      html += '<div class="skill-group-title">Team</div>';
      html += '<div class="skill-item' + (currentSkill?.key === 'team:_team' ? ' active' : '') + '" onclick="selectSkill(\'team\',\'_team\')">';
      html += '<span>_team</span><span class="skill-scope">team</span></div>';
    }
  }

  // Shared skills — highlight which ones are assigned to filtered agent
  const shared = (skillsData.shared || []).filter(s =>
    (!filter || s.name.toLowerCase().includes(filter)) && agentHasSkill(s.name)
  );
  if (shared.length) {
    html += '<div class="skill-group-title">Shared' + (agentFilter ? ' → ' + escHtml(agentFilter) : '') + '</div>';
    for (const s of shared) {
      const isAssigned = agentFilter && assignments[agentFilter]?.has(s.name);
      const badge = isAssigned ? ' <span style="color:var(--green);font-size:9px">●</span>' : '';
      html += '<div class="skill-item' + (currentSkill?.key === 'shared:'+s.name ? ' active' : '') + '" onclick="selectSkill(\'shared\',\'' + escHtml(s.name) + '\')">';
      html += '<span>' + escHtml(s.name) + badge + '</span><span class="skill-scope">shared</span></div>';
    }
  }

  // Agent-specific skill files
  const agents = skillsData.agents || {};
  for (const [aid, skills] of Object.entries(agents).sort()) {
    if (agentFilter && aid !== agentFilter) continue;  // skip agents not matching filter
    const filtered = skills.filter(s => !filter || s.name.toLowerCase().includes(filter) || aid.includes(filter));
    if (!filtered.length) continue;
    html += '<div class="skill-group-title">Agent: ' + escHtml(aid) + '</div>';
    for (const s of filtered) {
      const key = 'agent:' + aid + ':' + s.name;
      html += '<div class="skill-item' + (currentSkill?.key === key ? ' active' : '') + '" onclick="selectSkill(\'agent\',\'' + escHtml(s.name) + '\',\'' + escHtml(aid) + '\')">';
      html += '<span>' + escHtml(s.name) + '</span><span class="skill-scope">' + escHtml(aid) + '</span></div>';
    }
  }

  if (!html) html = '<div class="empty">No skills found</div>';
  body.innerHTML = html;
}

function filterSkills() { renderSkillsList(); }

async function selectSkill(scope, name, agentId) {
  // Check unsaved changes
  if (skillsDirty && !confirm('You have unsaved changes. Discard?')) return;
  skillsDirty = false;

  let path, key;
  if (scope === 'team') {
    path = '/v1/skills/team';
    key = 'team:_team';
  } else if (scope === 'agent') {
    path = '/v1/skills/agents/' + agentId + '/' + name;
    key = 'agent:' + agentId + ':' + name;
  } else {
    path = '/v1/skills/' + name;
    key = 'shared:' + name;
  }

  const data = await api(path);
  if (!data) { toast('Failed to load skill', 'error'); return; }

  currentSkill = {scope, name, agentId, key, data};

  const editor = document.getElementById('skillsEditor');
  let h = '<div class="skills-toolbar">';
  h += '<span class="skill-filename">' + escHtml(data.file || name + '.md') + '</span>';
  h += '<span style="font-size:11px;color:var(--fg3);margin-left:4px">(' + (data.size||0) + ' bytes)</span>';
  h += '<span style="flex:1"></span>';

  // Save button
  h += '<button class="btn btn-green btn-sm" onclick="saveSkill()">Save</button>';

  // Download button
  h += '<button class="btn btn-outline btn-sm" onclick="downloadSkill()">↓ Download</button>';

  // Delete button (not for team or system skills)
  if (scope !== 'team' && !name.startsWith('_')) {
    h += '<button class="btn btn-danger btn-sm" onclick="deleteSkill()">Delete</button>';
  }

  // Regen button for team
  if (scope === 'team') {
    h += '<button class="btn btn-outline btn-sm" onclick="regenerateTeamSkill()">↻ Regenerate</button>';
  }

  h += '</div>';

  // ── Assignment panel for shared skills ──
  if (scope === 'shared' && !name.startsWith('_')) {
    const agentsResp = await api('/v1/agents');
    const agentsList = agentsResp?.agents || [];
    if (agentsList.length) {
      h += '<div class="skill-assign-bar">';
      h += '<span class="skill-assign-label">Assigned to:</span>';
      for (const ag of agentsList) {
        const hasSkill = (ag.skills || []).includes(name);
        h += '<label class="skill-assign-cb"><input type="checkbox" class="assign-agent-cb" value="' + escHtml(ag.id) + '"'
          + (hasSkill ? ' checked' : '') + ' onchange="updateSkillAssignment()">'
          + '<span>' + escHtml(ag.id) + '</span></label>';
      }
      h += '</div>';
    }
  }

  h += '<textarea class="mono" id="skillContent" oninput="skillsDirty=true">' + escHtml(data.content||'') + '</textarea>';
  editor.innerHTML = h;

  // Mark active in list
  renderSkillsList();
}

async function saveSkill() {
  if (!currentSkill) return;
  const content = document.getElementById('skillContent').value;

  let path;
  if (currentSkill.scope === 'team') {
    path = '/v1/skills/team';
  } else if (currentSkill.scope === 'agent') {
    path = '/v1/skills/agents/' + currentSkill.agentId + '/' + currentSkill.name;
  } else {
    path = '/v1/skills/' + currentSkill.name;
  }

  const res = await apiPut(path, {content});
  if (res && res.ok) {
    toast('Skill saved');
    skillsDirty = false;
  } else {
    toast(res?.error || 'Failed to save', 'error');
  }
}

// Update which agents have this shared skill assigned
async function updateSkillAssignment() {
  if (!currentSkill || currentSkill.scope !== 'shared') return;
  const skillName = currentSkill.name;
  const agentsResp = await api('/v1/agents');
  const agentsList = agentsResp?.agents || [];
  const checkboxes = document.querySelectorAll('.assign-agent-cb');

  for (const cb of checkboxes) {
    const agentId = cb.value;
    const shouldHave = cb.checked;
    const agent = agentsList.find(a => a.id === agentId);
    if (!agent) continue;
    const currentSkills = new Set(agent.skills || []);
    const hasIt = currentSkills.has(skillName);
    if (shouldHave === hasIt) continue; // no change needed
    if (shouldHave) currentSkills.add(skillName);
    else currentSkills.delete(skillName);
    await apiPut('/v1/agents/' + agentId, {skills: Array.from(currentSkills)});
  }
  toast('Skill assignment updated');
}

async function deleteSkill() {
  if (!currentSkill) return;
  if (!confirm('Delete skill "' + currentSkill.name + '"? This cannot be undone.')) return;

  let path;
  if (currentSkill.scope === 'agent') {
    path = '/v1/skills/agents/' + currentSkill.agentId + '/' + currentSkill.name;
  } else {
    path = '/v1/skills/' + currentSkill.name;
  }

  const res = await apiDelete(path);
  if (res && res.ok) {
    toast('Skill deleted');
    currentSkill = null;
    skillsDirty = false;
    document.getElementById('skillsEditor').innerHTML = '<div class="skills-empty">Select a skill from the list</div>';
    loadSkills();
  } else {
    toast(res?.error || 'Failed to delete', 'error');
  }
}

function downloadSkill() {
  if (!currentSkill) return;
  const content = document.getElementById('skillContent').value;
  const blob = new Blob([content], {type: 'text/markdown'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (currentSkill.name || 'skill') + '.md';
  a.click();
  URL.revokeObjectURL(url);
}

function uploadSkill(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function() {
    const content = reader.result;
    const name = file.name.replace(/\.md$/, '');

    // Create as shared skill
    const res = await apiPut('/v1/skills/' + name, {content});
    if (res && res.ok) {
      // Auto-assign to all agents
      const agentsResp = await api('/v1/agents');
      if (agentsResp?.agents) {
        for (const ag of agentsResp.agents) {
          const skills = new Set(ag.skills || []);
          if (!skills.has(name)) {
            skills.add(name);
            await apiPut('/v1/agents/' + ag.id, {skills: Array.from(skills)});
          }
        }
      }
      toast('Skill "' + name + '" uploaded and assigned to all agents');
      await loadSkills();
      selectSkill('shared', name);
    } else {
      toast(res?.error || 'Upload failed', 'error');
    }
  };
  reader.readAsText(file);
  input.value = '';
}

async function regenerateTeamSkill() {
  const res = await apiPost('/v1/skills/team/regenerate', {});
  if (res && res.ok) {
    toast('Team skill regenerated');
    if (currentSkill?.scope === 'team') {
      selectSkill('team', '_team');
    }
  } else {
    toast(res?.error || 'Failed to regenerate', 'error');
  }
}

// ── Cleo Files ──────────────────────────────────────────────────────

async function loadCfFiles() {
  cfData = await api('/v1/cleo-files');
  if (!cfData) return;
  renderCfList();
}

function renderCfList() {
  const body = document.getElementById('cfListBody');
  const filter = (document.getElementById('cfSearch').value || '').toLowerCase();
  let html = '';

  // Global files
  const global = (cfData.global || []).filter(f =>
    !filter || f.name.toLowerCase().includes(filter));
  if (global.length) {
    html += '<div class="skill-group-title">Global</div>';
    for (const f of global) {
      const active = currentCfFile?.scope === 'global' && currentCfFile?.name === f.name;
      html += '<div class="skill-item' + (active ? ' active' : '') + '" onclick="selectCfFile(\'global\',\'' + escHtml(f.name) + '\')">';
      html += '<span>' + escHtml(f.name) + '</span>';
      html += '<span class="skill-scope">' + formatBytes(f.size) + '</span></div>';
    }
  }

  // Per-agent files
  const agents = cfData.agents || {};
  for (const aid of Object.keys(agents).sort()) {
    const files = agents[aid].filter(f =>
      !filter || f.name.toLowerCase().includes(filter));
    if (!files.length) continue;
    html += '<div class="skill-group-title">' + escHtml(aid) + '</div>';
    for (const f of files) {
      const scope = 'agent-' + aid;
      const active = currentCfFile?.scope === scope && currentCfFile?.name === f.name;
      html += '<div class="skill-item' + (active ? ' active' : '') + '" onclick="selectCfFile(\'' + escHtml(scope) + '\',\'' + escHtml(f.name) + '\')">';
      html += '<span>' + escHtml(f.name) + '</span>';
      html += '<span class="skill-scope">' + formatBytes(f.size) + '</span></div>';
    }
  }

  if (!html) html = '<div class="empty">No files found</div>';
  body.innerHTML = html;
}

function filterCfFiles() { renderCfList(); }

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  return (bytes / 1024).toFixed(1) + ' KB';
}

async function selectCfFile(scope, name) {
  if (cfDirty && !confirm('You have unsaved changes. Discard?')) return;
  cfDirty = false;

  const data = await api('/v1/cleo-files/' + scope + '/' + name);
  if (!data) { toast('Failed to load file', 'error'); return; }

  currentCfFile = {scope, name, content: data.content};

  const editor = document.getElementById('cfEditor');
  let h = '<div class="skills-toolbar">';
  h += '<span class="skill-filename">' + escHtml(data.path || name) + '</span>';
  h += '<span style="font-size:11px;color:var(--fg3);margin-left:4px">(' + formatBytes(data.size) + ')</span>';
  h += '<span style="flex:1"></span>';
  h += '<button class="btn btn-green btn-sm" onclick="saveCfFile()">Save</button>';
  h += '</div>';
  h += '<textarea class="mono" id="cfContent" oninput="cfDirty=true">' + escHtml(data.content || '') + '</textarea>';
  editor.innerHTML = h;

  renderCfList(); // update active highlight
}

async function saveCfFile() {
  if (!currentCfFile) return;
  const content = document.getElementById('cfContent').value;
  const res = await apiPut('/v1/cleo-files/' + currentCfFile.scope + '/' + currentCfFile.name, {content});
  if (res && res.ok) {
    toast('Saved ' + currentCfFile.name);
    cfDirty = false;
    currentCfFile.content = content;
    loadCfFiles(); // refresh sizes
  } else {
    toast(res?.error || 'Save failed', 'error');
  }
}

// ── Skills Create Dialog ────────────────────────────────────────────

function showCreateDialog() {
  // Populate agent scope options
  const sel = document.getElementById('newSkillScope');
  sel.innerHTML = '<option value="shared">Shared (all agents)</option>';
  if (skillsData?.agents) {
    for (const aid of Object.keys(skillsData.agents).sort()) {
      sel.innerHTML += '<option value="agent:' + escHtml(aid) + '">Agent: ' + escHtml(aid) + '</option>';
    }
  }
  // Also add agents from /v1/agents
  api('/v1/agents').then(d => {
    if (!d?.agents) return;
    for (const a of d.agents) {
      if (!skillsData?.agents?.[a.id]) {
        sel.innerHTML += '<option value="agent:' + escHtml(a.id) + '">Agent: ' + escHtml(a.id) + '</option>';
      }
    }
  });
  document.getElementById('newSkillName').value = '';
  document.getElementById('createDialog').style.display = 'flex';
}

function closeCreateDialog() {
  document.getElementById('createDialog').style.display = 'none';
}

async function createSkill() {
  const name = document.getElementById('newSkillName').value.trim().replace(/[^a-zA-Z0-9_-]/g, '');
  if (!name) { toast('Please enter a skill name', 'error'); return; }

  const scopeVal = document.getElementById('newSkillScope').value;
  const template = '---\nname: ' + name + '\ndescription: \ntags: []\n---\n\n# ' + name + '\n\nSkill content here.\n';

  let path;
  if (scopeVal.startsWith('agent:')) {
    const aid = scopeVal.slice(6);
    path = '/v1/skills/agents/' + aid + '/' + name;
  } else {
    path = '/v1/skills/' + name;
  }

  const res = await apiPut(path, {content: template});
  if (res && res.ok) {
    // Auto-assign shared skills to all agents
    if (!scopeVal.startsWith('agent:')) {
      const agentsResp = await api('/v1/agents');
      if (agentsResp?.agents) {
        for (const ag of agentsResp.agents) {
          const skills = new Set(ag.skills || []);
          if (!skills.has(name)) {
            skills.add(name);
            await apiPut('/v1/agents/' + ag.id, {skills: Array.from(skills)});
          }
        }
      }
    }
    toast('Skill "' + name + '" created');
    closeCreateDialog();
    await loadSkills();
    if (scopeVal.startsWith('agent:')) {
      const aid = scopeVal.slice(6);
      selectSkill('agent', name, aid);
    } else {
      selectSkill('shared', name);
    }
  } else {
    toast(res?.error || 'Failed to create', 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  TOOLS
// ══════════════════════════════════════════════════════════════════

async function loadTools() {
  const data = await api('/v1/tools');
  if (!data) return;

  const tools = data.tools || [];
  const available = tools.filter(t => t.available).length;
  const groups = Object.keys(data.groups || {}).length;

  document.getElementById('tAvail').textContent = available;
  document.getElementById('tTotal').textContent = tools.length;
  document.getElementById('tGroups').textContent = groups;

  // Group tools by group
  const byGroup = {};
  for (const t of tools) {
    const g = t.group || 'other';
    if (!byGroup[g]) byGroup[g] = [];
    byGroup[g].push(t);
  }

  const groupLabels = {web:'Web Tools',automation:'Automation',media:'Media & Devices',fs:'Filesystem',memory:'Memory & Knowledge',task:'Task Management',messaging:'Messaging',other:'Other'};
  const groupIcons = {web:'🌐',automation:'⚡',media:'📷',fs:'📁',memory:'🧠',task:'📋',messaging:'✉️',other:'🔧'};

  let h = '';
  for (const [gname, gtools] of Object.entries(byGroup)) {
    const label = groupLabels[gname] || gname;
    const icon = groupIcons[gname] || '🔧';
    h += '<div class="card" style="padding:16px">';
    h += '<h3 style="margin:0 0 12px;font-size:14px">' + icon + ' ' + escHtml(label) + '</h3>';
    h += '<div style="display:flex;flex-direction:column;gap:8px">';
    for (const t of gtools) {
      const statusColor = t.available ? 'var(--green)' : 'var(--muted)';
      const statusIcon = t.available ? '✓' : '✗';
      const envHint = !t.available && t.requires_env && t.requires_env.length
        ? ' <span style="color:var(--muted);font-size:11px">(needs ' + escHtml(t.requires_env.join(', ')) + ')</span>'
        : '';
      const params = Object.keys(t.parameters || {});
      const paramsStr = params.length ? params.join(', ') : 'none';
      h += '<div style="display:flex;align-items:start;gap:10px;padding:8px;border-radius:6px;background:rgba(255,255,255,0.02)">';
      h += '<span style="color:' + statusColor + ';font-weight:bold;min-width:18px">' + statusIcon + '</span>';
      h += '<div style="flex:1">';
      h += '<div style="font-weight:600;font-size:13px">' + escHtml(t.name) + envHint + '</div>';
      h += '<div style="font-size:11px;color:var(--muted);margin-top:2px">' + escHtml(t.description) + '</div>';
      h += '<div style="font-size:10px;color:var(--muted);margin-top:2px">Params: ' + escHtml(paramsStr) + '</div>';
      h += '</div></div>';
    }
    h += '</div></div>';
  }

  // Profiles reference
  h += '<div class="card" style="padding:16px">';
  h += '<h3 style="margin:0 0 12px;font-size:14px">📋 Tool Profiles</h3>';
  const profiles = data.profiles || {};
  for (const [pname, ptools] of Object.entries(profiles)) {
    const toolsStr = Array.isArray(ptools) ? ptools.join(', ') : ptools;
    h += '<div style="margin-bottom:6px"><span style="font-weight:600;color:var(--accent)">' + escHtml(pname) + '</span>';
    h += ' <span style="color:var(--muted);font-size:11px">— ' + escHtml(String(toolsStr)) + '</span></div>';
  }
  h += '<div style="margin-top:10px;font-size:11px;color:var(--muted)">Configure in agents.yaml under each agent\'s <code>tools:</code> key, or use <code>cleo configure --section tools</code></div>';
  h += '</div>';

  document.getElementById('toolsContent').innerHTML = h;
}

// ══════════════════════════════════════════════════════════════════
//  USAGE
// ══════════════════════════════════════════════════════════════════

async function loadUsage() {
  const data = await api('/v1/usage');
  if (!data) return;

  const agg = data.aggregate || {};
  document.getElementById('uCalls').textContent = fmtNum(agg.total_calls);
  document.getElementById('uTokens').textContent = fmtNum(agg.total_tokens);
  document.getElementById('uCost').textContent = '$' + (agg.total_cost_usd||0).toFixed(4);
  document.getElementById('uRetries').textContent = fmtNum(agg.total_retries);

  // By agent — merge old role IDs into current agent names
  const rawAgent = data.by_agent || {};
  const USAGE_ID_MAP = {planner:'leo', executor:'jerry', reviewer:'alic'};
  const byAgent = {};
  for (const [id, s] of Object.entries(rawAgent)) {
    const mapped = USAGE_ID_MAP[id] || id;
    if (!byAgent[mapped]) byAgent[mapped] = {calls:0, tokens:0, cost:0};
    byAgent[mapped].calls  += s.calls  || 0;
    byAgent[mapped].tokens += s.tokens || 0;
    byAgent[mapped].cost   += s.cost   || 0;
  }
  const agentEl = document.getElementById('usageByAgent');
  if (Object.keys(byAgent).length) {
    let h = '<table class="usage-table"><thead><tr><th>Agent</th><th>Calls</th><th>Tokens</th><th>Cost</th></tr></thead><tbody>';
    for (const [id, s] of Object.entries(byAgent).sort((a,b)=>b[1].tokens-a[1].tokens)) {
      const am = agentMeta(id);
      const ava = am.avatar ? '<img src="'+am.avatar+'" style="width:16px;height:16px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:4px">' : '';
      h += '<tr><td style="font-weight:600">'+ava+escHtml(capitalize(id))+'</td><td class="mono">'+fmtNum(s.calls)+'</td><td class="mono">'+fmtNum(s.tokens)+'</td><td class="mono">$'+s.cost.toFixed(4)+'</td></tr>';
    }
    h += '</tbody></table>';
    agentEl.innerHTML = h;
  } else { agentEl.innerHTML = '<div class="empty">No usage data</div>'; }

  // By model
  const byModel = data.by_model || {};
  const modelEl = document.getElementById('usageByModel');
  if (Object.keys(byModel).length) {
    let h = '<table class="usage-table"><thead><tr><th>Model</th><th>Calls</th><th>Tokens</th><th>Cost</th></tr></thead><tbody>';
    for (const [id, s] of Object.entries(byModel).sort((a,b)=>b[1].tokens-a[1].tokens)) {
      h += '<tr><td style="font-weight:600">'+escHtml(id)+'</td><td class="mono">'+fmtNum(s.calls)+'</td><td class="mono">'+fmtNum(s.tokens)+'</td><td class="mono">$'+s.cost.toFixed(4)+'</td></tr>';
    }
    h += '</tbody></table>';
    modelEl.innerHTML = h;
  } else { modelEl.innerHTML = '<div class="empty">No usage data</div>'; }
}

// ══════════════════════════════════════════════════════════════════
//  CHANNELS
// ══════════════════════════════════════════════════════════════════

const CHANNEL_META = {
  telegram: {
    icon: '💬', label: 'Telegram', sdk: 'python-telegram-bot',
    tokenFields: ['bot_token'],
    guide: 'https://core.telegram.org/bots#how-do-i-create-a-bot',
    guideSteps: ['1. Message @BotFather on Telegram', '2. Send /newbot and follow prompts', '3. Copy the API token and paste below'],
  },
  discord: {
    icon: '🎮', label: 'Discord', sdk: 'discord.py',
    tokenFields: ['bot_token'],
    guide: 'https://discord.com/developers/applications',
    guideSteps: ['1. Create app at Discord Developer Portal', '2. Go to Bot tab, Reset Token', '3. Enable Message Content Intent'],
  },
  feishu: {
    icon: '🐦', label: 'Feishu', sdk: 'lark-oapi',
    tokenFields: ['app_id', 'app_secret'],
    guide: 'https://open.feishu.cn/document/home/introduction-to-custom-app-development/self-built-application-development-process',
    guideSteps: ['1. Create app at Feishu Open Platform', '2. Copy App ID and App Secret', '3. Enable Bot capability under Features'],
  },
  slack: {
    icon: '💼', label: 'Slack', sdk: 'slack-sdk',
    tokenFields: ['bot_token', 'app_token'],
    guide: 'https://api.slack.com/apps',
    guideSteps: ['1. Create app at Slack API portal', '2. Enable Socket Mode, copy App Token (xapp-...)', '3. Install to workspace, copy Bot Token (xoxb-...)'],
  },
};

let _channelData = [];

async function loadChannels() {
  const data = await api('/v1/channels');
  if (!data) return;

  _channelData = data.channels || [];
  const running = _channelData.filter(c => c.running).length;
  const enabled = _channelData.filter(c => c.enabled).length;

  document.getElementById('chTotal').textContent = _channelData.length;
  document.getElementById('chRunning').textContent = running;
  document.getElementById('chEnabled').textContent = enabled;

  const grid = document.getElementById('channelGrid');
  if (!_channelData.length) {
    grid.innerHTML = '<div class="empty">No channels configured</div>';
    return;
  }

  let h = '';
  for (const ch of _channelData) {
    const meta = CHANNEL_META[ch.channel] || { icon: '📡', label: ch.channel, sdk: '?', tokenFields: [] };
    const statusColor = ch.running ? 'var(--green)' : ch.enabled ? 'var(--yellow)' : 'var(--fg3)';
    const statusText = ch.running ? 'Running' : ch.enabled ? 'Enabled (not running)' : 'Disabled';
    const tokenOk = ch.token_configured;

    h += '<div class="agent-card" style="cursor:default">'
      + '<div class="agent-card-header">'
      + '<span style="font-size:22px">' + meta.icon + '</span>'
      + '<span class="agent-name">' + meta.label + '</span>'
      + '<span class="hb-dot ' + (ch.running ? 'online' : 'offline') + '"></span>'
      + '</div>'
      + '<div style="display:flex;gap:8px;align-items:center;margin:4px 0">'
      + '<span style="color:' + statusColor + ';font-size:12px;font-weight:600">' + statusText + '</span>'
      + '</div>'
      + '<div style="display:flex;gap:8px;align-items:center;font-size:11px;color:var(--fg2)">'
      + '<span class="key-badge ' + (tokenOk ? 'set' : 'unset') + '">'
      + (tokenOk ? 'Token Set' : 'Token Not Set') + '</span>'
      + '<span>SDK: <code style="font-size:10px">' + meta.sdk + '</code></span>'
      + '</div>';

    // Config details
    if (ch.config) {
      const mention = ch.mention_required !== undefined ? ch.mention_required : true;
      h += '<div style="font-size:11px;color:var(--fg3);margin-top:4px">'
        + 'Mention required: ' + (mention ? 'Yes' : 'No')
        + '</div>';
    }

    // Action buttons
    h += '<div style="display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--bg3)">';
    if (ch.enabled) {
      h += '<button class="btn btn-sm btn-danger" onclick="toggleChannel(\'' + ch.channel + '\',false)">Disable</button>';
    } else {
      h += '<button class="btn btn-sm btn-green" onclick="toggleChannel(\'' + ch.channel + '\',true)">Enable</button>';
    }
    h += '<button class="btn btn-sm btn-outline" onclick="showChannelConfig(\'' + ch.channel + '\')">Configure</button>';
    h += '</div></div>';
  }
  grid.innerHTML = h;
}

async function toggleChannel(name, enabled) {
  const resp = await apiPut('/v1/channels/' + name, { enabled: enabled });
  if (resp && resp.ok) {
    loadChannels();
  }
}

function showChannelConfig(name) {
  const ch = _channelData.find(c => c.channel === name);
  const meta = CHANNEL_META[name] || { icon: '📡', label: name, tokenFields: [], guideSteps: [] };

  let h = '<div class="agent-modal-overlay" onclick="if(event.target===this)this.remove()">';
  h += '<div class="agent-modal">';
  h += '<div class="agent-modal-header">';
  h += '<div class="agent-modal-title">' + meta.icon + ' Configure ' + meta.label + '</div>';
  h += '<button class="agent-modal-close" onclick="this.closest(\'.agent-modal-overlay\').remove()">&times;</button>';
  h += '</div>';

  h += '<div class="agent-editor"><form id="chConfigForm" onsubmit="saveChannelConfig(\'' + name + '\');return false">';

  // Setup guide
  if (meta.guideSteps && meta.guideSteps.length) {
    h += '<div style="background:var(--bg2);border:1px solid var(--bg3);border-radius:8px;padding:10px 12px;margin-bottom:12px">';
    h += '<div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">Setup Guide</div>';
    for (const step of meta.guideSteps) {
      h += '<div style="font-size:11px;color:var(--fg2);margin:2px 0">' + escHtml(step) + '</div>';
    }
    if (meta.guide) {
      h += '<a href="' + meta.guide + '" target="_blank" rel="noopener" '
        + 'style="font-size:11px;color:var(--accent);text-decoration:none;display:inline-block;margin-top:4px">'
        + 'Open Developer Portal &rarr;</a>';
    }
    h += '</div>';
  }

  // Token fields
  for (const field of meta.tokenFields) {
    const label = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    h += '<div class="field">';
    h += '<label>' + escHtml(label) + '</label>';
    h += '<input class="input" type="password" id="ch_' + field + '" placeholder="Enter ' + label + '…" autocomplete="off">';
    h += '<div style="font-size:10px;color:var(--fg3);margin-top:2px">Leave empty to keep current value</div>';
    h += '</div>';
  }

  // Test token button + result area
  h += '<div style="margin:8px 0">';
  h += '<button type="button" class="btn btn-sm btn-outline" onclick="testChannelToken(\'' + name + '\')" id="ch_test_btn">Test Connection</button>';
  h += '<span id="ch_test_result" style="font-size:12px;margin-left:8px"></span>';
  h += '</div>';

  // Mention required
  const mention = ch ? (ch.mention_required !== undefined ? ch.mention_required : true) : true;
  h += '<div class="field">';
  h += '<label>Mention Required (groups)</label>';
  h += '<select class="input" id="ch_mention" style="width:120px">';
  h += '<option value="true"' + (mention ? ' selected' : '') + '>Yes</option>';
  h += '<option value="false"' + (!mention ? ' selected' : '') + '>No</option>';
  h += '</select>';
  h += '</div>';

  // Enabled toggle
  const enabled = ch ? ch.enabled : false;
  h += '<div class="field">';
  h += '<label>Enabled</label>';
  h += '<select class="input" id="ch_enabled" style="width:120px">';
  h += '<option value="true"' + (enabled ? ' selected' : '') + '>Yes</option>';
  h += '<option value="false"' + (!enabled ? ' selected' : '') + '>No</option>';
  h += '</select>';
  h += '</div>';

  h += '<div class="actions">';
  h += '<button type="button" class="btn btn-outline" onclick="this.closest(\'.agent-modal-overlay\').remove()">Cancel</button>';
  h += '<button type="submit" class="btn">Save</button>';
  h += '</div></form></div></div></div>';

  document.body.insertAdjacentHTML('beforeend', h);
}

async function testChannelToken(name) {
  const meta = CHANNEL_META[name] || { tokenFields: [] };
  const btn = document.getElementById('ch_test_btn');
  const result = document.getElementById('ch_test_result');

  btn.disabled = true;
  btn.textContent = 'Testing...';
  result.innerHTML = '';

  const body = {};
  for (const field of meta.tokenFields) {
    const val = document.getElementById('ch_' + field).value.trim();
    if (val) body[field.replace('bot_', '')] = val;
    if (field === 'bot_token' && val) body.token = val;
    if (field === 'app_id' && val) body.token = val;
  }

  try {
    const resp = await apiPost('/v1/channels/' + name + '/test', body);
    if (resp && resp.ok) {
      result.innerHTML = '<span style="color:var(--green)">&#10003; ' + escHtml(resp.message || 'Connected') + '</span>';
    } else {
      result.innerHTML = '<span style="color:var(--red)">&#10007; ' + escHtml((resp && resp.error) || 'Connection failed') + '</span>';
    }
  } catch (e) {
    result.innerHTML = '<span style="color:var(--red)">&#10007; Network error</span>';
  }

  btn.disabled = false;
  btn.textContent = 'Test Connection';
}

async function saveChannelConfig(name) {
  const meta = CHANNEL_META[name] || { tokenFields: [] };
  const body = {
    enabled: document.getElementById('ch_enabled').value === 'true',
    mention_required: document.getElementById('ch_mention').value === 'true',
  };

  // Add token values if provided
  for (const field of meta.tokenFields) {
    const val = document.getElementById('ch_' + field).value.trim();
    if (val) body[field] = val;
  }

  const resp = await apiPut('/v1/channels/' + name, body);
  if (resp && resp.ok) {
    // Close modal
    const overlay = document.querySelector('.agent-modal-overlay');
    if (overlay) overlay.remove();
    loadChannels();
    // Show success toast
    showToast(resp.message || ('Channel ' + name + ' saved.'), 'success');
  } else {
    showToast((resp && resp.error) || 'Save failed', 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  CONFIG (read-only)
// ══════════════════════════════════════════════════════════════════

async function loadConfig() {
  const data = await api('/v1/config');
  if (!data) return;

  // Agent config
  const cfg = data.config || {};
  const agents = cfg.agents || [];
  let agentText = '';
  for (const a of agents) {
    agentText += '- ' + (a.id||'?') + '\n'
      + '  model: ' + (a.model||'—') + '\n'
      + '  provider: ' + ((a.llm||{}).provider||'—') + '\n'
      + '  skills: [' + (a.skills||[]).join(', ') + ']\n'
      + '  fallbacks: [' + (a.fallback_models||[]).join(', ') + ']\n\n';
  }
  document.getElementById('configView').textContent = agentText || 'No agents configured';

  // Resilience
  const res = cfg.resilience || {};
  const compact = cfg.compaction || {};
  const mem = cfg.memory || {};
  let resText = 'Resilience:\n'
    + '  max_retries: ' + (res.max_retries ?? 3) + '\n'
    + '  base_delay: ' + (res.base_delay ?? 1.0) + 's\n'
    + '  max_delay: ' + (res.max_delay ?? 30.0) + 's\n'
    + '  jitter: ' + (res.jitter ?? 0.5) + '\n'
    + '  circuit_breaker_threshold: ' + (res.circuit_breaker_threshold ?? 3) + '\n'
    + '  circuit_breaker_cooldown: ' + (res.circuit_breaker_cooldown ?? 120) + 's\n\n'
    + 'Compaction:\n'
    + '  enabled: ' + (compact.enabled ?? true) + '\n'
    + '  max_context_tokens: ' + (compact.max_context_tokens ?? 8000) + '\n'
    + '  keep_recent_turns: ' + (compact.keep_recent_turns ?? 4) + '\n\n'
    + 'Memory:\n'
    + '  backend: ' + (mem.backend ?? 'chroma') + '\n';
  document.getElementById('resilienceView').textContent = resText;
}

// ══════════════════════════════════════════════════════════════════
//  GATEWAY — Token Management
// ══════════════════════════════════════════════════════════════════

async function loadGatewayInfo() {
  // Always show basic info from /health (no auth needed)
  try {
    const hRes = await fetch('/health');
    const hData = await hRes.json();
    if (hData && hData.status === 'ok') {
      document.getElementById('gwPort').textContent = hData.port || '—';
      document.getElementById('gwUptime').textContent = fmtTime(hData.uptime_seconds);
      document.getElementById('gwStatus').textContent = 'Online';
      document.getElementById('gwStatus').style.color = 'var(--green)';
    }
  } catch(e) {
    document.getElementById('gwStatus').textContent = 'Offline';
    document.getElementById('gwStatus').style.color = 'var(--red)';
  }
  // Fetch token (requires auth)
  const data = await apiPut('/v1/config/gateway', {action:'get_token'});
  if (data && data.token) {
    document.getElementById('gatewayToken').textContent = data.token;
  }
}

function copyToken() {
  const token = document.getElementById('gatewayToken').textContent;
  navigator.clipboard.writeText(token).then(() => toast('Token copied')).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = token;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    toast('Token copied');
  });
}

async function regenerateToken() {
  if (!confirm('Regenerate token? All existing clients will be disconnected.')) return;
  const data = await apiPut('/v1/config/gateway', {action:'regenerate_token'});
  if (data && data.ok) {
    TOKEN = data.token;
    localStorage.setItem('cleo_token', TOKEN);
    toast('Token regenerated');
    loadGatewayInfo();
  } else {
    toast(data?.error || 'Failed to regenerate', 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  HEALTH
// ══════════════════════════════════════════════════════════════════

async function loadDoctor() {
  // Fetch gateway status (public, no auth) and doctor checks in parallel
  const [healthData, data] = await Promise.all([
    (async () => { try { const r = await fetch('/health'); return await r.json(); } catch(e) { return null; } })(),
    api('/v1/doctor'),
  ]);

  // Populate gateway status cards
  if (healthData && healthData.status === 'ok') {
    document.getElementById('hGateway').textContent = 'Online';
    document.getElementById('hGateway').style.color = 'var(--green)';
    document.getElementById('hUptime').textContent = fmtTime(healthData.uptime_seconds);
    document.getElementById('hPort').textContent = ':' + (healthData.port || '—');
    document.getElementById('hAgents').textContent = healthData.agents || 0;
  } else {
    document.getElementById('hGateway').textContent = 'Offline';
    document.getElementById('hGateway').style.color = 'var(--red)';
  }

  // Populate diagnostic checks
  const el = document.getElementById('healthChecks');
  if (!data || !data.checks) { el.innerHTML = '<li class="empty">Could not run health checks</li>'; return; }

  let html = '';
  for (const c of data.checks) {
    const ok = c.ok !== undefined ? c.ok : c[0];
    const label = c.label || c[1] || '';
    const detail = c.detail || c[2] || '';
    const icon = ok ? '<span class="check-icon" style="color:var(--green)">✓</span>' : '<span class="check-icon" style="color:var(--red)">✗</span>';
    html += '<li>' + icon + '<span class="check-label">' + escHtml(label) + '</span><span class="check-detail">' + escHtml(detail) + '</span></li>';
  }
  el.innerHTML = html;
}

// ══════════════════════════════════════════════════════════════════
//  LOGS
// ══════════════════════════════════════════════════════════════════

async function initLogs() {
  // Populate agent selector
  const sel = document.getElementById('logAgentSelect');
  const prev = sel.value;
  const data = await api('/v1/agents');
  if (!data) return;

  sel.innerHTML = '<option value="">Select agent…</option>';
  for (const a of (data.agents||[])) {
    sel.innerHTML += '<option value="' + escHtml(a.id) + '"' + (a.id===prev?' selected':'') + '>' + escHtml(capitalize(a.id)) + '</option>';
  }
  // Add system log options
  sel.innerHTML += '<option value="exec"' + ('exec'===prev?' selected':'') + '>Exec</option>';
  sel.innerHTML += '<option value="gateway"' + ('gateway'===prev?' selected':'') + '>Gateway</option>';
  sel.innerHTML += '<option value="orchestrator"' + ('orchestrator'===prev?' selected':'') + '>Orchestrator</option>';

  if (sel.value) loadLogs();
}

async function loadLogs() {
  const agentId = document.getElementById('logAgentSelect').value;
  if (!agentId) {
    document.getElementById('logContent').textContent = 'Select an agent to view logs.';
    return;
  }

  const search = document.getElementById('logSearch').value;
  let url = '/v1/logs/' + agentId + '?lines=300';
  if (logLevel) url += '&level=' + logLevel;
  if (search) url += '&search=' + encodeURIComponent(search);

  const data = await api(url);
  const el = document.getElementById('logContent');

  if (!data || data.error) {
    el.textContent = data?.error || 'Failed to load logs';
    if (data?.available) {
      el.textContent += '\n\nAvailable logs: ' + data.available.join(', ');
    }
    return;
  }

  if (!data.lines || !data.lines.length) {
    el.textContent = 'No log entries found.';
    return;
  }

  // Render with color-coded lines
  let html = '';
  for (const line of data.lines) {
    let cls = 'log-line-info';
    if (/ERROR|CRITICAL/i.test(line)) cls = 'log-line-error';
    else if (/WARN/i.test(line)) cls = 'log-line-warn';
    html += '<div class="' + cls + '">' + escHtml(line) + '</div>';
  }
  el.innerHTML = html;

  // Auto-scroll to bottom
  el.scrollTop = el.scrollHeight;
}

function setLogLevel(btn) {
  document.querySelectorAll('.log-level-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  logLevel = btn.dataset.level;
  loadLogs();
}

function toggleLogAutoRefresh() {
  const checked = document.getElementById('logAutoRefresh').checked;
  if (logAutoRefreshTimer) { clearInterval(logAutoRefreshTimer); logAutoRefreshTimer = null; }
  if (checked) {
    logAutoRefreshTimer = setInterval(loadLogs, 3000);
  }
}

// ══════════════════════════════════════════════════════════════════
//  CHAIN PANEL
// ══════════════════════════════════════════════════════════════════

async function loadChain() {
  const data = await api('/v1/chain/status');
  if (!data) {
    document.getElementById('chainNetwork').textContent = 'Disabled';
    document.getElementById('chainNetwork').className = 'stat-value';
    document.getElementById('chainLitNet').textContent = '—';
    document.getElementById('chainAgents').textContent = '—';
    document.getElementById('chainAgents').className = 'stat-value';
    document.getElementById('chainX402').textContent = '—';
    document.getElementById('chainAgentsBody').innerHTML = '<tr><td colspan="6" class="empty">Chain not enabled</td></tr>';
    document.getElementById('chainTxList').textContent = 'Chain not enabled';
    return;
  }

  // Agent name mapping (legacy chain IDs → current agent names)
  const CHAIN_NAME_MAP = {planner:'Leo', executor:'Jerry', reviewer:'Alic', leo:'Leo', jerry:'Jerry', alic:'Alic'};

  // Stats cards
  document.getElementById('chainNetwork').textContent = data.network || '—';
  document.getElementById('chainLitNet').textContent = data.lit_network || '—';
  const agents = data.agents || {};
  const registered = Object.values(agents).filter(a => a.registered).length;
  const total = Object.keys(agents).length;
  document.getElementById('chainAgents').textContent = registered + '/' + total;
  document.getElementById('chainAgents').className = 'stat-value ' + (registered === total && total > 0 ? 'green' : registered > 0 ? 'cyan' : '');
  const x402El = document.getElementById('chainX402');
  x402El.textContent = data.x402_enabled ? 'Enabled' : 'Disabled';
  x402El.className = 'stat-value ' + (data.x402_enabled ? 'green' : '');

  // Agent table
  const scanBase = 'https://sepolia.basescan.org/address/';
  const tbody = document.getElementById('chainAgentsBody');
  if (total === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="empty">No agents initialized on-chain</td></tr>';
  } else {
    let html = '';
    for (const [aid, info] of Object.entries(agents)) {
      const displayName = CHAIN_NAME_MAP[aid] || aid;
      const statusDot = info.registered
        ? '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-right:6px"></span>'
        : '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--fg3);margin-right:6px"></span>';
      const statusText = info.registered ? 'Registered' : 'Not registered';
      const pkp = info.pkp_address
        ? '<a href="' + scanBase + escHtml(info.pkp_address) + '" target="_blank" rel="noopener" '
          + 'style="font-family:var(--mono);font-size:11px;color:var(--accent2);text-decoration:none" '
          + 'title="' + escHtml(info.pkp_address) + '">'
          + escHtml(info.pkp_address.slice(0,6)) + '…' + escHtml(info.pkp_address.slice(-4)) + '</a>'
        : '<span style="color:var(--fg3)">—</span>';
      const chainId = info.erc8004_agent_id != null
        ? '<span style="font-family:var(--mono);color:var(--cyan)">#' + info.erc8004_agent_id + '</span>'
        : '<span style="color:var(--fg3)">—</span>';
      const bal = parseFloat(info.usdc_balance || 0).toFixed(2);
      const balColor = parseFloat(bal) > 0 ? 'var(--green)' : 'var(--fg3)';
      const action = info.registered
        ? '<span style="color:var(--fg3);font-size:11px">✓ ready</span>'
        : '<button class="btn btn-sm" onclick="chainInit(\'' + escHtml(aid) + '\')">Initialize</button>';
      html += '<tr>'
        + '<td><strong style="color:var(--fg)">' + escHtml(displayName) + '</strong>'
        + ' <span style="color:var(--fg3);font-size:11px">(' + escHtml(capitalize(aid)) + ')</span></td>'
        + '<td>' + statusDot + statusText + '</td>'
        + '<td>' + pkp + '</td>'
        + '<td style="text-align:center">' + chainId + '</td>'
        + '<td style="font-family:var(--mono);color:' + balColor + '">' + bal + ' <span style="font-size:10px;color:var(--fg3)">USDC</span></td>'
        + '<td style="text-align:right">' + action + '</td></tr>';
    }
    tbody.innerHTML = html;
  }

  // Recent transactions
  const txList = document.getElementById('chainTxList');
  const txs = data.recent_transactions || [];
  if (txs.length === 0) {
    txList.innerHTML = '<div style="text-align:center;color:var(--fg3);padding:20px">No transactions yet</div>';
  } else {
    let html = '<div style="display:grid;grid-template-columns:auto 1fr auto auto;gap:0;font-size:12px">';
    // Header
    html += '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3)">Action</div>'
          + '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3)">Agent</div>'
          + '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3)">Tx Hash</div>'
          + '<div style="padding:6px 8px;color:var(--fg3);font-size:11px;font-weight:600;border-bottom:1px solid var(--bg3);text-align:right">Time</div>';
    for (const tx of txs.slice(-12).reverse()) {
      const ts = tx.timestamp ? new Date(tx.timestamp * 1000).toLocaleString(undefined, {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '—';
      const rawHash = tx.tx_hash || '';
      const isError = rawHash.startsWith('0x_error') || rawHash.startsWith('0x_err');
      const hashDisplay = rawHash ? rawHash.slice(0, 10) + '…' : '—';
      const hashEl = !isError && rawHash.length === 66
        ? '<a href="https://sepolia.basescan.org/tx/' + escHtml(rawHash) + '" target="_blank" rel="noopener" '
          + 'style="font-family:var(--mono);color:var(--accent2);text-decoration:none">' + hashDisplay + '</a>'
        : '<span style="font-family:var(--mono);color:' + (isError ? 'var(--red)' : 'var(--fg3)') + '">' + hashDisplay + '</span>';
      const agentName = CHAIN_NAME_MAP[tx.agent_id] || tx.agent_id || '';
      const rowBorder = 'border-bottom:1px solid var(--bg3)';
      html += '<div style="padding:6px 8px;' + rowBorder + '">'
            + '<span style="color:var(--accent2)">' + escHtml(tx.action || '?') + '</span></div>'
            + '<div style="padding:6px 8px;' + rowBorder + ';color:var(--fg)">' + escHtml(agentName) + '</div>'
            + '<div style="padding:6px 8px;' + rowBorder + '">' + hashEl + '</div>'
            + '<div style="padding:6px 8px;' + rowBorder + ';text-align:right;color:var(--fg3)">' + ts + '</div>';
    }
    html += '</div>';
    txList.innerHTML = html;
  }
}

async function chainInit(agentId) {
  if (!confirm('Initialize ' + agentId + ' on-chain? This will mint a PKP and register on ERC-8004.')) return;
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Working...';
  try {
    const data = await api('/v1/chain/init/' + agentId, 'POST');
    if (data && data.status === 'initialized') {
      alert('Agent ' + agentId + ' initialized successfully!');
    } else {
      alert('Error: ' + JSON.stringify(data));
    }
  } catch(e) {
    alert('Init failed: ' + e);
  }
  loadChain();
}

// ══════════════════════════════════════════════════════════════════
//  MEMORY PANEL
// ══════════════════════════════════════════════════════════════════

async function loadMemory() {
  const [statusData, kbData, insightsData] = await Promise.all([
    api('/v1/memory/status'),
    api('/v1/memory/kb/notes'),
    api('/v1/memory/kb/insights'),
  ]);

  // Stat cards
  if (statusData) {
    const agents = statusData.agents || {};
    let totalEps = 0, totalCases = 0, totalPats = 0;
    Object.values(agents).forEach(a => {
      totalEps += a.episodes || 0;
      totalCases += a.cases || 0;
      totalPats += a.patterns || 0;
    });
    document.getElementById('memEpisodes').textContent = totalEps;
    document.getElementById('memCases').textContent = totalCases;
    document.getElementById('memPatterns').textContent = totalPats;
    const kb = statusData.knowledge_base || {};
    document.getElementById('memNotes').textContent = kb.notes || 0;

    // Per-agent table
    const body = document.getElementById('memAgentsBody');
    let html = '';
    for (const [aid, info] of Object.entries(agents)) {
      html += '<tr>';
      html += '<td><strong>' + escHtml(capitalize(aid)) + '</strong></td>';
      html += '<td>' + (info.episodes || 0) + '</td>';
      html += '<td>' + (info.cases || 0) + '</td>';
      html += '<td>' + (info.patterns || 0) + '</td>';
      html += '<td>' + (info.daily_logs || 0) + '</td>';
      html += '</tr>';
    }
    body.innerHTML = html || '<tr><td colspan="5" class="empty">No memory data</td></tr>';
  }

  // Knowledge Base notes
  const kbList = document.getElementById('memKBList');
  if (kbData && kbData.notes && kbData.notes.length > 0) {
    let html = '<div style="display:flex;flex-direction:column;gap:8px">';
    kbData.notes.forEach(note => {
      const tags = (note.tags || []).map(t => '<span style="background:var(--surface);padding:1px 6px;border-radius:3px;font-size:10px">' + escHtml(t) + '</span>').join(' ');
      const contributors = (note.contributors || []).join(', ');
      const content = (note.content || '').substring(0, 200);
      html += '<div style="border-left:2px solid var(--accent1);padding-left:10px">';
      html += '<div><strong>' + escHtml(note.topic || note.slug) + '</strong> ' + tags + '</div>';
      html += '<div style="color:var(--fg3);font-size:11px">' + escHtml(content) + '</div>';
      html += '<div style="color:var(--fg3);font-size:10px;margin-top:2px">by ' + escHtml(contributors) + ' · ' + (note.update_count || 1) + ' updates</div>';
      html += '</div>';
    });
    html += '</div>';
    kbList.innerHTML = html;
  } else {
    kbList.innerHTML = '<span class="empty">No knowledge notes yet. Notes are created as agents learn from tasks.</span>';
  }

  // Insights feed
  const insList = document.getElementById('memInsightsList');
  if (insightsData && insightsData.insights && insightsData.insights.length > 0) {
    let html = '';
    insightsData.insights.slice(-15).reverse().forEach(ins => {
      const ts = new Date(ins.ts * 1000).toLocaleString();
      const tags = (ins.tags || []).join(', ');
      html += '<div style="margin-bottom:6px;border-left:2px solid var(--accent2);padding-left:8px">';
      html += '<span style="color:var(--accent1)">[' + escHtml(ins.agent_id) + ']</span> ';
      html += escHtml(ins.insight);
      html += '<div style="color:var(--fg3);font-size:10px">' + ts;
      if (tags) html += ' · ' + escHtml(tags);
      html += '</div></div>';
    });
    insList.innerHTML = html;
  } else {
    insList.innerHTML = '<span class="empty">No cross-agent insights yet. Insights are generated after task completion.</span>';
  }
}

// ══════════════════════════════════════════════════════════════════
//  CRON JOBS
// ══════════════════════════════════════════════════════════════════

async function loadCron() {
  const data = await api('/v1/cron');
  const jobs = data?.jobs || [];
  const tbody = document.getElementById('cronJobsBody');
  const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };

  el('cronTotal', jobs.length);
  el('cronActive', jobs.filter(j => j.enabled).length);
  el('cronRuns', jobs.reduce((s, j) => s + (j.run_count || 0), 0));

  if (!jobs.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty">No cron jobs configured. Click "+ New Job" to create one.</td></tr>';
    return;
  }
  let html = '';
  jobs.forEach(j => {
    const lastRun = j.last_run ? new Date(j.last_run * 1000).toLocaleString() : '—';
    html += '<tr>'
      + '<td><strong>' + escHtml(j.name || j.id) + '</strong></td>'
      + '<td><code>' + escHtml(j.action || '?') + '</code></td>'
      + '<td><code>' + escHtml(j.schedule || '?') + '</code></td>'
      + '<td>' + lastRun + '</td>'
      + '<td>' + (j.run_count || 0) + '</td>'
      + '<td>' + (j.enabled ? '✅' : '⏸️') + '</td>'
      + '<td>'
      + '<button class="btn btn-small" onclick="runCronJob(\'' + j.id + '\')">▶ Run</button> '
      + '<button class="btn btn-small" onclick="deleteCronJob(\'' + j.id + '\')" style="color:var(--red)">✕</button>'
      + '</td></tr>';
  });
  tbody.innerHTML = html;
}

async function runCronJob(id) {
  const res = await api('/v1/cron/' + id + '/run', { method: 'POST' });
  if (res && !res.error) { toast('Job triggered'); loadCron(); }
  else toast('Failed: ' + (res?.error || 'unknown'), 'error');
}

async function deleteCronJob(id) {
  if (!confirm('Delete this cron job?')) return;
  const res = await api('/v1/cron/' + id, { method: 'DELETE' });
  if (res && !res.error) { toast('Job deleted'); loadCron(); }
  else toast('Failed: ' + (res?.error || 'unknown'), 'error');
}

function showNewCronModal() {
  const overlay = document.createElement('div');
  overlay.className = 'agent-modal-overlay';
  overlay.id = 'cronModalOverlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = '<div class="agent-modal" style="width:500px" onclick="event.stopPropagation()">'
    + '<div style="padding:16px 20px;border-bottom:1px solid var(--bg4)"><h3 style="margin:0;font-size:15px">New Cron Job</h3></div>'
    + '<div style="padding:16px 20px">'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Name<br>'
    + '<input id="cronName" class="input" style="width:100%;margin-top:4px" placeholder="my-daily-task"></label>'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Action Type<br>'
    + '<select id="cronAction" class="input" style="width:100%;margin-top:4px"><option value="task">task (submit task)</option><option value="exec">exec (shell command)</option><option value="webhook">webhook (HTTP POST)</option></select></label>'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Payload<br>'
    + '<textarea id="cronPayload" class="input" style="width:100%;margin-top:4px;height:60px;font-family:var(--mono);font-size:12px" placeholder="task description or command"></textarea></label>'
    + '<label style="display:block;margin-bottom:12px;font-size:13px;color:var(--fg2)">Schedule Type<br>'
    + '<select id="cronSchedType" class="input" style="width:100%;margin-top:4px"><option value="interval">interval (e.g. 3600)</option><option value="cron">cron (e.g. 0 */2 * * *)</option><option value="once">once (ISO datetime)</option></select></label>'
    + '<label style="display:block;margin-bottom:16px;font-size:13px;color:var(--fg2)">Schedule Value<br>'
    + '<input id="cronSchedVal" class="input" style="width:100%;margin-top:4px" placeholder="3600"></label>'
    + '<div style="text-align:right"><button class="btn" onclick="document.getElementById(\'cronModalOverlay\').remove()">Cancel</button> '
    + '<button class="btn btn-accent" onclick="createCronJob()">Create</button></div>'
    + '</div></div>';
  document.body.appendChild(overlay);
}

async function createCronJob() {
  const name = document.getElementById('cronName').value.trim();
  const action = document.getElementById('cronAction').value;
  const payload = document.getElementById('cronPayload').value.trim();
  const schedType = document.getElementById('cronSchedType').value;
  const schedVal = document.getElementById('cronSchedVal').value.trim();
  if (!name || !payload || !schedVal) { toast('Fill all fields', 'error'); return; }

  const body = { name, action, payload, schedule_type: schedType, schedule: schedVal };
  const res = await api('/v1/cron', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (res && !res.error) {
    toast('Cron job created');
    document.getElementById('cronModalOverlay').remove();
    loadCron();
  } else {
    toast('Failed: ' + (res?.error || 'unknown'), 'error');
  }
}

// ══════════════════════════════════════════════════════════════════
//  AGENT FILES & TOOLS TABS
// ══════════════════════════════════════════════════════════════════

async function loadAgentFiles(agentId) {
  const data = await api('/v1/agents');
  const agents = data?.agents || [];
  const ag = agents.find(a => a.id === agentId);
  const files = ag?.files || [];

  const container = document.getElementById('agentFilesContent');
  if (!container) return;
  if (!files.length) {
    container.innerHTML = '<div class="empty" style="padding:16px">No files found for this agent. Create <code>skills/agents/' + escHtml(agentId) + '/soul.md</code> to get started.</div>';
    return;
  }

  let html = '<div style="display:flex;flex-direction:column;gap:8px;padding:12px">';
  files.forEach(f => {
    const name = f.name || f.path || 'unknown';
    const size = f.size ? (f.size < 1024 ? f.size + 'B' : (f.size / 1024).toFixed(1) + 'KB') : '?';
    html += '<div class="card" style="padding:10px 14px;cursor:pointer" onclick="viewAgentFile(\'' + escHtml(agentId) + '\',\'' + escHtml(name) + '\')">'
      + '<div style="display:flex;align-items:center;justify-content:space-between">'
      + '<div><strong style="color:var(--fg)">📄 ' + escHtml(name) + '</strong></div>'
      + '<div style="font-size:11px;color:var(--fg3)">' + size + '</div>'
      + '</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

async function viewAgentFile(agentId, fileName) {
  // API expects name without .md extension
  const apiName = fileName.endsWith('.md') ? fileName.slice(0, -3) : fileName;
  const res = await api('/v1/skills/agents/' + agentId + '/' + encodeURIComponent(apiName));
  const content = res?.content || res?.text || '(empty)';
  const container = document.getElementById('agentFilesContent');
  if (!container) return;
  container.innerHTML = '<div style="padding:12px">'
    + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">'
    + '<button class="btn btn-small" onclick="loadAgentFiles(\'' + escHtml(agentId) + '\')">← Back</button>'
    + '<strong>' + escHtml(fileName) + '</strong>'
    + '</div>'
    + '<textarea id="agentFileEditor" class="input" style="width:100%;height:300px;font-family:var(--mono);font-size:12px;background:var(--bg);color:var(--fg);border:1px solid var(--bg4);border-radius:6px;padding:12px">' + escHtml(content) + '</textarea>'
    + '<div style="text-align:right;margin-top:8px">'
    + '<button class="btn btn-accent" onclick="saveAgentFile(\'' + escHtml(agentId) + '\',\'' + escHtml(fileName) + '\')">Save</button>'
    + '</div></div>';
}

async function saveAgentFile(agentId, fileName) {
  const editor = document.getElementById('agentFileEditor');
  if (!editor) return;
  const apiName = fileName.endsWith('.md') ? fileName.slice(0, -3) : fileName;
  const res = await api('/v1/skills/agents/' + agentId + '/' + encodeURIComponent(apiName), {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ content: editor.value })
  });
  if (res && !res.error) toast('File saved');
  else toast('Save failed: ' + (res?.error || 'unknown'), 'error');
}

function loadAgentTools(agentId) {
  // Show agent's tool profile & available tools
  const container = document.getElementById('agentToolsContent');
  if (!container) return;
  api('/v1/agents').then(data => {
    const agents = data?.agents || [];
    const ag = agents.find(a => a.id === agentId);
    if (!ag) { container.innerHTML = '<div class="empty">Agent not found</div>'; return; }
    const tools = ag.tools || {};
    const profile = tools.profile || 'minimal';
    const allow = tools.allow || [];
    const deny = tools.deny || [];

    let html = '<div style="padding:12px">';
    html += '<div style="margin-bottom:16px"><strong>Tool Profile:</strong> <code>' + escHtml(profile) + '</code></div>';
    if (allow.length) html += '<div style="margin-bottom:8px"><strong>Allow:</strong> ' + allow.map(t => '<code style="margin:2px">' + escHtml(t) + '</code>').join(' ') + '</div>';
    if (deny.length) html += '<div style="margin-bottom:8px"><strong>Deny:</strong> ' + deny.map(t => '<code style="margin:2px;color:var(--red)">' + escHtml(t) + '</code>').join(' ') + '</div>';

    // Show all available tools
    api('/v1/tools').then(tdata => {
      const allTools = tdata?.tools || [];
      html += '<div style="margin-top:16px"><strong>Available Tools (' + allTools.length + '):</strong></div>';
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:6px;margin-top:8px">';
      allTools.forEach(t => {
        const name = t.name || t;
        const isAllowed = allow.length ? allow.includes(name) : !deny.includes(name);
        const icon = isAllowed ? '✅' : '❌';
        html += '<div style="padding:6px 10px;background:var(--bg);border-radius:4px;font-size:12px">'
          + icon + ' <code>' + escHtml(name) + '</code></div>';
      });
      html += '</div></div>';
      container.innerHTML = html;
    });
  });
}

// ══════════════════════════════════════════════════════════════════
//  INIT & POLLING
// ══════════════════════════════════════════════════════════════════

pollHealth();
pollChatUpdates();
setInterval(pollHealth, 5000);
setInterval(pollChatUpdates, 2000);
</script>
</body>
</html>
